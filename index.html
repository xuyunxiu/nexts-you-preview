<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXT'S YOU — Preview</title>
  <style>
    /* --- 基本 --- */
    :root { --bg:#111; --card:#222; --text:#fff; --red:#e02424; --muted:#9aa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    h2 { margin:16px 0; }
    section { display:none; padding:16px 16px 90px; }        /* 底部留空給 nav / input-bar */
    section.active { display:block; }

    /* --- 底部導覽 --- */
    nav { position:fixed; left:0; right:0; bottom:0; height:50px; background:#1a1a1a;
          display:flex; justify-content:space-around; align-items:center; border-top:1px solid #222;
          padding-bottom: max(0px, env(safe-area-inset-bottom)); z-index:5; }
    nav.hidden{ display:none; }
    nav button{ background:none; border:none; color:#fff; font-size:15px; }

    /* --- 共用按鈕/卡片 --- */
    .btn { display:inline-block; padding:10px 16px; margin:8px; border-radius:10px; font-weight:600; cursor:pointer; border:none; }
    .btn-red{ background:var(--red); color:#fff; }
    .product{ background:var(--card); margin:10px 0; padding:14px; border-radius:12px; text-align:left; }

    /* --- 頂部列 --- */
    .topbar{ position:sticky; top:0; left:0; right:0; background:var(--bg); z-index:2;
             display:flex; align-items:center; justify-content:space-between; padding:6px 4px 8px; border-bottom:1px solid #1f1f1f;}
    .hearts{ font-size:18px; color:pink; padding:6px 10px; background:#1f1a1a; border-radius:16px; }

    /* --- DM 佈局 --- */
    .chat-box{
      height: calc(100dvh - 50px /*nav*/ - 54px /*topbar估*/ - 64px /*input-bar估*/);
      overflow-y:auto; padding:12px 8px 12px; display:flex; flex-direction:column; gap:6px;
    }
    .msg{ max-width:72%; padding:10px 12px; border-radius:14px; font-size:15px; line-height:1.35; word-break:break-word; }
    .artist{ align-self:flex-start; background:#2f2f2f; color:#fff; border:1px solid #3a3a3a; }
    .fan{ align-self:flex-end; background:var(--red); color:#fff; }

    .stamp{ margin-top:4px; font-size:11px; color:var(--muted); }
    .bubble{ display:flex; flex-direction:column; }

    /* 輸入列固定底部（在 nav 上方） */
    .input-bar{
      position:fixed; left:0; right:0; bottom:50px;
      background:var(--bg); padding:10px 12px 12px;
      display:flex; gap:8px; align-items:center; border-top:1px solid #1f1f1f; z-index:4;
    }
    .input-bar input{
      flex:1; height:42px; padding:10px 14px; border-radius:20px; border:none; background:#1c1c1c; color:#fff;
      outline:none;
    }
    .input-bar button{ height:42px; padding:0 14px; border-radius:20px; }
  </style>
</head>
<body>

  <!-- 登入頁 -->
  <section id="login" class="active">
    <h2>登入</h2>
    <button class="btn btn-red" onclick="login('line')">用 LINE 登入（模擬）</button>
    <div style="margin-top:8px"></div>
    <input type="text" id="inviteCode" placeholder="輸入邀請碼，例如 NEXT2025"
           style="width:min(520px,92%); padding:10px; border-radius:10px; border:none; background:#1c1c1c; color:#fff;">
    <br/>
    <button class="btn" onclick="login('code')">使用邀請碼</button>
  </section>

  <!-- 首頁 -->
  <section id="home">
    <div class="topbar">
      <h2>NEXT’S YOU — Preview</h2>
      <!-- 首頁不顯示 ♡ -->
      <div style="width:64px"></div>
    </div>

    <p style="opacity:.9">這裡是首頁內容</p>
    <div class="product"><b>我的分數：</b><span id="points">0</span></div>

    <h3 style="text-align:left;margin:14px 0 8px">商品區</h3>
    <div class="product">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>7 天 DM 權益 <span style="color:#aaa">— 70 分</span></div>
        <button class="btn btn-red" onclick="buyProduct(70,7)">購買</button>
      </div>
    </div>
    <div class="product">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>30 天 DM 權益 <span style="color:#aaa">— 250 分</span></div>
        <button class="btn btn-red" onclick="buyProduct(250,30)">購買</button>
      </div>
    </div>
  </section>

  <!-- DM -->
  <section id="dm">
    <div class="topbar">
      <h2>ALIDAY PROJECT — 團體 DM</h2>
      <div class="hearts">♡<span id="heartDays">0</span></div>
    </div>

    <!-- 訊息區 -->
    <div id="chatBox" class="chat-box"></div>

    <!-- 輸入列（固定在底部 nav 上方） -->
    <div class="input-bar">
      <input type="text" id="chatInput" placeholder="對 NEXT’s 留言…" />
      <button class="btn btn-red" onclick="sendMessage()">送出</button>
    </div>
  </section>

  <!-- 相簿 -->
  <section id="gallery">
    <div class="topbar">
      <h2>相簿</h2>
      <div style="width:64px"></div>
    </div>
    <p>藝人上傳的圖片會顯示在這裡（佔位）。</p>
  </section>

  <!-- 直播 -->
  <section id="live">
    <div class="topbar">
      <h2>直播</h2>
      <div style="width:64px"></div>
    </div>
    <p>文字直播（上：主播／下：粉絲）之後接上。</p>
  </section>

  <!-- 底部導覽 -->
  <nav id="nav" class="hidden">
    <button onclick="showPage('home')">首頁</button>
    <button onclick="showPage('dm')">DM</button>
    <button onclick="showPage('gallery')">相簿</button>
    <button onclick="showPage('live')">直播</button>
  </nav>

  <script>
    /* ========== 初始化測試分數（沒有後端先頂著） ========== */
    if (!localStorage.getItem('points')) localStorage.setItem('points', 200);

    /* ========== 登入 ========== */
    function login(method){
      const ok = method==='line' || (method==='code' && document.getElementById('inviteCode').value.trim()==='NEXT2025');
      if(!ok){ alert('邀請碼錯誤！'); return; }
      localStorage.setItem('loggedIn','true');
      showPage('home'); renderPoints();
    }

    /* ========== 路由/守門員 ========== */
    function showPage(page){
      if(!localStorage.getItem('loggedIn') && page!=='login') page='login';
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(page).classList.add('active');

      const nav=document.getElementById('nav');
      nav.classList.toggle('hidden', !(localStorage.getItem('loggedIn') && page!=='login'));

      if(page==='home') renderPoints();
      if(page==='dm'){ renderHearts(); renderDM(); scrollToBottom(); }
    }

    /* ========== 分數/商品購買 ========== */
    function renderPoints(){ document.getElementById('points').textContent = localStorage.getItem('points'); }

    function buyProduct(cost, days){
      let pts = parseInt(localStorage.getItem('points')||'0',10);
      if(pts < cost){ alert('分數不足！'); return; }
      localStorage.setItem('points', pts - cost);
      // 權益寫入：起始日=今天、天數=商品天數
      localStorage.setItem('purchaseDate', new Date().toISOString().split('T')[0]);
      localStorage.setItem('duration', String(days));
      alert(`✅ 已購買 ${days} 天 DM 權益！`);
      renderPoints();
    }

    /* ========== DM：♡+N（只在 DM 顯示） ========== */
    function daysSince(dateStr){
      if(!dateStr) return 0;
      const s=new Date(dateStr), t=new Date();
      s.setHours(0,0,0,0); t.setHours(0,0,0,0);
      return Math.floor((t-s)/86400000);
    }
    function renderHearts(){
      const start = localStorage.getItem('purchaseDate');
      const duration = parseInt(localStorage.getItem('duration')||'0',10);
      if(!start || duration<=0){ document.getElementById('heartDays').textContent='0'; return; }
      const n = daysSince(start);
      document.getElementById('heartDays').textContent = (n<=duration)? n : '0';
    }

    /* ========== DM：訊息流（左右分流＋固定底部輸入列） ========== */
    const DM_KEY='dmMessages';
    // 首次塞一條系統訊息
    if(!localStorage.getItem(DM_KEY)){
      const seed=[{role:'artist', text:'歡迎來到 DM！這裡是團體訊息流～', ts:Date.now()}];
      localStorage.setItem(DM_KEY, JSON.stringify(seed));
    }

    function renderDM(){
      const list = JSON.parse(localStorage.getItem(DM_KEY) || '[]');
      const box = document.getElementById('chatBox');
      box.innerHTML='';
      list.forEach(m=>{
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (m.role==='artist'?'artist':'fan');
        wrap.innerHTML = `<div class="bubble">${m.text}<div class="stamp">${new Date(m.ts).toLocaleString()}</div></div>`;
        box.appendChild(wrap);
      });
    }

    function sendMessage(){
      const inp=document.getElementById('chatInput');
      const t=inp.value.trim(); if(!t) return;
      const list = JSON.parse(localStorage.getItem(DM_KEY) || '[]');
      list.push({role:'fan', text:t, ts:Date.now()});
      localStorage.setItem(DM_KEY, JSON.stringify(list));
      inp.value='';
      renderDM(); scrollToBottom();
    }

    function scrollToBottom(){
      const box=document.getElementById('chatBox');
      requestAnimationFrame(()=>{ box.scrollTop = box.scrollHeight; });
    }

    /* ========== 啟動 ========== */
    window.onload = ()=>{ showPage(localStorage.getItem('loggedIn')?'home':'login'); };
  </script>
</body>
</html>
