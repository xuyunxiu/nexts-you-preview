
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>NEXT'S YOU â€” App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<!-- =========================
=  CSSï¼šä¸»é¡Œèˆ‡å…±ç”¨åŸºç¤æ¨£å¼  =
========================== -->
<style>
/* ===== Themeï¼šè—ç´«ç™½ ===== */
:root {
  --bg: #f5f7ff;          /* èƒŒæ™¯ è—ç™½ */
  --card: #ffffff;        /* å¡ç‰‡ ç™½ */
  --accent: #6a5acd;      /* ä¸»è‰² è—ç´« (slateblue) */
  --accent-2: #836fff;    /* æ¼¸å±¤ è—ç´« (lighter purple) */
  --text: #1a1a1a;        /* æ–‡å­— é»‘ç° */
  --sub: #666;            /* æ¬¡æ–‡å­— */
  --line: #ddd;           /* åˆ†éš”ç·š */
  --hover: #eef1ff;       /* hover ç‹€æ…‹ */
  --r: 16px;
  --shadow: 12px 18px 40px rgba(0,0,0,.1);
}

body.nx {
  margin:0;
  color:var(--text);
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}

.panel,.card {
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow)
}
.panel.soft,.card.soft{padding:16px}
section{display:none; padding:16px 16px 96px}
section.active{display:block; animation:fadeIn .24s ease}
@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
h2,h3,p{margin:0}
.ghost{opacity:.75; color:var(--sub)}
.row{display:flex; align-items:center; gap:12px}
.topbar{display:flex; align-items:center; gap:12px; margin-bottom:10px}
.menu-btn{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); color:var(--text); cursor:pointer}

/* ===== Nav & StoryBar å‹•ç•« ===== */
#nav, #storyBar { transition: transform .3s ease; }

/* ===== Home header ===== */
#friendsHeader{display:flex; justify-content:space-between; align-items:center; gap:12px}
#friendsHeader .me{display:flex; align-items:center; gap:12px; cursor:pointer}
#friendsHeader img{width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
#friendsHeader .nick{font-weight:800}

/* ===== Story bar ===== */
.story-bar{display:flex; gap:14px; padding:12px; overflow-x:auto}
.story-item{flex:0 0 auto; text-align:center; cursor:pointer}
.story-avatar{width:60px; height:60px; border-radius:50%; border:2px solid var(--accent); object-fit:cover}
.story-name{margin-top:4px; font-size:12px; color:var(--sub)}

/* ===== æ–‡ç« å¡ç‰‡ ===== */
.post-card img {
  width: 100%;           /* å¡«æ»¿å¡ç‰‡å¯¬åº¦ */
  height: 400px;         /* å›ºå®šé«˜åº¦ï¼Œè‡ªå·±å¯ä»¥æ”¹ 300/350/400px */
  border-radius: 12px;   /* è·Ÿå¡ç‰‡åŒæ¨£åœ“è§’ */
  display: block;
  object-fit: cover;     /* ä¿æŒæ¯”ä¾‹ï¼Œè¶…å‡ºéƒ¨åˆ†è£æ‰ */
}

/* ===== Reaction åˆ— ===== */
.reactions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
.reaction{display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:var(--hover); cursor:pointer; min-width:48px}
.reaction .count{font-weight:700; font-size:12px}
.reaction.active {
  background: var(--accent);
  color: #fff;
  transform: scale(1.05);
  transition: .15s;
}

/* ===== ç•™è¨€å€ ===== */
.comments-head{display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px}
.comments-left{display:flex; align-items:center; gap:10px}
.refresh-btn{width:22px; height:22px; border-radius:50%; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; cursor:pointer}
.switch{position:relative; width:44px; height:24px}
.switch input{opacity:0; width:0; height:0}
.slider{position:absolute; cursor:pointer; inset:0; background:#ccc; border-radius:999px; transition:.2s}
.slider:before{content:""; position:absolute; height:18px; width:18px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s}
.switch input:checked + .slider{background:var(--accent)}
.switch input:checked + .slider:before{transform:translateX(20px)}
.citem{border:1px solid var(--line); border-radius:12px; padding:10px; background:linear-gradient(180deg, var(--card), var(--hover)); margin-bottom:10px}
.citem.artist{background:linear-gradient(180deg, #eae6ff, #f5f2ff); border-color:#b8aaff} /* è—äººå›è¦†ï¼šä¸åŒé¡è‰² */
.citem .u{display:flex; align-items:center; gap:10px}
.citem .u img{width:36px; height:36px; border-radius:50%; border:1px solid var(--line); object-fit:cover}
.citem .name{font-weight:800}
.comment-input{position:fixed; left:0; right:0; bottom:0; padding:12px 14px; background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.85)); backdrop-filter:blur(10px); display:flex; gap:10px}
.comment-input input{flex:1; border:none; outline:none; border-radius:16px; padding:14px 16px; background:var(--hover); color:var(--text); border:1px solid var(--line)}
.comment-input button{width:52px; height:52px; border:none; border-radius:18px; font-weight:900; color:#fff; background:linear-gradient(180deg,var(--accent),var(--accent-2)); cursor:pointer}

/* ===== NAV ===== */
nav{position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--line);
    display:flex; justify-content:space-around; padding:12px 8px 16px; backdrop-filter:blur(8px)}
nav.hidden{display:none}
nav button{background:transparent; border:none; color:var(--text); font-weight:800; padding:8px 10px; border-radius:12px; cursor:pointer}
nav button:active{background:var(--hover)}

  /* =========================
  =  Profileï¼ˆå–®ä¸€é ï¼šè‡ªå·±/ä»–äººå…±ç”¨ï¼‰=
  ========================== */
  #profile .topbar{position:sticky; top:0; z-index:5; padding-top:8px; background:linear-gradient(180deg, rgba(15,15,18,.85), rgba(15,15,18,0))}
  #profileHeader{position:relative; height:46vh; border-radius:0 0 24px 24px; overflow:hidden}
  #profileBg{width:100%; height:100%; object-fit:cover}
  #profileHeader::after{content:""; position:absolute; left:0; right:0; bottom:0; height:40%; background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.5))}
  #avatarWrap{position:absolute; left:50%; transform:translateX(-50%); bottom:-48px; text-align:center}
  #editAvatar{width:96px; height:96px; border-radius:50%; border:3px solid #fff; object-fit:cover; cursor:pointer; background:#666}
  .profile-actions{position:absolute; left:50%; transform:translateX(-50%); bottom:62px; display:flex; gap:16px}
  .round-btn{width:40px; height:40px; border-radius:50%; border:1px solid var(--line); background:var(--card); display:flex; align-items:center; justify-content:center; cursor:pointer}
  #profileInfo{margin-top:72px; display:flex; flex-direction:column; gap:12px}
  .pitem{display:flex; align-items:center; justify-content:space-between; padding:16px; border:1px solid var(--line); background:var(--card); border-radius:16px}
  .pitem .label{color:var(--sub); font-size:13px}
  .pitem .value{font-weight:800}
  .edit-btn{border:none; background:transparent; cursor:pointer; font-size:14px}
  .onlyMe{display:none} /* é è¨­éš±è—ï¼Œé€²å…¥è‡ªå·±é é¢æ™‚å†é–‹ */

:root { --profileHeaderH: 50vh; }  /* ä½ å¯ä»¥æ”¹ 46vh/60vh/100vh */
#profileHeader{ position:relative; height:var(--profileHeaderH); border-radius:0 0 24px 24px; overflow:hidden; }

#profile{padding:0}

/* Profile ç‹€æ…‹è¨Šæ¯è™•ç† */
#p_status {
  max-width: 100%;
  overflow-wrap: break-word;  /* é‡åˆ°é•·å­—æ›è¡Œ */
  white-space: pre-wrap;      /* ä¿ç•™æ›è¡Œ */
  word-break: break-word;     /* å¼·åˆ¶åˆ‡æ–·å¤ªé•·çš„å­—ä¸² */
}

/* ========================= DM åˆ—è¡¨ ========================= */
.dmBox {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid var(--line);
  cursor: pointer;
}

.dmBox img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.dmBox .info {
  flex: 1;
  min-width: 0; /* é˜²æ­¢æ–‡å­—æº¢å‡º */
}

.dmBox .info b {
  display: block;
  font-size: 15px;
  color: var(--text);
}

.dmBox .info .lastMsg {
  font-size: 13px;
  color: var(--text-light);
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.dmBox .time {
  font-size: 12px;
  color: var(--text-light);
}

/* DM æ–°ç‰ˆæ¨£å¼ */
.dmThread {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  max-height: 60vh;
}

.msg {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 70%;
  word-break: break-word;
  font-size: 14px;
  position: relative;
}

.msg.left {
  background: var(--card);
  align-self: flex-start;
}

.msg.right {
  background: var(--accent);
  color: white;
  align-self: flex-end;
}

/* æœªè®€æç¤ºå°åœ“é» */
.readStatus {
  font-size: 10px;
  background: white;
  color: var(--accent);
  padding: 2px 6px;
  border-radius: 999px;
  margin-left: 8px;
}

/* Header çµ±ä¸€è¨­å®š */
.postHeader, .detailHeader {
  display:flex;
  align-items:center;
  position:relative; /* è®“ç¿»è­¯éµçµ•å°å®šä½ */
}

/* ç¿»è­¯éµ */
.translateBtn {
  position:absolute;
  right:12px;
  top:12px;
  border:1px solid var(--line);
  background:var(--hover);
  border-radius:12px;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
}

</style>
</head>

<body class="nx">

<!-- =========================
=  HTMLï¼šé¦–é ï¼ˆHomeï¼‰       =
========================== -->
<section id="home" class="active">
  <div id="friendsHeader">
    <div class="me" onclick="openProfile()">
      <img id="avatar" src="https://picsum.photos/80?u=me">
      <div class="nick" id="nickHome">æš±ç¨±</div>
    </div>
  </div>
  <div id="storyBar" class="story-bar"></div>
  <div id="feedWrap" class="feed-col"></div>
</section>

<!-- è²¼æ–‡å¡ç‰‡ (ç¤¾ç¾¤é¦–é ç”¨) -->
<div class=".postCard img " onclick="openPostDetail(this)">
  <div class="postHeader">
    <img src="annie.jpg" class="avatar">
    <div class="meta">
      <b>ANNIE</b> <span class="verify">âœ”</span>
      <span class="time">3å°æ™‚å‰</span>
    </div>

    <!-- ç¿»è­¯éµä¹Ÿåœ¨å³ä¸Šè§’ -->
    <button class="translateBtn">ç¿»è­¯</button>
  </div>
  <div class="detailBody">
    <img src="annie_post.jpg" class="postImg">
    <p>last one just for my day onesâœ¨ğŸ°</p>
    <div class="postReactions">
      <button>ğŸ‘ <span>717</span></button>
      <button>ğŸ˜ <span>538</span></button>
      <button>ğŸ˜‚ <span>234</span></button>
      <button>ğŸ¼ <span>177</span></button>
      <button>ğŸ˜­ <span>110</span></button>
    </div>
  </div>
  <div class="commentBar">
    <span>å…¨éƒ¨ 314</span>
    <label><input type="checkbox"> åªçœ‹ADPçš„è©•è«–</label>
  </div>
  <div class="commentInput">
    <input type="text" placeholder="è«‹è¼¸å…¥è©•è«–">
    <button>â¤</button>
  </div>
</div>

<!-- =========================
=  HTMLï¼šè²¼æ–‡è©³æƒ…ï¼ˆç•™è¨€å€ï¼‰ =
========================== -->
<section id="postDetail">
  <div class="topbar">
    <button class="menu-btn" onclick="goBack()">â†</button>
    <h2 style="font-weight:900">ç•™è¨€å€</h2>
  </div>

  <!-- æ–‡ç« å…§å®¹ï¼ˆå«å³ä¸Šç¿»è­¯éµ & Reaction åˆ—ï¼‰ -->
  <div id="postDetailContent"></div>

  <!-- ç•™è¨€æ§åˆ¶åˆ—ï¼šå·¦å´ã€Œå…¨éƒ¨Nå‰‡ + åˆ·æ–°ã€ã€å³å´ã€Œåªçœ‹{è—äºº}å›è¦†ã€é–‹é—œ -->
  <div class="comments-head">
    <div class="comments-left">
      <div id="commentsCount" class="ghost">å…¨éƒ¨ 0 å‰‡</div>
      <div class="refresh-btn" title="é‡æ–°æ•´ç†" onclick="renderComments()">âŸ³</div>
    </div>
    <div style="display:flex; align-items:center; gap:8px">
      <div id="filterLabel" class="ghost">åªçœ‹ çš„å›è¦†</div>
      <label class="switch">
        <input id="filterArtistSwitch" type="checkbox" onchange="renderComments()">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <!-- ç•™è¨€åˆ—è¡¨ -->
  <div id="commentList"></div>

  <!-- è¼¸å…¥ -->
  <div class="comment-input">
    <input id="commentInput" placeholder="è¼¸å…¥è©•è«–â€¦" />
    <button onclick="sendComment()">é€å‡º</button>
  </div>
</section>

<!-- =========================
=  HTMLï¼šå€‹äººè³‡æ–™ï¼ˆè‡ªå·±/ä»–äººï¼‰
========================== -->
<section id="profile">
  <div class="topbar">
    <button class="menu-btn" onclick="goBack()">â†</button>
    <h2 style="font-weight:900">å€‹äººè³‡æ–™</h2>
  </div>

  <div id="profileHeader">
    <img id="profileBg" src="https://picsum.photos/1000/800?blur" alt="">
    <!-- å…©é¡†åœ“å½¢æŒ‰éˆ•ï¼šæ›é ­è²¼ / æ›èƒŒæ™¯ï¼ˆåªæœ‰è‡ªå·±å¯è¦‹ï¼‰ -->
    <div class="profile-actions onlyMe">
      <button class="round-btn" title="My photo settings" onclick="document.getElementById('avatarInput').click()">ğŸ“·</button>
      <button class="round-btn" title="Background settings" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸</button>
    </div>
    <div id="avatarWrap">
      <img id="editAvatar" src="https://picsum.photos/160?u=me" alt="" onclick="document.getElementById('avatarInput').click()">
      <input type="file" id="avatarInput" accept="image/*" class="onlyMe" style="display:none" onchange="changeAvatar(event)">
      <input type="file" id="bgInput"     accept="image/*" class="onlyMe" style="display:none" onchange="changeBg(event)">
    </div>
  </div>

  <div id="profileInfo">
    <div class="pitem">
      <div>
        <div class="label">Chat name</div>
        <div class="value" id="p_nickname">æš±ç¨±</div>
      </div>
      <button class="edit-btn onlyMe" onclick="editNickname()">âœï¸</button>
    </div>
    <div class="pitem">
      <div>
        <div class="label">Status message</div>
        <div class="value" id="p_status">å°šæœªè¨­å®š</div>
      </div>
      <button class="edit-btn onlyMe" onclick="editStatus()">âœï¸</button>
    </div>
    <div class="pitem">
      <div class="label">ç²‰çµ² ID</div>
      <div class="value" id="p_fanId">NEXT00000</div>
    </div>
    <div class="pitem">
      <div class="label">åŠ å…¥æ—¥æœŸ</div>
      <div class="value" id="p_joinDate">â€”</div>
    </div>
  </div>
</section>

<!-- ===== DM åˆ—è¡¨ ===== -->
<section id="dm">
  <div class="topbar">
    <button class="menu-btn" onclick="goBack()">â†</button>
    <h2>DM</h2>
  </div>

  <div id="dmListWrap"></div>
  <div id="dmEmpty" class="ghost" style="text-align:center;margin-top:30vh;display:none">
    å°šæœªèˆ‡ä»»ä½•è—äººé–‹å•ŸèŠå¤© â¤ï¸
  </div>
</section>

<!-- DM è©³æƒ…é  -->
<div id="dmDetail" class="page hidden">
  <div class="detailHeader">
    <button class="backBtn" onclick="goBackToDMList()">â†</button>
    <span class="title">DOHEE</span>
  </div>

  <!-- èŠå¤©å…§å®¹ -->
  <div class="dmThread" id="dmThread">
    <div class="msg left">
      å—¨ï½
    </div>
    <div class="msg right">
      å“ˆå›‰ï¼æœ€è¿‘å¥½å—ï¼Ÿ
      <span class="readStatus">1</span>
    </div>
    <div class="msg left">
      æˆ‘å‰›å‚³äº†ä¸€å¼µè‡ªæ‹ ğŸ“¸
    </div>
  </div>

  <!-- è¼¸å…¥æ¡† -->
  <div class="dmInputBar">
    <input type="text" id="dmMessageInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦" />
    <button id="dmSendBtn">â¤</button>
  </div>
</div>

<!-- ===== GALLERY ===== -->
<section id="gallery">
  <div class="topbar"><h2>ç›¸ç°¿</h2></div>
  <div id="galleryGrid"></div>
</section>

<!-- ===== LIVE LIST ===== -->
<section id="liveList">
  <div class="topbar"><h2>ç›´æ’­åˆ—è¡¨</h2><button onclick="toggleLiveSort()">æ’åº</button></div>
  <div id="liveListWrap"></div>
</section>

<!-- ===== LIVE DETAIL ===== -->
<section id="liveDetail">
  <div class="topbar"><button class="menu-btn" onclick="showPage('liveList')">â†</button><h2 id="liveTitle">ç›´æ’­ä¸­</h2></div>
  <div id="hostInfo" class="host-card"></div>
  <div id="fanMessages"></div>
  <div id="fanInput"><input id="fanMsgInput" placeholder="è¼¸å…¥ç•™è¨€â€¦"><button onclick="sendFanMsg()">é€å‡º</button></div>
</section>

<!-- ===== WALLET ===== -->
<section id="wallet">
  <div class="topbar"><h2>éŒ¢åŒ…</h2></div>
  <div class="panel soft">
    <p>ç›®å‰é»æ•¸ï¼š<b id="points2">0</b></p>
    <button onclick="buyNexx()">è³¼è²· NEXX</button>
  </div>
</section>

<!-- =========================
=  HTMLï¼šåº•éƒ¨ NAV           =
========================== -->
<nav id="nav">
  <button onclick="showPage('home')">é¦–é </button>
  <button onclick="showPage('dm')">DM</button>
  <button onclick="showPage('liveList')">ç›´æ’­</button>
  <button onclick="showPage('wallet')">éŒ¢åŒ…</button>
</nav>

<!-- =========================
=  JSï¼šè³‡æ–™ã€å·¥å…·ã€åŠŸèƒ½å€   =
========================== -->
<script>
/* -------------------------------------
 *  JSï¼šå¸¸æ•¸èˆ‡å‡è³‡æ–™ï¼ˆFeed + Storyï¼‰
 * -----------------------------------*/
const ARTISTS = [
  {id:'annie',  name:'Annie',   avatar:'https://picsum.photos/60?u=an'},
  {id:'dohee',  name:'Dohee',   avatar:'https://picsum.photos/60?u=dh'},
  {id:'woo',    name:'Woochan', avatar:'https://picsum.photos/60?u=wc'},
  {id:'group',  name:'ALLDAY PROJECT', avatar:'https://picsum.photos/60?u=group'}
];

const POSTS = [
  { id:'p1', artistId:'woo',   artistName:'Woochan', avatar:'https://picsum.photos/60?u=wc', text:'ä»Šå¤©åƒæ‹‰éºµ ğŸœ', img:'https://picsum.photos/1000?u=wc1', ts:'13å°æ™‚å‰' },
  { id:'p2', artistId:'dohee', artistName:'Dohee',   avatar:'https://picsum.photos/60?u=dh', text:'ç·´èˆç·´åˆ°çˆ†æ±— ğŸ’ƒ', img:'https://picsum.photos/1000?u=dh1', ts:'10å°æ™‚å‰' },
  { id:'p3', artistId:'annie', artistName:'Annie',   avatar:'https://picsum.photos/60?u=an', text:'å‚³äº†ä¸€å¼µè‡ªæ‹ ğŸ“¸', img:'https://picsum.photos/1000?u=an1', ts:'8å°æ™‚å‰' }
];

const STORY_USERS = [
  {id:'all', name:'ALL', avatar:'https://picsum.photos/60?u=all'},
  ...ARTISTS
];

/* -------------------------------------
 *  JSï¼šReaction è¨­å®š
 * -----------------------------------*/
const REACTION_TYPES = [
  {key:'clap', icon:'ğŸ‘'},
  {key:'heart', icon:'ğŸ˜'},
  {key:'laugh', icon:'ğŸ¤£'},
  {key:'panda', icon:'ğŸ¼'},
  {key:'tears', icon:'ğŸ¥²'},
  {key:'cheer', icon:'ğŸ¥³'}
];
function getReactions(postId){
  return JSON.parse(localStorage.getItem(`reactions:${postId}`) || '{}');
}
function setReactions(postId, data){
  localStorage.setItem(`reactions:${postId}`, JSON.stringify(data));
}
function getMyReactions(postId){
  return JSON.parse(localStorage.getItem(`myReacts:${postId}`) || '{}');
}
function setMyReactions(postId, data){
  localStorage.setItem(`myReacts:${postId}`, JSON.stringify(data));
}

/* -------------------------------------
 *  JSï¼šProfileï¼ˆèº«åˆ†ã€ä¸Šå‚³ï¼‰
 * -----------------------------------*/
function ensureMyIdentity(){
  if(!localStorage.getItem('fanId')){
    const id = 'NEXT' + Math.floor(10000 + Math.random()*90000);
    localStorage.setItem('fanId', id);
  }
  if(!localStorage.getItem('joinDate')){
    localStorage.setItem('joinDate', new Date().toLocaleDateString());
  }
}
function openProfile(){
  ensureMyIdentity();
  showFanProfile({
    fanId: localStorage.getItem('fanId'),
    joinDate: localStorage.getItem('joinDate'),
    nickname: localStorage.getItem('nickname') || 'æš±ç¨±',
    status:   localStorage.getItem('statusMsg') || 'å°šæœªè¨­å®š',
    avatar:   localStorage.getItem('avatar') || 'https://picsum.photos/160?u=me',
    bg:       localStorage.getItem('profileBg') || 'https://picsum.photos/1000/800?blur',
    isMe:     true
  });
}
function showFanProfile(fan){
  showPage('profile');
  document.getElementById('profileBg').src = fan.bg;
  document.getElementById('editAvatar').src = fan.avatar;
  document.getElementById('p_nickname').textContent = fan.nickname;
  document.getElementById('p_status').textContent   = fan.status;
  document.getElementById('p_fanId').textContent    = fan.fanId;
  document.getElementById('p_joinDate').textContent = fan.joinDate;
  document.querySelectorAll('.onlyMe').forEach(el=>{
    el.style.display = fan.isMe ? '' : 'none';
  });
}
function compressImage(file, maxSize = 600, callback){
  const img = new Image();
  const reader = new FileReader();
  reader.onload = e=>{
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if(w > h){
        if(w > maxSize){ h *= maxSize / w; w = maxSize; }
      }else{
        if(h > maxSize){ w *= maxSize / h; h = maxSize; }
      }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>{
        callback(URL.createObjectURL(blob));
      }, 'image/jpeg', 0.85);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
function changeAvatar(e){
  const f = e.target.files[0];
  if(f){
    compressImage(f, 600, u=>{
      document.getElementById('editAvatar').src = u;
      localStorage.setItem('avatar', u);
    });
  }
}
function changeBg(e){
  const f = e.target.files[0];
  if(f){
    compressImage(f, 1200, u=>{
      document.getElementById('profileBg').src = u;
      localStorage.setItem('profileBg', u);
    });
  }
}
function editNickname(){
  const current = localStorage.getItem('nickname') || 'æš±ç¨±';
  const n = prompt('è¼¸å…¥æ–°æš±ç¨±', current);
  if(n){
    localStorage.setItem('nickname', n);
    document.getElementById('nickHome').textContent = n;
    document.getElementById('p_nickname').textContent = n;
  }
}

/* -------------------------------------
 *  JSï¼šFeed èˆ‡ Story
 * -----------------------------------*/
function renderStoryBar(){
  const bar = document.getElementById('storyBar');
  bar.innerHTML = STORY_USERS.map(u=>`
    <div class="story-item" onclick="renderFeed('${u.id}')">
      <img class="story-avatar" src="${u.avatar}">
      <div class="story-name">${u.name}</div>
    </div>
  `).join('');
}
function renderFeed(filter='all'){
  const wrap = document.getElementById('feedWrap');
  let list = POSTS;
  if (filter!=='all') {
    list = POSTS.filter(p => p.artistId === filter);
  }
  wrap.innerHTML = list.map(p=>`
<div class="card soft postCard" onclick="openPost('${p.id}')">
      <div class="row">
        <img src="${p.avatar}" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
        <div><b>${p.artistName}</b><br><small class="ghost">${p.ts}</small></div>
        <div class="translate-chip" onclick="event.stopPropagation(); toggleTranslate('${p.id}')">ç¿»è­¯</div>
      </div>
      <p id="postText-${p.id}" style="margin-top:8px">${p.text}</p>
      ${p.img ? `<img class="hero" src="${p.img}">` : ''}
      ${renderReactionsBar(p.id)}
      <div style="margin-top:10px"><button class="menu-btn" onclick="openPost('${p.id}')">æ‰“é–‹ç•™è¨€</button></div>
    </div>
  `).join('');
}
const _translateState = {};
function toggleTranslate(postId){
  const pEl = document.getElementById(`postText-${postId}`);
  if(!pEl) return;
  _translateState[postId] = !_translateState[postId];
  if(_translateState[postId]){
    pEl.dataset.origin = pEl.textContent;
    pEl.textContent = `ï¼ˆå·²ç¿»è­¯ï¼‰${pEl.dataset.origin} [ä¸­æ–‡ç¿»è­¯ç‰ˆ]`;
  }else{
    pEl.textContent = pEl.dataset.origin || pEl.textContent;
  }
}

// === Reaction Bar æ¸²æŸ“ ===
function renderReactionsBar(postId){
  const data = getReactions(postId);
  const myData = getMyReactions(postId);
  return `<div class="reactions" id="reactions-${postId}">
    ${REACTION_TYPES.map(r=>{
      const cnt = data[r.key] || 0;
      const active = myData[r.key] ? 'active' : '';
      // ğŸŸ¢ æ•¸å­—åªæœ‰ >0 æ‰é¡¯ç¤º
      const countHtml = cnt > 0 
        ? `<span class="count" id="rc-${postId}-${r.key}">${cnt}</span>` 
        : `<span class="count" id="rc-${postId}-${r.key}"></span>`;
      return `<div class="reaction ${active}" onclick="toggleReaction('${postId}','${r.key}')">
        <span>${r.icon}</span>${countHtml}
      </div>`;
    }).join('')}
  </div>`;
}
function toggleReaction(postId, type) {
  let data = getReactions(postId);
  let myData = getMyReactions(postId);

  if (myData[type]) {
    delete myData[type];
    data[type] = Math.max((data[type]||0)-1, 0);
  } else {
    // æ¸…æ‰èˆŠçš„
    for (let k in myData) {
      if (myData[k]) {
        data[k] = Math.max((data[k]||0)-1, 0);
      }
    }
    myData = {};
    myData[type] = true;
    data[type] = (data[type]||0)+1;
  }

  setMyReactions(postId, myData);
  setReactions(postId, data);

  document.getElementById(`reactions-${postId}`).outerHTML = renderReactionsBar(postId);
}

/* -------------------------------------
 *  JSï¼šç•™è¨€
 * -----------------------------------*/
let CURRENT_POST_ID = null;
let CURRENT_ARTIST_NAME = '';
function seedCommentsIfEmpty(postId){
  const k = `comments:${postId}`;
  if(!localStorage.getItem(k)){
    let defaults = [];
    if(postId==='p1'){
      defaults = [
        {id:1, name:'ç²‰çµ²A', avatar:'https://picsum.photos/40?u=f1', isArtist:false, text:'å¥½å¥½åƒçš„æ¨£å­ï¼'},
        {id:2, name:'Woochan', avatar:'https://picsum.photos/40?u=wc', isArtist:true,  text:'çœŸçš„è¶…å¥½åƒ ğŸ˜‹'}
      ];
    }else if(postId==='p2'){
      defaults = [
        {id:1, name:'ç²‰çµ²C', avatar:'https://picsum.photos/40?u=f3', isArtist:false, text:'åŠªåŠ›çš„æ¨£å­æœ€ç¾ï¼'},
        {id:2, name:'Dohee', avatar:'https://picsum.photos/40?u=dh', isArtist:true,  text:'è¬è¬å¤§å®¶ ğŸ’–'},
      ];
    }else{
      defaults = [
        {id:1, name:'ç²‰çµ²D', avatar:'https://picsum.photos/40?u=f4', isArtist:false, text:'è‡ªæ‹å¥½æ¼‚äº®ï¼'},
        {id:2, name:'Annie', avatar:'https://picsum.photos/40?u=an', isArtist:true,  text:'è¬è¬ä½ å€‘ ğŸ¥°'}
      ];
    }
    localStorage.setItem(k, JSON.stringify(defaults));
  }
}
function getComments(postId){
  seedCommentsIfEmpty(postId);
  return JSON.parse(localStorage.getItem(`comments:${postId}`) || '[]');
}
function setComments(postId, list){
  localStorage.setItem(`comments:${postId}`, JSON.stringify(list));
}

function openPost(postId){
  const post = POSTS.find(p=>p.id===postId);
  if(!post) return;
  CURRENT_POST_ID = postId;
  CURRENT_ARTIST_NAME = post.artistName;

  // ğŸŸ¢ æ›´æ–° filterLabel
  document.getElementById('filterLabel').textContent = `åªçœ‹ ${post.artistName} çš„å›è¦†`;

  const content = `
  <div class="card soft postCard" onclick="openPost('${post.id}')">
      <div class="row">
        <img src="${post.avatar}" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
        <div><b>${post.artistName}</b><br><small class="ghost">${post.ts}</small></div>
        <div class="translate-chip" onclick="toggleTranslate('${post.id}')">ç¿»è­¯</div>
      </div>
      <p id="postText-${post.id}" style="margin-top:8px">${post.text}</p>
      ${post.img ? `<img class="hero" src="${post.img}">` : ''}
      ${renderReactionsBar(post.id)}
    </div>
  `;
  document.getElementById('postDetailContent').innerHTML = content;
  renderComments();
  showPage('postDetail');
}

function renderComments() {
  if(!CURRENT_POST_ID) return;
  const wrap = document.getElementById("commentList");
  wrap.innerHTML = "";
  const onlyArtist = document.getElementById("filterArtistSwitch").checked;

  const comments = getComments(CURRENT_POST_ID);
  document.getElementById("commentsCount").textContent = `å…¨éƒ¨ ${comments.length} å‰‡`;

  comments.forEach(c => {
    if(onlyArtist && !c.isArtist) return;
    const div = document.createElement("div");
    div.className = "citem" + (c.isArtist ? " artist" : "");
    div.innerHTML = `
      <div class="u"><img src="${c.avatar}"><b class="name">${c.name}</b></div>
      <p>${c.text}</p>
    `;
    wrap.appendChild(div);
  });
}
function sendComment(){
  if(!CURRENT_POST_ID) return;
  const inp = document.getElementById('commentInput');
  const t = (inp.value||'').trim();
  if(!t) return;
  const meName = localStorage.getItem('nickname') || 'æˆ‘';
  const meAvatar = localStorage.getItem('avatar') || 'https://picsum.photos/40?u=me';
  const list = getComments(CURRENT_POST_ID);
  list.push({id: Date.now(), name: meName, avatar: meAvatar, isArtist: false, text: t});
  setComments(CURRENT_POST_ID, list);
  inp.value='';
  renderComments();
}

/* -------------------------------------
 *  JSï¼šåˆ‡é 
 * -----------------------------------*/

let pageStack = [];

function showPage(id){
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(pageStack[pageStack.length-1] !== id){
    pageStack.push(id);
  }
}

function goBack(){
  if(pageStack.length > 1){
    pageStack.pop();
    const prev = pageStack[pageStack.length-1];
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById(prev).classList.add("active");
  }
}

/* -------------------------------------
 *  JSï¼šDM æ¨¡çµ„
 * -----------------------------------*/
let currentChat = null;
let dmMessages = {};

// å‡ç¿»è­¯è³‡æ–™ï¼ˆé¿å…å ±éŒ¯ï¼Œå¯å¾ŒçºŒè£œå……ï¼‰
const FAKE_DM_TRANSLATIONS = {};

// å‡è³‡æ–™ï¼šDM è—äººåˆ—è¡¨
const DM_ARTISTS = [
  {id:'dohee',   name:'Dohee',   avatar:'https://picsum.photos/50?1', subscribed:true,  days:120, lastMsg:'é‚„æƒ³å†èŠä¸€ä¸‹ ğŸ¥º', unread:2},
  {id:'woo',     name:'Woochan', avatar:'https://picsum.photos/50?2', subscribed:false, days:0,   lastMsg:'ï¼ˆç„¡è¨Šæ¯ï¼‰', unread:0},
  {id:'annie',   name:'Annie',   avatar:'https://picsum.photos/50?3', subscribed:true,  days:45,  lastMsg:'å‰›å‰›å‚³äº†è‡ªæ‹ï¼Œä½ æœ‰çœ‹åˆ°å—ï¼Ÿ', unread:1}
];

function getDmTranslateState(msgId){ 
  return localStorage.getItem(`dmTranslate:${msgId}`) === 'true'; 
}
function setDmTranslateState(msgId, state){ 
  localStorage.setItem(`dmTranslate:${msgId}`, state); 
}

function renderDMList(){
  const wrap = document.getElementById('dmListWrap');
  const empty = document.getElementById('dmEmpty');
  const subscribed = DM_ARTISTS.filter(a=>a.subscribed);

  if(subscribed.length === 0){
    wrap.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  wrap.innerHTML = subscribed.map(a=>`
    <div class="dmCard" onclick="openDm('${a.id}')">
      <img src="${a.avatar}">
      <div class="dmMeta">
        <b>${a.name}</b>
        <small class="ghost">${a.lastMsg || ''}</small>
      </div>
      <div class="dmRight">
        <span class="days">â¤ï¸ ${a.days}</span>
        ${a.unread > 0 ? `<span class="dmUnread">${a.unread}</span>` : ''}
      </div>
    </div>
  `).join('');
}

function openDm(chatId){
  currentChat = chatId;
  const artist = DM_ARTISTS.find(a=>a.id===chatId);
  if(!artist) return;

  document.getElementById('dmTitle').textContent = artist.name;
  artist.unread = 0; // æ¸…é™¤æœªè®€
  renderDMList();
  showPage('dmDetail');
  renderDm(chatId);
}

function renderDm(chatId){
  const box = document.getElementById('dmBox');
  const list = dmMessages[chatId] || [];
  box.innerHTML = list.map(m=>{
    const translated = getDmTranslateState(m.id);
    const text = translated ? (FAKE_DM_TRANSLATIONS[m.id] || `ï¼ˆç¿»è­¯ï¼‰${m.text}`) : m.text;
    return `
      <div class="dmMsg ${m.from}">
        <div class="bubble">
          <p id="dmText-${m.id}">${text}</p>
          <div class="translate-chip" onclick="toggleDmTranslate('${m.id}','${m.text}')">ç¿»è­¯</div>
        </div>
      </div>
    `;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

function toggleDmTranslate(msgId, origin){
  const el = document.getElementById(`dmText-${msgId}`);
  if(!el) return;
  const newState = !getDmTranslateState(msgId);
  setDmTranslateState(msgId, newState);
  if(newState){
    el.dataset.origin = origin;
    el.textContent = FAKE_DM_TRANSLATIONS[msgId] || `ï¼ˆç¿»è­¯ï¼‰${origin}`;
  }else{
    el.textContent = el.dataset.origin || el.textContent;
  }
}

// é€å‡º DM è¨Šæ¯ï¼ˆæ–°ç‰ˆç”¨æ³•ï¼‰
document.getElementById('dmSendBtn').addEventListener('click', () => {
  const input = document.getElementById('dmMessageInput');
  const message = input.value.trim();
  if (!message) return;

  // æ–°å¢ä¸€å‰‡å³é‚Šè¨Šæ¯ï¼ˆå«æœªè®€ç‹€æ…‹ï¼‰
  const thread = document.getElementById('dmThread');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg right';
  msgDiv.innerHTML = `${message}<span class="readStatus">1</span>`;
  thread.appendChild(msgDiv);

  // æ¸…ç©ºè¼¸å…¥æ¡†
  input.value = '';

  // è‡ªå‹•æ»¾åˆ°æœ€åº•
  thread.scrollTop = thread.scrollHeight;
});

/* -------------------------------------
 *  JSï¼šè³¼è²· NEXX
 * -----------------------------------*/
function buyNexx(){
  alert("é€™è£¡æœƒå°åˆ° NEXX è³¼è²·æµç¨‹ï¼");
}

/* -------------------------------------
 *  JSï¼šåˆå§‹åŒ–
 * -----------------------------------*/
document.addEventListener('DOMContentLoaded', ()=>{
  ensureMyIdentity();
  const a = localStorage.getItem('avatar'); 
  if(a) document.getElementById('avatar').src = a;
  const n = localStorage.getItem('nickname') || 'æš±ç¨±';
  document.getElementById('nickHome').textContent = n;
  renderStoryBar();
  renderFeed();
  renderDMList();
  showPage('home');
});
</script>
</body>
</html>
