<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NEXT’S YOU — Fan App (單頁版)</title>

  <style>
    /* ---------- Theme ---------- */
    :root{
      --bg:#f5f7ff;
      --card:#fff;
      --text:#1a1a1a;
      --sub:#666;
      --line:#e6e8ef;
      --ghost:#9aa0b4;
      --accent:#6a5acd;     /* 藍紫 */
      --accent2:#836fff;
      --danger:#ff4d4f;
      --ok:#1abc9c;
      --hover:#eef1ff;
      --fan:#ffffff;
      --artist:#efe7ff;
      --radius:16px;
      --shadow:0 10px 35px rgba(26,26,26,.08);
    }

    /* ---------- Reset ---------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    img{display:block; max-width:100%}
    button{font:inherit}
    a{color:inherit; text-decoration:none}

    /* ---------- Utilities ---------- */
    .ghost{color:var(--ghost)}
    .sub{color:var(--sub)}
    .row{display:flex; align-items:center; gap:12px}
    .wrap{padding:12px}
    .hidden{display:none !important}
    .soft{padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--hover); border:1px solid var(--line); font-size:12px}
    .divider{height:1px; background:var(--line); margin:12px 0}

    /* ---------- Page & Nav ---------- */
    section.page{display:none; padding:12px 12px 88px}
    section.page.active{display:block; animation:fadeIn .24s ease}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    nav#nav{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--card); border-top:1px solid var(--line);
      display:flex; justify-content:space-around; padding:10px 8px 14px; gap:6px;
      backdrop-filter:saturate(140%) blur(10px);
      transition:transform .28s ease;
      z-index:40;
    }
    nav#nav.hidden{transform:translateY(120%)}
    nav#nav button{
      flex:1; border:none; background:transparent; padding:8px 0 6px; border-radius:12px; cursor:pointer;
      color:var(--sub); font-weight:800; font-size:13px;
    }
    nav#nav button.active{color:var(--accent); background:var(--hover); border:1px solid var(--line)}

    /* ---------- Home Header (Me bar) ---------- */
    #homeHeader{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 6px 8px}
    #homeHeader .me{display:flex; align-items:center; gap:10px}
    #homeHeader .me img{width:44px; height:44px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    #homeHeader .me .id{font-size:12px; color:var(--ghost)}
    #homeHeader .right{display:flex; align-items:center; gap:8px}

    /* --- Story bar 捲動收起 --- */
    #storyWrap{
      position:sticky; top:0; z-index:30;
      background:linear-gradient(180deg,rgba(245,247,255,.98),rgba(245,247,255,.92));
      backdrop-filter:blur(6px);
      transition:transform .24s ease;
    }
    #storyWrap.collapse{transform:translateY(-120%);}
    #storyBar{
      display:flex; gap:12px; overflow-x:auto; padding:10px 8px 12px; scroll-snap-type:x proximity;
      -webkit-overflow-scrolling:touch; border-bottom:1px solid var(--line);
      scrollbar-width:none;
    }
    #storyBar::-webkit-scrollbar{display:none}
    .story-item{flex:0 0 auto; width:64px; text-align:center; cursor:pointer; scroll-snap-align:center}
    .story-item img{width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid #cfcfe9;}
    .story-item .name{font-size:12px; margin-top:4px; color:#9aa1ad;}
    .story-item.active img{border-color:var(--accent); box-shadow:0 0 0 2px rgba(106,90,205,.18);}
    .story-item.active .name{color:var(--accent); font-weight:700;}
    .story-item.all img{border-color:#111}

    /* ---------- Feed / 貼文卡片 ---------- */
    .postCard{margin:12px 6px; cursor:pointer}
    .postCard .hdr{display:flex; align-items:center; gap:10px; position:relative}
    .postCard .avatar{width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    .postCard .meta b{font-weight:900}
    .postCard .meta small{display:block; color:var(--ghost)}
    .translate-btn{
      position:absolute; right:0; top:0; transform:translateY(2px);
      font-size:12px; border:1px solid var(--line); background:var(--hover); border-radius:12px; padding:4px 8px; cursor:pointer;
    }
    .postCard .body{margin-top:8px}
    .postCard .body p{margin:8px 0 0}
    .postCard .hero{width:100%; height:400px; object-fit:cover; border-radius:12px; border:1px solid var(--line)}

    /* ====== 新：Reaction Bar（縮小版） ====== */
    .reaction-bar{
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:8px; margin-top:10px
    }
    .reaction{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      height:36px; padding:6px 10px;
      border:1px solid var(--line); background:#f7f8ff; border-radius:12px;
      cursor:pointer; user-select:none; font-weight:800; font-size:13px;
    }
    .reaction .count{margin-left:auto; min-width:2.2em; text-align:right; font-size:12px; font-weight:800}
    .reaction.active{background:var(--accent); color:#fff; border-color:transparent}

    .postMeta{
      display:flex; align-items:center; justify-content:space-between;
      margin-top:10px; padding-top:8px; border-top:1px solid var(--line);
    }
    .c-bubble{display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line); border-radius:14px; padding:6px 10px; font-weight:800;}
    .comment-link{font-weight:900; color:var(--accent); text-decoration:none}
    
    /* ---------- Post Detail ---------- */
    #postDetail .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #postDetail .topbar .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .comments-head{display:flex; align-items:center; justify-content:space-between; margin:10px 0 12px}
    .switch{position:relative; width:46px; height:26px}
    .switch input{opacity:0; width:0; height:0}
    .slider{position:absolute; inset:0; background:#cfd3e1; border-radius:999px; transition:.2s}
    .slider:before{content:""; position:absolute; width:20px; height:20px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    .citem{border:1px solid var(--line); border-radius:12px; padding:10px; background:linear-gradient(180deg,var(--card),var(--hover)); margin-bottom:10px}
    .citem.artist{background:linear-gradient(180deg,#ece6ff,#f6f3ff); border-color:#c4b6ff}
    .citem .u{display:flex; align-items:center; gap:10px; margin-bottom:6px}
    .citem .u img{width:36px; height:36px; border-radius:50%; border:1px solid var(--line); object-fit:cover}
    .citem .name{font-weight:800}
    .citem .c-actions{display:flex; align-items:center; gap:8px; margin-top:6px}
    .comment-input{position:sticky; bottom:0; left:0; right:0; padding:12px; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px); border-top:1px solid var(--line); display:flex; gap:8px}
    .comment-input input{flex:1; border:1px solid var(--line); background:var(--hover); padding:12px 14px; border-radius:16px}
    .comment-input button{min-width:64px; border:none; border-radius:12px; background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; font-weight:900; cursor:pointer}

    /* ---------- DM List ---------- */
    #dm .dmCard{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border:1px solid var(--line); border-radius:14px; background:var(--card); margin:10px 0; cursor:pointer;
    }
    #dm .dmCard .left{display:flex; align-items:center; gap:12px}
    #dm .dmCard img{width:52px; height:52px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    #dm .dmCard .meta b{display:block}
    #dm .dmCard .meta small{color:var(--ghost)}
    #dm .dmRight{display:flex; align-items:center; gap:10px}
    .badge{background:#ff3b30; color:#fff; font-size:12px; padding:2px 7px; border-radius:999px; min-width:22px; text-align:center}
    .heartDays{color:var(--danger); font-weight:800}
    .heartDays::before{content:"❤️ ";}

/* ---------- DM Detail ---------- */
#dmDetail .topbar{display:flex;align-items:center;gap:10px;margin:2px 0 10px}
#dmDetail .back{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer}

/* 讓標題區上下堆疊：徽章在上、名字在下 */
#dmDetail .topbar .titleWrap{
  display:flex; flex-direction:column; align-items:flex-start;
  gap:4px; line-height:1.12;
}

/* ARTIST 徽章（紫藍白漸層、圓角膠囊） */
.artistTag{
  display:inline-flex; align-items:center; justify-content:center;
  padding:3px 8px;
  height:18px;
  border-radius:8px;
  font-size:10px; font-weight:900; letter-spacing:.7px;
  text-transform:uppercase;
  color:#2e2a6f;                           /* 深紫字色 */
  background: linear-gradient(90deg,       /* 紫→藍→白 */
              #cbb9ff 0%,
              #8fb4ff 62%,
              #ffffff 100%);
  border:1px solid #ded6ff;
  box-shadow: 0 2px 8px rgba(106,90,205,.20);
}
.dmThread{padding:8px 2px 8px;display:flex;flex-direction:column;gap:8px;height:calc(100vh - 180px);overflow-y:auto}

.dmInputBar{
  display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--line);
  position:sticky; bottom:0;
  background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95));
  backdrop-filter:blur(10px);
}
.dmInputBar input{flex:1;border:1px solid var(--line);padding:12px;border-radius:14px;background:var(--hover)}
.dmInputBar button{min-width:60px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border-radius:12px;font-weight:900;cursor:pointer}

.dmMsg{display:flex;flex-direction:column;max-width:78%;margin:6px 0}
.dmMsg.left{align-self:flex-start}
.dmMsg.right{align-self:flex-end}
.dmMsg .bubble{max-width:100%;padding:10px 12px;border-radius:14px}
.dmMsg.left .bubble{background:var(--artist)}
.dmMsg.right .bubble{background:var(--accent);color:#fff}
.bubble .orig{white-space:pre-wrap;}
.bubble .transDivider{height:1px;background:var(--line);margin:8px 0}
.bubble .tran{white-space:pre-wrap;font-weight:800}
.bubble .by{margin-top:2px;font-size:10px;color:var(--ghost)}

.dmRow{display:flex;align-items:flex-end;gap:8px}
.dmMsg.right .dmRow{flex-direction:row-reverse}
.dmTime{font-size:11px;color:var(--ghost)}

.dmSide{display:flex;flex-direction:column;align-items:flex-end;gap:4px;min-width:56px}
.dmSideRow{display:flex;align-items:center;gap:8px}
.read1{font-size:12px;color:var(--ghost);font-weight:900;line-height:1}
.trash{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;padding:0;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
.trash svg{width:14px;height:14px;opacity:.55}

/* 翻譯按鈕在氣泡內，樣式像截圖 */
.bubble .translate-in{
  display:inline-flex;            /* 讓按鈕自身是小膠囊 */
  align-items:center;
  gap:6px;
  margin-top:8px;
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #e3e6ef;
  background:#f1f3f6;
  color:#6f7a94;
  cursor:pointer;
  user-select:none;
}
.bubble .translate-in svg{ width:14px; height:14px; opacity:.7 }

    /* ---------- Live / Replay / Profile / MiniProfile ---------- */
    #liveList .group{margin:10px 0}
    .liveCard{display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--line); border-radius:14px; background:var(--card); margin:8px 0; cursor:pointer;}
    .liveCard img{width:100px; height:64px; border-radius:10px; object-fit:cover; border:1px solid var(--line)}
    .liveMeta b{display:block}
    .status{font-size:12px; color:var(--ghost)}
    .status.on{color:var(--ok)}
    .status.soon{color:#ff9800}
    .status.end{color:var(--ghost)}

    #liveRoom .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #liveRoom .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .liveThread{display:flex; flex-direction:column; gap:8px; height:calc(100vh - 180px); overflow-y:auto; padding:4px 2px}
    .liveMsg{max-width:72%; padding:10px 12px; border-radius:14px}
    .liveMsg.host{background:var(--artist); align-self:flex-start}
    .liveMsg.fan{background:var(--fan); align-self:flex-end}
    .liveMsg.welcome{background:#ffeaa7; align-self:center; font-size:12px}
    .liveInputBar{display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--line); position:sticky; bottom:0; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px)}
    .liveInputBar input{flex:1; border:1px solid var(--line); padding:12px; border-radius:14px; background:var(--hover)}
    .liveInputBar button{min-width:60px; border:none; background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border-radius:12px; font-weight:900; cursor:pointer}

    #liveReplay .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #liveReplay .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .replayThread{display:flex; flex-direction:column; gap:8px; height:calc(100vh - 200px); overflow-y:auto; padding:4px 2px}
    .replayMsg{max-width:72%; padding:10px 12px; border-radius:14px}
    .replayMsg.host{background:var(--artist); align-self:flex-start}
    .replayMsg.fan{background:var(--fan); align-self:flex-end}
    .replayCtrl{display:flex; align-items:center; gap:8px; padding:10px 0}

    #profileHeader{height:auto; border-radius:0; overflow:visible; background:none;}
    #profileHeader::after{display:none;}
    #profileBg{display:none;}
    .profile-actions{display:none;}
    #avatarWrap{position:static; transform:none; bottom:auto; text-align:center; margin:16px auto 4px;}
    #editAvatar{width:120px; height:120px; border-radius:50%; border:2px solid var(--line); object-fit:cover; cursor:pointer}
    #profileInfo{margin-top:12px; padding:12px; display:flex; flex-direction:column; gap:12px}
    .pitem{display:flex; align-items:center; justify-content:space-between; padding:14px; border:1px solid var(--line); background:var(--card); border-radius:14px}
    .pitem .label{color:var(--sub); font-size:13px}
    .pitem .value{font-weight:900}
    .edit-btn{border:none; background:transparent; cursor:pointer; font-size:14px; color:var(--accent)}

    #miniProfile{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:300px; max-width:86vw; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:14px; z-index:60; display:none;
    }
    #miniProfile .hdr{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    #miniProfile .hdr img{width:56px; height:56px; border-radius:50%; border:1px solid var(--line); object-fit:cover}
    #miniProfile .actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
    #miniProfile .actions button{border:none; background:var(--hover); border:1px solid var(--line); padding:8px 12px; border-radius:10px; cursor:pointer}

/* ==== Live：新版 Ongoing 卡片 & HUD（照抄你給的樣式感） ==== */

/* 隱藏 liveRoom 舊的 topbar，改用 HUD＋滑動返回 */
#liveRoom .topbar{ display:none }

/* Ongoing 大卡（清單頁用；之後有人開播才會出現） */
.liveHeroCard{
  position:relative;
  border:1px solid var(--line);
  border-radius:20px;
  overflow:hidden;
  background:#222;
  box-shadow:var(--shadow);
  min-height:180px;
}
.liveHeroCard .bg{
  position:absolute; inset:0;
  background-size:cover; background-position:center;
  filter:brightness(.92);
}
.liveHeroCard .grad{
  position:absolute; inset:0;
  background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35) 60%, rgba(0,0,0,.45));
}
.liveHeroCard .hud{
  position:absolute; inset:12px 12px auto 12px;
  display:flex; align-items:center; justify-content:space-between;
}
.liveTag{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:999px;
  background:#ff2e2e; color:#fff; font-weight:900; font-size:12px;
  box-shadow:0 6px 20px rgba(255,46,46,.25);
}
.liveTag::after{ content:"●"; font-size:10px }
@keyframes blink { 0%,55%{opacity:1} 56%,100%{opacity:.35} }
.liveTag{ animation:blink 1.1s infinite }

.hud .liveHearts{ 
  color:#fff; font-weight:900; font-size:12px;
  display:inline-flex; align-items:center; gap:6px;
  background:rgba(0,0,0,.25); padding:4px 10px; border-radius:999px;
}
.hud .liveHearts::before{ content:"♡" }

.liveHeroCard .meta{
  position:absolute; left:16px; bottom:14px; right:16px;
  color:#fff;
}
.liveHeroCard .meta b{ font-size:18px; letter-spacing:.2px }
.liveHeroCard .meta .title{ margin-top:6px; opacity:.92; font-weight:700 }

/* Live Room 頂部 HUD（LIVE 標＋右上角愛心數） */
.liveHUD{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 4px 6px;
  background:linear-gradient(180deg, rgba(245,247,255,.75), rgba(245,247,255,0));
}
.liveHUD .liveHearts{ font-weight:900; color:#333; }

/* 輸入列：新增愛心按鈕 */
.liveInputBar{ position:sticky; bottom:0 }
#liveHeartBtn{
  min-width:44px; height:44px; border-radius:12px; border:1px solid var(--line);
  background:linear-gradient(180deg,#ffb3d9,#ffc9f1);
  font-size:18px; cursor:pointer;
}
#liveHeartBtn:active{ transform:scale(.96) }

/* 點愛心動畫（由輸入列冒出） */
.liveInputBar{ position:sticky; }
.heartFloat{
  position:fixed; bottom:92px; right:86px;   /* 右下靠近按鈕 */
  font-size:18px; pointer-events:none; opacity:0; transform:translateY(10px);
  animation:floatUp 1.2s ease forwards;
}

/* 心心飛出（配合 JS 計算位置） */
.flying-heart{
  position:fixed;
  z-index:50;
  font-size:18px;
  pointer-events:none;
  animation:floatUp 1.2s ease forwards;
}
    
@keyframes floatUp{
  0%{ opacity:0; transform:translateY(10px) scale(.9) }
  10%{ opacity:1 }
  100%{ opacity:0; transform:translateY(-120px) scale(1.6) }
}

/* 直播結束畫面（圖四） */
.liveEndedScene{
  position:fixed; inset:0; z-index:20; background:#000;
  display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff;
}
.liveEndedScene img{ width:120px; height:120px; border-radius:50%; border:2px solid #fff; object-fit:cover }
.liveEndedScene .name{ margin-top:16px; font-weight:900; letter-spacing:.6px }
.liveEndedScene .text{ margin-top:8px; font-size:20px; font-weight:900 }
    
 /* 齒輪版 Verified 徽章（藍紫＋一咪咪白） */
.verified-badge{
  display:inline-block;
  width:18px; height:18px;         /* 想變大改這裡（以及 VB(size)） */
  margin-left:6px; vertical-align:middle;
}
.verified-badge svg{width:100%; height:100%; display:block}
.verified-badge .gear{
  stroke:#fff; stroke-width:.9;     /* 白色細描邊，背景上更清楚 */
  filter:drop-shadow(0 1px 2px rgba(0,0,0,.25));
}
.verified-badge .tick{
  fill:#fff;                        /* 勾勾顏色：白。如果要深藍，改成 #0a1b4f */
  filter:drop-shadow(0 1px 0 rgba(0,0,0,.18));
}

/* ===== Polish Pack: Tokens ===== */
:root{
  --accent-grad: linear-gradient(180deg,#7b7fff,#6a5acd);
  --accent-grad-2: linear-gradient(90deg,#8fb4ff,#7b6dff 60%,#ffffff);
  --surface: rgba(255,255,255,.82);
  --hair: rgba(26,26,26,.08);         /* 超淡邊框 */
  --shadow-1: 0 6px 22px rgba(26,26,26,.08);
  --shadow-2: 0 12px 44px rgba(26,26,26,.12);
  --radius-s: 10px; --radius-m: 14px; --radius-l: 20px; --radius-xl: 26px;
  --ease: cubic-bezier(.2,.7,.2,1);
}

/* 全局細節：更銳利的字、去藍色點擊高亮、統一 focus ring */
*{-webkit-tap-highlight-color:transparent}
:focus-visible{outline:2px solid #7b6dff44; outline-offset:2px; border-radius:12px}
button:active{transform:translateY(1px)}

/* ===== 玻璃化 App Bar / Bottom Nav ===== */
#storyWrap,
nav#nav{
  background: var(--surface);
  backdrop-filter: saturate(140%) blur(14px);
  border-color: var(--hair);
  box-shadow: var(--shadow-1);
}

/* ===== Story bar 強化：圓環＋邊緣漸隱＋未讀紅點 ===== */
#storyBar{ position:relative; mask-image: linear-gradient(to right, transparent 0, #000 24px, #000 calc(100% - 24px), transparent 100%) }
.story-item img{
  border:2px solid #dfe3ff; box-shadow:0 0 0 3px #fff inset;
  transition:transform .18s var(--ease), box-shadow .18s var(--ease);
}
.story-item.active img{ border-color:#7b6dff; box-shadow:0 0 0 3px #f0f1ff inset, 0 0 0 2px rgba(123,109,255,.20) }
.story-item.new::after{
  content:""; position:absolute; right:6px; top:2px; width:9px; height:9px;
  background:#ff4d4f; border:2px solid #fff; border-radius:50%;
}

/* ===== 卡片層次 ===== */
.card{border-color:var(--hair); box-shadow:var(--shadow-1); border-radius:var(--radius-l)}
.postCard .hero{border-radius:var(--radius-m)}
.translate-btn{background:rgba(123,109,255,.1)}

/* ===== 反應按鈕更像「按鈕」 ===== */
.reaction{
  background: rgba(123,109,255,.06);
  border-color: var(--hair);
  transition: transform .12s var(--ease), background .18s var(--ease);
}
.reaction:active{ transform: scale(.98) }
.reaction.active{
  background: var(--accent-grad); color:#fff; border-color:transparent; box-shadow:0 6px 18px rgba(123,109,255,.30)
}

/* ===== DM：玻璃泡泡＋群組頭更精緻 ===== */
.dmMsg .bubble{
  background: rgba(255,255,255,.80);
  backdrop-filter: blur(8px);
  border:1px solid var(--hair);
  border-radius: 18px;
}
.dmMsg.right .bubble{ background: var(--accent-grad); color:#fff; border-color:transparent }
.msgHeader b{ letter-spacing:.2px }
.artistTag{
  background:var(--accent-grad-2); color:#2e2a6f; border:1px solid #ded6ff;
}

/* 背景遮罩（粉絲/藝人都好看） */
#dmBgMask::after{
  background: linear-gradient(180deg,rgba(255,255,255,.70),rgba(255,255,255,.88));
}

/* ===== 骨架屏 / Shimmer ===== */
.skeleton{
  position:relative; overflow:hidden; background:#eef1ff;
}
.skeleton::after{
  content:""; position:absolute; inset:0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent);
  transform: translateX(-100%);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer{ 100%{ transform:translateX(100%) } }

/* ===== 小動效：出場淡入 ===== */
.fade-in{animation:fadeIn .24s var(--ease)}    
  </style>
</head>

<body class="nx">

  <!-- =============================== HOME =============================== -->
  <section id="home" class="page active">
    <div id="homeHeader">
      <div class="me" onclick="openProfile()">
        <img id="meAvatar" src="https://picsum.photos/80?u=me" onerror="imgFallback(this)">
        <div>
          <div id="meNickname" style="font-weight:900">暱稱</div>
          <div class="id" id="meFanId">NEXT-00000</div>
        </div>
      </div>
  </div> 

    <div id="storyWrap"><div id="storyBar"></div></div>
    <div id="feedWrap"></div>
  </section>

  <!-- ============================ POST DETAIL =========================== -->
  <section id="postDetail" class="page">
    <div class="topbar">
      <button class="back" onclick="goBack()">←</button>
      <b style="font-weight:900">留言區</b>
    </div>
    <div id="postDetailContent"></div>

    <div class="comments-head">
      <div class="row">
        <div id="commentsCount" class="ghost">全部 0 則</div>
        <div class="chip" style="cursor:pointer" onclick="renderComments()">⟳</div>
      </div>
      <div class="row">
        <div id="filterLabel" class="ghost">只看 的回覆</div>
        <label class="switch">
          <input id="filterArtistSwitch" type="checkbox" onchange="renderComments()" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div id="commentList"></div>

    <div class="comment-input">
      <input id="commentInput" placeholder="輸入評論…" />
      <button onclick="sendComment()">送出</button>
    </div>
  </section>

  <!-- ============================== DM LIST ============================ -->
  <section id="dm" class="page">
    <div class="row" style="justify-content:space-between; margin:2px 0 10px">
      <b style="font-weight:900">訊息</b>
    </div>
    <div id="dmListWrap"></div>
    <div id="dmEmpty" class="ghost" style="text-align:center; margin-top:30vh; display:none">
  還未添加任何好友<br>請去添加好友
</div>
  </section>

  <!-- ============================ DM DETAIL ============================ -->
  <section id="dmDetail" class="page">
    <div class="topbar">
      <button class="back" onclick="goBack()">←</button>
      <div class="titleWrap">
        <span class="artistTag">ARTIST</span>
        <b id="dmTitle">DOHEE</b>
      </div>
    </div>
    <div id="dmThread" class="dmThread"></div>
    <div class="dmInputBar">
      <input id="dmMessageInput" placeholder="輸入訊息…" />
      <button id="dmSendBtn">➤</button>
    </div>
  </section>

  <!-- ============================= LIVE LIST =========================== -->
  <section id="liveList" class="page">
    <div class="row" style="justify-content:space-between; margin:2px 0 10px">
      <b style="font-weight:900">直播</b>
    </div>

    <div class="group">
      <h3 class="sub">進行中</h3>
      <div id="liveOngoingList"></div>
    </div>
    <div class="group">
      <h3 class="sub">已結束</h3>
      <div id="liveEndedList"></div>
    </div>

<!-- 新增：直播空狀態（照 DM 的寫法） -->
<div id="liveEmpty" class="ghost" style="text-align:center; margin-top:30vh; display:none">
  還未有藝人開始直播<br>敬請期待
</div>
  </section>

  <!-- ============================== LIVE ROOM ========================== -->
  <section id="liveRoom" class="page">
    <div class="topbar">
      <button class="back" onclick="showPage('liveList')">←</button>
      <b id="liveTitle">直播中</b>
    </div>

<div class="liveHUD">
  <span class="liveTag">LIVE</span>
  <div class="liveHearts"> <span id="liveHeartCount">0</span> </div>
</div>
    
    <div class="row" style="gap:12px; margin-bottom:6px">
      <img id="liveHostAvatar" src="https://picsum.photos/60?u=host" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;border:1px solid var(--line);object-fit:cover">
      <div><b id="liveHostName">Host</b><br></div>
    </div>

    <div id="liveThread" class="liveThread"></div>

    <div class="liveInputBar">
  <input id="liveInput" placeholder="輸入留言…" />
  <button id="liveHeartBtn" type="button" >💗</button>
  <button onclick="sendLiveMsg()">&gt;</button>
</div>
  </section>

  <!-- ============================= LIVE REPLAY ========================= -->
  <section id="liveReplay" class="page">
    <div class="topbar">
      <button class="back" onclick="showPage('liveList')">←</button>
      <b>直播回放</b>
      <div class="row" style="margin-left:auto">
        <span class="ghost">速度</span>
        <select id="replaySpeed" onchange="changeReplaySpeed(this.value)">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1.0x</option>
          <option value="2">2.0x</option>
        </select>
      </div>
    </div>

    <div class="row" style="gap:12px; margin-bottom:6px">
      <img id="replayHostAvatar" src="https://picsum.photos/60?u=replay" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;border:1px solid var(--line);object-fit:cover">
      <div>
        <b id="replayHostName">Host</b><br>
        <small id="replayTitle" class="ghost">回放標題</small>
      </div>
    </div>

    <div id="replayThread" class="replayThread"></div>
  </section>

  <!-- ================================ STORE ============================ -->
  <section id="store" class="page">
    <div class="row" style="justify-content:space-between; margin:2px 0 10px">
      <b style="font-weight:900">商店</b>
    </div>

    <div class="card soft">
      <b>購買愛心（個人）</b>
      <div class="row" style="flex-wrap:wrap; margin-top:10px">
        <button class="chip" onclick="buyHeartsStore('annie',30,1000)">Annie 30天（1000點）</button>
        <button class="chip" onclick="buyHeartsStore('dohee',30,1000)">Dohee 30天（1000點）</button>
        <button class="chip" onclick="buyHeartsStore('woo',30,1000)">Woochan 30天（1000點）</button>
      </div>
    </div>

    <div class="card soft" style="margin-top:12px">
      <b>購買愛心（團體）</b>
      <div class="row" style="flex-wrap:wrap; margin-top:10px">
        <button class="chip" onclick="buyHeartsStore('group',30,2400)">ALLDAY 30天（2400點）</button>
      </div>
    </div>

    <div class="ghost" style="margin-top:12px">＊點數不足不會自動扣。需先由後台加值。</div>
  </section>

  <!-- =============================== PROFILE =========================== -->
  <section id="profile" class="page">
    <div class="topbar"><b style="font-weight:900">我的</b></div>

    <div id="profileHeader">
      <img id="profileBg" src="https://picsum.photos/1200/800?blur" onerror="imgFallback(this)">
      <div class="profile-actions"></div>
      <div id="avatarWrap">
        <img id="editAvatar" src="https://picsum.photos/160?u=me" onclick="document.getElementById('avatarInput').click()">
        <input type="file" id="avatarInput" accept="image/*" class="onlyMe hidden" onchange="changeAvatar(event)">
        <input type="file" id="bgInput" accept="image/*" class="onlyMe hidden" onchange="changeBg(event)">
      </div>
    </div>

    <div id="profileInfo">
      <div class="pitem">
        <div><div class="label">Chat name</div><div class="value" id="p_nickname">暱稱</div></div>
        <button class="edit-btn onlyMe" onclick="editNickname()">✏️</button>
      </div>

      <div class="pitem">
        <div><div class="label">Status message</div><div class="value" id="p_status">尚未設定</div></div>
        <button class="edit-btn onlyMe" onclick="editStatus()">✏️</button>
      </div>

      <div class="pitem"><div class="label">粉絲 ID</div><div class="value" id="p_fanId">NEXT-00000</div></div>
      <div class="pitem"><div class="label">加入日期</div><div class="value" id="p_joinDate">—</div></div>

      <div class="pitem">
        <div class="label">生日</div>
        <div class="value"><input type="date" id="birthdayInput" onchange="saveBirthday(this.value)"></div>
      </div>

      <div class="pitem"><div class="label">💜 我的愛心（剩餘天數）</div><div class="value"><span id="heartDays">0</span> 天</div></div>
      <div class="pitem"><div class="label">錢包餘額</div><div class="value"><span id="walletBalance">0</span> 點</div></div>
    </div>
  </section>

  <!-- ============================== MINI PROFILE ======================= -->
  <div id="miniProfile">
    <div class="hdr">
      <img id="mpAvatar" src="" onerror="imgFallback(this)">
      <div>
        <div id="mpName" style="font-weight:900">名稱</div>
        <div id="mpId" class="ghost" style="font-size:12px">NEXT-00000</div>
      </div>
    </div>
    <div id="mpBio" class="sub" style="font-size:13px">—</div>
    <div class="actions"><button onclick="closeMiniProfile()">關閉</button></div>
  </div>

  <!-- ============================== BOTTOM NAV ========================= -->
  <nav id="nav">
    <button id="tabHome" class="active" onclick="showPage('home')">首頁</button>
    <button id="tabDM" onclick="showPage('dm')">DM</button>
    <button id="tabLive" onclick="showPage('liveList')">直播</button>
    <button id="tabStore" onclick="showPage('store')">商店</button>
  </nav>

  <!-- ================================ SCRIPTS ========================== -->
  <script>
    /* 工具：fallback image */
    function imgFallback(img){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
      img.src = 'data:image/svg+xml;charset=UTF-8,' + svg;
      img.onerror = null;
    }

    
    /* 假資料 */
    const ARTISTS = [
      {id:'annie',  name:'Annie',   avatar:'https://picsum.photos/80?u=an'},
      {id:'dohee',  name:'Dohee',   avatar:'https://picsum.photos/80?u=dh'},
      {id:'woo',    name:'Woochan', avatar:'https://picsum.photos/80?u=wc'},
      {id:'group',  name:'ALLDAY PROJECT', avatar:'https://picsum.photos/80?u=group'}
    ];

    const POSTS = [
      { id:'p1', artistId:'woo',   artistName:'Woochan', avatar:'https://picsum.photos/80?u=wc', text:'今天吃拉麵 🍜', img:'https://picsum.photos/1200?u=wc1', ts:'13小時前' },
      { id:'p2', artistId:'dohee', artistName:'Dohee',   avatar:'https://picsum.photos/80?u=dh', text:'練舞練到爆汗 💃', img:'https://picsum.photos/1200?u=dh1', ts:'10小時前' },
      { id:'p3', artistId:'annie', artistName:'Annie',   avatar:'https://picsum.photos/80?u=an', text:'傳了一張自拍 📸', img:'https://picsum.photos/1200?u=an1', ts:'8小時前' }
    ];

    const REACTION_TYPES = [
      {key:'heart', icon:'💜'},
      {key:'clap',  icon:'👏'},
      {key:'laugh', icon:'🤣'},
      {key:'panda', icon:'🐼'},
      {key:'tear',  icon:'🥲'},
      {key:'cheer', icon:'🥳'}
    ];

    /* DM 假資料 */
    const DM_ARTISTS = [
      {id:'dohee',   name:'Dohee',   avatar:'https://picsum.photos/100?2', subscribed:true,  heartDays:120, lastMsg:'還想再聊一下 🥺', unread:2, lastTs:Date.now()-1000*60*4 },
      {id:'woo',     name:'Woochan', avatar:'https://picsum.photos/100?1', subscribed:false, heartDays:0,   lastMsg:'（無訊息）', unread:0, lastTs:Date.now()-1000*60*60 },
      {id:'annie',   name:'Annie',   avatar:'https://picsum.photos/100?3', subscribed:true,  heartDays:45,  lastMsg:'剛剛傳了自拍，你有看到嗎？', unread:1, lastTs:Date.now()-1000*60*2 }
    ];
    let dmMessages = {
      dohee: [
        {id:'d1', from:'left',  text:'嗨～粉絲你好！', ts:Date.now()-1000*60*60, translated:false, read:true},
        {id:'d2', from:'right', text:'哈囉！最近好嗎？', ts:Date.now()-1000*60*45, translated:false, read:false}
      ],
      woo: [{id:'w1', from:'left', text:'今天午餐吃什麼？', ts:Date.now()-1000*60*70, translated:false, read:true}],
      annie: [{id:'a1', from:'left', text:'我剛傳了一張自拍 📸', ts:Date.now()-1000*60*8, translated:false, read:true}]
    };

    /* LocalStorage Helpers */
    const LS = {
      get(k, def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
      set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
      getStr(k, def=''){ const v=localStorage.getItem(k); return v ?? def },
      setStr(k, v){ localStorage.setItem(k, v) }
    };

    /* Profile */
    function ensureMyIdentity(){
      if(!LS.getStr('fanId')){
        const id = 'NEXT-' + Math.floor(10000 + Math.random()*90000);
        LS.setStr('fanId', id);
      }
      if(!LS.getStr('joinDate')){
        LS.setStr('joinDate', new Date().toLocaleDateString());
      }
    }
    function openProfile(){ showPage('profile'); }
    function showMyBar(){
      document.getElementById('meNickname').textContent = LS.getStr('nickname','暱稱');
      document.getElementById('meFanId').textContent = LS.getStr('fanId','NEXT-00000');
      const a = LS.getStr('avatar'); if(a) document.getElementById('meAvatar').src = a;
    }
    function showFanProfile(){
      document.getElementById('p_nickname').textContent = LS.getStr('nickname','暱稱');
      document.getElementById('p_status').textContent   = LS.getStr('statusMsg','尚未設定');
      document.getElementById('p_fanId').textContent    = LS.getStr('fanId','NEXT-00000');
      document.getElementById('p_joinDate').textContent = LS.getStr('joinDate','—');
      const a = LS.getStr('avatar'); if(a) document.getElementById('editAvatar').src = a;
      const bg= LS.getStr('profileBg'); if(bg) document.getElementById('profileBg').src = bg;
      const bd = LS.getStr('birthday'); if(bd) document.getElementById('birthdayInput').value = bd;
      document.getElementById('walletBalance').textContent = LS.getStr('walletBalance','0');
      document.getElementById('heartDays').textContent = LS.getStr('heartDays','0');
    }
    function compressImage(file, maxSize = 900, callback){
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e=>{
        img.onload = ()=>{
          let w = img.width, h = img.height;
          if(w > h){ if(w > maxSize){ h *= maxSize / w; w = maxSize; } }
          else{ if(h > maxSize){ w *= maxSize / h; h = maxSize; } }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img,0,0,w,h);
          canvas.toBlob(b=>{ callback(URL.createObjectURL(b)); }, 'image/jpeg', 0.9);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    function changeAvatar(e){
      const f = e.target.files[0];
      if(f){
        compressImage(f, 900, u=>{
          document.getElementById('editAvatar').src = u;
          LS.setStr('avatar', u);
          document.getElementById('meAvatar').src = u;
        });
      }
    }
    function changeBg(e){
      const f = e.target.files[0];
      if(f){
        compressImage(f, 1400, u=>{
          document.getElementById('profileBg').src = u;
          LS.setStr('profileBg', u);
        });
      }
    }
    function editNickname(){
      const current = LS.getStr('nickname','暱稱');
      const n = prompt('輸入新暱稱', current);
      if(n){
        LS.setStr('nickname', n);
        document.getElementById('meNickname').textContent = n;
        document.getElementById('p_nickname').textContent = n;
      }
    }
    function editStatus(){
      const current = LS.getStr('statusMsg','尚未設定');
      const s = prompt('輸入狀態訊息', current);
      if(s!==null){
        LS.setStr('statusMsg', s);
        document.getElementById('p_status').textContent = s;
      }
    }
    function saveBirthday(val){ LS.setStr('birthday', val); checkBirthday(); }
    function checkBirthday(){
      const bd = LS.getStr('birthday'); if(!bd) return;
      const today = new Date();
      const [,mm,dd] = bd.split('-').map(Number);
      if( (today.getMonth()+1)===mm && today.getDate()===dd ){
        alert('🎉 生日快樂！祝你有美好的一天！');
      }
    }
    function buyHearts(days){
      let h = parseInt(LS.getStr('heartDays','0'),10);
      h += days;
      LS.setStr('heartDays', String(h));
      document.getElementById('heartDays').textContent = h;
      DM_ARTISTS.forEach(a=>{ if(a.subscribed) a.heartDays = h; });
      renderDMList();
      alert(`成功購買 ${days} 天 ♡`);
      renderDMList();
    }
    function chargeWallet(){
      let b = parseInt(LS.getStr('walletBalance','0'),10);
      b += 100;
      LS.setStr('walletBalance', String(b));
      document.getElementById('walletBalance').textContent = b;
    }

    /* Story Bar */
    let currentFilter = 'all';
    function buildStorySet(){
      const items = [{ id:'all', name:'ALL', avatar:'https://picsum.photos/60?u=all' }];
      ARTISTS.forEach(a=> items.push({ id:a.id, name:a.name, avatar:a.avatar }));
      const recent = {};
      POSTS.forEach((p,i)=>{ recent[p.artistId] = Date.now() - i; });
      const others = items.slice(1).sort((a,b)=>(recent[b.id]||0)-(recent[a.id]||0));
      return [items[0], ...others];
    }
    function renderStoryBar(){
      const bar = document.getElementById('storyBar');
      const data = buildStorySet();
      bar.innerHTML = data.map(u=>`
        <div class="story-item ${u.id==='all'?'all':''} ${u.id===currentFilter?'active':''}" data-id="${u.id}">
          <img src="${u.avatar}" onerror="imgFallback(this)">
          <div class="name">${u.name}</div>
        </div>
      `).join('');
      bar.querySelectorAll('.story-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          currentFilter = el.dataset.id;
          renderFeed(currentFilter);
          bar.querySelectorAll('.story-item').forEach(x=>x.classList.toggle('active', x===el));
          window.scrollTo({ top:0, behavior:'smooth' });
        });
      });
    }
    function rebuildStoryFromNewPost(newPost){ POSTS.unshift(newPost); renderStoryBar(); }

    /* ===== Reaction 狀態儲存 ===== */
    const _translateState = {};
    function getReactions(postId){ return LS.get(`reactions:${postId}`, {}); }
    function setReactions(postId, data){ LS.set(`reactions:${postId}`, data); }
    function getMyReactions(postId){ return LS.get(`myReacts:${postId}`, {}); }
    function setMyReactions(postId, data){ LS.set(`myReacts:${postId}`, data); }
    function formatCount(n){
      if(n>=1000000) return Math.round(n/100000)/10+'M';
      if(n>=1000) return Math.round(n/100)/10+'K';
      return String(n);
    }

    /* ===== Feed ===== */
    function renderFeed(filter='all'){
      const wrap = document.getElementById('feedWrap');
      let list = POSTS;
      if(filter!=='all'){ list = POSTS.filter(p=> p.artistId===filter); }
      wrap.innerHTML = list.map(p=>{
        const commentsCount = getComments(p.id).length;
        return `
          <div class="card soft postCard" onclick="onPostCardClick(event,'${p.id}')">
            <div class="hdr">
              <img src="${p.avatar}" class="avatar" onerror="imgFallback(this)">
              <div class="meta">
  <b>${escapeHtml(p.artistName)} ${VB()}</b>
  <small class="ghost">${p.ts}</small>
</div>
              <div class="translate-btn" onclick="event.stopPropagation(); togglePostTranslate('${p.id}')">翻譯</div>
            </div>
            <div class="body">
              <p id="postText-${p.id}">${escapeHtml(p.text)}</p>
              ${p.img ? `<img class="hero skeleton" src="${p.img}" onload="this.classList.remove('skeleton')" onerror="imgFallback(this)">` : ''}
              ${renderReactionsBar(p.id)}
              <div class="postMeta">
                <div class="c-bubble">💬 <span>${commentsCount}</span></div>
                <a class="comment-link" href="javascript:void(0)" onclick="event.stopPropagation(); openPost('${p.id}')">發表評論</a>
              </div>
            </div>
          </div>
        `;
      }).join('');
      restoreHomeScroll();
    }
    function onPostCardClick(e, postId){
      const path = e.composedPath ? e.composedPath(): [];
      if( path.some(el=> el && el.classList && (el.classList.contains('reaction') || el.classList.contains('translate-btn')) ) ){
        return;
      }
      openPost(postId);
    }

    function togglePostTranslate(postId){
      const el = document.getElementById(`postText-${postId}`);
      if(!el) return;
      _translateState[postId] = !_translateState[postId];
      if(_translateState[postId]){
        el.dataset.origin = el.textContent;
        el.textContent = `（已翻譯）${el.dataset.origin}`;
      }else{
        el.textContent = el.dataset.origin || el.textContent;
      }
      LS.setStr(`postTranslated:${postId}`, _translateState[postId] ? '1' : '0');
    }

    /* ===== Reaction Bar（無重複 id 版本） ===== */
    function renderReactionsBar(postId){
      const data = getReactions(postId);
      const myData = getMyReactions(postId);
      return `<div class="reaction-bar" data-react-for="${postId}">
        ${REACTION_TYPES.map(r=>{
          const cnt = data[r.key] || 0;
          const active = myData[r.key] ? 'active' : '';
          const countHtml = cnt>0 ? `<span class="count" data-react-count="${r.key}">${formatCount(cnt)}</span>` : `<span class="count" data-react-count="${r.key}"></span>`;
          return `<button type="button" class="reaction ${active}" onclick="toggleReaction('${postId}','${r.key}', event)">
            <span class="icon">${r.icon}</span>${countHtml}
          </button>`;
        }).join('')}
      </div>`;
    }

    function toggleReaction(postId, type, e){
      if(e && e.stopPropagation) e.stopPropagation();
      let data = getReactions(postId);
      let myData = getMyReactions(postId);

      if(myData[type]){
        delete myData[type];
        data[type] = Math.max((data[type]||0)-1, 0);
      }else{
        for(const k in myData){ if(myData[k]){ data[k] = Math.max((data[k]||0)-1, 0); } }
        myData = {};
        myData[type] = true;
        data[type] = (data[type]||0)+1;
      }
      setMyReactions(postId, myData);
      setReactions(postId, data);

      // 同步刷新：頁面上所有同貼文的 reaction-bar 都更新（避免詳情頁/首頁不同步）
      document.querySelectorAll(`.reaction-bar[data-react-for="${postId}"]`)
        .forEach(area => { area.outerHTML = renderReactionsBar(postId); });
    }

    /* ===== 留言（Post Detail） ===== */
    let CURRENT_POST_ID = null;
    let CURRENT_ARTIST_NAME = '';
    function seedCommentsIfEmpty(postId){
      const k = `comments:${postId}`;
      if(!localStorage.getItem(k)){
        let defaults = [];
        if(postId==='p1'){
          defaults = [
            {id:1, name:'粉絲A', avatar:'https://picsum.photos/40?u=f1', isArtist:false, text:'好好吃的樣子！', translated:false},
            {id:2, name:'Woochan', avatar:'https://picsum.photos/40?u=wc', isArtist:true,  text:'真的超好吃 😋', translated:false}
          ];
        }else if(postId==='p2'){
          defaults = [
            {id:1, name:'粉絲C', avatar:'https://picsum.photos/40?u=f3', isArtist:false, text:'努力的樣子最美！', translated:false},
            {id:2, name:'Dohee',  avatar:'https://picsum.photos/40?u=dh', isArtist:true,  text:'謝謝大家 💖', translated:false}
          ];
        }else{
          defaults = [
            {id:1, name:'粉絲D', avatar:'https://picsum.photos/40?u=f4', isArtist:false, text:'自拍好漂亮！', translated:false},
            {id:2, name:'Annie',  avatar:'https://picsum.photos/40?u=an', isArtist:true,  text:'謝謝你們 🥰', translated:false}
          ];
        }
        LS.set(k, defaults);
      }
    }
    function getComments(postId){ seedCommentsIfEmpty(postId); return LS.get(`comments:${postId}`, []); }
    function setComments(postId, list){ LS.set(`comments:${postId}`, list); }

    function openPost(postId){
      saveHomeScroll();
      const post = POSTS.find(p=>p.id===postId); if(!post) return;
      CURRENT_POST_ID = postId;
      CURRENT_ARTIST_NAME = post.artistName;

      const sw = document.getElementById('filterArtistSwitch'); if(sw) sw.checked = true;
      document.getElementById('filterLabel').textContent = `只看 ${post.artistName} 的回覆`;

      const content = `
        <div class="card soft postCard" onclick="void(0)">
          <div class="hdr">
            <img src="${post.avatar}" class="avatar" onerror="imgFallback(this)">
            <div class="meta">
  <b>${escapeHtml(post.artistName)} ${VB()}</b>
  <small class="ghost">${post.ts}</small>
</div>
            <div class="translate-btn" onclick="togglePostTranslate('${post.id}')">翻譯</div>
          </div>
          <div class="body">
            <p id="postText-${post.id}">${escapeHtml(post.text)}</p>
            ${post.img ? `<img class="hero skeleton" src="${post.img}" onload="this.classList.remove('skeleton')" onerror="imgFallback(this)">` : ''}
            ${renderReactionsBar(post.id)}
          </div>
        </div>
      `;
      document.getElementById('postDetailContent').innerHTML = content;
      renderComments();
      showPage('postDetail');
    }

    function renderComments(){
      if(!CURRENT_POST_ID) return;
      const wrap = document.getElementById('commentList'); wrap.innerHTML = '';
      const onlyArtist = document.getElementById('filterArtistSwitch').checked;
      const list = getComments(CURRENT_POST_ID);
      document.getElementById('commentsCount').textContent = `全部 ${list.length} 則`;

      list.forEach(c=>{
        if(onlyArtist && c.name !== CURRENT_ARTIST_NAME) return;
        const item = document.createElement('div');
        item.className = 'citem'+(c.isArtist?' artist':'');
        item.innerHTML = `
          <div class="u">
            <img src="${c.avatar}" onerror="imgFallback(this)" onclick="openMiniProfile('${c.name}','${c.avatar}')">
            <b class="name">
  ${escapeHtml(c.name)} ${c.isArtist ? VB(16) : ''}
</b>
          </div>
          <p id="cText-${c.id}">${escapeHtml(c.text)}</p>
          <div class="c-actions">
            <div class="chip" onclick="toggleCommentTranslate('${c.id}')">翻譯</div>
          </div>
        `;
        wrap.appendChild(item);
      });
    }
    function toggleCommentTranslate(cid){
      const k = `cTranslated:${CURRENT_POST_ID}:${cid}`;
      const translated = LS.getStr(k,'0')==='1';
      const el = document.getElementById(`cText-${cid}`); if(!el) return;
      if(translated){ el.textContent = el.textContent.replace(/^（翻譯）/,''); LS.setStr(k,'0'); }
      else{ el.textContent = `（翻譯）${el.textContent}`; LS.setStr(k,'1'); }
    }
    function sendComment(){
      if(!CURRENT_POST_ID) return;
      const inp = document.getElementById('commentInput');
      const t = (inp.value||'').trim(); if(!t) return;
      const meName = LS.getStr('nickname','我');
      const meAvatar = LS.getStr('avatar','https://picsum.photos/40?u=me');
      const list = getComments(CURRENT_POST_ID);
      list.push({id: Date.now(), name: meName, avatar: meAvatar, isArtist:false, text:t, translated:false});
      setComments(CURRENT_POST_ID, list);
      inp.value=''; renderComments();
    }

    /* ===== DM ===== */
    let currentChat = null;
    function renderDMList(){
  const wrap  = document.getElementById('dmListWrap');
  const empty = document.getElementById('dmEmpty');

  // 依錢包天數重算當前的「是否已購買」
  const artistsNow = DM_ARTISTS.map(a => ({
  ...a,
  subscribed: isSubscribed(a.id),
  heartDays: getDaysFor(a.id)
}));

  // 只留已購買的
  const visible = artistsNow.filter(a => a.subscribed);

  // 如果沒有任何好友（=未購買）
  if(visible.length === 0){
    wrap.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  // 排序＋顯示
  const withTs = visible.map(a=>{
    const msgs = dmMessages[a.id] || [];
    const last = msgs.length ? msgs[msgs.length-1] : null;
    return { ...a, lastTs: last ? (last.ts || 0) : (a.lastTs || 0), _lastMsgText: last ? last.text : (a.lastMsg || '') };
  }).sort((a,b)=> b.lastTs - a.lastTs);

  wrap.innerHTML = withTs.map(a=>`
    <div class="dmCard" onclick="openDm('${a.id}')">
      <div class="left">
        <img src="${a.avatar}" onerror="imgFallback(this)">
        <div class="meta">
          <b>${a.name}</b>
          <small class="ghost">${escapeHtml(a._lastMsgText || '')}</small>
        </div>
      </div>
      <div class="dmRight">
        <span class="heartDays">${a.heartDays || 0}</span>
        ${a.unread>0 ? `<span class="badge">${a.unread}</span>` : ''}
      </div>
    </div>
  `).join('');
}
    function openDm(chatId){
      if(!isSubscribed(chatId)){ alert('尚未添加好友'); return; }
      currentChat = chatId;
      const artist = DM_ARTISTS.find(a=>a.id===chatId); if(!artist) return;
      document.getElementById('dmTitle').textContent = artist.name;
      artist.unread = 0;
      markSeenByLatestLeft(chatId);
      renderDMList();
      renderDmThread(chatId);
      showPage('dmDetail');
      setTimeout(()=> document.getElementById('dmMessageInput')?.focus(), 50);
    }
    function markSeenByLatestLeft(chatId){
      const arr = dmMessages[chatId] || [];
      let lastLeftTs = 0;
      for(let i=arr.length-1;i>=0;i--){ if(arr[i].from==='left'){ lastLeftTs = arr[i].ts||0; break; } }
      arr.forEach(m=>{ if(m.from==='right' && (m.ts||0)<=lastLeftTs){ m.read = true; } });
    }
    function renderDmThread(chatId){
  const box = document.getElementById('dmThread');
  box.innerHTML = '';
  markSeenByLatestLeft(chatId);
  const list = dmMessages[chatId] || [];
  const start = Math.max(0, list.length - 50);

  list.slice(start).forEach(m=>{
    const isLeft    = (m.from === 'left');
    const showTrans = isLeft && (LS.getStr(`dmTranslated:${m.id}`,'0') === '1');
    const timeStr   = new Date(m.ts||Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

   // ===== 氣泡內容（保留原文 + 譯文；不提供收合） =====
let bubbleHTML = `<div class="bubble">`;

if (showTrans) {
  // 需要：原文 → 分隔線 → 譯文 → 「Translated by Papago」
  bubbleHTML += `
    <div class="orig">${escapeHtml(m.text)}</div>
    <div class="transDivider"></div>
    <div class="tran">${escapeHtml(m.text /* 這裡可換成真正的翻譯結果 m.trans */)}</div>
    <div class="by">Translated by Papago</div>
  `;
} else {
  bubbleHTML += `<div class="orig">${escapeHtml(m.text)}</div>`;
  if (m.from === 'left') {
    bubbleHTML += `
      <div class="translate-in" onclick="doDmTranslate('${m.id}')">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 4h18v2H3V4zm8 4h2v2h-2V8zm-6 0h4v2H5V8zm0 4h14v2H5v-2zm0 4h10v2H5v-2z" fill="currentColor"/>
        </svg>
        Translate
      </div>
    `;
  }
}
bubbleHTML += `</div>`;

    // ===== 右側側欄（時間／未讀 1／垃圾桶） =====
    let topRow = '';
    let bottomRow = `<span class="dmTime">${timeStr}</span>`;
    if(m.from === 'right'){
      const unread1 = !m.read ? `<span class="read1">1</span>` : '';
      const trash = `
        <button class="trash" title="刪除" onclick="deleteMsg('${m.id}')">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v8h-2V9zm4 0h2v8h-2V9z" fill="currentColor"/>
          </svg>
        </button>`;
      topRow = unread1;
      bottomRow = `${trash}${bottomRow}`;
    }
    const sideHTML = `<div class="dmSide">${topRow ? topRow : ''}<div class="dmSideRow">${bottomRow}</div></div>`;

    const wrap = document.createElement('div');
    wrap.className = `dmMsg ${m.from}`;
    wrap.innerHTML = `<div class="dmRow">${bubbleHTML}${sideHTML}</div>`;
    box.appendChild(wrap);
  });

  box.scrollTop = box.scrollHeight;
}
    function deleteMsg(msgId){
      const arr = dmMessages[currentChat] || [];
      const idx = arr.findIndex(x => x.id === msgId && x.from === 'right');
      if(idx > -1){
        arr.splice(idx,1);
        const artist = DM_ARTISTS.find(a=>a.id===currentChat);
        if(artist){
          const last = arr[arr.length-1];
          artist.lastMsg = last ? last.text : '（無訊息）';
        }
        renderDmThread(currentChat);
        renderDMList();
      }
    }

    function sendDm(){
  if(!currentChat) return;                           // 還沒開任何聊天
  const inp = document.getElementById('dmMessageInput');
  const t = (inp.value || '').trim();
  if(!t) return;

  const arr = dmMessages[currentChat] || (dmMessages[currentChat] = []);
  const msg = {
    id: 'u' + Date.now(),
    from: 'right',
    text: t,
    ts: Date.now(),
    translated: false,
    read: false
  };
  arr.push(msg);

  // 更新列表上的最後一則訊息與排序依據
  const artist = DM_ARTISTS.find(a => a.id === currentChat);
  if (artist){
    artist.lastMsg = t;
    artist.lastTs  = msg.ts;
  }

  inp.value = '';
  renderDmThread(currentChat);   // 重新渲染聊天室
  renderDMList();                // 重新渲染 DM 清單（讓預覽/排序更新）
}

function isSubscribed(artistId){
  const groupDays = parseInt(LS.getStr('heartDaysGroup','0'), 10) || 0;           // 全團
  const personal   = parseInt(LS.getStr(`heartDays:${artistId}`,'0'), 10) || 0;   // 個人
  return (groupDays > 0) || (personal > 0);
}

 function getDaysFor(artistId){
  const groupDays = parseInt(LS.getStr('heartDaysGroup','0'),10) || 0;
  const personal  = parseInt(LS.getStr(`heartDays:${artistId}`,'0'),10) || 0;
  return Math.max(groupDays, personal);
}
function updateHeartDaysSummary(){
  const all = ['annie','dohee','woo'].map(getDaysFor);
  const groupDays = parseInt(LS.getStr('heartDaysGroup','0'),10) || 0;
  const summary = Math.max(groupDays, ...all);
  LS.setStr('heartDays', String(summary));
  const el = document.getElementById('heartDays'); if(el) el.textContent = summary;
}   

function doDmTranslate(msgId){
  const k = `dmTranslated:${msgId}`;
  if (LS.getStr(k,'0') !== '1') {
    LS.setStr(k,'1');            // 只往「已翻譯」設定，不再切回
    if(currentChat) renderDmThread(currentChat);
  }
}
    
  /* Live */
const LIVE_DATA = {
  active: [],   // 目前沒有進行中
  ended:  []    // 目前沒有回放
};
function renderLives(){
  const og    = document.getElementById('liveOngoingList');
  const ed    = document.getElementById('liveEndedList');
  const empty = document.getElementById('liveEmpty');
  const groups = Array.from(document.querySelectorAll('#liveList .group'));

  const hasActive = Array.isArray(LIVE_DATA.active) && LIVE_DATA.active.length > 0;
  const hasEnded  = Array.isArray(LIVE_DATA.ended)  && LIVE_DATA.ended.length  > 0;

  // ✅ 完全沒有直播/回放 → 只顯示置中空狀態，隱藏群組標題
  if(!hasActive && !hasEnded){
    groups.forEach(g => g.style.display = 'none');
    empty.style.display = 'block';
    og.innerHTML = '';
    ed.innerHTML = '';
    return;
  }

  // 其他情況 → 顯示群組，隱藏空狀態
  groups.forEach(g => g.style.display = '');
  empty.style.display = 'none';

  // 進行中
  if(!hasActive){
    og.innerHTML = `<div class="ghost" style="padding:12px">目前沒有進行中的直播</div>`;
  }else{
    og.innerHTML = LIVE_DATA.active.map(l => liveOngoingCard(l)).join('');
  }

  // 已結束
  if(!hasEnded){
    ed.innerHTML = `<div class="ghost" style="padding:12px">尚無回放</div>`;
  }else{
    ed.innerHTML = LIVE_DATA.ended.map(l => `
      <div class="liveCard" onclick="openReplay('${l.id}')">
        ${post.img ? `<img class="hero skeleton" src="${post.img}" onload="this.classList.remove('skeleton')" onerror="imgFallback(this)">` : ''}
        <div class="liveMeta"><b>${escapeHtml(l.title||l.host)}</b><span class="status end">已結束</span></div>
      </div>
    `).join('');
  }
}

function liveOngoingCard(l){
  const bg = encodeURI(l.cover || l.thumb || '');
  return `
    <div class="liveHeroCard" onclick="openLive('${l.id}')">
      <div class="bg" style="background-image:url('${l.cover||l.thumb||''}')"></div>
      <div class="grad"></div>
      <div class="hud">
        <span class="liveTag">LIVE</span>
        <div class="liveHearts">${formatCount(l.hearts||0)}</div>
      </div>
      <div class="meta">
        <b>${escapeHtml(l.host)}</b>
        <div class="title">${escapeHtml(l.title||'Live')}</div>
      </div>
    </div>`;
}
function liveCard(l,status){
  let label = `<span class="status ${status}">已結束</span>`;
  if(status==='on') {
    label = `<span class="status on">進行中</span>`;
  } else if(status==='soon'){
    const diffMs = (typeof l.startTime === 'number') ? Math.max(0, l.startTime - Date.now()) : 0;
    const secs = Math.ceil(diffMs / 1000);
    label = `<span class="status soon">即將開始（${secs}s）</span>`;
  }
  return `
    <div class="liveCard" onclick="${status==='end' ? `openReplay('${l.id}')` : `openLive('${l.id}')`}">
      <img src="${l.thumb}" onerror="imgFallback(this)">
      <div class="liveMeta"><b>${escapeHtml(l.title || l.host || 'Live')}</b>${label}</div>
    </div>
  `;
}
    let _currentLiveId = null;
let _liveHearts = 0;

function openLive(id){
  const live = LIVE_DATA.active.find(l => l.id === id);
  if(!live) return;

  _currentLiveId = id;
  _liveHearts = Number(live.hearts || 0);

  // 標題、主持與右上角愛心數
  document.getElementById('liveTitle').textContent = live.title || '直播中';
  document.getElementById('liveHostName').textContent = live.host || 'Host';
  document.getElementById('liveHeartCount').textContent = formatCount(_liveHearts); // 用你前面那個 formatCount

  // 清空訊息串 + 歡迎訊息
  const box = document.getElementById('liveThread');
  box.innerHTML = '';
  const welcome = document.createElement('div');
  welcome.className = 'liveMsg welcome';
  welcome.textContent = '🎤 歡迎來到直播';
  box.appendChild(welcome);

  showPage('liveRoom');

  // 綁愛心按鈕（注意：抓正確的 id）
  const hb = document.getElementById('liveHeartBtn');
  hb.onclick = () => {
    _liveHearts++;
    document.getElementById('liveHeartCount').textContent = formatCount(_liveHearts);
    spawnHeartAnimation(hb);               // 動畫
    const obj = LIVE_DATA.active.find(l => l.id === _currentLiveId);
    if(obj) obj.hearts = _liveHearts;      // 回寫，之後做回放用
  };
}

// 心心飛出動畫：每次點 2~3 顆，位置跟著按鈕
function spawnHeartAnimation(btnEl){
  const rect = btnEl.getBoundingClientRect();
  const howMany = 2 + Math.floor(Math.random()*2); // 2~3 顆
  for(let i=0;i<howMany;i++){
    const heart = document.createElement('div');
    heart.className = 'flying-heart';
    heart.textContent = '💗';
    document.body.appendChild(heart);

    const x = rect.left + rect.width/2 + (Math.random()*30 - 15);
    const y = rect.top  + (Math.random()*10 - 5);
    heart.style.left = `${x}px`;
    heart.style.top  = `${y}px`;

    heart.animate(
      [
        { transform:'translate(0, 0) scale(1)',    opacity:1 },
        { transform:`translate(${(Math.random()*40-20)}px, -120px) scale(1.6)`, opacity:0 }
      ],
      { duration: 900 + Math.random()*300, easing:'ease-out' }
    ).onfinish = () => heart.remove();
  }
}
    function sendLiveMsg(){
      const input = document.getElementById('liveInput');
      const text = input.value.trim(); if(!text) return;
      const div = document.createElement('div');
      div.className='liveMsg fan';
      div.textContent = text;
      const box = document.getElementById('liveThread');
      box.appendChild(div);
      input.value=''; box.scrollTop = box.scrollHeight;
    }

function installLiveSwipeToExit(){
  const el = document.getElementById('liveRoom');
  let x0=null, y0=null, dragging=false;

  el.addEventListener('touchstart', e=>{
    if(e.touches.length!==1) return;
    x0 = e.touches[0].clientX;
    y0 = e.touches[0].clientY;
    dragging = true;
  }, {passive:true});

  el.addEventListener('touchmove', e=>{
    if(!dragging) return;
    const dx = e.touches[0].clientX - x0;
    const dy = e.touches[0].clientY - y0;
    // 右滑距離夠，且非上下捲動
    if(dx > 60 && Math.abs(dy) < 40){
      dragging = false;
      showPage('liveList');
    }
  }, {passive:true});

  el.addEventListener('touchend', ()=> dragging=false, {passive:true});
}

    function renderLivePage(){
  const ongoingBox = document.getElementById('liveOngoing');
  const replayBox  = document.getElementById('liveReplay');
  const emptyTip   = document.getElementById('liveEmptyTip');
  if(!ongoingBox || !replayBox || !emptyTip){
    // 舊函式作廢，交給新版的 renderLives()
    renderLives();
    return;
  }
  // 若未來補齊 DOM，再把真實渲染邏輯放回來
}

// 排序方法
function sortReplay(mode){
  if(mode==='new'){
    LIVE_DATA.ended.sort((a,b)=> new Date(b.date) - new Date(a.date));
  }else{
    LIVE_DATA.ended.sort((a,b)=> new Date(a.date) - new Date(b.date));
  }
  renderLives();
}
    
    let replayTimer = null;
    let replayMsgs = [];
    function openReplay(id){
      const live = LIVE_DATA.ended.find(l=>l.id===id); if(!live) return;
      document.getElementById('replayHostName').textContent = live.host;
      document.getElementById('replayTitle').textContent = live.title;
      const avatar = document.getElementById('replayHostAvatar'); avatar.src = 'https://picsum.photos/60?u='+encodeURIComponent(live.host);
      showPage('liveReplay');
      replayMsgs = [
        {type:'host', text:'大家好～我是 '+ live.host},
        {type:'fan',  text:'嗨！！'},
        {type:'fan',  text:'愛你💜'},
        {type:'host', text:'謝謝大家來看～'}
      ];
      playReplay(1);
    }
    function playReplay(speed=1){
      clearInterval(replayTimer);
      const thread = document.getElementById('replayThread'); thread.innerHTML = '';
      let i = 0;
      replayTimer = setInterval(()=>{
        if(i >= replayMsgs.length){ clearInterval(replayTimer); return; }
        const m = replayMsgs[i++];
        const div = document.createElement('div');
        div.className = 'replayMsg '+m.type;
        div.textContent = m.text;
        thread.appendChild(div);
        thread.scrollTop = thread.scrollHeight;
      }, 2000 / speed);
    }
    function changeReplaySpeed(val){ playReplay(parseFloat(val)||1); }

function endCurrentLive(){
  if(!_currentLiveId) return;
  const idx = LIVE_DATA.active.findIndex(l => l.id === _currentLiveId);
  if(idx === -1) return;

  const live = LIVE_DATA.active[idx];
  LIVE_DATA.active.splice(idx,1);

  // 存成回放（最前面）
  LIVE_DATA.ended.unshift({
    id: 'R'+Date.now(),
    host: live.host,
    title: live.title,
    thumb: live.cover || live.thumb || `https://picsum.photos/400/240?u=${encodeURIComponent(live.host)}`,
    hearts: _liveHearts,
    date: new Date().toISOString()
  });

  // 結束畫面
  showLiveEndedScene(live.host, live.cover || live.thumb);

  setTimeout(()=>{
    document.getElementById('liveEndedOverlay')?.remove();
    showPage('liveList');
    renderLives();
    _currentLiveId = null;
  }, 1500);
}
    function showLiveEndedScene(host, avatar){
  const o = document.createElement('div');
  o.className = 'liveEndedScene';
  o.id = 'liveEndedOverlay';
  o.innerHTML = `
    ${avatar? `<img src="${avatar}" onerror="imgFallback(this)">` : ''}
    <div class="name">${escapeHtml(host||'')}</div>
    <div class="text">直播已結束。</div>
  `;
  document.body.appendChild(o);
}
    
    /* Mini Profile */
    function openMiniProfile(name, avatar){
      document.getElementById('mpName').textContent = name;
      document.getElementById('mpId').textContent = randomFanIdForName(name);
      const img = document.getElementById('mpAvatar'); img.src = avatar; img.onerror = ()=>imgFallback(img);
      document.getElementById('mpBio').textContent = `Hi，我是 ${name}`;
      document.getElementById('miniProfile').style.display = 'block';
    }
    function closeMiniProfile(){ document.getElementById('miniProfile').style.display = 'none'; }
    function randomFanIdForName(name){
      const key = `miniId:${name}`;
      let id = LS.getStr(key);
      if(!id){ id = 'NEXT-'+ Math.floor(10000+Math.random()*90000); LS.setStr(key, id); }
      return id;
    }

    /* 導航 / 滾動記憶 */
    let CURRENT_PAGE = 'home';
    const pageStack = [];
    function showPage(id){
      CURRENT_PAGE = id;
      document.querySelectorAll('section.page').forEach(s=>s.classList.remove('active'));
      const page = document.getElementById(id); if(page) page.classList.add('active');
      if(pageStack[pageStack.length-1] !== id) pageStack.push(id);

      const hideNavOn = ['postDetail','dmDetail','liveRoom','liveReplay'];
      const nav = document.getElementById('nav');
      if(hideNavOn.includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');

      document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
      const map = {home:'tabHome', dm:'tabDM', liveList:'tabLive', store:'tabStore' };
      if(map[id]) document.getElementById(map[id]).classList.add('active');

      if(id==='dm') renderDMList();
      if(id==='liveList') renderLives();
      if(id==='profile'){ showFanProfile(); }
      if(id==='home'){ renderFeed(currentFilter); restoreHomeScroll(); }
    }
    function goBack(){
      if(pageStack.length>1){
        pageStack.pop();
        showPage(pageStack[pageStack.length-1]);
      }else{
        showPage('home');
      }
    }
    function saveHomeScroll(){
      const y = document.documentElement.scrollTop || document.body.scrollTop || 0;
      LS.setStr('homeScroll', String(y));
    }
    function restoreHomeScroll(){
      const y = parseInt(LS.getStr('homeScroll','0'),10) || 0;
      window.scrollTo(0, y);
    }

    /* 小工具 */
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }
    function buyHeartsStore(target, days, cost){
      let wallet = parseInt(LS.getStr('walletBalance','0'),10);
      if(wallet < cost){ alert('點數不足，請先充值或等待後台加值'); return; }
      wallet -= cost;
      LS.setStr('walletBalance', String(wallet));
      const wElm = document.getElementById('walletBalance'); if(wElm) wElm.textContent = wallet;
      const key = (target==='group') ? 'heartDaysGroup' : `heartDays:${target}`;
      let cur = parseInt(LS.getStr(key,'0'),10); cur += days; LS.setStr(key, String(cur));
      alert(`已購買：${target==='group'?'全團':'個人'} ${days} 天（已扣 ${cost} 點）`);
      updateHeartDaysSummary();
renderDMList();
if (CURRENT_PAGE === 'profile') showFanProfile();
    }

    /* Home 捲動自動隱藏 story/nav */
function installScrollAutoHide(){
  const nav   = document.getElementById('nav');
  const story = document.getElementById('storyWrap');
  let lastY = window.scrollY || 0;
  let ticking = false;

  const pagesEnable = ['home','dm','liveList'];   // 這三頁要自動隱藏
  const canWork = () => pagesEnable.includes(CURRENT_PAGE);

  function handle(){
    if(!canWork()){ ticking=false; return; }
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    const goingDown = y > lastY + 6;
    const goingUp   = y < lastY - 6;

    if(goingDown && y > 60){
      if(CURRENT_PAGE==='home' && story) story.classList.add('collapse'); // 只有首頁收起 story bar
      nav.classList.add('hidden');
      document.documentElement.classList.add('chrome-collapsed');         // 給 iOS 一點提示（見下方 CSS）
    }else if(goingUp){
      if(CURRENT_PAGE==='home' && story) story.classList.remove('collapse');
      nav.classList.remove('hidden');
      document.documentElement.classList.remove('chrome-collapsed');
    }
    lastY = y;
    ticking=false;
  }

  window.addEventListener('scroll', ()=>{
    if(ticking) return;
    ticking = true;
    requestAnimationFrame(handle);
  }, {passive:true});
}

function VB(size=18){
  const gid = 'vbGrad-' + Math.random().toString(36).slice(2,8);
  return `
  <span class="verified-badge" style="width:${size}px;height:${size}px">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="${gid}" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%"   stop-color="#6fb3ff"/>
          <stop offset="58%"  stop-color="#7b6dff"/>
          <stop offset="92%"  stop-color="#ffffff"/>
          <stop offset="100%" stop-color="#e9ecff"/>
        </linearGradient>
      </defs>
      <path class="gear" fill="url(#${gid})" d="M12 2.3 14 4l2.9-.6.9 2.7 2.7.9-.6 2.9L22 12l-2.1 2.1.6 2.9-2.7.9-.9 2.7-2.9-.6L12 21.7 10 20l-2.9.6-.9-2.7-2.7-.9.6-2.9L2 12l2.1-2.1-.6-2.9 2.7-.9.9-2.7L10 4l2-1.7z"/>
      <path class="tick" d="M10.4 12.8 8.7 11.2l1.1-1.1 1.2 1.2 3-3 1.1 1.1-3.8 3.8a1 1 0 0 1-1.4 0z"/>
    </svg>
  </span>`;
}

    /* 初始化 */
    document.addEventListener('DOMContentLoaded', ()=>{
      ensureMyIdentity();
      showMyBar();
      showFanProfile();
      updateHeartDaysSummary();

      renderStoryBar();
      renderFeed('all');
      renderDMList();
      renderLives();

      showPage('home');
      checkBirthday();
      installScrollAutoHide();
      installLiveSwipeToExit();
      document.getElementById('dmSendBtn').addEventListener('click', sendDm);
document.getElementById('dmMessageInput').addEventListener('keydown', function(e){
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendDm();
    updateHeartDaysSummary();
  }
    });
  });
  </script>
</body>
</html>
