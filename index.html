<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>NEXT'S YOU â€” Preview (Polished UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- é˜²å¿«å– -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ================= IG-Neumorphism Theme (Scoped, No Layout Changes) ================= -->
  <style>
    /* åªä½œç”¨åœ¨ body.nxï¼ˆé¿å…è“‹æ‰ä½ å…¶å®ƒé çš„æ¨£å¼ï¼‰ */
    body.nx{
      --bg:#0f0f12; --card:#16181d; --hover:#1b1e24; --line:rgba(255,255,255,.06);
      --text:#f6f7fb; --sub:#b5bac7; --muted:#8c92a1;
      --accent:#ff2d55; --accent-2:#ff3b63; --ok:#2ecc71; --ng:#ff5a5f;
      --r:16px; --r-sm:12px; --shadow: 12px 18px 40px rgba(0,0,0,.45);
    }
    /* æ·ºè‰²ä¸»é¡Œï¼ˆè‹¥æœªä¾†ä½ æƒ³é–‹ï¼ŒNX.setTheme('light') å³å¯ã€‚é è¨­ darkï¼‰ */
    body.nx.light{
      --bg:#f7f8fb; --card:#ffffff; --hover:#f1f2f6; --line:rgba(0,0,0,.08);
      --text:#121317; --sub:#4a4e59; --muted:#6b7280;
      --accent:#ff2d55; --accent-2:#ff3b63; --ok:#16a34a; --ng:#ef4444;
      --shadow: 8px 12px 26px rgba(0,0,0,.12);
    }

    /* èƒŒæ™¯æ°›åœ */
    html,body{height:100%}
    body.nx{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 800px at 90% -10%, rgba(255,45,85,.08), transparent 50%),
        radial-gradient(900px 700px at 10% 110%, rgba(109,40,217,.08), transparent 50%),
        var(--bg);
      -webkit-font-smoothing:antialiased; font-smooth:always;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* å€å¡Š / å¡ç‰‡ï¼ˆå°ç¾æœ‰ .panelã€.cardã€.product å¥—çš®ï¼‰ */
    .panel, .card, .product{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);
    }
    .panel.soft{ padding:16px }

    /* é€šç”¨æ’ç‰ˆ */
    section{display:none; padding:16px 16px 96px}
    section.active{display:block; animation:fadeIn .24s ease}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
    h2,h3,p{margin:0}
    .ghost{opacity:.75; color:var(--sub)}
    .list-col{display:grid; gap:12px}

    /* Friends Headerï¼ˆä½ å·²æœ‰çš„ #friendsHeaderï¼‰ */
    #friendsHeader{display:flex; justify-content:space-between; align-items:center; gap:12px}
    #friendsHeader .me{display:flex; align-items:center; gap:12px}
    #friendsHeader img{width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    #friendsHeader .nick{font-weight:800}

    /* Tabsï¼ˆè—äºº/åœ˜é«”/å·²è³¼è²·/æœªè³¼è²·ï¼‰ */
    .tabs{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:14px 0}
    .tabs button{
      border:none; border-radius:999px; padding:10px 0; font-weight:800; color:var(--sub);
      background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
    }
    .tabs button.active{ color:var(--text); background:linear-gradient(180deg, var(--hover), var(--card)); border-color:transparent }

    /* åˆ—è¡¨çš„å¡ç‰‡æ¨£å¼ï¼ˆä½  renderHome / renderDMList å·²è¼¸å‡º .card äº†ï¼‰ */
    .card .row{display:flex; align-items:center; gap:12px}
    .card .row img{width:52px; height:52px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    .badge{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid var(--line)}
    .badge.ok{background:rgba(46,204,113,.15); color:#aef7c6}
    .badge.ng{background:rgba(255,90,95,.15); color:#ffb3b5}

    /* DM é  */
    .topbar{display:flex; align-items:center; gap:12px; margin-bottom:10px}
    .topbar .dm-top{display:flex; align-items:center; gap:10px}
    .dm-title{font-weight:800}
    .menu-btn{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); color:var(--text)}
    .pill{display:flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,var(--hover),var(--card)); font-weight:800}
    .dm-wrap{display:flex; flex-direction:column; gap:12px}
    .dm-messages{display:flex; flex-direction:column; gap:14px; max-height:62vh; overflow:auto; padding-bottom:6px}
    .msg{max-width:78%; position:relative; padding:12px 14px; border-radius:18px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#f2f3f5); color:#17181c}
    .msg .sub-balloon{margin-top:8px; background:#eceff3; padding:10px; border-radius:14px; color:#333; border:1px solid rgba(0,0,0,.06)}
    .msg.me{margin-left:auto; background:linear-gradient(180deg, var(--hover), #121317); color:#e8eaf0}
    .date-chip{align-self:center; border:1px solid var(--line); border-radius:999px; padding:6px 12px; color:var(--sub); background:var(--hover); font-weight:800; font-size:12px}
    .msg time{position:absolute; right:14px; bottom:-18px; font-size:11px; color:var(--muted)}
    .dm-input{position:fixed; left:0; right:0; bottom:0; padding:12px 14px; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.55)); backdrop-filter:blur(10px); display:flex; gap:10px}
    .dm-input input{flex:1; border:none; outline:none; border-radius:16px; padding:14px 16px; background:var(--hover); color:var(--text); box-shadow:inset 0 1px 0 rgba(255,255,255,.04); border:1px solid var(--line)}
    .dm-input button{width:52px; height:52px; border:none; border-radius:18px; font-weight:900; color:#fff; background:linear-gradient(180deg,var(--accent),var(--accent-2))}

    /* GALLERY */
    #galleryGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    #galleryGrid img{width:100%; height:100%; object-fit:cover; border-radius:14px; border:1px solid var(--line); box-shadow:var(--shadow)}

    /* LIVE */
    .live-host{padding:16px}
    .live-host .title{font-weight:800; opacity:.9}
    .live-fans{display:grid; gap:10px; margin-top:12px}
    .fan-item{padding:12px; border-radius:12px; background:var(--card); border:1px solid var(--line)}

    /* NAVï¼ˆè‹¥ä¿ç•™ï¼‰ */
    nav{position:fixed; left:0; right:0; bottom:0; background:#0f1116; border-top:1px solid var(--line); display:flex; justify-content:space-around; padding:12px 8px 16px; backdrop-filter:blur(8px)}
    nav.hidden{display:none}
    nav button{background:transparent; border:none; color:var(--text); font-weight:800; padding:8px 10px; border-radius:12px}
    nav button:active{background:var(--hover)}

    /* æˆªåœ–è­¦å‘Š modalï¼ˆæ²¿ç”¨ä½ çš„çµæ§‹ï¼ŒåŠ åŸºæœ¬çš®è†šï¼‰ */
    #shotModal{display:none; position:fixed; inset:0; place-items:center; background:rgba(0,0,0,.4)}
    #shotModal .box{max-width:560px; width:90%; background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); padding:16px}
    #shotModal .warn{margin-top:6px; padding:12px; border-radius:12px; background:rgba(255,45,85,.12); border:1px dashed rgba(255,45,85,.35)}

    /* é–‹å ´å‹•ç•«ï¼ˆç½®ä¸­ã€NEXT éœæ­¢ã€'S YOU ç¿»è½‰ã€ONE å…ˆå‡ºå ´ï¼‰ */
    #splash{position:fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:9999}
    #splash .stage{display:flex; gap:20px; align-items:center; font-weight:800; font-size:44px; color:#fff}
    #splash .next{color:#fff}
    #splash .one{opacity:0}
    #splash .syou{opacity:0; color:#e42323; transform:rotateY(90deg)}
    @keyframes fadeIn {from{opacity:0} to{opacity:1}}
    @keyframes fadeOut{from{opacity:1} to{opacity:0}}
    @keyframes flipIn{from{opacity:0; transform:rotateY(90deg)} to{opacity:1; transform:rotateY(0)}}
  </style>
  <!-- ================================================================== -->
</head>

<body class="nx"><!-- åŠ ä¸Š .nx è®“æ•´å€‹ä¸»é¡Œåªåœ¨é€™é ç”Ÿæ•ˆ -->

<!-- ğŸ” LOGIN -->
<section id="login" class="active" 
         style="display:flex;align-items:center;justify-content:center;
                min-height:100vh; padding:20px; box-sizing:border-box;">
  <div class="panel soft" 
       style="max-width:400px; width:100%; text-align:center; padding:32px 24px; 
              border-radius:16px; background:var(--card); box-shadow:0 8px 20px rgba(0,0,0,.35)">
    
    <h2 style="margin-bottom:24px; font-size:22px; font-weight:600">ç™»å…¥</h2>

    <button id="lineLoginBtn" class="btn btn-red" 
            style="width:100%; margin-bottom:16px;">ç”¨ LINE ç™»å…¥ï¼ˆæ¨¡æ“¬ï¼‰</button>
    
    <div style="display:flex; gap:8px; margin-top:8px; justify-content:center">
      <input id="inviteCode" 
             placeholder="è¼¸å…¥é‚€è«‹ç¢¼ï¼Œä¾‹å¦‚ NEXT2025"
             style="flex:1; border:1px solid var(--line); border-radius:12px; 
                    padding:12px; background:var(--hover); color:var(--text)">
      <button id="codeLoginBtn" class="btn" 
              style="border:1px solid var(--line); border-radius:12px; 
                     padding:12px 18px; background:var(--card); color:var(--text)">
        ä½¿ç”¨é‚€è«‹ç¢¼
      </button>
    </div>
  </div>
</section>

<script>
/* ===== LOGIN FLOW ===== */
function fakeLogin(method){
  if(method==='line' || (method==='code' && document.getElementById('inviteCode').value.trim()==='NEXT2025')){
    localStorage.setItem('loggedIn','true');
    if(!localStorage.getItem('fanId')){
      localStorage.setItem('fanId','FAN'+Math.floor(Math.random()*100000));
    }
    showPage('home');
  }else{
    // âŒ éŒ¯èª¤æ™‚ input æŠ–å‹•
    const inp=document.getElementById('inviteCode');
    inp.classList.add('shake');
    setTimeout(()=>inp.classList.remove('shake'),500);
    alert('é‚€è«‹ç¢¼éŒ¯èª¤ï¼');
  }
}

// ç¶å®šæŒ‰éˆ•
document.getElementById('lineLoginBtn').addEventListener('click', ()=>fakeLogin('line'));
document.getElementById('codeLoginBtn').addEventListener('click', ()=>fakeLogin('code'));
</script>

<style>
/* æŠ–å‹•å‹•ç•« */
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%,60% { transform: translateX(-6px); }
  40%,80% { transform: translateX(6px); }
}
.shake { animation: shake 0.4s; }
</style>

<!-- HOME -->
<section id="home">
  <div id="friendsHeader" class="panel soft">
    <div class="me">
      <img id="userAvatar" src="https://picsum.photos/80?u=me" alt="é ­è²¼" onclick="openProfile()">
      <div class="nick" id="nickname" onclick="openProfile()">æš±ç¨±</div>
    </div>
    <button class="btn" onclick="showPage('wallet')" style="border:1px solid var(--line); border-radius:12px; padding:10px 14px; background:var(--card); color:var(--text)">éŒ¢åŒ…</button>
  </div>

  <div class="tabs">
    <button id="tab-artists" class="active" onclick="setHomeTab('artists')">è—äºº</button>
    <button id="tab-groups" onclick="setHomeTab('groups')">åœ˜é«”</button>
    <button id="tab-purchased" onclick="setHomeTab('purchased')">å·²è³¼è²·</button>
    <button id="tab-unpurchased" onclick="setHomeTab('unpurchased')">æœªè³¼è²·</button>
  </div>

  <div id="homeList" class="list-col"></div>
  <div id="homeEmpty" class="ghost" style="padding:12px;display:none">é€™ä¸€é¡ç›®å‰æ˜¯ç©ºçš„ï½</div>
</section>

<!-- PROFILE -->
<section id="profile">
  <div class="topbar"><h2>æˆ‘çš„å€‹äººé </h2></div>
  <div class="panel soft" style="text-align:center">
    <img id="editAvatar" src="https://picsum.photos/160?u=me" style="width:96px;height:96px;border-radius:20px;object-fit:cover; border:1px solid var(--line)"><br/>
    <div style="margin:10px 0">
      <input type="file" id="avatarInput" accept="image/*" onchange="changeAvatar(event)">
    </div>
    <div style="display:flex; gap:8px; justify-content:center">
      <input type="text" id="editNickname" placeholder="è¼¸å…¥æš±ç¨±" style="width:70%;max-width:320px; border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--hover); color:var(--text)">
      <button class="btn btn-red" onclick="saveProfile()" style="border:none; border-radius:12px; padding:10px 14px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">å„²å­˜</button>
    </div>
    <p class="ghost" style="margin:10px 0 0"><b>ç²‰çµ² IDï¼š</b><span id="fanId"></span></p>
    <div style="margin-top:10px"><button class="btn" onclick="showPage('home')" style="border:1px solid var(--line); border-radius:12px; padding:10px 14px; background:var(--card); color:var(--text)">è¿”å› Friends</button></div>
  </div>
</section>

<!-- DM LIST -->
<section id="dmList">
  <div class="topbar"><h2>Messages</h2></div>
  <div id="dmListWrap" class="list-col"></div>
  <div id="dmListEmpty" class="ghost" style="margin-top:12px;display:none">
    ç›®å‰æ²’æœ‰å·²é–‹é€šçš„ DMã€‚<button class="btn btn-red" onclick="showPage('wallet')" style="margin-left:6px; border:none; border-radius:12px; padding:8px 12px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">å»éŒ¢åŒ…é–‹é€š</button>
  </div>
</section>

<!-- DM CHAT -->
<section id="dm">
  <div class="topbar">
    <div class="dm-top">
      <button class="btn" onclick="showPage('dmList')" style="border:1px solid var(--line); border-radius:12px; padding:8px 12px; background:var(--card); color:var(--text)">â€¹</button>
      <div class="dm-title" id="dmTitle">ALLDAY PROJECT â€” åœ˜é«” DM</div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <button class="menu-btn" onclick="openGallery()">â–¦</button>
      <div class="pill"><b>â™¡</b><span id="heartDays">+0</span></div>
    </div>
  </div>

  <div class="dm-wrap">
    <div id="dm-messages" class="dm-messages"></div>
    <div class="dm-input">
      <input id="dmInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦">
      <button onclick="sendMessage()">â¤</button>
    </div>
  </div>
</section>

<!-- GALLERY (åƒ… â–¦ é€²) -->
<section id="gallery">
  <div class="topbar">
    <h2>ç›¸ç°¿</h2>
    <div style="margin-left:auto"><button class="btn" onclick="showPage('dm')" style="border:1px solid var(--line); border-radius:12px; padding:8px 12px; background:var(--card); color:var(--text)">è¿”å› DM</button></div>
  </div>
  <div id="galleryGrid"></div>
</section>

<!-- LIVE -->
<section id="live">
  <div class="topbar"><h2>LIVE</h2></div>
  <div class="panel soft live-host">
    <div class="title">ä¸»æ’­è¨Šæ¯</div>
    <div id="liveHostMsg" style="font-size:18px;line-height:1.55;margin-top:6px;min-height:40px">ç­‰å¾…é–‹æ’­â€¦</div>
    <div id="liveHostTime" class="ghost" style="margin-top:6px;font-size:12px"></div>
  </div>
  <div id="liveFans" class="live-fans"></div>
  <div style="position:sticky;bottom:96px; display:flex; gap:10px; margin-top:10px">
    <input id="liveInput" placeholder="ç™¼é€ç•™è¨€â€¦" style="flex:1; border:1px solid var(--line); border-radius:12px; padding:12px; background:var(--hover); color:var(--text)">
    <button class="btn btn-red" onclick="fanSendLive()" style="border:none; border-radius:12px; padding:10px 14px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">é€å‡º</button>
  </div>
</section>

<!-- WALLET -->
<section id="wallet">
  <div class="topbar"><h2>éŒ¢åŒ…</h2><div style="margin-left:auto"><button class="btn" onclick="logout()" style="border:1px solid var(--line); border-radius:12px; padding:8px 12px; background:var(--card); color:var(--text)">ç™»å‡º</button></div></div>
  <div class="panel soft">
    <p><b>æˆ‘çš„åˆ†æ•¸ï¼š</b><span id="points">0</span></p>
    <div class="product" style="padding:12px; display:flex; align-items:center; justify-content:space-between; margin-top:10px">
      <h4 style="margin:0">7 å¤© DM æ¬Šç›Š â€” 70 åˆ†</h4><button class="btn btn-red" onclick="buyProduct(70,7)" style="border:none; border-radius:12px; padding:8px 12px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">è³¼è²·</button>
    </div>
    <div class="product" style="padding:12px; display:flex; align-items:center; justify-content:space-between; margin-top:10px">
      <h4 style="margin:0">30 å¤© DM æ¬Šç›Š â€” 250 åˆ†</h4><button class="btn btn-red" onclick="buyProduct(250,30)" style="border:none; border-radius:12px; padding:8px 12px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">è³¼è²·</button>
    </div>

    <h3 style="margin:18px 0 6px">æ¸¬è©¦è³¼è²·æ·å¾‘</h3>
    <div class="product" style="padding:12px; display:flex; align-items:center; justify-content:space-between">
      <p style="margin:0">è³¼è²·ã€Œåœ˜é«”ã€pass</p><button class="btn btn-red" onclick="markPurchased('group',true)" style="border:none; border-radius:12px; padding:8px 12px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">æ¨™è¨˜å·²è³¼è²·ï¼ˆåœ˜é«”ï¼‰</button>
    </div>
    <div class="product" style="padding:12px; display:flex; align-items:center; justify-content:space-between; margin-top:10px">
      <p style="margin:0">è³¼è²·ã€ŒWOOCHANã€</p><button class="btn btn-red" onclick="markPurchased('wc',true)" style="border:none; border-radius:12px; padding:8px 12px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff">æ¨™è¨˜å·²è³¼è²·ï¼ˆWOOCHANï¼‰</button>
    </div>
  </div>
</section>

<script>
/* ===== æˆªåœ–è­¦å‘Šï¼ˆæ¯æ¬¡æˆªåœ–è§¸ç™¼ï¼‰ ===== */
function showScreenshotWarning(){
  const modal = document.getElementById('shotModal');
  if(!modal) return;
  modal.querySelector('.warn').innerHTML = `
    <b>å·²åµæ¸¬åˆ°è¢å¹•æˆªåœ–</b><br>
    æœªç¶“æˆæ¬Šæ“·å–ã€è½‰å‚³æˆ–å¤–æµè—äººä¹‹æ–‡å­—ã€ç…§ç‰‡æˆ–å½±ç‰‡ï¼Œå¯èƒ½é•åå¹³å°è¦ç¯„ä¸¦å½±éŸ¿ä»–äººæ¬Šç›Šã€‚<br>
    å› æ­¤ç”¢ç”Ÿçš„ä»»ä½•å¾Œæœèˆ‡è²¬ä»»ï¼Œå°‡ç”±æ‚¨è‡ªè¡Œæ‰¿æ“”ã€‚è‹¥æŒçºŒé•è¦ï¼Œå¸³è™Ÿèˆ‡ç›¸é—œæ¬Šç›Šå¯èƒ½è¢«åœç”¨ã€‚
  `;
  modal.style.display = 'grid';
}
function dismissShot(){ const m=document.getElementById('shotModal'); if(m) m.style.display='none'; }

/* æ¡Œé¢æ¨¡æ“¬ï¼šæŒ‰ä¸‹ PrintScreen è§¸ç™¼ï¼›è¡Œå‹•ç«¯éœ€ App åŸç”Ÿ API æ‰èƒ½åµæ¸¬ */
window.addEventListener('keyup', e=>{
  if(e.key === 'PrintScreen'){ showScreenshotWarning(); }
});

/* é¡å¤–ï¼šæ‹·è²äº‹ä»¶ä¹Ÿæé†’ï¼ˆæœ‰æ™‚å€™ä½¿ç”¨è€…æœƒè¤‡è£½æ–‡å­—/åœ–ç‰‡å¾Œå¤–æµï¼‰ */
document.addEventListener('copy', ()=>{ showScreenshotWarning(); });
</script>

<!-- NAV -->
<nav id="nav" class="hidden">
  <button onclick="showPage('home')">é¦–é </button>
  <button onclick="showPage('dmList')">DM</button>
  <button onclick="showPage('live')">ç›´æ’­</button>
  <button onclick="showPage('wallet')">éŒ¢åŒ…</button>
</nav>

<script>
/* ===== DATA ===== */
const ARTISTS = [
  {id:'wc', name:'WOOCHAN', avatar:'https://picsum.photos/120?u=wc', kind:'artist'},
  {id:'ys', name:'YOUNGSEO', avatar:'https://picsum.photos/120?u=ys', kind:'artist'},
  {id:'an', name:'ANNIE',    avatar:'https://picsum.photos/120?u=an', kind:'artist'},
  {id:'ba', name:'BAILEY',   avatar:'https://picsum.photos/120?u=ba', kind:'artist'},
];
const GROUPS = [{id:'group', name:'ALLDAY PROJECT', avatar:'https://picsum.photos/120?u=grp', kind:'group'}];

/* ===== STATE ===== */
if(!localStorage.getItem('points')) localStorage.setItem('points', 200);
if(!localStorage.getItem('userId')) localStorage.setItem('userId','u_'+Math.random().toString(36).slice(2,10));

<<script>
/* ===== NAV é¡¯ç¤º/éš±è—ï¼ˆDM / gallery ä¸é¡¯ç¤ºï¼‰ ===== */
function showPage(id){
  // åˆ‡é 
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  // åº•éƒ¨ navï¼šç™»å…¥å¾Œæ‰é¡¯ç¤ºï¼Œä½† DM / gallery éš±è—
  const nav = document.getElementById('nav');
  if (localStorage.getItem('loggedIn') && id!=='login' && id!=='dm' && id!=='gallery') {
    nav.classList.remove('hidden');
  } else {
    nav.classList.add('hidden');
  }

  // æ¯é åˆ·æ–°
  if(id==='home'){ renderProfile(); setHomeTab(HOME_TAB||'artists'); }
  if(id==='dmList'){ renderDMList(); }
  if(id==='dm'){ renderHearts(); renderDM(); }   // ä¸å†å‘¼å« maybeWarnShot()
  if(id==='gallery'){ renderGallery(); }
  if(id==='wallet'){ renderPoints(); }
  if(id==='profile'){ prepProfile(); }
}

/* ===== PROFILE ===== */
function renderProfile(){
  document.getElementById('nickname').textContent = localStorage.getItem('nickname') || 'æš±ç¨±';
  document.getElementById('userAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/80?u=me';
}
function openProfile(){ showPage('profile'); }
function prepProfile(){
  document.getElementById('editNickname').value = localStorage.getItem('nickname') || 'æš±ç¨±';
  document.getElementById('editAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/160?u=me';
  document.getElementById('fanId').textContent = localStorage.getItem('fanId');
}
function changeAvatar(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload = ev => { document.getElementById('editAvatar').src = ev.target.result; }; r.readAsDataURL(f);
}
function saveProfile(){
  const name=document.getElementById('editNickname').value.trim();
  if(name) localStorage.setItem('nickname', name);
  localStorage.setItem('avatar', document.getElementById('editAvatar').src);
  showPage('home');
}

/* ===== HOME LIST & FILTER ===== */
let HOME_TAB='artists';
function setHomeTab(tab){
  HOME_TAB=tab;
  ['artists','groups','purchased','unpurchased'].forEach(t=>document.getElementById('tab-'+t).classList.toggle('active', t===tab));
  renderHome();
}
function isPurchased(id){
  if(id==='group') return passActive();
  const p=JSON.parse(localStorage.getItem('purchases')||'{}'); return !!p[id];
}
function renderHome(){
  const list=document.getElementById('homeList'); const empty=document.getElementById('homeEmpty');
  let dataset=[];
  if(HOME_TAB==='artists') dataset=ARTISTS;
  if(HOME_TAB==='groups') dataset=GROUPS;
  if(HOME_TAB==='purchased') dataset=[...GROUPS,...ARTISTS].filter(i=>isPurchased(i.id));
  if(HOME_TAB==='unpurchased') dataset=[...GROUPS,...ARTISTS].filter(i=>!isPurchased(i.id));

  list.innerHTML = dataset.map(i=>`
    <div class="card" onclick="homeCardClick('${i.id}')">
      <div class="row">
        <img src="${i.avatar}" onerror="this.src='https://picsum.photos/120?u=${i.id}'">
        <div>
          <div><b>${i.name}</b></div>
          <div class="badge ${isPurchased(i.id)?'ok':'ng'}">${isPurchased(i.id)?'å·²è³¼è²·':'æœªè³¼è²·'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = dataset.length ? 'none' : 'block';
}
function homeCardClick(id){ if(isPurchased(id)) openDM(id); else showPage('wallet'); }

/* ===== WALLET ===== */
function renderPoints(){ document.getElementById('points').textContent = localStorage.getItem('points')||'0'; }
function buyProduct(cost, days){
  let p=parseInt(localStorage.getItem('points')||'0',10);
  if(p<cost) return alert('åˆ†æ•¸ä¸è¶³ï¼');
  p-=cost; localStorage.setItem('points',p);
  localStorage.setItem('purchaseDate', new Date().toISOString().split('T')[0]);
  localStorage.setItem('duration', days);
  alert(`âœ… å·²è³¼è²· ${days} å¤© DM æ¬Šç›Šï¼`); renderPoints(); renderHearts();
}
function markPurchased(id, yes=true){
  const map=JSON.parse(localStorage.getItem('purchases')||'{}'); map[id]=!!yes;
  localStorage.setItem('purchases', JSON.stringify(map));
  alert(`å·²æ¨™è¨˜ ${id} ç‚º ${yes?'å·²è³¼è²·':'æœªè³¼è²·'}`);
}

/* ===== DM LIST & GATING ===== */
function passActive(){
  const start=localStorage.getItem('purchaseDate'); const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0) return false;
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  return Math.floor((t-s)/86400000) <= dur;
}
function renderDMList(){
  const box=document.getElementById('dmListWrap'); const empty=document.getElementById('dmListEmpty');
  const active=passActive();
  const items=[...GROUPS, ...ARTISTS];
  box.innerHTML = items.map(it=>`
    <div class="card" onclick="enterDMFromList('${it.id}')">
      <div class="row">
        <img src="${it.avatar}">
        <div>
          <div><b>${it.name}</b></div>
          <div class="badge ${(it.id==='group'?active:isPurchased(it.id))?'ok':'ng'}">${(it.id==='group'?active:isPurchased(it.id))?'å¯é€²å…¥':'æœªé–‹é€š'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = (active || Object.values(JSON.parse(localStorage.getItem('purchases')||'{}')).some(Boolean)) ? 'none' : 'block';
}
function enterDMFromList(id){
  if(id==='group'){ if(!passActive()) return showPage('wallet'); }
  else if(!isPurchased(id)) return showPage('wallet');
  openDM(id);
}

/* ===== DM / GALLERY ===== */
function currentArtist(){ return localStorage.getItem('currentArtist') || 'group'; }
function dmKey(){ return `dm_${localStorage.getItem('userId')}_${currentArtist()}`; }
function galleryKey(){ return `gallery_${currentArtist()}`; }

function openDM(id){
  localStorage.setItem('currentArtist', id||'group');
  const title = id==='group' ? 'ALLDAY PROJECT â€” åœ˜é«” DM' : (ARTISTS.find(a=>a.id===id)?.name + ' â€” DM');
  document.getElementById('dmTitle').textContent = title || 'DM';
  showPage('dm');
}
function passStartTS(){ const d=localStorage.getItem('purchaseDate'); if(!d) return null; const s=new Date(d); s.setHours(0,0,0,0); return s.getTime(); }

function renderDM(){
  if(!localStorage.getItem(dmKey())){
    localStorage.setItem(dmKey(), JSON.stringify([{role:'artist',type:'text',text:'æ­¡è¿ä¾†åˆ° DMï¼',trans:'Welcome to DM!',ts:Date.now()}]));
  }
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  const showFrom = currentArtist()==='group' ? passStartTS() : (isPurchased(currentArtist())?0:Infinity);
  const box=document.getElementById('dm-messages'); box.innerHTML='';

  let lastDate='';
  list.filter(m=>!showFrom || (m.ts||0)>=showFrom).forEach(m=>{
    const d=new Date(m.ts||Date.now());
    const D=`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    const hh=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if(D!==lastDate){ const chip=document.createElement('div'); chip.className='date-chip'; chip.textContent=D; box.appendChild(chip); lastDate=D; }

    const wrap=document.createElement('div'); wrap.className='msg '+(m.role==='fan'?'me':'artist');
    if(m.type==='image'){
      const img=new Image(); img.src=m.url; img.style="max-width:100%;border-radius:12px;border:1px solid var(--line)";
      wrap.appendChild(img);
      if(m.caption){ const c=document.createElement('div'); c.className='sub-balloon'; c.textContent=m.caption; wrap.appendChild(c); }
    }else{
      const main=document.createElement('div'); main.textContent=m.text||''; wrap.appendChild(main);
      if(m.role==='artist' && m.trans){ const sub=document.createElement('div'); sub.className='sub-balloon'; sub.textContent=m.trans; wrap.appendChild(sub); }
    }
    const t=document.createElement('time'); t.textContent=hh; wrap.appendChild(t);
    box.appendChild(wrap);
  });
  requestAnimationFrame(()=>{ box.scrollTop = box.scrollHeight; });
}
function sendMessage(){
  const inp=document.getElementById('dmInput'); const t=(inp.value||'').trim(); if(!t) return;
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  list.push({role:'fan',type:'text',text:t,ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(list)); inp.value=''; renderDM();
}
/* console helpers */
function addArtistMessage(text,translation){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]'); dm.push({role:'artist',type:'text',text,trans:translation||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm)); renderDM();
}
function addArtistImage(url,caption){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]'); dm.push({role:'artist',type:'image',url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm));
  const gal=JSON.parse(localStorage.getItem(galleryKey())||'[]'); gal.push({url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(galleryKey(), JSON.stringify(gal)); renderDM();
}

function openGallery(){ showPage('gallery'); renderGallery(); }
function renderGallery(){
  const grid=document.getElementById('galleryGrid');
  const list=JSON.parse(localStorage.getItem(galleryKey())||'[]');
  grid.innerHTML = list.length? list.slice().reverse().map(i=>`<img src="${i.url}" onerror="this.src='https://picsum.photos/400?ph'">`).join('') : '<div class="ghost">é‚„æ²’æœ‰ç…§ç‰‡</div>';
}

/* ===== LIVE ===== */
function hostPushLive(text){
  document.getElementById('liveHostMsg').textContent = text;
  document.getElementById('liveHostTime').textContent = new Date().toLocaleString();
}
function fanSendLive(){
  const inp=document.getElementById('liveInput'); const t=(inp.value||'').trim(); if(!t) return;
  const box=document.getElementById('liveFans');
  const item=document.createElement('div'); item.className='fan-item';
  item.innerHTML=`<b>${localStorage.getItem('nickname')||'ç²‰çµ²'}</b><div style="opacity:.9">${t}</div>
                  <div style="font-size:12px;opacity:.6;margin-top:4px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(item); box.scrollTop=box.scrollHeight; inp.value='';
}

/* ===== HEARTS ===== */
function renderHearts(){
  const el=document.getElementById('heartDays'); if(!el) return;
  const start=localStorage.getItem('purchaseDate'); const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0){ el.textContent='+0'; return; }
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  const n=Math.floor((t-s)/86400000); el.textContent = (n<=dur)?`+${n}`:'+0';
}

/* ===== SCREENSHOT WARNING ===== */
function showScreenshotWarning(){
  document.getElementById('shotModal').style.display='grid';
}
function dismissShot(){
  document.getElementById('shotModal').style.display='none';
}

/* ===== THEME BOOT ===== */
(function(){
  window.NX = window.NX || {};
  NX.setTheme = mode => {
    const b=document.body; if(!b.classList.contains('nx')) b.classList.add('nx');
    b.classList.remove('light','dark'); b.classList.add(mode==='light'?'light':'dark');
    localStorage.setItem('nx-theme', mode==='light'?'light':'dark');
  };
  const saved=localStorage.getItem('nx-theme');
  if(saved){ NX.setTheme(saved); }
  else{
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    NX.setTheme(prefersDark ? 'dark' : 'light');
  }
})();

/* ===== BOOT ===== */
window.addEventListener('load', ()=>{ if(localStorage.getItem('loggedIn')) showPage('home'); else showPage('login'); });

/* ===== SPLASH ===== */
(function(){
  const one = document.getElementById("one");
  const syou = document.getElementById("syou");
  const splash = document.getElementById("splash");
  one.style.animation = "fadeIn 600ms ease forwards";
  setTimeout(()=>{
    one.style.animation = "fadeOut 400ms ease forwards";
    setTimeout(()=>{ syou.style.animation = "flipIn 600ms ease forwards"; }, 400);
  }, 1200);
  setTimeout(()=>{
    splash.style.transition = "opacity 420ms ease";
    splash.style.opacity = "0";
    setTimeout(()=> splash.remove(), 460);
  }, 2800);
})();
</script>
<!-- ğŸš€ Stable Splash: NEXT å›ºå®šã€'S YOU ç¿»è½‰ï¼›å¤±æ•—ä¿éšª 4.5s å¼·åˆ¶é—œé–‰ -->
<style>
  #splash {
    position: fixed; inset: 0; background: #000;
    display: flex; justify-content: center; align-items: center;
    z-index: 9999; pointer-events: none;
  }
  #splash .stage {
    display: flex; gap: 20px; align-items: center; justify-content:center;
    font-weight: 800; font-size: 44px; color: #fff;
    transform: translateZ(0);
    will-change: opacity, transform;
  }
  #splash .next { color:#fff; }
  #splash .one  { opacity:0; }
  #splash .syou { opacity:0; color:#e42323; transform: rotateY(90deg); transform-origin: left center; }

  /* å‹•ç•« */
  @keyframes sp-fade-in  { from{opacity:0} to{opacity:1} }
  @keyframes sp-fade-out { from{opacity:1} to{opacity:0} }
  @keyframes sp-flip-in  { from{opacity:0; transform:rotateY(90deg)} to{opacity:1; transform:rotateY(0)} }

  #splash .one.play   { animation: sp-fade-in .6s ease forwards; }
  #splash .one.hide   { animation: sp-fade-out .4s ease forwards; }
  #splash .syou.play  { animation: sp-flip-in .6s ease forwards; }
  #splash.hide        { transition: opacity .4s ease; opacity:0; }
</style>

<div id="splash" aria-hidden="true">
  <div class="stage">
    <span class="next">NEXT</span>
    <span class="one"  id="spOne">ONE</span>
    <span class="syou" id="spYou">â€™S YOU</span>
  </div>
</div>

<script>
(function(){
  const splash = document.getElementById('splash');
  const one    = document.getElementById('spOne');
  const you    = document.getElementById('spYou');

  // å…¼å®¹ iOSï¼šç­‰ä¸€å¹€ â†’ å†ç­‰ä¸€å¹€ï¼Œç¢ºä¿ç¬¬ä¸€æ¬¡ paint ä¹‹å¾Œæ‰åŠ å‹•ç•« class
  const raf = window.requestAnimationFrame || (fn=>setTimeout(fn,16));
  const safeHide = () => { if (!splash) return; splash.classList.add('hide'); setTimeout(()=>splash.remove(), 460); };

  // 4.5s ä¿éšªï¼šä¸è«–å¦‚ä½•å¼·åˆ¶é—œé–‰ï¼Œé¿å…å¡ä½
  const killer = setTimeout(safeHide, 4500);

  function start(){
    // Step1: ONE é¡¯ç¤º
    one.classList.add('play');

    // Step2: ONE æ·¡å‡º â†’ 'S YOU ç¿»è½‰é€²å ´
    setTimeout(()=>{
      one.classList.remove('play'); one.classList.add('hide');
      setTimeout(()=>{ you.classList.add('play'); }, 400);
    }, 900);

    // Step3: æ•´å€‹ splash æ·¡å‡º
    setTimeout(()=>{
      clearTimeout(killer);
      safeHide();
    }, 2600);
  }

  // é‡å° iOS/Safari è¿”å›é é¢(BFCache) çš„è™•ç†ï¼šå›ä¾†å°±é‡è·‘ä¸€æ¬¡
  window.addEventListener('pageshow', (e)=>{ if (e.persisted) start(); }, {once:true});

  // å…©æ¬¡ RAFï¼Œä¿è­‰ DOM çœŸçš„é€²ç•«é¢
  raf(()=> raf(start));
})();
</script>
<!-- ğŸ”§ CACHE BUSTER (paste just before </body>) -->
<script>
(function(){
  // âŠ æ¯æ¬¡ä½ ç™¼æ–°ç‰ˆæœ¬ï¼ŒæŠŠä¸‹é¢é€™å€‹å­—ä¸²éš¨ä¾¿æ”¹ï¼šæ—¥æœŸ/ç·¨è™Ÿéƒ½è¡Œ
  const BUILD = 'b2025-09-11-01';
  const KEY_BUILD = '_nx_build';
  const KEY_JUST  = '_nx_just_refreshed';

  try{
    const prev = localStorage.getItem(KEY_BUILD);
    const just = sessionStorage.getItem(KEY_JUST);

    // â‹ å¦‚æœåµæ¸¬åˆ°ç‰ˆæœ¬è®Šäº†ï¼Œè€Œä¸”é‚„æ²’åˆ·æ–°é â†’ ç«‹åˆ»æ¸…å¿«å–ä¸¦å¸¶ç‰ˆæœ¬åƒæ•¸é‡æ–°è¼‰å…¥
    if (prev !== BUILD && !just) {
      sessionStorage.setItem(KEY_JUST, '1');
      localStorage.setItem(KEY_BUILD, BUILD);

      // a) åˆªæ‰å¯èƒ½çš„ CacheStorageï¼ˆGitHub Pages/ç€è¦½å™¨å±¤ï¼‰
      if ('caches' in window) {
        caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      }

      // b) è¨»éŠ·ä»»ä½• Service Workerï¼ˆå¦‚æœä¸å°å¿ƒè¨»å†Šéï¼‰
      if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
        navigator.serviceWorker.getRegistrations().then(list => list.forEach(r => r.unregister()));
      }

      // c) æ”¹å¯«ç¶²å€åŠ ä¸Šç‰ˆæœ¬åƒæ•¸ï¼Œç¢ºä¿ HTML ä¹Ÿé‡æŠ“ï¼ˆé¿å…ä¸­ç¹¼ç¯€é»å¿«å–ï¼‰
      const u = new URL(location.href);
      u.searchParams.set('v', BUILD);
      location.replace(u.toString());
      return; // ä¸­æ­¢å¾ŒçºŒç¨‹å¼ï¼Œç­‰å¾…é‡æ–°è¼‰å…¥
    }
  }catch(e){/* éœé»˜å¿½ç•¥ */ }

  // âŒ iOS/Safari è¿”å›ä¸Šä¸€é æœƒç”¨ BFCacheï¼Œé€™è£¡åµæ¸¬ä¸¦å¼·åˆ¶é‡æ•´
  window.addEventListener('pageshow', e => { if (e.persisted) location.reload(); });

  // â æä¾›ä¸€å€‹æ‰‹å‹•æŒ‡ä»¤ï¼šåœ¨ç€è¦½å™¨ console æ‰“ NX.refresh() å¯æ‰‹å‹•æ¸…ä¸€æ¬¡ä¸¦åˆ·æ–°
  window.NX = window.NX || {};
  window.NX.refresh = function(){
    try{
      sessionStorage.removeItem('_nx_just_refreshed');
      localStorage.removeItem('_nx_build');
    }catch(_){}
    location.reload();
  };
})();
</script>
</body>
</html>
