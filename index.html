<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>NEXT'S YOU — Preview (Polished UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- 防快取 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    /* ============ DESIGN TOKENS ============ */
    :root{
      /* 黑紅霸氣風 + 工業感 */
      --bg:#0c0c0e;            /* 背景底黑 */
      --bg2:#141417;           /* 次層黑 */
      --ui:#191a1d;            /* 面板 */
      --line:#2a2c31;          /* 邊框 */
      --text:#f4f4f5;          /* 正文 */
      --muted:#a6a7aa;         /* 次文字 */
      --brand:#e0152f;         /* 主紅 */
      --brand2:#ff3b3b;        /* 高亮紅 */
      --glow:rgba(224,21,47,.45);
      --accent:#9f6f63;        /* 奶茶棕 */
      --accent-2:#4b433f;      /* 日期膠囊棕 */
      --teal:#3dd2c6;          /* 成功/在線 */
      --warn:#ffcc00;          /* 截圖警告色 */

      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --shadow-soft:0 6px 16px rgba(0,0,0,.28);
    }

    /* ============ RESET ============ */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial;
      background:
        radial-gradient(1200px 600px at 120% -10%, rgba(224,21,47,.16), transparent 60%),
        radial-gradient(900px 500px at -10% -10%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg,#101115 0%, #0c0c0e 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    h1,h2,h3,b,strong{font-weight:800; letter-spacing:.2px}
    section{display:none; padding:calc(env(safe-area-inset-top,0) + 12px) 16px 96px}
    section.active{display:block; animation:fadeIn .18s ease-out}
    @keyframes fadeIn{from{opacity:.0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    /* ============ NAV (無相簿) ============ */
    nav{
      position:fixed; left:0; right:0; bottom:0;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom,0));
      background:rgba(14,14,16,.85); backdrop-filter:blur(10px);
      border-top:1px solid var(--line);
      display:flex; justify-content:space-around; gap:8px; z-index:50;
    }
    nav.hidden{display:none}
    nav button{
      flex:1; background:linear-gradient(180deg,#1a1b1f,#141418);
      border:1px solid var(--line); color:var(--text);
      border-radius:14px; padding:12px 10px; font-weight:700;
      box-shadow:var(--shadow-soft); letter-spacing:.2px;
    }
    nav button:active{transform:translateY(1px); filter:brightness(.95)}

    /* ============ CARDS / PANELS ============ */
    .panel{
      background:var(--ui); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .soft{box-shadow:var(--shadow-soft)}

    /* top bar (DM / Gallery / Live / Wallet) */
    .topbar{
      position:sticky; top:calc(env(safe-area-inset-top,0)); z-index:20;
      display:flex; align-items:center; gap:10px;
      padding:12px 12px; margin:-4px 0 10px;
      background:linear-gradient(180deg, rgba(32,33,37,.95), rgba(25,26,29,.88));
      border:1px solid var(--line); border-radius:12px;
    }
    .topbar h2{margin:0; font-size:18px}
    .btn,.chip{
      border:1px solid var(--line); background:#202126; color:var(--text);
      border-radius:12px; padding:8px 12px; font-weight:700;
    }
    .btn-red{background:linear-gradient(180deg, var(--brand2), var(--brand)); border-color:transparent; box-shadow:0 8px 22px var(--glow)}
    .btn-ghost{background:#1a1b20}

    /* ============ HOME: 個人區＋分頁＋清單 ============ */
    #friendsHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px; border:1px solid var(--line); border-radius:var(--radius); background:linear-gradient(180deg,#17181c,#141417);
      box-shadow:var(--shadow-soft);
    }
    #friendsHeader .me{display:flex; align-items:center; gap:10px}
    #friendsHeader img{width:44px;height:44px;border-radius:12px;object-fit:cover; border:1px solid var(--line)}
    #friendsHeader .nick{font-weight:800; letter-spacing:.3px; cursor:pointer}

    .tabs{display:flex; gap:10px; margin:14px 2px 10px}
    .tabs button{
      flex:1; padding:10px; border-radius:12px; background:#1a1b21; border:1px solid var(--line); color:#d7d8da; font-weight:800;
    }
    .tabs button.active{
      color:#fff; background:linear-gradient(180deg,#2d0e12,#1a0a0c), linear-gradient(180deg,#2c2c32,#1a1b21);
      border:1px solid #4a0f18; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 6px 16px rgba(224,21,47,.25);
    }

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .card{
      cursor:pointer; padding:12px; border:1px solid var(--line); border-radius:16px;
      background:linear-gradient(180deg,#191a1d,#121316);
      box-shadow:var(--shadow-soft);
      transition:transform .1s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{transform:translateY(-1px); box-shadow:0 10px 26px rgba(224,21,47,.2)}
    .row{display:flex; gap:10px; align-items:center}
    .card img{width:56px; height:56px; border-radius:14px; object-fit:cover; border:1px solid var(--line)}
    .badge{display:inline-flex; align-items:center; gap:6px; margin-top:6px; font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#1a1b21; opacity:.9}
    .ok{background:#0d2a1e; color:#b9ffd0; border-color:#174a36}
    .ng{background:#2a1414; color:#ffd6d2; border-color:#4d2626}

    /* ============ DM ============ */
    .dm-top{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .dm-title{font-weight:900; letter-spacing:.3px}
    .menu-btn{border:1px solid var(--line); background:#22242a; color:#fff; border-radius:12px; padding:6px 10px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:#3a2f2b; border:1px solid rgba(255,255,255,.08)}
    .pill b{color:#ff8a8a}

    .dm-wrap{display:flex; flex-direction:column; height:calc(100vh - 192px)}
    .dm-messages{flex:1; overflow:auto; padding:14px; border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg,#141417,#0f0f11)}
    .date-chip{align-self:center; background:var(--accent-2); color:#efe8e3; padding:6px 12px; border-radius:14px; font-size:12px; margin:8px 0 4px; opacity:.95}

    .msg{max-width:78%; padding:12px 14px; border-radius:16px; margin:8px 0; font-size:15px; line-height:1.45; word-break:break-word; box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
    .msg.me{background:linear-gradient(180deg,#6c4b40,#5a4036); color:#fff; margin-left:auto; border-bottom-right-radius:5px}
    .msg.artist{background:linear-gradient(180deg,#ffffff,#efefef); color:#111; border-bottom-left-radius:5px}
    .sub-balloon{margin-top:6px; padding:8px 10px; background:#ececec; color:#555; border-radius:12px; font-size:13px}
    .msg time{display:block; text-align:right; font-size:12px; opacity:.7; margin-top:6px}

    .dm-input{display:flex; gap:10px; background:linear-gradient(180deg,#1b1c20,#16171a); border:1px solid var(--line); border-radius:16px; padding:10px; margin-top:10px}
    .dm-input input{flex:1; border:none; border-radius:12px; padding:12px; background:#101114; color:#fff; box-shadow:inset 0 0 0 1px #24262c}
    .dm-input button{border:none; border-radius:50%; padding:12px 14px; background:linear-gradient(180deg,var(--brand2),var(--brand)); color:#fff; box-shadow:0 10px 22px var(--glow)}

    /* ============ GALLERY (僅 ▦ 進) ============ */
    #galleryGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:6px}
    #galleryGrid img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; border:1px solid var(--line)}

    /* ============ LIVE ============ */
    .live-host{background:linear-gradient(180deg,#1e2025,#181a1e); border:1px solid var(--line); border-radius:16px; padding:14px; margin-bottom:12px; box-shadow:var(--shadow-soft)}
    .live-host .title{font-weight:900; letter-spacing:.3px; opacity:.9}
    .live-fans{background:#141418; border:1px solid var(--line); border-radius:16px; padding:10px; max-height:40vh; overflow:auto}
    .fan-item{background:#1c1d22; border:1px solid var(--line); border-radius:12px; padding:8px 10px; margin:6px 0}

    /* ============ WALLET ============ */
    .product{background:linear-gradient(180deg,#191a1e,#141417); border:1px solid var(--line); border-radius:16px; padding:12px; margin:10px 0; text-align:left; box-shadow:var(--shadow-soft)}
    .product h4{margin:0 0 6px}
    .ghost{opacity:.8}

    /* ============ MODALS ============ */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; z-index:80;
      background:radial-gradient(1200px 600px at 50% -10%, rgba(224,21,47,.18), transparent 60%), rgba(7,7,9,.78);
      backdrop-filter:blur(8px);
    }
    .modal .box{
      width:min(92vw,520px);
      background:linear-gradient(180deg,#1b1c20,#141417);
      border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow);
      text-align:left;
    }
    .modal h3{margin:0 0 6px}
    .modal p{color:#ddd; line-height:1.5}
    .modal .warn{display:flex; align-items:center; gap:10px; padding:10px; background:rgba(255,204,0,.12); border:1px solid rgba(255,204,0,.35); border-radius:12px}
    .modal .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .hide{display:none!important}

    /* motion */
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important; transition:none!important}
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<section id="login" class="active">
  <div class="panel soft" style="padding:18px">
    <h2 style="margin-bottom:8px">登入</h2>
    <button class="btn btn-red" onclick="login('line')">用 LINE 登入（模擬）</button>
    <div style="margin-top:8px">
      <input id="inviteCode" placeholder="輸入邀請碼，例如 NEXT2025" style="width:70%;max-width:320px">
      <button class="btn" onclick="login('code')">使用邀請碼</button>
    </div>
  </div>
</section>

<!-- HOME -->
<section id="home">
  <div id="friendsHeader" class="panel soft">
    <div class="me">
      <img id="userAvatar" src="https://picsum.photos/80?u=me" alt="頭貼" onclick="openProfile()">
      <div class="nick" id="nickname" onclick="openProfile()">暱稱</div>
    </div>
    <button class="btn" onclick="showPage('wallet')">錢包</button>
  </div>

  <div class="tabs">
    <button id="tab-artists" class="active" onclick="setHomeTab('artists')">藝人</button>
    <button id="tab-groups" onclick="setHomeTab('groups')">團體</button>
    <button id="tab-purchased" onclick="setHomeTab('purchased')">已購買</button>
    <button id="tab-unpurchased" onclick="setHomeTab('unpurchased')">未購買</button>
  </div>

  <div id="homeList" class="grid"></div>
  <div id="homeEmpty" class="ghost" style="padding:12px;display:none">這一類目前是空的～</div>
</section>

<!-- PROFILE -->
<section id="profile">
  <div class="topbar"><h2>我的個人頁</h2></div>
  <div class="panel soft" style="padding:16px; text-align:center">
    <img id="editAvatar" src="https://picsum.photos/160?u=me" style="width:96px;height:96px;border-radius:20px;object-fit:cover; border:1px solid var(--line)"><br/>
    <div style="margin:10px 0">
      <input type="file" id="avatarInput" accept="image/*" onchange="changeAvatar(event)">
    </div>
    <div>
      <input type="text" id="editNickname" placeholder="輸入暱稱" style="width:70%;max-width:320px">
      <button class="btn btn-red" onclick="saveProfile()">儲存</button>
    </div>
    <p class="ghost" style="margin:10px 0 0"><b>粉絲 ID：</b><span id="fanId"></span></p>
    <div style="margin-top:10px"><button class="btn" onclick="showPage('home')">返回 Friends</button></div>
  </div>
</section>

<!-- DM LIST -->
<section id="dmList">
  <div class="topbar"><h2>Messages</h2></div>
  <div id="dmListWrap" class="list-col"></div>
  <div id="dmListEmpty" class="ghost" style="margin-top:12px;display:none">
    目前沒有已開通的 DM。<button class="btn btn-red" onclick="showPage('wallet')">去錢包開通</button>
  </div>
</section>

<!-- DM CHAT -->
<section id="dm">
  <div class="topbar">
    <div class="dm-top">
      <button class="btn btn-ghost" onclick="showPage('dmList')">‹ 返回</button>
      <div class="dm-title" id="dmTitle">ALLDAY PROJECT — 團體 DM</div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <button class="menu-btn" onclick="openGallery()">▦</button>
      <div class="pill"><b>♡</b><span id="heartDays">+0</span></div>
    </div>
  </div>

  <div class="dm-wrap">
    <div id="dm-messages" class="dm-messages"></div>
    <div class="dm-input">
      <input id="dmInput" placeholder="輸入訊息…">
      <button onclick="sendMessage()">➤</button>
    </div>
  </div>
</section>

<!-- GALLERY (僅 ▦ 進) -->
<section id="gallery">
  <div class="topbar">
    <h2>相簿</h2>
    <div style="margin-left:auto"><button class="btn" onclick="showPage('dm')">返回 DM</button></div>
  </div>
  <div id="galleryGrid"></div>
</section>

<!-- LIVE -->
<section id="live">
  <div class="topbar"><h2>LIVE</h2></div>
  <div class="live-host">
    <div class="title">主播訊息</div>
    <div id="liveHostMsg" style="font-size:18px;line-height:1.55;margin-top:6px;min-height:40px">等待開播…</div>
    <div id="liveHostTime" class="ghost" style="margin-top:6px;font-size:12px"></div>
  </div>

  <div id="liveFans" class="live-fans"></div>

  <div style="position:sticky;bottom:96px; display:flex; gap:10px; margin-top:10px">
    <input id="liveInput" placeholder="發送留言…" style="flex:1; border:none; border-radius:12px; padding:12px; background:#101114; color:#fff; box-shadow:inset 0 0 0 1px #24262c">
    <button class="btn btn-red" onclick="fanSendLive()">送出</button>
  </div>
</section>

<!-- WALLET -->
<section id="wallet">
  <div class="topbar"><h2>錢包</h2><div style="margin-left:auto"><button class="btn" onclick="logout()">登出</button></div></div>
  <div class="panel soft" style="padding:14px">
    <p><b>我的分數：</b><span id="points">0</span></p>
    <div class="product">
      <h4>7 天 DM 權益 — 70 分</h4><button class="btn btn-red" onclick="buyProduct(70,7)">購買</button>
    </div>
    <div class="product">
      <h4>30 天 DM 權益 — 250 分</h4><button class="btn btn-red" onclick="buyProduct(250,30)">購買</button>
    </div>

    <h3 style="margin:18px 0 6px">測試購買捷徑</h3>
    <div class="product"><p>購買「團體」pass</p><button class="btn btn-red" onclick="markPurchased('group',true)">標記已購買（團體）</button></div>
    <div class="product"><p>購買「WOOCHAN」</p><button class="btn btn-red" onclick="markPurchased('wc',true)">標記已購買（WOOCHAN）</button></div>
  </div>
</section>

<!-- 截圖警告 MODAL（首次進 DM 顯示一次） -->
<div id="shotModal" class="modal">
  <div class="box">
    <h3>截圖警告（Screenshot Warning）</h3>
    <div class="warn">
      ⚠️ 你在聊天室內的截圖、轉傳、外流都可能導致權益被停用。請尊重創作者與社群成員。
    </div>
    <p class="ghost" style="margin:8px 0 0">We protect artists and fans. Unauthorized capture/redistribution is prohibited.</p>
    <div class="actions">
      <button class="btn" onclick="dismissShot()">我知道了</button>
      <button class="btn btn-red" onclick="dismissShot(true)">不再提示</button>
    </div>
  </div>
</div>

<!-- NAV -->
<nav id="nav" class="hidden">
  <button onclick="showPage('home')">首頁</button>
  <button onclick="showPage('dmList')">DM</button>
  <button onclick="showPage('live')">直播</button>
  <button onclick="showPage('wallet')">錢包</button>
</nav>

<script>
/* ===== DATA ===== */
const ARTISTS = [
  {id:'wc', name:'WOOCHAN', avatar:'https://picsum.photos/120?u=wc', kind:'artist'},
  {id:'ys', name:'YOUNGSEO', avatar:'https://picsum.photos/120?u=ys', kind:'artist'},
  {id:'an', name:'ANNIE',    avatar:'https://picsum.photos/120?u=an', kind:'artist'},
  {id:'ba', name:'BAILEY',   avatar:'https://picsum.photos/120?u=ba', kind:'artist'},
];
const GROUPS = [{id:'group', name:'ALLDAY PROJECT', avatar:'https://picsum.photos/120?u=grp', kind:'group'}];

/* ===== STATE ===== */
if(!localStorage.getItem('points')) localStorage.setItem('points', 200);
if(!localStorage.getItem('userId')) localStorage.setItem('userId','u_'+Math.random().toString(36).slice(2,10));

/* ===== LOGIN & NAV ===== */
function login(m){
  if(m==='line' || (m==='code' && document.getElementById('inviteCode').value.trim()==='NEXT2025')){
    localStorage.setItem('loggedIn','true');
    if(!localStorage.getItem('fanId')) localStorage.setItem('fanId','FAN'+Math.floor(Math.random()*100000));
    showPage('home');
  }else alert('邀請碼錯誤！');
}
function logout(){ localStorage.removeItem('loggedIn'); showPage('login'); }

function showPage(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const nav=document.getElementById('nav');
  if(localStorage.getItem('loggedIn') && id!=='login') nav.classList.remove('hidden'); else nav.classList.add('hidden');

  // 自動刷新
  if(id==='home'){ renderProfile(); setHomeTab(HOME_TAB||'artists'); }
  if(id==='dmList'){ renderDMList(); }
  if(id==='dm'){ renderHearts(); renderDM(); maybeWarnShot(); }
  if(id==='gallery'){ renderGallery(); }
  if(id==='wallet'){ renderPoints(); }
  if(id==='profile'){ prepProfile(); }
}

/* ===== PROFILE ===== */
function renderProfile(){
  document.getElementById('nickname').textContent = localStorage.getItem('nickname') || '暱稱';
  document.getElementById('userAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/80?u=me';
}
function openProfile(){ showPage('profile'); }
function prepProfile(){
  document.getElementById('editNickname').value = localStorage.getItem('nickname') || '暱稱';
  document.getElementById('editAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/160?u=me';
  document.getElementById('fanId').textContent = localStorage.getItem('fanId');
}
function changeAvatar(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload = ev => { document.getElementById('editAvatar').src = ev.target.result; }; r.readAsDataURL(f);
}
function saveProfile(){
  const name=document.getElementById('editNickname').value.trim();
  if(name) localStorage.setItem('nickname', name);
  localStorage.setItem('avatar', document.getElementById('editAvatar').src);
  showPage('home');
}

/* ===== HOME LIST & FILTER ===== */
let HOME_TAB='artists';
function setHomeTab(tab){
  HOME_TAB=tab;
  ['artists','groups','purchased','unpurchased'].forEach(t=>document.getElementById('tab-'+t).classList.toggle('active', t===tab));
  renderHome();
}
function isPurchased(id){
  if(id==='group') return passActive();
  const p=JSON.parse(localStorage.getItem('purchases')||'{}'); return !!p[id];
}
function renderHome(){
  const list=document.getElementById('homeList'); const empty=document.getElementById('homeEmpty');
  let dataset=[];
  if(HOME_TAB==='artists') dataset=ARTISTS;
  if(HOME_TAB==='groups') dataset=GROUPS;
  if(HOME_TAB==='purchased') dataset=[...GROUPS,...ARTISTS].filter(i=>isPurchased(i.id));
  if(HOME_TAB==='unpurchased') dataset=[...GROUPS,...ARTISTS].filter(i=>!isPurchased(i.id));

  list.innerHTML = dataset.map(i=>`
    <div class="card" onclick="homeCardClick('${i.id}')">
      <div class="row">
        <img src="${i.avatar}" onerror="this.src='https://picsum.photos/120?u=${i.id}'">
        <div>
          <div><b>${i.name}</b></div>
          <div class="badge ${isPurchased(i.id)?'ok':'ng'}">${isPurchased(i.id)?'已購買':'未購買'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = dataset.length ? 'none' : 'block';
}
function homeCardClick(id){ if(isPurchased(id)) openDM(id); else showPage('wallet'); }

/* ===== WALLET ===== */
function renderPoints(){ document.getElementById('points').textContent = localStorage.getItem('points')||'0'; }
function buyProduct(cost, days){
  let p=parseInt(localStorage.getItem('points')||'0',10);
  if(p<cost) return alert('分數不足！');
  p-=cost; localStorage.setItem('points',p);
  localStorage.setItem('purchaseDate', new Date().toISOString().split('T')[0]);
  localStorage.setItem('duration', days);
  alert(`✅ 已購買 ${days} 天 DM 權益！`); renderPoints(); renderHearts();
}
function markPurchased(id, yes=true){
  const map=JSON.parse(localStorage.getItem('purchases')||'{}'); map[id]=!!yes;
  localStorage.setItem('purchases', JSON.stringify(map));
  alert(`已標記 ${id} 為 ${yes?'已購買':'未購買'}`);
}

/* ===== DM LIST & GATING ===== */
function passActive(){
  const start=localStorage.getItem('purchaseDate'); const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0) return false;
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  return Math.floor((t-s)/86400000) <= dur;
}
function renderDMList(){
  const box=document.getElementById('dmListWrap'); const empty=document.getElementById('dmListEmpty');
  const active=passActive();
  const items=[...GROUPS, ...ARTISTS];
  box.innerHTML = items.map(it=>`
    <div class="card" onclick="enterDMFromList('${it.id}')">
      <div class="row">
        <img src="${it.avatar}">
        <div>
          <div><b>${it.name}</b></div>
          <div class="badge ${(it.id==='group'?active:isPurchased(it.id))?'ok':'ng'}">${(it.id==='group'?active:isPurchased(it.id))?'可進入':'未開通'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = (active || Object.values(JSON.parse(localStorage.getItem('purchases')||'{}')).some(Boolean)) ? 'none' : 'block';
}
function enterDMFromList(id){
  if(id==='group'){ if(!passActive()) return showPage('wallet'); }
  else if(!isPurchased(id)) return showPage('wallet');
  openDM(id);
}

/* ===== DM / GALLERY ===== */
function currentArtist(){ return localStorage.getItem('currentArtist') || 'group'; }
function dmKey(){ return `dm_${localStorage.getItem('userId')}_${currentArtist()}`; }
function galleryKey(){ return `gallery_${currentArtist()}`; }

function openDM(id){
  localStorage.setItem('currentArtist', id||'group');
  const title = id==='group' ? 'ALLDAY PROJECT — 團體 DM' : (ARTISTS.find(a=>a.id===id)?.name + ' — DM');
  document.getElementById('dmTitle').textContent = title || 'DM';
  showPage('dm');
}

function passStartTS(){ const d=localStorage.getItem('purchaseDate'); if(!d) return null; const s=new Date(d); s.setHours(0,0,0,0); return s.getTime(); }

function renderDM(){
  if(!localStorage.getItem(dmKey())){
    localStorage.setItem(dmKey(), JSON.stringify([{role:'artist',type:'text',text:'歡迎來到 DM！',trans:'Welcome to DM!',ts:Date.now()}]));
  }
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  const showFrom = currentArtist()==='group' ? passStartTS() : (isPurchased(currentArtist())?0:Infinity);
  const box=document.getElementById('dm-messages'); box.innerHTML='';

  let lastDate='';
  list.filter(m=>!showFrom || (m.ts||0)>=showFrom).forEach(m=>{
    const d=new Date(m.ts||Date.now());
    const D=`${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
    const hh=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if(D!==lastDate){ const chip=document.createElement('div'); chip.className='date-chip'; chip.textContent=D; box.appendChild(chip); lastDate=D; }

    const wrap=document.createElement('div'); wrap.className='msg '+(m.role==='fan'?'me':'artist');
    if(m.type==='image'){
      const img=new Image(); img.src=m.url; img.style="max-width:100%;border-radius:12px;border:1px solid #e5e5e5";
      wrap.appendChild(img);
      if(m.caption){ const c=document.createElement('div'); c.className='sub-balloon'; c.textContent=m.caption; wrap.appendChild(c); }
    }else{
      const main=document.createElement('div'); main.textContent=m.text||''; wrap.appendChild(main);
      if(m.role==='artist' && m.trans){ const sub=document.createElement('div'); sub.className='sub-balloon'; sub.textContent=m.trans; wrap.appendChild(sub); }
    }
    const t=document.createElement('time'); t.textContent=hh; wrap.appendChild(t);
    box.appendChild(wrap);
  });
  requestAnimationFrame(()=>{ box.scrollTop = box.scrollHeight; });
}
function sendMessage(){
  const inp=document.getElementById('dmInput'); const t=(inp.value||'').trim(); if(!t) return;
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  list.push({role:'fan',type:'text',text:t,ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(list)); inp.value=''; renderDM();
}
/* for console tests */
function addArtistMessage(text,translation){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]'); dm.push({role:'artist',type:'text',text,trans:translation||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm)); renderDM();
}
function addArtistImage(url,caption){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]'); dm.push({role:'artist',type:'image',url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm));
  const gal=JSON.parse(localStorage.getItem(galleryKey())||'[]'); gal.push({url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(galleryKey(), JSON.stringify(gal)); renderDM();
}

function openGallery(){ showPage('gallery'); renderGallery(); }
function renderGallery(){
  const grid=document.getElementById('galleryGrid');
  const list=JSON.parse(localStorage.getItem(galleryKey())||'[]');
  grid.innerHTML = list.length? list.slice().reverse().map(i=>`<img src="${i.url}" onerror="this.src='https://picsum.photos/400?ph'">`).join('') : '<div class="ghost">還沒有照片</div>';
}

/* ===== LIVE ===== */
function hostPushLive(text){
  document.getElementById('liveHostMsg').textContent = text;
  document.getElementById('liveHostTime').textContent = new Date().toLocaleString();
}
function fanSendLive(){
  const inp=document.getElementById('liveInput'); const t=(inp.value||'').trim(); if(!t) return;
  const box=document.getElementById('liveFans');
  const item=document.createElement('div'); item.className='fan-item';
  item.innerHTML=`<b>${localStorage.getItem('nickname')||'粉絲'}</b><div style="opacity:.9">${t}</div>
                  <div style="font-size:12px;opacity:.6;margin-top:4px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(item); box.scrollTop=box.scrollHeight; inp.value='';
}

/* ===== HEARTS ===== */
function renderHearts(){
  const el=document.getElementById('heartDays'); if(!el) return;
  const start=localStorage.getItem('purchaseDate'); const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0){ el.textContent='+0'; return; }
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  const n=Math.floor((t-s)/86400000); el.textContent = (n<=dur)?`+${n}`:'+0';
}

/* ===== SCREENSHOT WARNING ===== */
function maybeWarnShot(){
  const key='shotWarnDismissed';
  if(localStorage.getItem(key)==='true') return;
  document.getElementById('shotModal').style.display='grid';
}
function dismissShot(remember=false){
  if(remember) localStorage.setItem('shotWarnDismissed','true');
  document.getElementById('shotModal').style.display='none';
}

/* ===== BOOT ===== */
window.addEventListener('load', ()=>{ if(localStorage.getItem('loggedIn')) showPage('home'); else showPage('login'); });
</script>
 <!-- 🚀 開場動畫：NEXT 固定 + 'S YOU 翻轉出現 -->
<div id="splash">
  <div class="stage">
    <span class="next">NEXT</span>
    <span id="one" class="one">ONE</span>
    <span id="syou" class="syou">’S YOU</span>
  </div>
</div>

<style>
  #splash {
    position: fixed; inset: 0; background: #000;
    display: flex; justify-content: center; align-items: center;
    z-index: 9999;
  }
  .stage {
    font-weight: 700; font-size: 44px; color: #fff;
    display: flex; gap: 20px; align-items: center;
  }
  .next { color: #fff; }
  .one { opacity: 0; }
  .syou { opacity: 0; color: #e42323; transform: rotateY(90deg); }

  /* 動畫定義 */
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  @keyframes fadeOut { from{opacity:1} to{opacity:0} }
  @keyframes flipIn {
    from { opacity:0; transform: rotateY(90deg); }
    to   { opacity:1; transform: rotateY(0deg); }
  }
</style>

<script>
  const one = document.getElementById("one");
  const syou = document.getElementById("syou");
  const splash = document.getElementById("splash");

  // Step 1: 顯示 NEXT ONE
  one.style.animation = "fadeIn 600ms ease forwards";

  // Step 2: ONE 消失，'S YOU 翻轉進場
  setTimeout(()=>{
    one.style.animation = "fadeOut 400ms ease forwards";
    setTimeout(()=>{
      syou.style.animation = "flipIn 600ms ease forwards";
    }, 400);
  }, 1200);

  // Step 3: 最後淡出整個開場
  setTimeout(()=>{
    splash.style.transition = "opacity 400ms ease";
    splash.style.opacity = "0";
    setTimeout(()=> splash.remove(), 450);
  }, 2800);
</script>
</body>
</html>
