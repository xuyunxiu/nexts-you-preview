<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>NEXT'S YOU â€” Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ğŸš« é˜²å¿«å– -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#111;--panel:#1a1a1a;--ui:#222;--text:#fff;--muted:#aaa;--brand:#e02020;
      --bubble:#5a4036;--tea:#4b433f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
    section{display:none;padding:16px 16px 84px}
    section.active{display:block}
    h2{margin:0 0 8px}

    /* åº•éƒ¨å°è¦½ï¼ˆä¸å«ç›¸ç°¿ï¼‰ */
    nav{position:fixed;left:0;right:0;bottom:0;background:#1b1b1b;
        border-top:1px solid #2a2a2a;display:flex;justify-content:space-around;padding:10px}
    nav.hidden{display:none}
    nav button{background:none;border:none;color:#fff}

    /* Friends é ï¼šå€‹äººé ­ï¼‹æš±ç¨± */
    #friendsHeader{display:flex;justify-content:space-between;align-items:center;
      background:var(--panel);border:1px solid #2a2a2a;border-radius:12px;padding:10px;margin-bottom:10px}
    #friendsHeader img{width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer}
    #friendsHeader span{cursor:pointer;font-weight:700}

    /* Friends åˆ†é èˆ‡å¡ç‰‡ */
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs button{flex:1;background:#2a2a2a;border:none;color:#ddd;padding:10px;border-radius:10px}
    .tabs button.active{background:var(--brand);color:#fff}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--panel);border:1px solid #2a2a2a;border-radius:12px;padding:12px;text-align:left;cursor:pointer}
    .card .row{display:flex;gap:10px;align-items:center}
    .card img{width:52px;height:52px;border-radius:12px;object-fit:cover}
    .badge{display:inline-block;margin-top:6px;font-size:12px;padding:4px 8px;border-radius:999px;background:#2a2a2a;opacity:.9}
    .ok{background:#214d2d;color:#b9ffd0}.ng{background:#44302f;color:#ffd6d2}

    /* DM åˆ—è¡¨ */
    .list-col{display:flex;flex-direction:column;gap:12px}

    /* DM èŠå¤© */
    .dm-top{display:flex;justify-content:space-between;align-items:center;gap:10px;background:var(--ui);padding:10px;border-radius:10px}
    .dm-title{font-weight:700}
    .menu-btn{background:#333;border:none;color:#fff;border-radius:10px;padding:6px 10px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#4a403c;border:1px solid rgba(255,255,255,.12);border-radius:14px}
    .pill b{color:#ff7d7d}
    .dm-wrap{display:flex;flex-direction:column;height:calc(100vh - 180px)}
    .dm-messages{flex:1;overflow:auto;background:var(--panel);padding:12px;border-radius:12px;text-align:left}
    .msg{max-width:75%;padding:10px 14px;border-radius:16px;margin:6px 0;font-size:15px;line-height:1.4;word-break:break-word}
    .msg.me{background:var(--bubble);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
    .msg.artist{background:#fff;color:#111;border-bottom-left-radius:4px}
    .sub-balloon{margin-top:6px;padding:8px 12px;background:#eee;color:#555;border-radius:12px;font-size:13px;line-height:1.3}
    .dm-input{display:flex;gap:10px;background:var(--ui);padding:10px;border-radius:12px;margin-top:10px}
    .dm-input input{flex:1;border:none;border-radius:16px;padding:10px;background:#1d1d1d;color:#fff}
    .dm-input button{border:none;border-radius:50%;background:var(--brand);color:#fff;padding:10px 14px}

    /* ç›¸ç°¿ï¼ˆåƒ…å­é å­˜åœ¨ï¼Œç„¡ navï¼‰ */
    #galleryGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    #galleryGrid img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px}

    /* ç›´æ’­ */
    .live-host{background:#222;border:1px solid #2a2a2a;border-radius:12px;padding:14px;margin-bottom:12px}
    .live-fans{background:#1a1a1a;border-radius:12px;padding:10px;max-height:40vh;overflow:auto}
    .fan-item{background:#222;border:1px solid #2a2a2a;border-radius:10px;padding:8px 10px;margin:6px 0}

    /* éŒ¢åŒ… */
    .product{background:#1c1c1c;border:1px solid #2a2a2a;border-radius:12px;padding:12px;margin:10px 0;text-align:left}
    .btn{border:none;border-radius:10px;padding:8px 12px;background:#333;color:#fff}
    .btn-red{background:var(--brand)}
  </style>
</head>
<body>

<!-- ç™»å…¥ -->
<section id="login" class="active">
  <h2>ç™»å…¥</h2>
  <button class="btn btn-red" onclick="login('line')">ç”¨ LINE ç™»å…¥ï¼ˆæ¨¡æ“¬ï¼‰</button><br/>
  <input id="inviteCode" placeholder="è¼¸å…¥é‚€è«‹ç¢¼ï¼Œä¾‹å¦‚ NEXT2025" />
  <button class="btn" onclick="login('code')">ä½¿ç”¨é‚€è«‹ç¢¼</button>
</section>

<!-- Friends é¦–é  -->
<section id="home">
  <div id="friendsHeader">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="userAvatar" src="https://picsum.photos/80?u=me" alt="é ­è²¼" onclick="openProfile()">
      <span id="nickname" onclick="openProfile()">æš±ç¨±</span>
    </div>
    <button class="btn" onclick="showPage('wallet')">éŒ¢åŒ…</button>
  </div>

  <div class="tabs">
    <button id="tab-artists" class="active" onclick="setHomeTab('artists')">è—äºº</button>
    <button id="tab-groups" onclick="setHomeTab('groups')">åœ˜é«”</button>
    <button id="tab-purchased" onclick="setHomeTab('purchased')">å·²è³¼è²·</button>
    <button id="tab-unpurchased" onclick="setHomeTab('unpurchased')">æœªè³¼è²·</button>
  </div>

  <div id="homeList" class="grid"></div>
  <div id="homeEmpty" style="padding:12px;opacity:.7;display:none">é€™ä¸€é¡ç›®å‰æ˜¯ç©ºçš„ï½</div>
</section>

<!-- å€‹äººé  -->
<section id="profile">
  <h2>æˆ‘çš„å€‹äººé </h2>
  <div style="margin:10px 0">
    <img id="editAvatar" src="https://picsum.photos/160?u=me" style="width:96px;height:96px;border-radius:20px;object-fit:cover"><br/>
    <input type="file" id="avatarInput" accept="image/*" onchange="changeAvatar(event)">
  </div>
  <div>
    <input type="text" id="editNickname" placeholder="è¼¸å…¥æš±ç¨±">
    <button class="btn btn-red" onclick="saveProfile()">å„²å­˜</button>
  </div>
  <p><b>ç²‰çµ² IDï¼š</b><span id="fanId"></span></p>
  <button class="btn" onclick="showPage('home')">è¿”å› Friends</button>
</section>

<!-- DM åˆ—è¡¨ï¼ˆåº•éƒ¨ DM å…ˆåˆ°é€™ï¼‰ -->
<section id="dmList">
  <div class="dm-top"><h2>Messages</h2></div>
  <div id="dmListWrap" class="list-col"></div>
  <div id="dmListEmpty" style="opacity:.7;margin-top:12px;display:none">
    ç›®å‰æ²’æœ‰å·²é–‹é€šçš„ DMã€‚<button class="btn btn-red" onclick="showPage('wallet')">å»éŒ¢åŒ…é–‹é€š</button>
  </div>
</section>

<!-- DM èŠå¤© -->
<section id="dm">
  <div class="dm-top">
    <button class="btn" onclick="showPage('dmList')">â€¹</button>
    <div class="dm-title" id="dmTitle">ALLDAY PROJECT â€” åœ˜é«” DM</div>
    <div class="dm-icons" style="display:flex;align-items:center;gap:10px">
      <button class="menu-btn" onclick="openGallery()">â–¦</button>
      <div class="pill"><b>â™¡</b><span id="heartDays">+0</span></div>
    </div>
  </div>

  <div class="dm-wrap">
    <div id="dm-messages" class="dm-messages"></div>
    <div class="dm-input">
      <input id="dmInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦">
      <button onclick="sendMessage()">â¤</button>
    </div>
  </div>
</section>

<!-- ç›¸ç°¿ï¼ˆç„¡ navï¼Œåªèƒ½ç”± â–¦ æ‰“é–‹ï¼‰ -->
<section id="gallery">
  <div class="dm-top"><h2>ç›¸ç°¿</h2><button class="btn" onclick="showPage('dm')">è¿”å› DM</button></div>
  <div id="galleryGrid"></div>
</section>

<!-- ç›´æ’­ -->
<section id="live">
  <div class="dm-top"><h2>LIVE</h2></div>
  <div class="live-host">
    <div class="badge" style="background:#2a2a2a">ä¸»æ’­è¨Šæ¯</div>
    <div id="liveHostMsg" style="font-size:18px;line-height:1.5;margin-top:6px;min-height:40px">ç­‰å¾…é–‹æ’­â€¦</div>
    <div id="liveHostTime" style="opacity:.7;margin-top:6px;font-size:12px"></div>
  </div>
  <div id="liveFans" class="live-fans"></div>
  <div style="position:sticky;bottom:84px;display:flex;gap:10px;margin-top:8px">
    <input id="liveInput" placeholder="ç™¼é€ç•™è¨€â€¦" style="flex:1;border:none;border-radius:12px;padding:10px;background:#1d1d1d;color:#fff">
    <button class="btn btn-red" onclick="fanSendLive()">é€å‡º</button>
  </div>
</section>

<!-- éŒ¢åŒ… -->
<section id="wallet">
  <div class="dm-top"><h2>éŒ¢åŒ…</h2><button class="btn" style="margin-left:auto" onclick="logout()">ç™»å‡º</button></div>
  <p><b>æˆ‘çš„åˆ†æ•¸ï¼š</b><span id="points">0</span></p>
  <div class="product"><p>7å¤© DM æ¬Šç›Š â€” 70 åˆ†</p><button class="btn btn-red" onclick="buyProduct(70,7)">è³¼è²·</button></div>
  <div class="product"><p>30å¤© DM æ¬Šç›Š â€” 250 åˆ†</p><button class="btn btn-red" onclick="buyProduct(250,30)">è³¼è²·</button></div>

  <!-- æ¸¬è©¦è³¼è²·ï¼šå…¨åŸŸåœ˜é«” pass / æŒ‡å®šè—äºº -->
  <h3 style="margin-top:18px">æ¸¬è©¦è³¼è²·æ·å¾‘</h3>
  <div class="product"><p>è³¼è²·ã€Œåœ˜é«”ã€pass</p><button class="btn btn-red" onclick="markPurchased('group',true)">æ¨™è¨˜å·²è³¼è²·ï¼ˆåœ˜é«”ï¼‰</button></div>
  <div class="product"><p>è³¼è²·ã€ŒWOOCHANã€</p><button class="btn btn-red" onclick="markPurchased('wc',true)">æ¨™è¨˜å·²è³¼è²·ï¼ˆWOOCHANï¼‰</button></div>
</section>

<!-- åº•éƒ¨å°è¦½ï¼ˆç„¡ç›¸ç°¿æŒ‰éˆ•ï¼‰ -->
<nav id="nav" class="hidden">
  <button onclick="showPage('home')">é¦–é </button>
  <button onclick="showPage('dmList')">DM</button>
  <button onclick="showPage('live')">ç›´æ’­</button>
  <button onclick="showPage('wallet')">éŒ¢åŒ…</button>
</nav>

<script>
/* ====== å‡è³‡æ–™ï¼šè—äººèˆ‡åœ˜é«” ====== */
const ARTISTS = [
  {id:'wc', name:'WOOCHAN', avatar:'https://picsum.photos/120?u=wc', kind:'artist'},
  {id:'ys', name:'YOUNGSEO', avatar:'https://picsum.photos/120?u=ys', kind:'artist'},
  {id:'an', name:'ANNIE', avatar:'https://picsum.photos/120?u=an', kind:'artist'},
  {id:'ba', name:'BAILEY', avatar:'https://picsum.photos/120?u=ba', kind:'artist'},
];
const GROUPS = [{id:'group', name:'ALLDAY PROJECT', avatar:'https://picsum.photos/120?u=grp', kind:'group'}];

/* ====== ç‹€æ…‹ï¼šç™»å…¥ã€åˆ†æ•¸ã€ç”¨æˆ¶ID ====== */
if(!localStorage.getItem('points')) localStorage.setItem('points', 200);
if(!localStorage.getItem('userId')) localStorage.setItem('userId','u_'+Math.random().toString(36).slice(2,10));

/* ====== Login / Nav / Page ====== */
function login(method){
  if(method==='line' || (method==='code' && (document.getElementById('inviteCode').value.trim()==='NEXT2025'))){
    localStorage.setItem('loggedIn','true');
    if(!localStorage.getItem('fanId')) localStorage.setItem('fanId','FAN'+Math.floor(Math.random()*100000));
    showPage('home');
  }else alert('é‚€è«‹ç¢¼éŒ¯èª¤ï¼');
}
function logout(){ localStorage.removeItem('loggedIn'); showPage('login'); }

function showPage(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const nav=document.getElementById('nav');
  if(localStorage.getItem('loggedIn') && id!=='login') nav.classList.remove('hidden'); else nav.classList.add('hidden');

  // æ¯æ¬¡åˆ‡é è‡ªå‹•åˆ·æ–°
  if(id==='home'){ renderProfile(); setHomeTab(HOME_TAB||'artists'); }
  if(id==='dmList'){ renderDMList(); }
  if(id==='dm'){ renderHearts(); renderDM(); }
  if(id==='gallery'){ renderGallery(); }
  if(id==='wallet'){ renderPoints(); }
  if(id==='profile'){ prepProfile(); }
}

/* ====== å€‹äººé  ====== */
function renderProfile(){
  document.getElementById('nickname').textContent = localStorage.getItem('nickname') || 'æš±ç¨±';
  document.getElementById('userAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/80?u=me';
}
function openProfile(){ showPage('profile'); }
function prepProfile(){
  document.getElementById('editNickname').value = localStorage.getItem('nickname') || 'æš±ç¨±';
  document.getElementById('editAvatar').src = localStorage.getItem('avatar') || 'https://picsum.photos/160?u=me';
  document.getElementById('fanId').textContent = localStorage.getItem('fanId');
}
function changeAvatar(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload = ev => { document.getElementById('editAvatar').src = ev.target.result; }; r.readAsDataURL(f);
}
function saveProfile(){
  const name = document.getElementById('editNickname').value.trim();
  if(name) localStorage.setItem('nickname', name);
  localStorage.setItem('avatar', document.getElementById('editAvatar').src);
  showPage('home');
}

/* ====== Friends é¦–é ï¼šåˆ†é èˆ‡å¡ç‰‡ ====== */
let HOME_TAB = 'artists';
function setHomeTab(tab){
  HOME_TAB = tab;
  ['artists','groups','purchased','unpurchased'].forEach(t=>document.getElementById('tab-'+t).classList.toggle('active', t===tab));
  renderHome();
}
function isPurchased(id){
  if(id==='group') return passActive(); // åœ˜é«”çœ‹å…¨åŸŸ pass
  const p = JSON.parse(localStorage.getItem('purchases')||'{}');
  return !!p[id];
}
function renderHome(){
  const list=document.getElementById('homeList'); const empty=document.getElementById('homeEmpty');
  let dataset=[];
  if(HOME_TAB==='artists') dataset=ARTISTS;
  if(HOME_TAB==='groups') dataset=GROUPS;
  if(HOME_TAB==='purchased') dataset=[...GROUPS,...ARTISTS].filter(i=>isPurchased(i.id));
  if(HOME_TAB==='unpurchased') dataset=[...GROUPS,...ARTISTS].filter(i=>!isPurchased(i.id));

  list.innerHTML = dataset.map(i=>`
    <div class="card" onclick="homeCardClick('${i.id}')">
      <div class="row">
        <img src="${i.avatar}" onerror="this.src='https://picsum.photos/120?u=${i.id}'">
        <div>
          <div><b>${i.name}</b></div>
          <div class="badge ${isPurchased(i.id)?'ok':'ng'}">${isPurchased(i.id)?'å·²è³¼è²·':'æœªè³¼è²·'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = dataset.length ? 'none' : 'block';
}
function homeCardClick(id){ if(isPurchased(id)) openDM(id); else showPage('wallet'); }

/* ====== éŒ¢åŒ… / è³¼è²· ====== */
function renderPoints(){ document.getElementById('points').textContent = localStorage.getItem('points')||'0'; }
function buyProduct(cost, days){
  let p=parseInt(localStorage.getItem('points')||'0',10);
  if(p<cost) return alert('åˆ†æ•¸ä¸è¶³ï¼');
  p-=cost; localStorage.setItem('points',p);
  localStorage.setItem('purchaseDate', new Date().toISOString().split('T')[0]);
  localStorage.setItem('duration', days);
  alert(`âœ… å·²è³¼è²· ${days} å¤© DM æ¬Šç›Šï¼`);
  renderPoints(); renderHearts();
}
// å€‹åˆ¥è—äººè³¼è²·æ¨™è¨˜
function markPurchased(id, yes=true){
  const map = JSON.parse(localStorage.getItem('purchases')||'{}'); map[id]=!!yes;
  localStorage.setItem('purchases', JSON.stringify(map));
  alert(`å·²æ¨™è¨˜ ${id} ç‚º ${yes?'å·²è³¼è²·':'æœªè³¼è²·'}`);
}

/* ====== DM åˆ—è¡¨ & gating ====== */
function passActive(){
  const start=localStorage.getItem('purchaseDate');
  const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0) return false;
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  return Math.floor((t-s)/86400000) <= dur;
}
function renderDMList(){
  const box=document.getElementById('dmListWrap'); const empty=document.getElementById('dmListEmpty');
  const active = passActive();
  const items=[...GROUPS, ...ARTISTS];
  box.innerHTML = items.map(it=>`
    <div class="card" onclick="enterDMFromList('${it.id}')">
      <div class="row">
        <img src="${it.avatar}">
        <div>
          <div><b>${it.name}</b></div>
          <div class="badge ${ (it.id==='group'?active:isPurchased(it.id)) ? 'ok':'ng' }">${ (it.id==='group'?active:isPurchased(it.id)) ? 'å¯é€²å…¥':'æœªé–‹é€š'}</div>
        </div>
      </div>
    </div>`).join('');
  empty.style.display = (active || Object.values(JSON.parse(localStorage.getItem('purchases')||'{}')).some(Boolean)) ? 'none':'block';
}
function enterDMFromList(id){
  if(id==='group'){ if(!passActive()) return showPage('wallet'); }
  else if(!isPurchased(id)) return showPage('wallet');
  openDM(id);
}

/* ====== DMï¼šæ¯äººÃ—æ¯è—äºº keyã€æ¸²æŸ“ã€ç›¸ç°¿åŒæ­¥ ====== */
function currentArtist(){ return localStorage.getItem('currentArtist') || 'group'; }
function dmKey(){ return `dm_${localStorage.getItem('userId')}_${currentArtist()}`; }
function galleryKey(){ return `gallery_${currentArtist()}`; }

function openDM(id){
  localStorage.setItem('currentArtist', id||'group');
  const title = id==='group' ? 'ALLDAY PROJECT â€” åœ˜é«” DM' : (ARTISTS.find(a=>a.id===id)?.name + ' â€” DM');
  document.getElementById('dmTitle').textContent = title || 'DM';
  showPage('dm');
}
function passStartTS(){ const d=localStorage.getItem('purchaseDate'); if(!d) return null; const s=new Date(d); s.setHours(0,0,0,0); return s.getTime(); }

function renderDM(){
  // ç¨®å­
  if(!localStorage.getItem(dmKey())){
    localStorage.setItem(dmKey(), JSON.stringify([{role:'artist',type:'text',text:'æ­¡è¿ä¾†åˆ° DMï¼',trans:'Welcome to DM!',ts:Date.now()}]));
  }
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  const showFrom = currentArtist()==='group' ? passStartTS() : (isPurchased(currentArtist())?0:Infinity);
  const box=document.getElementById('dm-messages'); box.innerHTML='';

  let lastDate='';
  list.filter(m=>!showFrom || (m.ts||0)>=showFrom).forEach(m=>{
    const d=new Date(m.ts||Date.now());
    const D=`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    const hh=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if(D!==lastDate){
      const chip=document.createElement('div');
      chip.style.cssText="align-self:center;background:var(--tea);color:#efe8e3;padding:6px 12px;border-radius:14px;font-size:12px;margin:6px 0 2px;opacity:.9;";
      chip.textContent=D; box.appendChild(chip); lastDate=D;
    }
    const wrap=document.createElement('div'); wrap.className='msg '+(m.role==='fan'?'me':'artist');
    if(m.type==='image'){
      const img=new Image(); img.src=m.url; img.style="max-width:100%;border-radius:10px;"; wrap.appendChild(img);
      if(m.caption){ const c=document.createElement('div'); c.className='sub-balloon'; c.textContent=m.caption; wrap.appendChild(c); }
    }else{
      const main=document.createElement('div'); main.textContent=m.text||''; wrap.appendChild(main);
      if(m.role==='artist' && m.trans){ const sub=document.createElement('div'); sub.className='sub-balloon'; sub.textContent=m.trans; wrap.appendChild(sub); }
    }
    const time=document.createElement('div'); time.style.cssText="text-align:right;font-size:12px;opacity:.7;margin-top:4px;"; time.textContent=hh; wrap.appendChild(time);
    box.appendChild(wrap);
  });
  requestAnimationFrame(()=>{ box.scrollTop = box.scrollHeight; }); // è‡ªå‹•æ²åº•
}
function sendMessage(){
  const inp=document.getElementById('dmInput'); const t=(inp.value||'').trim(); if(!t) return;
  const list=JSON.parse(localStorage.getItem(dmKey())||'[]');
  list.push({role:'fan',type:'text',text:t,ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(list)); inp.value=''; renderDM();
}
// æ¸¬è©¦ï¼šè—äººè¨Šæ¯ï¼åœ–ç‰‡ï¼ˆåœ–ç‰‡æœƒåŒæ­¥åˆ°ç›¸ç°¿ï¼‰
function addArtistMessage(text,translation){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]');
  dm.push({role:'artist',type:'text',text,trans:translation||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm)); renderDM();
}
function addArtistImage(url,caption){
  const dm=JSON.parse(localStorage.getItem(dmKey())||'[]');
  dm.push({role:'artist',type:'image',url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(dmKey(), JSON.stringify(dm));
  const gal=JSON.parse(localStorage.getItem(galleryKey())||'[]'); gal.push({url,caption:caption||'',ts:Date.now()});
  localStorage.setItem(galleryKey(), JSON.stringify(gal));
  renderDM();
}

/* ====== ç›¸ç°¿ï¼ˆåƒ… â–¦ é–‹å•Ÿï¼‰ ====== */
function openGallery(){ showPage('gallery'); renderGallery(); }
function renderGallery(){
  const grid=document.getElementById('galleryGrid');
  const list=JSON.parse(localStorage.getItem(galleryKey())||'[]');
  grid.innerHTML = list.length? list.slice().reverse().map(i=>`<img src="${i.url}" onerror="this.src='https://picsum.photos/400?ph'">`).join('')
                              : '<div style="opacity:.6;">é‚„æ²’æœ‰ç…§ç‰‡</div>';
}

/* ====== ç›´æ’­ï¼ˆä¸»æ’­å¤§æ¡† + ç²‰çµ²ç•™è¨€ï¼‰ ====== */
function hostPushLive(text){
  document.getElementById('liveHostMsg').textContent = text;
  document.getElementById('liveHostTime').textContent = new Date().toLocaleString();
}
function fanSendLive(){
  const inp=document.getElementById('liveInput'); const t=(inp.value||'').trim(); if(!t) return;
  const box=document.getElementById('liveFans');
  const item=document.createElement('div'); item.className='fan-item';
  item.innerHTML=`<b>${localStorage.getItem('nickname')||'ç²‰çµ²'}</b><div style="opacity:.85">${t}</div>
                  <div style="font-size:12px;opacity:.6;margin-top:4px">${new Date().toLocaleTimeString()}</div>`;
  box.appendChild(item); box.scrollTop=box.scrollHeight; inp.value='';
}

/* ====== Hearts (â™¡+N) ====== */
function renderHearts(){
  const el=document.getElementById('heartDays'); if(!el) return;
  const start=localStorage.getItem('purchaseDate'); const dur=parseInt(localStorage.getItem('duration')||'0',10);
  if(!start||dur<=0){ el.textContent='+0'; return; }
  const s=new Date(start), t=new Date(); s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  const n=Math.floor((t-s)/86400000); el.textContent = (n<=dur)?`+${n}`:'+0';
}

/* ====== å•Ÿå‹• ====== */
window.addEventListener('load', ()=>{
  if(localStorage.getItem('loggedIn')) showPage('home'); else showPage('login');
});
</script>
</body>
</html>
