<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NEXTâ€™S YOU â€” Fan App (å–®é ç‰ˆ)</title>

  <!-- ===============================
       ==========  GLOBAL CSS  =========
       =============================== -->
  <style>
    /* ---------- Theme ---------- */
    :root{
      --bg:#f5f7ff;
      --card:#fff;
      --text:#1a1a1a;
      --sub:#666;
      --line:#e6e8ef;
      --ghost:#9aa0b4;
      --accent:#6a5acd;     /* è—ç´« */
      --accent2:#836fff;
      --danger:#ff4d4f;
      --ok:#1abc9c;
      --hover:#eef1ff;
      --fan:#ffffff;        /* ç²‰çµ²ç•™è¨€èƒŒæ™¯ */
      --artist:#efe7ff;     /* è—äººç•™è¨€èƒŒæ™¯ï¼ˆæ·¡ç´«ï¼‰ */
      --radius:16px;
      --shadow:0 10px 35px rgba(26,26,26,.08);
    }

    /* ---------- Reset ---------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    img{display:block; max-width:100%}
    button{font:inherit}
    a{color:inherit; text-decoration:none}

    /* ---------- Utilities ---------- */
    .ghost{color:var(--ghost)}
    .sub{color:var(--sub)}
    .row{display:flex; align-items:center; gap:12px}
    .wrap{padding:12px}
    .hidden{display:none !important}
    .soft{padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--hover); border:1px solid var(--line); font-size:12px}
    .divider{height:1px; background:var(--line); margin:12px 0}

    /* ---------- Page & Nav ---------- */
    section.page{display:none; padding:12px 12px 88px}
    section.page.active{display:block; animation:fadeIn .24s ease}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    nav#nav{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--card); border-top:1px solid var(--line);
      display:flex; justify-content:space-around; padding:10px 8px 14px; gap:6px;
      backdrop-filter:saturate(140%) blur(10px);
      transition:transform .28s ease;
      z-index:40;
    }
    nav#nav.hidden{transform:translateY(120%)}
    nav#nav button{
      flex:1; border:none; background:transparent; padding:8px 0 6px; border-radius:12px; cursor:pointer;
      color:var(--sub); font-weight:800; font-size:13px;
    }
    nav#nav button.active{color:var(--accent); background:var(--hover); border:1px solid var(--line)}

    /* ---------- Home Header (Me bar) ---------- */
    #homeHeader{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 6px 8px}
    #homeHeader .me{display:flex; align-items:center; gap:10px}
    #homeHeader .me img{width:44px; height:44px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    #homeHeader .me .id{font-size:12px; color:var(--ghost)}
    #homeHeader .right{display:flex; align-items:center; gap:8px}

    /* ---------- StoryBar / åˆ†é¡åœˆåœˆ ---------- */
    #storyWrap{position:sticky; top:0; z-index:30; background:linear-gradient(180deg,rgba(245,247,255,.98),rgba(245,247,255,.92)); backdrop-filter:blur(6px)}
    #storyBar{
      display:flex; gap:12px; overflow-x:auto; padding:10px 8px 12px; scroll-snap-type:x proximity;
      -webkit-overflow-scrolling:touch;
      border-bottom:1px solid var(--line);
      /* éš±è—æ°´å¹³æ²è»¸çš„ç°æ¢ï¼ˆå„ç€è¦½å™¨ï¼‰ */
      scrollbar-width:none; /* Firefox */
    }
    #storyBar::-webkit-scrollbar{display:none} /* WebKit */
    .story-item{flex:0 0 auto; width:64px; text-align:center; cursor:pointer; scroll-snap-align:center}
    .story-item img{width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid var(--accent)}
    .story-item .name{font-size:12px; margin-top:4px; color:var(--sub)}
    .story-item.all img{border-color:#111}

    /* ---------- Feed / è²¼æ–‡å¡ç‰‡ ---------- */
    .postCard{margin:12px 6px; cursor:pointer}
    .postCard .hdr{display:flex; align-items:center; gap:10px; position:relative}
    .postCard .avatar{width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    .postCard .meta b{font-weight:900}
    .postCard .meta small{display:block; color:var(--ghost)}
    .translate-btn{
      position:absolute; right:0; top:0; transform:translateY(2px);
      font-size:12px; border:1px solid var(--line); background:var(--hover); border-radius:12px; padding:4px 8px; cursor:pointer;
    }
    .postCard .body{margin-top:8px}
    .postCard .body p{margin:8px 0 0}
    .postCard .hero{width:100%; height:400px; object-fit:cover; border-radius:12px; border:1px solid var(--line)}
    .reaction-bar{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .reaction{
      display:flex; flex-direction:column; align-items:center; gap:4px; min-width:54px;
      padding:6px 10px; border:1px solid var(--line); background:var(--hover); border-radius:12px; cursor:pointer;
      user-select:none;
    }
    .reaction.active{background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff}
    .reaction .count{font-weight:800; font-size:12px}

    /* ---------- Post Detail ---------- */
    #postDetail .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #postDetail .topbar .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .comments-head{display:flex; align-items:center; justify-content:space-between; margin:10px 0 12px}
    .switch{position:relative; width:46px; height:26px}
    .switch input{opacity:0; width:0; height:0}
    .slider{position:absolute; inset:0; background:#cfd3e1; border-radius:999px; transition:.2s}
    .slider:before{content:""; position:absolute; width:20px; height:20px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    .citem{border:1px solid var(--line); border-radius:12px; padding:10px; background:linear-gradient(180deg,var(--card),var(--hover)); margin-bottom:10px}
    .citem.artist{background:linear-gradient(180deg,#ece6ff,#f6f3ff); border-color:#c4b6ff}
    .citem .u{display:flex; align-items:center; gap:10px; margin-bottom:6px}
    .citem .u img{width:36px; height:36px; border-radius:50%; border:1px solid var(--line); object-fit:cover}
    .citem .name{font-weight:800}
    .citem .c-actions{display:flex; align-items:center; gap:8px; margin-top:6px}
    .comment-input{position:sticky; bottom:0; left:0; right:0; padding:12px; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px); border-top:1px solid var(--line); display:flex; gap:8px}
    .comment-input input{flex:1; border:1px solid var(--line); background:var(--hover); padding:12px 14px; border-radius:16px}
    .comment-input button{min-width:64px; border:none; border-radius:12px; background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; font-weight:900; cursor:pointer}

    /* ---------- DM List ---------- */
    #dm .dmCard{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border:1px solid var(--line); border-radius:14px; background:var(--card); margin:10px 0; cursor:pointer;
    }
    #dm .dmCard .left{display:flex; align-items:center; gap:12px}
    #dm .dmCard img{width:52px; height:52px; border-radius:50%; object-fit:cover; border:1px solid var(--line)}
    #dm .dmCard .meta b{display:block}
    #dm .dmCard .meta small{color:var(--ghost)}
    #dm .dmRight{display:flex; align-items:center; gap:10px}
    .badge{background:#ff3b30; color:#fff; font-size:12px; padding:2px 7px; border-radius:999px; min-width:22px; text-align:center}
    .heartDays{color:var(--danger); font-weight:800}
    .heartDays::before{content:"â¤ï¸ ";}

    /* ---------- DM Detail ---------- */
    #dmDetail .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #dmDetail .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .dmThread{padding:8px 2px 8px; display:flex; flex-direction:column; gap:8px; height:calc(100vh - 180px); overflow-y:auto}
    .dmMsg{display:flex}
    .dmMsg .bubble{max-width:72%; padding:10px 12px; border-radius:14px; position:relative}
    .dmMsg.left .bubble{background:var(--artist); margin-right:auto}
    .dmMsg.right .bubble{background:var(--accent); color:#fff; margin-left:auto}
    .dmMsg .meta{font-size:11px; color:var(--ghost); margin-top:4px}
    .dmMsg .translate-chip{font-size:10px; opacity:.9; margin-top:4px; cursor:pointer}
    .read1{display:inline-flex; align-items:center; justify-content:center; min-width:16px; height:16px; font-size:11px; background:#fff; color:var(--accent); border-radius:999px; padding:0 4px; margin-left:6px}

    .dmInputBar{display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--line); position:sticky; bottom:0; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px)}
    .dmInputBar input{flex:1; border:1px solid var(--line); padding:12px; border-radius:14px; background:var(--hover)}
    .dmInputBar button{min-width:60px; border:none; background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border-radius:12px; font-weight:900; cursor:pointer}

    /* ---------- Live List ---------- */
    #liveList .group{margin:10px 0}
    .liveCard{
      display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--line); border-radius:14px; background:var(--card); margin:8px 0; cursor:pointer;
    }
    .liveCard img{width:100px; height:64px; border-radius:10px; object-fit:cover; border:1px solid var(--line)}
    .liveMeta b{display:block}
    .status{font-size:12px; color:var(--ghost)}
    .status.on{color:var(--ok)}
    .status.soon{color:#ff9800}
    .status.end{color:var(--ghost)}

    /* ---------- Live Room ---------- */
    #liveRoom .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #liveRoom .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .liveThread{display:flex; flex-direction:column; gap:8px; height:calc(100vh - 180px); overflow-y:auto; padding:4px 2px}
    .liveMsg{max-width:72%; padding:10px 12px; border-radius:14px}
    .liveMsg.host{background:var(--artist); align-self:flex-start}
    .liveMsg.fan{background:var(--fan); align-self:flex-end}
    .liveMsg.welcome{background:#ffeaa7; align-self:center; font-size:12px}
    .liveInputBar{display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--line); position:sticky; bottom:0; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px)}
    .liveInputBar input{flex:1; border:1px solid var(--line); padding:12px; border-radius:14px; background:var(--hover)}
    .liveInputBar button{min-width:60px; border:none; background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border-radius:12px; font-weight:900; cursor:pointer}

    /* ---------- Live Replay ---------- */
    #liveReplay .topbar{display:flex; align-items:center; gap:10px; margin:2px 0 10px}
    #liveReplay .back{width:40px; height:40px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer}
    .replayThread{display:flex; flex-direction:column; gap:8px; height:calc(100vh - 200px); overflow-y:auto; padding:4px 2px}
    .replayMsg{max-width:72%; padding:10px 12px; border-radius:14px}
    .replayMsg.host{background:var(--artist); align-self:flex-start}
    .replayMsg.fan{background:var(--fan); align-self:flex-end}
    .replayCtrl{display:flex; align-items:center; gap:8px; padding:10px 0}

    /* ---------- Profile ---------- */
    #profile{padding:0}
    #profile .topbar{position:sticky; top:0; z-index:5; padding:8px 12px; background:linear-gradient(180deg,rgba(245,247,255,.95),rgba(245,247,255,.6))}
    #profileHeader{position:relative; height:46vh; border-radius:0 0 22px 22px; overflow:hidden}
    #profileBg{width:100%; height:100%; object-fit:cover}
    #profileHeader::after{content:""; position:absolute; inset:auto 0 0 0; height:36%; background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55))}
    #avatarWrap{position:absolute; left:50%; transform:translateX(-50%); bottom:-46px; text-align:center}
    #editAvatar{width:96px; height:96px; border-radius:50%; border:3px solid #fff; object-fit:cover; background:#888; cursor:pointer}
    .profile-actions{position:absolute; left:50%; transform:translateX(-50%); bottom:64px; display:flex; gap:14px}
    .round-btn{width:40px; height:40px; border-radius:50%; border:1px solid var(--line); background:var(--card); display:flex; align-items:center; justify-content:center; cursor:pointer}

    #profileInfo{margin-top:68px; padding:12px; display:flex; flex-direction:column; gap:12px}
    .pitem{display:flex; align-items:center; justify-content:space-between; padding:14px; border:1px solid var(--line); background:var(--card); border-radius:14px}
    .pitem .label{color:var(--sub); font-size:13px}
    .pitem .value{font-weight:900}
    .edit-btn{border:none; background:transparent; cursor:pointer; font-size:14px; color:var(--accent)}

    /* ---------- Popup: mini profile ---------- */
    #miniProfile{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:300px; max-width:86vw; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:14px; z-index:60; display:none;
    }
    #miniProfile .hdr{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    #miniProfile .hdr img{width:56px; height:56px; border-radius:50%; border:1px solid var(--line); object-fit:cover}
    #miniProfile .actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
    #miniProfile .actions button{border:none; background:var(--hover); border:1px solid var(--line); padding:8px 12px; border-radius:10px; cursor:pointer}
  </style>
</head>

<body class="nx">

  <!-- ===============================
         HOME
       =============================== -->
  <section id="home" class="page active">
    <div id="homeHeader">
      <div class="me" onclick="openProfile()">
        <img id="meAvatar" src="https://picsum.photos/80?u=me" onerror="imgFallback(this)">
        <div>
          <div id="meNickname" style="font-weight:900">æš±ç¨±</div>
          <div class="id" id="meFanId">NEXT-00000</div>
        </div>
      </div>
      <div class="right">
        <span class="chip">></span>
      </div>
    </div>

    <div id="storyWrap">
      <div id="storyBar"></div>
    </div>

    <div id="feedWrap"></div>
  </section>

  <!-- ===============================
         POST DETAIL
       =============================== -->
  <section id="postDetail" class="page">
    <div class="topbar">
      <button class="back" onclick="goBack()">â†</button>
      <b style="font-weight:900">ç•™è¨€å€</b>
    </div>
    <div id="postDetailContent"></div>

    <div class="comments-head">
      <div class="row">
        <div id="commentsCount" class="ghost">å…¨éƒ¨ 0 å‰‡</div>
        <div class="chip" style="cursor:pointer" onclick="renderComments()">âŸ³ é‡æ–°æ•´ç†</div>
      </div>
      <div class="row">
        <div id="filterLabel" class="ghost">åªçœ‹ çš„å›è¦†</div>
        <label class="switch">
          <input id="filterArtistSwitch" type="checkbox" onchange="renderComments()" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div id="commentList"></div>

    <div class="comment-input">
      <input id="commentInput" placeholder="è¼¸å…¥è©•è«–â€¦" />
      <button onclick="sendComment()">é€å‡º</button>
    </div>
  </section>

  <!-- ===============================
         DM LIST
       =============================== -->
  <section id="dm" class="page">
    <div class="row" style="justify-content:space-between; margin:2px 0 10px">
      <b style="font-weight:900">è¨Šæ¯</b>
      <span class="ghost" id="dmTips">å‘å³æ»‘è¿”å›é¦–é </span>
    </div>
    <div id="dmListWrap"></div>
    <div id="dmEmpty" class="ghost" style="text-align:center; margin-top:30vh; display:none">å°šæœªèˆ‡ä»»ä½•è—äººé–‹å•ŸèŠå¤© â¤ï¸</div>
  </section>

  <!-- ===============================
         DM DETAIL
       =============================== -->
  <section id="dmDetail" class="page">
    <div class="topbar">
      <button class="back" onclick="goBack()">â†</button>
      <b id="dmTitle">DOHEE</b>
    </div>
    <div id="dmThread" class="dmThread"></div>
    <div class="dmInputBar">
      <input id="dmMessageInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦" />
      <button id="dmSendBtn">â¤</button>
    </div>
  </section>

  <!-- ===============================
         LIVE LIST
       =============================== -->
  <section id="liveList" class="page">
    <div class="row" style="justify-content:space-between; margin:2px 0 10px">
      <b style="font-weight:900">ç›´æ’­</b>
      <span class="ghost">ç²‰çµ²é™å®šèŠå¤©å®¤</span>
    </div>

    <div class="group">
      <h3 class="sub">é€²è¡Œä¸­</h3>
      <div id="liveOngoingList"></div>
    </div>
    <div class="group">
      <h3 class="sub">å³å°‡é–‹å§‹</h3>
      <div id="liveUpcomingList"></div>
    </div>
    <div class="group">
      <h3 class="sub">å·²çµæŸ</h3>
      <div id="liveEndedList"></div>
    </div>
  </section>

  <!-- ===============================
         LIVE ROOM
       =============================== -->
  <section id="liveRoom" class="page">
    <div class="topbar">
      <button class="back" onclick="showPage('liveList')">â†</button>
      <b id="liveTitle">ç›´æ’­ä¸­</b>
    </div>

    <div class="row" style="gap:12px; margin-bottom:6px">
      <img id="liveHostAvatar" src="https://picsum.photos/60?u=host" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;border:1px solid var(--line);object-fit:cover">
      <div>
        <b id="liveHostName">Host</b><br>
        <small class="ghost">ç²‰çµ²é™å®šèŠå¤©å®¤</small>
      </div>
    </div>

    <div id="liveThread" class="liveThread"></div>

    <div class="liveInputBar">
      <input id="liveInput" placeholder="è¼¸å…¥ç•™è¨€â€¦" />
      <button onclick="sendLiveMsg()">é€å‡º</button>
    </div>
  </section>

  <!-- ===============================
         LIVE REPLAY
       =============================== -->
  <section id="liveReplay" class="page">
    <div class="topbar">
      <button class="back" onclick="showPage('liveList')">â†</button>
      <b>ç›´æ’­å›æ”¾</b>
      <div class="row" style="margin-left:auto">
        <span class="ghost">é€Ÿåº¦</span>
        <select id="replaySpeed" onchange="changeReplaySpeed(this.value)">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1.0x</option>
          <option value="2">2.0x</option>
        </select>
      </div>
    </div>

    <div class="row" style="gap:12px; margin-bottom:6px">
      <img id="replayHostAvatar" src="https://picsum.photos/60?u=replay" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;border:1px solid var(--line);object-fit:cover">
      <div>
        <b id="replayHostName">Host</b><br>
        <small id="replayTitle" class="ghost">å›æ”¾æ¨™é¡Œ</small>
      </div>
    </div>

    <div id="replayThread" class="replayThread"></div>
  </section>

  <!-- ===============================
         PROFILE
       =============================== -->
  <section id="profile" class="page">
    <div class="topbar">
      <b style="font-weight:900">æˆ‘çš„</b>
    </div>

    <div id="profileHeader">
      <img id="profileBg" src="https://picsum.photos/1200/800?blur" onerror="imgFallback(this)">
      <div class="profile-actions">
        <button class="round-btn onlyMe" title="æ›é ­è²¼" onclick="document.getElementById('avatarInput').click()">ğŸ“·</button>
        <button class="round-btn onlyMe" title="æ›èƒŒæ™¯" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸</button>
      </div>
      <div id="avatarWrap">
        <img id="editAvatar" src="https://picsum.photos/160?u=me" onclick="document.getElementById('avatarInput').click()">
        <input type="file" id="avatarInput" accept="image/*" class="onlyMe hidden" onchange="changeAvatar(event)">
        <input type="file" id="bgInput" accept="image/*" class="onlyMe hidden" onchange="changeBg(event)">
      </div>
    </div>

    <div id="profileInfo">
      <div class="pitem">
        <div>
          <div class="label">Chat name</div>
          <div class="value" id="p_nickname">æš±ç¨±</div>
        </div>
        <button class="edit-btn onlyMe" onclick="editNickname()">âœï¸</button>
      </div>

      <div class="pitem">
        <div>
          <div class="label">Status message</div>
          <div class="value" id="p_status">å°šæœªè¨­å®š</div>
        </div>
        <button class="edit-btn onlyMe" onclick="editStatus()">âœï¸</button>
      </div>

      <div class="pitem">
        <div class="label">ç²‰çµ² ID</div>
        <div class="value" id="p_fanId">NEXT-00000</div>
      </div>

      <div class="pitem">
        <div class="label">åŠ å…¥æ—¥æœŸ</div>
        <div class="value" id="p_joinDate">â€”</div>
      </div>

      <div class="pitem">
        <div class="label">ç”Ÿæ—¥</div>
        <div class="value">
          <input type="date" id="birthdayInput" onchange="saveBirthday(this.value)">
        </div>
      </div>

      <div class="pitem">
        <div class="label">ğŸ’œ æˆ‘çš„æ„›å¿ƒï¼ˆå‰©é¤˜å¤©æ•¸ï¼‰</div>
        <div class="value"><span id="heartDays">0</span> å¤©</div>
      </div>

      <div class="pitem">
        <div class="label">éŒ¢åŒ…é¤˜é¡</div>
        <div class="value"><span id="walletBalance">0</span> é»</div>
      </div>

      <div class="row" style="gap:10px; margin-top:4px">
        <button class="chip" onclick="buyHearts(30)">è³¼è²· 30 å¤©</button>
        <button class="chip" onclick="chargeWallet()">å……å€¼ +100</button>
      </div>
    </div>
  </section>

  <!-- ===============================
         MINI PROFILE POPUP
       =============================== -->
  <div id="miniProfile">
    <div class="hdr">
      <img id="mpAvatar" src="" onerror="imgFallback(this)">
      <div>
        <div id="mpName" style="font-weight:900">åç¨±</div>
        <div id="mpId" class="ghost" style="font-size:12px">NEXT-00000</div>
      </div>
    </div>
    <div id="mpBio" class="sub" style="font-size:13px">â€”</div>
    <div class="actions">
      <button onclick="closeMiniProfile()">é—œé–‰</button>
    </div>
  </div>

  <!-- ===============================
         BOTTOM NAV
       =============================== -->
  <nav id="nav">
    <button id="tabHome" class="active" onclick="showPage('home')">é¦–é </button>
    <button id="tabDM" onclick="showPage('dm')">DM</button>
    <button id="tabLive" onclick="showPage('liveList')">ç›´æ’­</button>
    <button id="tabProfile" onclick="showPage('profile')">æˆ‘çš„</button>
  </nav>

  <!-- ===============================
         SCRIPTS (DATA + LOGIC)
       =============================== -->
  <script>
    /* -------------------------------------
     * å·¥å…·ï¼šfallback avatar / image
     * -----------------------------------*/
    function imgFallback(img){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
      img.src = 'data:image/svg+xml;charset=UTF-8,' + svg;
      img.onerror = null;
    }

    /* -------------------------------------
     * å‡è³‡æ–™
     * -----------------------------------*/
    const ARTISTS = [
      {id:'annie',  name:'Annie',   avatar:'https://picsum.photos/80?u=an'},
      {id:'dohee',  name:'Dohee',   avatar:'https://picsum.photos/80?u=dh'},
      {id:'woo',    name:'Woochan', avatar:'https://picsum.photos/80?u=wc'},
      {id:'group',  name:'ALLDAY PROJECT', avatar:'https://picsum.photos/80?u=group'}
    ];

    // Feed posts
    const POSTS = [
      { id:'p1', artistId:'woo',   artistName:'Woochan', avatar:'https://picsum.photos/80?u=wc', text:'ä»Šå¤©åƒæ‹‰éºµ ğŸœ', img:'https://picsum.photos/1200?u=wc1', ts:'13å°æ™‚å‰' },
      { id:'p2', artistId:'dohee', artistName:'Dohee',   avatar:'https://picsum.photos/80?u=dh', text:'ç·´èˆç·´åˆ°çˆ†æ±— ğŸ’ƒ', img:'https://picsum.photos/1200?u=dh1', ts:'10å°æ™‚å‰' },
      { id:'p3', artistId:'annie', artistName:'Annie',   avatar:'https://picsum.photos/80?u=an', text:'å‚³äº†ä¸€å¼µè‡ªæ‹ ğŸ“¸', img:'https://picsum.photos/1200?u=an1', ts:'8å°æ™‚å‰' }
    ];

    // Reaction ç¨®é¡
    const REACTION_TYPES = [
      {key:'heart', icon:'ğŸ’œ'},
      {key:'clap',  icon:'ğŸ‘'},
      {key:'laugh', icon:'ğŸ¤£'},
      {key:'panda', icon:'ğŸ¼'},
      {key:'tear',  icon:'ğŸ¥²'},
      {key:'cheer', icon:'ğŸ¥³'}
    ];

    // DM å‡è³‡æ–™
    const DM_ARTISTS = [
      {id:'dohee',   name:'Dohee',   avatar:'https://picsum.photos/100?2', subscribed:true,  heartDays:120, lastMsg:'é‚„æƒ³å†èŠä¸€ä¸‹ ğŸ¥º', unread:2, lastTs:Date.now()-1000*60*4 },
      {id:'woo',     name:'Woochan', avatar:'https://picsum.photos/100?1', subscribed:false, heartDays:0,   lastMsg:'ï¼ˆç„¡è¨Šæ¯ï¼‰', unread:0, lastTs:Date.now()-1000*60*60 },
      {id:'annie',   name:'Annie',   avatar:'https://picsum.photos/100?3', subscribed:true,  heartDays:45,  lastMsg:'å‰›å‰›å‚³äº†è‡ªæ‹ï¼Œä½ æœ‰çœ‹åˆ°å—ï¼Ÿ', unread:1, lastTs:Date.now()-1000*60*2 }
    ];
    let dmMessages = {
      dohee: [
        {id:'d1', from:'left',  text:'å—¨ï½ç²‰çµ²ä½ å¥½ï¼', ts:Date.now()-1000*60*60, translated:false, read:true},
        {id:'d2', from:'right', text:'å“ˆå›‰ï¼æœ€è¿‘å¥½å—ï¼Ÿ', ts:Date.now()-1000*60*45, translated:false, read:false}
      ],
      woo: [
        {id:'w1', from:'left',  text:'ä»Šå¤©åˆé¤åƒä»€éº¼ï¼Ÿ', ts:Date.now()-1000*60*70, translated:false, read:true}
      ],
      annie: [
        {id:'a1', from:'left',  text:'æˆ‘å‰›å‚³äº†ä¸€å¼µè‡ªæ‹ ğŸ“¸', ts:Date.now()-1000*60*8, translated:false, read:true}
      ]
    };

    // Live å‡è³‡æ–™
    const LIVE_DATA = {
      active: [{id:'L1', host:'Annie',  title:'Annie Live',  thumb:'https://picsum.photos/300/180?live1'}],
      upcoming: [{id:'L2', host:'Dohee', title:'Dance Practice', thumb:'https://picsum.photos/300/180?live2', startTime: Date.now()+1000*60*3 }],
      ended: [{id:'L3', host:'ALLDAY', title:'Full Group Replay', thumb:'https://picsum.photos/300/180?live3'}]
    };

    /* -------------------------------------
     * LocalStorage Helpers
     * -----------------------------------*/
    const LS = {
      get(k, def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
      set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
      getStr(k, def=''){ const v=localStorage.getItem(k); return v ?? def },
      setStr(k, v){ localStorage.setItem(k, v) }
    };

    /* -------------------------------------
     * Profileï¼ˆèº«åˆ†ã€ä¸Šå‚³ï¼‰
     * -----------------------------------*/
    function ensureMyIdentity(){
      if(!LS.getStr('fanId')){
        const id = 'NEXT-' + Math.floor(10000 + Math.random()*90000);
        LS.setStr('fanId', id);
      }
      if(!LS.getStr('joinDate')){
        LS.setStr('joinDate', new Date().toLocaleDateString());
      }
    }
    function openProfile(){
      showPage('profile');
    }
    function showMyBar(){
      document.getElementById('meNickname').textContent = LS.getStr('nickname','æš±ç¨±');
      document.getElementById('meFanId').textContent = LS.getStr('fanId','NEXT-00000');
      const a = LS.getStr('avatar');
      if(a) document.getElementById('meAvatar').src = a;
    }
    function showFanProfile(){
      document.getElementById('p_nickname').textContent = LS.getStr('nickname','æš±ç¨±');
      document.getElementById('p_status').textContent   = LS.getStr('statusMsg','å°šæœªè¨­å®š');
      document.getElementById('p_fanId').textContent    = LS.getStr('fanId','NEXT-00000');
      document.getElementById('p_joinDate').textContent = LS.getStr('joinDate','â€”');
      const a = LS.getStr('avatar'); if(a) document.getElementById('editAvatar').src = a;
      const bg= LS.getStr('profileBg'); if(bg) document.getElementById('profileBg').src = bg;

      // ç”Ÿæ—¥ & éŒ¢åŒ… & æ„›å¿ƒ
      const bd = LS.getStr('birthday'); if(bd) document.getElementById('birthdayInput').value = bd;
      document.getElementById('walletBalance').textContent = LS.getStr('walletBalance','0');
      document.getElementById('heartDays').textContent = LS.getStr('heartDays','0');
    }
    function compressImage(file, maxSize = 900, callback){
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e=>{
        img.onload = ()=>{
          let w = img.width, h = img.height;
          if(w > h){ if(w > maxSize){ h *= maxSize / w; w = maxSize; } }
          else{ if(h > maxSize){ w *= maxSize / h; h = maxSize; } }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img,0,0,w,h);
          canvas.toBlob(b=>{
            callback(URL.createObjectURL(b));
          }, 'image/jpeg', 0.9);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    function changeAvatar(e){
      const f = e.target.files[0];
      if(f){
        compressImage(f, 900, u=>{
          document.getElementById('editAvatar').src = u;
          LS.setStr('avatar', u);
          document.getElementById('meAvatar').src = u;
        });
      }
    }
    function changeBg(e){
      const f = e.target.files[0];
      if(f){
        compressImage(f, 1400, u=>{
          document.getElementById('profileBg').src = u;
          LS.setStr('profileBg', u);
        });
      }
    }
    function editNickname(){
      const current = LS.getStr('nickname','æš±ç¨±');
      const n = prompt('è¼¸å…¥æ–°æš±ç¨±', current);
      if(n){
        LS.setStr('nickname', n);
        document.getElementById('meNickname').textContent = n;
        document.getElementById('p_nickname').textContent = n;
      }
    }
    function editStatus(){
      const current = LS.getStr('statusMsg','å°šæœªè¨­å®š');
      const s = prompt('è¼¸å…¥ç‹€æ…‹è¨Šæ¯', current);
      if(s!==null){
        LS.setStr('statusMsg', s);
        document.getElementById('p_status').textContent = s;
      }
    }
    function saveBirthday(val){
      LS.setStr('birthday', val);
      checkBirthday();
    }
    function checkBirthday(){
      const bd = LS.getStr('birthday');
      if(!bd) return;
      const today = new Date();
      const [yyyy,mm,dd] = bd.split('-').map(Number);
      if( (today.getMonth()+1)===mm && today.getDate()===dd ){
        alert('ğŸ‰ ç”Ÿæ—¥å¿«æ¨‚ï¼ç¥ä½ æœ‰ç¾å¥½çš„ä¸€å¤©ï¼');
      }
    }
    function buyHearts(days){
      let h = parseInt(LS.getStr('heartDays','0'),10);
      h += days;
      LS.setStr('heartDays', String(h));
      document.getElementById('heartDays').textContent = h;
      // DM åˆ—è¡¨éœ€åŒæ­¥é¡¯ç¤º
      DM_ARTISTS.forEach(a=>{ if(a.subscribed) a.heartDays = h; });
      renderDMList(); // æ›´æ–°æ„›å¿ƒå¤©æ•¸
      alert(`æˆåŠŸè³¼è²· ${days} å¤© ğŸ’œ`);
    }
    function chargeWallet(){
      let b = parseInt(LS.getStr('walletBalance','0'),10);
      b += 100;
      LS.setStr('walletBalance', String(b));
      document.getElementById('walletBalance').textContent = b;
    }

    /* -------------------------------------
     * StoryBar / åˆ†é¡åœ“åœˆ
     * -----------------------------------*/
    function buildStorySet(){
      const set = new Map();
      set.set('all', {id:'all', name:'ALL', avatar:'https://picsum.photos/60?u=all'});
      ARTISTS.forEach(a=> set.set(a.id, {id:a.id, name:a.name, avatar:a.avatar}) );
      // æ ¹æ“š POST å‹•æ…‹æ’åºï¼ˆæœ€æ–°äº’å‹•çš„è—äººé å‰ï¼Œä½† ALL æ°¸é ç¬¬ä¸€ï¼‰
      const recentByArtist = {};
      POSTS.forEach((p,i)=>{ recentByArtist[p.artistId] = Date.now() - (i*1000) });
      const sorted = [...set.values()].filter(x=>x.id!=='all').sort((a,b)=>(recentByArtist[b.id]||0)-(recentByArtist[a.id]||0));
      return [ set.get('all'), ...sorted ];
    }
    function renderStoryBar(){
      const bar = document.getElementById('storyBar');
      const items = buildStorySet();
      bar.innerHTML = items.map(u=>`
        <div class="story-item ${u.id==='all'?'all':''}" onclick="renderFeed('${u.id}')">
          <img src="${u.avatar}" onerror="imgFallback(this)">
          <div class="name">${u.name}</div>
        </div>
      `).join('');
    }
    function rebuildStoryFromNewPost(newPost){
      POSTS.unshift(newPost);
      renderStoryBar(); // ALL å›ºå®šæœ€å‰ï¼›æ–°çš„ artist åœˆåœˆæœƒæ’åˆ° ALL å¾Œç¬¬ä¸€
    }

    /* -------------------------------------
     * Feed & Translation & Reactions
     * -----------------------------------*/
    const _translateState = {}; // postId => bool
    function getReactions(postId){ return LS.get(`reactions:${postId}`, {}); }
    function setReactions(postId, data){ LS.set(`reactions:${postId}`, data); }
    function getMyReactions(postId){ return LS.get(`myReacts:${postId}`, {}); }
    function setMyReactions(postId, data){ LS.set(`myReacts:${postId}`, data); }

    function renderFeed(filter='all'){
      const wrap = document.getElementById('feedWrap');
      let list = POSTS;
      if(filter!=='all'){ list = POSTS.filter(p=> p.artistId===filter); }
      wrap.innerHTML = list.map(p=>`
        <div class="card soft postCard" onclick="onPostCardClick(event,'${p.id}')">
          <div class="hdr">
            <img src="${p.avatar}" class="avatar" onerror="imgFallback(this)">
            <div class="meta"><b>${p.artistName}</b><small class="ghost">${p.ts}</small></div>
            <div class="translate-btn" onclick="event.stopPropagation(); togglePostTranslate('${p.id}')">ç¿»è­¯</div>
          </div>
          <div class="body">
            <p id="postText-${p.id}">${escapeHtml(p.text)}</p>
            ${p.img ? `<img class="hero" src="${p.img}" onerror="imgFallback(this)">` : ''}
            ${renderReactionsBar(p.id)}
          </div>
        </div>
      `).join('');
      restoreHomeScroll();
    }
    function onPostCardClick(e, postId){
      const path = e.composedPath ? e.composedPath(): [];
      // é˜»æ“‹ï¼šreaction btn / translate-btn
      if( path.some(el=> el && el.classList && (el.classList.contains('reaction') || el.classList.contains('translate-btn')) ) ){
        return;
      }
      openPost(postId);
    }
    function togglePostTranslate(postId){
      const el = document.getElementById(`postText-${postId}`);
      if(!el) return;
      _translateState[postId] = !_translateState[postId];
      if(_translateState[postId]){
        el.dataset.origin = el.textContent;
        el.textContent = `ï¼ˆå·²ç¿»è­¯ï¼‰${el.dataset.origin}`;
      }else{
        el.textContent = el.dataset.origin || el.textContent;
      }
      // æŒä¹…åŒ–
      const key = `postTranslated:${postId}`;
      LS.setStr(key, _translateState[postId] ? '1' : '0');
    }
    function renderReactionsBar(postId){
      const data = getReactions(postId);
      const myData = getMyReactions(postId);
      return `<div class="reaction-bar" id="reactions-${postId}">
        ${REACTION_TYPES.map(r=>{
          const cnt = data[r.key] || 0;
          const active = myData[r.key] ? 'active' : '';
          const countHtml = cnt>0 ? `<span class="count" id="rc-${postId}-${r.key}">${cnt}</span>` : `<span class="count" id="rc-${postId}-${r.key}"></span>`;
          return `<div class="reaction ${active}" onclick="event.stopPropagation(); toggleReaction('${postId}','${r.key}')">
            <span>${r.icon}</span>${countHtml}
          </div>`;
        }).join('')}
      </div>`;
    }
    function toggleReaction(postId, type){
      let data = getReactions(postId);
      let myData = getMyReactions(postId);
      if(myData[type]){
        delete myData[type];
        data[type] = Math.max((data[type]||0)-1, 0);
      }else{
        // å–®é¸ï¼šæ¸…æ‰èˆŠçš„
        for(const k in myData){ if(myData[k]){ data[k] = Math.max((data[k]||0)-1, 0); } }
        myData = {};
        myData[type] = true;
        data[type] = (data[type]||0)+1;
      }
      setMyReactions(postId, myData);
      setReactions(postId, data);
      const area = document.getElementById(`reactions-${postId}`);
      if(area) area.outerHTML = renderReactionsBar(postId);
    }

    /* -------------------------------------
     * ç•™è¨€ï¼ˆPost Detailï¼‰
     * -----------------------------------*/
    let CURRENT_POST_ID = null;
    let CURRENT_ARTIST_NAME = '';
    function seedCommentsIfEmpty(postId){
      const k = `comments:${postId}`;
      if(!localStorage.getItem(k)){
        let defaults = [];
        if(postId==='p1'){
          defaults = [
            {id:1, name:'ç²‰çµ²A', avatar:'https://picsum.photos/40?u=f1', isArtist:false, text:'å¥½å¥½åƒçš„æ¨£å­ï¼', translated:false},
            {id:2, name:'Woochan', avatar:'https://picsum.photos/40?u=wc', isArtist:true,  text:'çœŸçš„è¶…å¥½åƒ ğŸ˜‹', translated:false}
          ];
        }else if(postId==='p2'){
          defaults = [
            {id:1, name:'ç²‰çµ²C', avatar:'https://picsum.photos/40?u=f3', isArtist:false, text:'åŠªåŠ›çš„æ¨£å­æœ€ç¾ï¼', translated:false},
            {id:2, name:'Dohee',  avatar:'https://picsum.photos/40?u=dh', isArtist:true,  text:'è¬è¬å¤§å®¶ ğŸ’–', translated:false}
          ];
        }else{
          defaults = [
            {id:1, name:'ç²‰çµ²D', avatar:'https://picsum.photos/40?u=f4', isArtist:false, text:'è‡ªæ‹å¥½æ¼‚äº®ï¼', translated:false},
            {id:2, name:'Annie',  avatar:'https://picsum.photos/40?u=an', isArtist:true,  text:'è¬è¬ä½ å€‘ ğŸ¥°', translated:false}
          ];
        }
        LS.set(k, defaults);
      }
    }
    function getComments(postId){ seedCommentsIfEmpty(postId); return LS.get(`comments:${postId}`, []); }
    function setComments(postId, list){ LS.set(`comments:${postId}`, list); }

    function openPost(postId){
      saveHomeScroll(); // è¨˜ä½é¦–é ä½ç½®
      const post = POSTS.find(p=>p.id===postId); if(!post) return;
      CURRENT_POST_ID = postId;
      CURRENT_ARTIST_NAME = post.artistName;

      // filter é è¨­ ON
      const sw = document.getElementById('filterArtistSwitch');
      if(sw){ sw.checked = true; }
      document.getElementById('filterLabel').textContent = `åªçœ‹ ${post.artistName} çš„å›è¦†`;

      const content = `
        <div class="card soft postCard" onclick="void(0)">
          <div class="hdr">
            <img src="${post.avatar}" class="avatar" onerror="imgFallback(this)">
            <div class="meta"><b>${post.artistName}</b><small class="ghost">${post.ts}</small></div>
            <div class="translate-btn" onclick="togglePostTranslate('${post.id}')">ç¿»è­¯</div>
          </div>
          <div class="body">
            <p id="postText-${post.id}">${escapeHtml(post.text)}</p>
            ${post.img ? `<img class="hero" src="${post.img}" onerror="imgFallback(this)">` : ''}
            ${renderReactionsBar(post.id)}
          </div>
        </div>
      `;
      document.getElementById('postDetailContent').innerHTML = content;
      renderComments();
      showPage('postDetail');
    }

    function renderComments(){
      if(!CURRENT_POST_ID) return;
      const wrap = document.getElementById('commentList'); wrap.innerHTML = '';
      const onlyArtist = document.getElementById('filterArtistSwitch').checked;
      const list = getComments(CURRENT_POST_ID);
      document.getElementById('commentsCount').textContent = `å…¨éƒ¨ ${list.length} å‰‡`;

      list.forEach(c=>{
        if(onlyArtist && c.name !== CURRENT_ARTIST_NAME) return; // åªçœ‹è©²è—äºº
        const item = document.createElement('div');
        item.className = 'citem'+(c.isArtist?' artist':'');
        item.innerHTML = `
          <div class="u">
            <img src="${c.avatar}" onerror="imgFallback(this)" onclick="openMiniProfile('${c.name}','${c.avatar}')">
            <b class="name">${escapeHtml(c.name)}</b>
          </div>
          <p id="cText-${c.id}">${escapeHtml(c.text)}</p>
          <div class="c-actions">
            <div class="chip" onclick="toggleCommentTranslate('${c.id}')">ç¿»è­¯</div>
          </div>
        `;
        wrap.appendChild(item);
      });
    }
    function toggleCommentTranslate(cid){
      const wrap = document.getElementById('commentList');
      if(!wrap) return;
      const k = `cTranslated:${CURRENT_POST_ID}:${cid}`;
      const translated = LS.getStr(k,'0')==='1';
      const el = document.getElementById(`cText-${cid}`);
      if(!el) return;
      if(translated){
        el.textContent = el.textContent.replace(/^ï¼ˆç¿»è­¯ï¼‰/,'');
        LS.setStr(k,'0');
      }else{
        el.textContent = `ï¼ˆç¿»è­¯ï¼‰${el.textContent}`;
        LS.setStr(k,'1');
      }
    }
    function sendComment(){
      if(!CURRENT_POST_ID) return;
      const inp = document.getElementById('commentInput');
      const t = (inp.value||'').trim();
      if(!t) return;
      const meName = LS.getStr('nickname','æˆ‘');
      const meAvatar = LS.getStr('avatar','https://picsum.photos/40?u=me');
      const list = getComments(CURRENT_POST_ID);
      list.push({id: Date.now(), name: meName, avatar: meAvatar, isArtist:false, text:t, translated:false});
      setComments(CURRENT_POST_ID, list);
      inp.value=''; renderComments();
    }

    /* -------------------------------------
     * DM æ¨¡çµ„
     * -----------------------------------*/
    let currentChat = null;

    function renderDMList(){
      const wrap = document.getElementById('dmListWrap');
      const empty = document.getElementById('dmEmpty');

      // åŒæ­¥æ„›å¿ƒï¼šä»¥ Profile å„²å­˜ç‚ºæº–ï¼ˆç²‰çµ²å‰©é¤˜å¤©æ•¸é¡¯ç¤ºï¼‰
      const days = parseInt(LS.getStr('heartDays','0'),10);
      DM_ARTISTS.forEach(a=>{ if(a.subscribed) a.heartDays = days; });

      // ä¾æœ€å¾Œè¨Šæ¯æ™‚é–“æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
      const withTs = DM_ARTISTS.map(a=>{
        const msgs = dmMessages[a.id] || [];
        const last = msgs.length? msgs[msgs.length-1].ts : a.lastTs || 0;
        return {...a, lastTs: last};
      }).sort((a,b)=> b.lastTs - a.lastTs);

      if(withTs.length===0){
        wrap.innerHTML = ''; empty.style.display = 'block'; return;
      }
      empty.style.display = 'none';
      wrap.innerHTML = withTs.map(a=>`
        <div class="dmCard" onclick="openDm('${a.id}')">
          <div class="left">
            <img src="${a.avatar}" onerror="imgFallback(this)">
            <div class="meta">
              <b>${a.name}</b>
              <small class="ghost">${escapeHtml(a.lastMsg || '')}</small>
            </div>
          </div>
          <div class="dmRight">
            ${a.subscribed? `<span class="heartDays">${a.heartDays}</span>` : ''}
            ${a.unread>0 ? `<span class="badge">${a.unread}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function openDm(chatId){
      currentChat = chatId;
      const artist = DM_ARTISTS.find(a=>a.id===chatId);
      if(!artist) return;
      document.getElementById('dmTitle').textContent = artist.name;

      // æ¸…é™¤æœªè®€
      artist.unread = 0;
      renderDMList();

      // é¡¯ç¤ºå…§å®¹
      renderDmThread(chatId);

      showPage('dmDetail');

      // æ¨¡æ“¬ã€Œè—äººå·²è®€ã€ï¼š2 ç§’å¾ŒæŠŠæˆ‘æ–¹è¨Šæ¯ read ç‹€æ…‹è¨­ç‚º trueï¼Œä¸¦åˆ·æ–° UI
      setTimeout(()=>{
        const list = dmMessages[chatId] || [];
        list.forEach(m=>{ if(m.from==='right') m.read = true; });
        renderDmThread(chatId);
      }, 2000);
    }

    function renderDmThread(chatId){
      const box = document.getElementById('dmThread'); box.innerHTML = '';
      const list = dmMessages[chatId] || [];
      // Lazyï¼šåªé¡¯ç¤ºæœ€å¾Œ 50 å‰‡
      const start = Math.max(0, list.length - 50);
      const slice = list.slice(start);
      slice.forEach(m=>{
        const translated = LS.getStr(`dmTranslated:${m.id}`,'0')==='1';
        const text = translated ? `ï¼ˆç¿»è­¯ï¼‰${m.text}` : m.text;
        const div = document.createElement('div');
        div.className = `dmMsg ${m.from}`;
        div.innerHTML = `
          <div class="bubble">
            <div>${escapeHtml(text)}</div>
            <div class="translate-chip ghost" onclick="toggleDmTranslate('${m.id}','${m.text}')">ç¿»è­¯</div>
            <div class="meta">${new Date(m.ts||Date.now()).toLocaleTimeString()} ${m.from==='right' ? `<span class="read1">${m.read? '' : '1'}</span>`:''}</div>
          </div>
        `;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    function toggleDmTranslate(msgId, origin){
      const k = `dmTranslated:${msgId}`;
      const newState = LS.getStr(k,'0')==='1' ? '0' : '1';
      LS.setStr(k, newState);
      // é‡æ–°æ¸²æŸ“ç›®å‰èŠå¤©å®¤
      if(currentChat) renderDmThread(currentChat);
    }

    document.getElementById('dmSendBtn').addEventListener('click', ()=>{
      const input = document.getElementById('dmMessageInput');
      const message = input.value.trim(); if(!message) return;
      const arr = dmMessages[currentChat] || (dmMessages[currentChat]=[]);
      arr.push({id:'x'+Date.now(), from:'right', text:message, ts:Date.now(), translated:false, read:false});
      input.value='';
      renderDmThread(currentChat);
      // æ›´æ–°åˆ—è¡¨æ’åº
      renderDMList();
    });

    /* -------------------------------------
     * Live
     * -----------------------------------*/
    function renderLives(){
      const og = document.getElementById('liveOngoingList');
      const up = document.getElementById('liveUpcomingList');
      const ed = document.getElementById('liveEndedList');

      og.innerHTML = LIVE_DATA.active.map(l=> liveCard(l,'on')).join('');
      up.innerHTML = LIVE_DATA.upcoming.map(l=> liveCard(l,'soon')).join('');
      ed.innerHTML = LIVE_DATA.ended.map(l=> liveCard(l,'end')).join('');
    }
    function liveCard(l,status){
      let label = `<span class="status ${status}">å·²çµæŸ</span>`;
      if(status==='on') label = `<span class="status on">é€²è¡Œä¸­</span>`;
      if(status==='soon'){
        const diff = Math.max(0, l.startTime - Date.now());
        label = `<span class="status soon">å³å°‡é–‹å§‹ï¼ˆ${Math.ceil(diff/1000)}sï¼‰</span>`;
      }
      return `
        <div class="liveCard" onclick="${status==='end' ? `openReplay('${l.id}')` : `openLive('${l.id}')`}">
          <img src="${l.thumb}" onerror="imgFallback(this)">
          <div class="liveMeta">
            <b>${l.title}</b>
            ${label}
          </div>
        </div>
      `;
    }
    // å€’æ•¸å‹•æ…‹æ›´æ–°
    setInterval(()=>{
      if( document.getElementById('liveUpcomingList') ){
        renderLives();
      }
    },1000);

    function openLive(id){
      const live = [...LIVE_DATA.active, ...LIVE_DATA.upcoming].find(l=>l.id===id);
      if(!live) return;
      document.getElementById('liveTitle').textContent = live.title;
      document.getElementById('liveHostName').textContent = live.host;
      document.getElementById('liveThread').innerHTML = '';

      showPage('liveRoom');

      // æ­¡è¿è¨Šæ¯ï¼ˆåªé¡¯ç¤ºåœ¨æˆ‘è‡ªå·±ç•«é¢ï¼‰
      const welcome = document.createElement('div');
      welcome.className = 'liveMsg welcome';
      welcome.textContent = 'ğŸ¤ æ­¡è¿ä¾†åˆ°ç›´æ’­';
      document.getElementById('liveThread').appendChild(welcome);
    }
    function sendLiveMsg(){
      const input = document.getElementById('liveInput');
      const text = input.value.trim(); if(!text) return;
      const div = document.createElement('div');
      div.className='liveMsg fan';
      div.textContent = text;
      const box = document.getElementById('liveThread');
      box.appendChild(div);
      input.value=''; box.scrollTop = box.scrollHeight;
    }

    // å›æ”¾
    let replayTimer = null;
    let replayMsgs = [];
    function openReplay(id){
      const live = LIVE_DATA.ended.find(l=>l.id===id);
      if(!live) return;
      document.getElementById('replayHostName').textContent = live.host;
      document.getElementById('replayTitle').textContent = live.title;
      const avatar = document.getElementById('replayHostAvatar'); avatar.src = 'https://picsum.photos/60?u='+encodeURIComponent(live.host);

      showPage('liveReplay');

      // å‡è³‡æ–™
      replayMsgs = [
        {type:'host', text:'å¤§å®¶å¥½ï½æˆ‘æ˜¯ '+ live.host},
        {type:'fan',  text:'å—¨ï¼ï¼'},
        {type:'fan',  text:'æ„›ä½ ğŸ’œ'},
        {type:'host', text:'è¬è¬å¤§å®¶ä¾†çœ‹ï½'}
      ];
      playReplay(1);
    }
    function playReplay(speed=1){
      clearInterval(replayTimer);
      const thread = document.getElementById('replayThread'); thread.innerHTML = '';
      let i = 0;
      replayTimer = setInterval(()=>{
        if(i >= replayMsgs.length){ clearInterval(replayTimer); return; }
        const m = replayMsgs[i++];
        const div = document.createElement('div');
        div.className = 'replayMsg '+m.type;
        div.textContent = m.text;
        thread.appendChild(div);
        thread.scrollTop = thread.scrollHeight;
      }, 2000 / speed);
    }
    function changeReplaySpeed(val){ playReplay(parseFloat(val)||1); }

    /* -------------------------------------
     * Mini Profileï¼ˆç°¡åŒ–å¡ç‰‡ï¼‰
     * -----------------------------------*/
    function openMiniProfile(name, avatar){
      document.getElementById('mpName').textContent = name;
      document.getElementById('mpId').textContent = randomFanIdForName(name);
      const img = document.getElementById('mpAvatar'); img.src = avatar; img.onerror = ()=>imgFallback(img);
      document.getElementById('mpBio').textContent = `Hiï¼Œæˆ‘æ˜¯ ${name}`;
      document.getElementById('miniProfile').style.display = 'block';
    }
    function closeMiniProfile(){ document.getElementById('miniProfile').style.display = 'none'; }
    function randomFanIdForName(name){
      // ç‚ºå±•ç¤ºæ–¹ä¾¿ï¼Œæ¯å€‹åå­—å›ºå®šä¸€æ¬¡
      const key = `miniId:${name}`;
      let id = LS.getStr(key);
      if(!id){
        id = 'NEXT-'+ Math.floor(10000+Math.random()*90000);
        LS.setStr(key, id);
      }
      return id;
    }

    /* -------------------------------------
     * å°èˆª / åˆ‡é  / æ»¾å‹•è¨˜æ†¶
     * -----------------------------------*/
    const pageStack = [];
    function showPage(id){
      document.querySelectorAll('section.page').forEach(s=>s.classList.remove('active'));
      const page = document.getElementById(id); if(page) page.classList.add('active');

      // è¨˜éŒ„ stack
      if(pageStack[pageStack.length-1] !== id) pageStack.push(id);

      // åº•éƒ¨ nav é¡¯ç¤ºè¦å‰‡
      const hideNavOn = ['postDetail','dmDetail','liveRoom','liveReplay'];
      const nav = document.getElementById('nav');
      if(hideNavOn.includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');

      // nav active æ¨£å¼
      document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
      const map = {home:'tabHome', dm:'tabDM', liveList:'tabLive', profile:'tabProfile'};
      if(map[id]) document.getElementById(map[id]).classList.add('active');

      // ç‰¹å®šé é¢åˆå§‹åŒ–
      if(id==='dm') renderDMList();
      if(id==='liveList') renderLives();
      if(id==='profile'){ showFanProfile(); }
      if(id==='home'){ restoreHomeScroll(); }
    }
    function goBack(){
      if(pageStack.length>1){
        pageStack.pop();
        showPage(pageStack[pageStack.length-1]);
      }else{
        showPage('home');
      }
    }
    function saveHomeScroll(){
      const y = document.documentElement.scrollTop || document.body.scrollTop || 0;
      LS.setStr('homeScroll', String(y));
    }
    function restoreHomeScroll(){
      const y = parseInt(LS.getStr('homeScroll','0'),10) || 0;
      window.scrollTo(0, y);
    }

    /* -------------------------------------
     * å°å·¥å…·
     * -----------------------------------*/
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }

    /* -------------------------------------
     * åˆå§‹åŒ–
     * -----------------------------------*/
    document.addEventListener('DOMContentLoaded', ()=>{
      ensureMyIdentity();
      showMyBar();
      showFanProfile();

      renderStoryBar();
      renderFeed('all');   // é¦–é é¡¯ç¤ºå…¨éƒ¨
      renderDMList();
      renderLives();

      // é è¨­åœç•™åœ¨ home
      showPage('home');

      // é¦–æ¬¡ç”Ÿæ—¥æç¤º
      checkBirthday();
    });
  </script>

  <<!-- ============== NEXT'S YOU FAN APP â€” INTEGRATED HOTFIX BUNDLE (paste before </body>) ============== -->
<style>
  :root{
    --bg:#f5f7ff; --card:#ffffff; --line:#e7e8ef; --sub:#8187a1;
    --accent:#6a5acd; --accent-2:#8b7bff; --chip:#eef1ff;
    --danger:#ff4d4f;
  }

  /* ---------- å…±ç”¨ ---------- */
  .hidden{display:none!important;}
  .v-badge{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;
    margin-left:6px;font-size:10px;font-weight:900;background:var(--chip);color:var(--accent);border:1px solid rgba(106,90,205,.25);}
  .ghost{color:var(--sub);}

  /* ---------- StoryBarï¼šåƒ…é¸ä¸­ç‚ºç´«åœˆç´«å­— ---------- */
  #storyBar{position:sticky;top:0;z-index:5;background:var(--card);}
  #storyBar .storyItem, #storyBar .story-item{opacity:.95;transition:.15s; text-align:center;}
  #storyBar .storyItem img, #storyBar .story-item img{width:62px;height:62px;border-radius:50%;object-fit:cover;border:2px solid #cfcfe9;}
  #storyBar .storyItem span, #storyBar .story-item span{display:block;margin-top:6px;font-size:12px;color:#9aa1ad;font-weight:700}
  #storyBar .storyItem.active img, #storyBar .story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18);}
  #storyBar .storyItem.active span, #storyBar .story-item.active span{color:var(--accent);}

  /* ---------- Post Card / é€²è©³æƒ… ---------- */
  .postCard{background:var(--card);border-radius:16px;padding:14px;box-shadow:0 1px 0 var(--line);margin:12px 12px 16px;}
  .postHead{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
  .postHead .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--line);}
  .postHead .name{font-weight:800;}
  .postHead .name .v-badge{transform:translateY(-1px);}
  .postBody img.hero{width:100%;border-radius:14px;display:block}
  .translate-chip{margin-left:auto;font-size:12px;background:var(--chip);border-radius:999px;padding:4px 8px;cursor:pointer}

  /* ---------- Reactionï¼šè† å›Š+æ•¸å­—é å³ï¼ˆå°ä¸€è™Ÿï¼‰ ---------- */
  .reactions{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .rx{display:flex;align-items:center;justify-content:space-between;gap:10px;
      min-width:110px;padding:10px 14px;border-radius:16px;border:2px solid #bdbfd6;background:transparent;cursor:pointer}
  .rx .emoji{font-size:18px;line-height:1}
  .rx .count{min-width:2.4em;text-align:right;font-weight:900;color:#6b6f85}
  .rx.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .rx.active .count{color:#fff}

  .postMeta{display:flex;align-items:center;justify-content:space-between;margin-top:10px;padding-top:8px;border-top:1px solid var(--line)}
  .metaLeft{display:flex;align-items:center;gap:10px;color:#70758f;font-weight:700}
  .c-bubble{display:inline-flex;align-items:center;gap:6px;border:2px solid #bdbfd6;border-radius:16px;padding:6px 10px}
  .metaRight a{font-weight:800;color:var(--accent);text-decoration:none}

  /* ---------- è²¼æ–‡è©³æƒ… ---------- */
  #postDetail .detailBody{padding:12px}
  #postDetail .commentsRow{margin-top:12px;padding-top:10px;border-top:1px solid var(--line)}

  /* ---------- DMï¼šæ°£æ³¡ä¸Šä¸‹2å±¤ã€æ™‚é–“èˆ‡ã€Œ1ã€åœ¨æ°£æ³¡å¤– ---------- */
  .dmThread{padding:12px 14px 88px}
  .dmMsg{max-width:78%;display:flex;flex-direction:column;margin:8px 0}
  .dmMsg.left{align-self:flex-start}.dmMsg.right{align-self:flex-end}
  .dmMsg .bubble{border-radius:18px;padding:10px 12px;background:#fff;position:relative}
  .dmMsg.right .bubble{background:var(--accent);color:#fff}
  .dmMsg .tr{margin-top:6px;padding:8px 10px;background:#f2f3ff;border-radius:12px;color:#444}
  .dmMeta{display:flex;align-items:center;gap:8px;margin-top:6px;font-size:12px;color:#9aa1ad}
  .dmMsg.left .dmMeta{justify-content:flex-start}.dmMsg.right .dmMeta{justify-content:flex-end}
  .readFlag{font-weight:900;color:var(--accent)} .readFlag.hidden{display:none}

  /* ---------- Live / Replay ---------- */
  #liveList .section{padding:10px 16px 0}
  .liveCard{display:flex;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:12px}
  .liveCard img{width:96px;height:64px;border-radius:12px;object-fit:cover}
  .liveTitle{font-weight:900}
  .liveTitle .v-badge{margin-left:6px}
  .liveState{font-size:12px;margin-top:6px}
  #liveReplay .toolbar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);cursor:pointer}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* ---------- Profile ---------- */
  #profilePage .topbar{padding:14px 16px;font-weight:900}
  #profilePage{padding-bottom:calc(120px + env(safe-area-inset-bottom,16px))}
  #profilePage .card{background:var(--card);border:1px solid var(--line);border-radius:18px;margin:12px;padding:14px}
  #profilePage .kv{display:flex;justify-content:space-between;align-items:center}
  #profilePage .avatar{width:92px;height:92px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  #profilePage .actions{display:flex;gap:12px;margin-top:8px}
  #profilePage .actions button{border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:8px 12px;cursor:pointer}

  /* ---------- å•†åº— ---------- */
  #storePage{display:none;padding-bottom:calc(120px + env(safe-area-inset-bottom,16px))}
  #storePage .topbar{padding:14px 16px;font-weight:900}
  .good{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--line);
        border-radius:16px;padding:12px;margin:12px}
  .good h4{margin:0;font-size:16px}
  .good small{color:var(--sub)}
  .good button{border:none;background:var(--accent);color:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
</style>

<!-- è‹¥ç¼ºå°‘å•†åº—é ï¼Œå‹•æ…‹è£œä¸Š -->
<div id="storePage" class="page">
  <div class="topbar">å•†åº—</div>
  <div class="good">
    <div>
      <h4>å…¨åœ˜æ„›å¿ƒ 30 å¤©</h4>
      <small>è³¼è²·å¾Œï¼šå…¨åœ˜ç•™è¨€æ¬Šï¼ˆéœ€é»æ•¸è¶³å¤ ï¼‰</small>
    </div>
    <button onclick="buyHeartsStore('group',30,300)">300 é»</button>
  </div>
  <div id="storeArtistGoods"></div>
</div>

<script>
<!-- ================== ONE-SHOT HOTFIX BUNDLE (paste before </body>) ================== -->
<style>
  :root{
    --accent:#6a5acd;      /* ä¸»ç´« */
    --accent-2:#7c6cff;    /* æ¬¡ç´« */
    --text:#222;
    --muted:#9aa1ad;
    --chip:#eef1ff;
    --line:#e6e7ee;
    --card:#fff;
    --bg:#f5f7ff;
  }

  /* -------- å…±ç”¨ -------- */
  .hidden{display:none!important;}
  .verify-badge{
    display:inline-flex; align-items:center; justify-content:center;
    width:16px; height:16px; border-radius:50%;
    font-size:11px; line-height:1; margin-left:6px;
    background:var(--chip); color:var(--accent);
    box-shadow: inset 0 0 0 1px var(--accent);
  }

  /* -------- é¦–é ï¼šStoryBar åªåœ¨é¸ä¸­æ‰ç´«åœˆèˆ‡ç´«å -------- */
  #storyBar{ background:var(--card); padding:10px 8px; }
  #storyBar .story-item, #storyBar .storyItem{
    display:flex; flex-direction:column; align-items:center; gap:6px;
    width:84px; user-select:none; cursor:pointer;
  }
  #storyBar .story-item img, #storyBar .storyItem img{
    width:66px; height:66px; border-radius:50%; object-fit:cover;
    border:2px solid #cfcfe9; box-shadow:none; transition:.15s;
  }
  #storyBar .story-item span, #storyBar .storyItem span{
    font-size:14px; color:#9aa1ad; font-weight:600;
    text-align:center; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #storyBar .story-item.active img, #storyBar .storyItem.active img{
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(106,90,205,.18);
  }
  #storyBar .story-item.active span, #storyBar .storyItem.active span{
    color:var(--accent);
  }

  /* -------- é¦–é ï¼šè²¼æ–‡å¡ç‰‡ -------- */
  .postCard{ position:relative; background:var(--card); border-radius:16px; padding:14px; margin:12px 0; box-shadow:0 1px 0 var(--line); cursor:pointer; }
  .postCard .post-head{ display:flex; gap:10px; align-items:center; }
  .postCard .post-name{ font-weight:800; color:var(--text); display:flex; align-items:center; }
  .postCard .post-name .verify-badge{ margin-left:6px; }
  .postCard .post-time{ font-size:12px; color:var(--muted); }
  .postCard .post-img{ width:100%; border-radius:16px; margin:10px 0; display:block; }
  .postCard .translate-btn{ position:absolute; top:10px; right:10px; background:var(--chip); color:#333; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-weight:700; cursor:pointer; }

  /* è®“å…§éƒ¨å¯äº¤äº’å…ƒç´ ä¸è§¸ç™¼æ•´å¡é»æ“Š */
  .postCard .translate-btn, .postCard .reaction-pill, .postCard .comment-link{ pointer-events:auto; }
  .postCard .translate-btn *,.postCard .reaction-pill *,.postCard .comment-link *{ pointer-events:none; }

  /* -------- Reaction Barï¼šè† å›ŠåŒ–ã€æ•¸å­—åœ¨å³ã€å°ºå¯¸ç²¾ç·» -------- */
  .reactions{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:10px 0 6px; }
  .reaction-pill{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 14px; border:1.2px solid var(--line); border-radius:14px;
    background:#f7f8ff; cursor:pointer; font-weight:800; user-select:none;
    height:44px;
  }
  .reaction-pill .emoji{ font-size:20px; line-height:1; }
  .reaction-pill .count{ margin-left:auto; min-width:2em; text-align:right; font-size:12px; }
  .reaction-pill.active{ background:var(--accent); color:#fff; border-color:transparent; }

  /* -------- ç•™è¨€åˆ—ï¼ˆå¦‚ä½ ç¤ºæ„ï¼‰ -------- */
  .comment-row{ display:flex; align-items:center; justify-content:space-between; padding:8px 4px 2px; }
  .comment-chip{
    display:inline-flex; align-items:center; gap:8px; border:1.2px solid var(--line); border-radius:14px;
    padding:8px 12px; background:#fff; font-weight:700; color:#333;
  }
  .comment-link{ font-weight:900; color:var(--accent); text-decoration:none; }

  /* -------- DMï¼šæ³¡æ³¡èˆ‡æ™‚é–“/æœªè®€ 1 åœ¨æ³¡æ³¡å¤– -------- */
  .dmThread{ display:flex; flex-direction:column; gap:12px; padding-bottom:120px; }
  .dmMsg{ max-width:78%; display:flex; flex-direction:column; }
  .dmMsg.left { align-self:flex-start; }
  .dmMsg.right{ align-self:flex-end; }
  .dmMsg .bubble{
    position:relative; padding:12px 14px; border-radius:16px; color:#212121;
    background:#f3eaff; /* å·¦å³é¡è‰²ä¸åŒåœ¨ render è£¡è™•ç† class */
  }
  .dmMsg.left  .bubble{ background:#eedfff; }       /* è—äººï¼šæ·¡ç´« */
  .dmMsg.right .bubble{ background:#6a5acd; color:#fff; } /* ç²‰çµ²ï¼šä¸»ç´« */
  .dmMsg .meta{
    display:flex; align-items:center; gap:8px; margin-top:6px; font-size:12px; color:var(--muted);
  }
  .dmMsg.left .meta{ justify-content:flex-start; }
  .dmMsg.right .meta{ justify-content:flex-end; }
  .dmMsg .readFlag{ font-weight:900; color:var(--accent); }
  .dmMsg.right .readFlag{ color:var(--accent); }
  .dmMsg .t-chip{
    display:inline-block; margin-top:8px; padding:6px 10px; border-radius:999px;
    background:#edf0ff; color:#333; font-weight:800; font-size:12px;
  }
  .dmMsg.right .t-chip{ background:#fff; color:#333; }

  /* -------- ç›´æ’­åˆ—è¡¨ï¼šå»æ‰ã€Œå³å°‡é–‹å§‹ã€èˆ‡å³ä¸Šè§’å­—ã€æ’åº Chips -------- */
  .live-subtitle,.live-upcoming{ display:none !important; } /* ç›´æ¥éš±è—ç¾æœ‰å€å¡Šï¼ˆè‹¥æœ‰ï¼‰ */
  .live-sort{
    display:flex; gap:8px; justify-content:flex-end; margin:8px 12px 4px;
  }
  .sort-chip{
    padding:6px 12px; border-radius:999px; border:1.2px solid var(--line); background:#fff; cursor:pointer; font-weight:800;
  }
  .sort-chip.active{ background:var(--accent); color:#fff; border-color:transparent; }

  .live-card{ display:flex; gap:14px; align-items:center; background:#fff; border-radius:18px; padding:12px; box-shadow:0 1px 0 var(--line); cursor:pointer; }
  .live-card .cover{ width:96px; height:56px; border-radius:12px; object-fit:cover; }
  .live-card .title{ font-weight:900; display:flex; align-items:center; gap:6px; }
  .live-card .title .verify-badge{ margin-left:6px; }
  .live-card .status{ font-size:13px; color:#29a38f; font-weight:800; }

  /* -------- Profileï¼šæ‹¿æ‰å¤§èƒŒæ™¯ã€åº•éƒ¨å®‰å…¨è· -------- */
  #profileHeader{ display:none !important; }
  #profilePage, #profile{ padding-bottom: calc(120px + env(safe-area-inset-bottom,16px)) !important; }
  .profile-actions-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .profile-actions-row button{ border:1.2px solid var(--line); background:var(--chip); border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; }

  /* -------- Navï¼šæŠŠã€Œæˆ‘çš„ã€æ”¹æˆã€Œå•†åº—ã€ -------- */
  .tab-store .icon::after{ content:"ğŸ›ï¸"; }
</style>

<script>
(function(){
  /* ----------------------- è³‡æ–™å¿«å–ï¼ˆç¤ºä¾‹ï¼‰ ----------------------- */
  window.postsData = window.postsData || window.posts || [];  // æ¯ç­†éœ€å« {id, artistId, artistName, title, img, time, comments:[...]}
  window.artists   = window.artists   || [
    {id:'all', name:'ALL', avatar:''},
    {id:'woochan', name:'Woochan'},
    {id:'dohee', name:'Dohee'},
    {id:'annie', name:'Annie'},
    {id:'allday', name:'ALLDAY PROJECT'}
  ];
  window.REACTION_TYPES = window.REACTION_TYPES || [
    {key:'thumb',icon:'ğŸ‘'},{key:'love',icon:'ğŸ˜'},{key:'laugh',icon:'ğŸ¤£'},
    {key:'clap',icon:'ğŸ‘'},{key:'panda',icon:'ğŸ¼'},{key:'tears',icon:'ğŸ¥²'}
  ];
  const g = k => JSON.parse(localStorage.getItem(k)||'{}');
  const s = (k,v) => localStorage.setItem(k,JSON.stringify(v));

  /* ----------------------- StoryBar é«˜äº® + æ­£ç¢ºç¯©é¸ ----------------------- */
  window.currentFilter = window.currentFilter || 'all';
  window.renderStoryBar = function(){
    const bar = document.getElementById('storyBar'); if(!bar) return;
    bar.innerHTML = '';
    artists.forEach(a=>{
      const item = document.createElement('div');
      item.className = 'story-item'+(a.id===currentFilter?' active':'');
      item.dataset.id = a.id;
      item.innerHTML = `
        <img src="${a.avatar||'https://picsum.photos/seed/'+a.id+'/120/120'}" loading="lazy">
        <span>${a.name}</span>`;
      item.addEventListener('click', (e)=>{
        e.stopPropagation(); renderFeed(a.id);
        bar.querySelectorAll('.story-item').forEach(x=>x.classList.toggle('active', x.dataset.id===a.id));
        window.scrollTo({top:0, behavior:'smooth'});
      });
      bar.appendChild(item);
    });
  };

  /* ----------------------- é¦–é è²¼æ–‡ï¼šæ•´å¡å¯é»é€²è©³æƒ…ï¼ˆæ’é™¤ç¿»è­¯/åæ‡‰/ç•™è¨€ï¼‰ ----------------------- */
  function cardOpenHandler(postId){
    if (window.openPostDetail) return openPostDetail(postId);
    alert('æ‰“é–‹è²¼æ–‡è©³æƒ…ï¼š'+postId);
  }

  function renderReactionsBar(postId){
    const data   = g('reactions:'+postId);
    const myData = g('myReacts:'+postId);
    const pills = (window.REACTION_TYPES).map(r=>{
      const cnt = data[r.key]||0, active = myData[r.key]?'active':'';
      const n = cnt>0?cnt:'';
      return `<div class="reaction-pill ${active}" data-type="${r.key}">
                <span class="emoji">${r.icon}</span>
                <span class="count">${n}</span>
              </div>`;
    }).join('');
    return `<div class="reactions" data-post="${postId}">${pills}</div>`;
  }

  function renderCommentRow(post){
    const c = (post.comments||[]).length||0;
    return `<div class="comment-row">
      <div class="comment-chip"><span>ğŸ’¬</span><span>${c}</span></div>
      <a class="comment-link" href="javascript:void(0)">ç™¼è¡¨è©•è«–</a>
    </div>`;
  }

  window.renderFeed = function(filter='all'){
    window.currentFilter = filter;
    const feed = document.getElementById('feed'); if(!feed) return;

    const list = (filter==='all')? postsData : postsData.filter(p=> (p.artistId||'').toLowerCase()===filter);
    feed.innerHTML = list.map(p=>{
      const nameHtml = `${p.artistName||'Artist'} <span class="verify-badge">âœ“</span>`;
      return `<article class="postCard" data-id="${p.id}">
        <div class="post-head">
          <img src="${p.artistAvatar||'https://picsum.photos/seed/a'+p.id+'/64/64'}" width="40" height="40" style="border-radius:50%">
          <div>
            <div class="post-name">${nameHtml}</div>
            <div class="post-time">${p.time||''}</div>
          </div>
          <button class="translate-btn" data-id="${p.id}">ç¿»è­¯</button>
        </div>
        <img class="post-img" src="${p.img||'https://picsum.photos/seed/p'+p.id+'/900/600'}" alt="">
        ${renderReactionsBar(p.id)}
        ${renderCommentRow(p)}
      </article>`;
    }).join('');

    // ç¶å®šæ•´å¡é»æ“Šï¼ˆæ’é™¤äº¤äº’å…ƒä»¶ï¼‰
    feed.querySelectorAll('.postCard').forEach(card=>{
      const postId = card.dataset.id;
      card.addEventListener('click', e=>{
        const t = e.target;
        if (t.closest('.reaction-pill') || t.closest('.translate-btn') || t.closest('.comment-link')) return;
        cardOpenHandler(postId);
      });
      // Reaction é»æ“Š
      card.querySelectorAll('.reaction-pill').forEach(pill=>{
        pill.addEventListener('click', e=>{
          e.stopPropagation();
          const type = pill.dataset.type;
          const data   = g('reactions:'+postId);
          const myData = g('myReacts:'+postId);
          if (myData[type]){ // å–æ¶ˆ
            delete myData[type];
            data[type]=Math.max((data[type]||0)-1,0);
            pill.classList.remove('active');
          }else{ // å–®é¸
            for (const k in myData){ if(myData[k]){ delete myData[k]; const n = g('reactions:'+postId); n[k]=Math.max((n[k]||0)-1,0); s('reactions:'+postId,n); } }
            myData[type]=true;
            const n2 = g('reactions:'+postId); n2[type]=(n2[type]||0)+1; s('reactions:'+postId,n2);
            card.querySelectorAll('.reaction-pill').forEach(x=>x.classList.remove('active'));
            pill.classList.add('active');
          }
          s('myReacts:'+postId,myData);
          const final = g('reactions:'+postId); pill.querySelector('.count').textContent = final[type]||'';
        });
      });
      // ç¿»è­¯ï¼ˆç¤ºä¾‹ï¼šåƒ…åˆ‡æ›æ–‡æ¡ˆé¡¯ç¤ºï¼‰
      card.querySelector('.translate-btn').addEventListener('click', e=>{
        e.stopPropagation();
        alert('ï¼ˆç¤ºæ„ï¼‰å·²ç¿»è­¯ä¸»æ–‡ / è©•è«–ç¿»è­¯åŒæ¨£å¯ç”¨ chip è§¸ç™¼');
      });
      // ç™¼è¡¨è©•è«–
      card.querySelector('.comment-link').addEventListener('click', e=>{
        e.stopPropagation();
        cardOpenHandler(postId);
      });
    });
  };

  /* ----------------------- DMï¼šæ™‚é–“èˆ‡ 1 åœ¨æ³¡æ³¡å¤–ï¼›åªæœ‰ã€Œè—äººå·²è®€ã€æ‰æ¶ˆå¤± ----------------------- */
  window.renderDm = function(chatId){
    const box = document.getElementById('dmThread') || document.getElementById('dmBox');
    if(!box) return;

    const list = (window.dmMessages && window.dmMessages[chatId]) || [];
    box.innerHTML = list.map(m=>{
      const isRight = m.from==='right';
      const showFlag = isRight && !m.readByArtist;
      const timeStr = new Date(m.ts||Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const nameHtml = (m.role==='artist')
        ? `${m.name||'Artist'} <span class="verify-badge">âœ“</span>`
        : (m.name ? `${m.name}` : '');
      const bubbleInner = `
        ${m.text ? `<div>${m.text}</div>`:''}
        ${m.translated ? `<div style="margin-top:6px; padding-top:6px; border-top:1px dashed rgba(0,0,0,.1); opacity:.9"><small>${m.translated}</small></div>`:''}
        <span class="t-chip">ç¿»è­¯</span>`;
      return `
        <div class="dmMsg ${isRight?'right':'left'}" data-id="${m.id}">
          <div class="bubble">${bubbleInner}</div>
          <div class="meta">
            ${isRight?`<span class="readFlag ${showFlag?'':'hidden'}" id="rf-${m.id}">1</span>`:''}
            <span class="time">${timeStr}</span>
          </div>
        </div>`;
    }).join('');

    // é»ã€Œç¿»è­¯ã€chipï¼šåŸæ–‡åœ¨ä¸Šã€ç¿»è­¯åœ¨ä¸‹ï¼ˆåˆ‡æ›ï¼‰
    box.querySelectorAll('.dmMsg .t-chip').forEach(ch=>{
      ch.addEventListener('click', e=>{
        e.stopPropagation();
        const parent = ch.closest('.dmMsg');
        const id = parent.dataset.id;
        const chat = window.dmMessages[chatId];
        const msg = chat.find(x=>x.id===id);
        if (!msg) return;
        if (msg.translated){ delete msg.translated; }
        else { msg.translated = 'ï¼ˆç¿»è­¯ï¼‰'+ (msg.text || ''); }
        renderDm(chatId);
      });
    });

    // é•·æŒ‰å³å´æ³¡æ³¡ â†’ æ¨¡æ“¬ã€Œè—äººå·²è®€ã€ï¼ˆé–‹ç™¼æ¸¬è©¦ï¼‰
    box.querySelectorAll('.dmMsg.right .bubble').forEach(b=>{
      const id = b.closest('.dmMsg').dataset.id;
      let t=null;
      const start=()=>{ t=setTimeout(()=>{ markArtistRead(chatId, id); },650); };
      const end=()=>{ if(t){clearTimeout(t);t=null;} };
      b.addEventListener('mousedown', start); b.addEventListener('mouseup', end); b.addEventListener('mouseleave', end);
      b.addEventListener('touchstart', start, {passive:true}); b.addEventListener('touchend', end); b.addEventListener('touchcancel', end);
    });

    box.scrollTop = box.scrollHeight;
  };

  window.sendDm = function(){
    const input = document.getElementById('dmInput') || document.getElementById('dmMessageInput');
    if(!input) return;
    const val = (input.value||'').trim(); if(!val) return;
    const chatId = window.currentChat || 'default';
    if (!window.dmMessages) window.dmMessages = {};
    if (!window.dmMessages[chatId]) window.dmMessages[chatId] = [];
    window.dmMessages[chatId].push({
      id:'m'+Date.now(), from:'right', text:val, ts:Date.now(),
      readByArtist:false, role:'fan', name: (window.profileName || 'Me')
    });
    input.value=''; renderDm(chatId);
  };

  window.markArtistRead = function(chatId, msgId){
    const list = window.dmMessages?.[chatId]; if(!list) return;
    const m = list.find(x=>x.id===msgId); if(!m) return;
    if (m.from==='right'){
      m.readByArtist = true;
      const flag = document.getElementById('rf-'+msgId);
      if (flag) flag.classList.add('hidden');
    }
  };

  /* ----------------------- ç›´æ’­åˆ—è¡¨ï¼šåˆªã€Œå³å°‡é–‹å§‹ã€/åŠ æ’åº/å¯é»è©³æƒ…/åç¨±å¸¶å‹¾ ----------------------- */
  function renderLiveList(){
    const root = document.getElementById('liveList') || document.getElementById('liveEnded')?.parentElement;
    if(!root) return;

    // å‡è³‡æ–™ä¾†æº
    const lives = (window.livesData || []).map(x=>({...x}));
    // å¦‚æœé é¢å·²ç¶“æœ‰å¡ç‰‡ä¸”æ²’æœ‰ livesDataï¼Œå°±å¾ DOM è®€ï¼ˆç›¡é‡å…¼å®¹ï¼‰
    if (!lives.length){
      document.querySelectorAll('.live-card[data-id]').forEach(card=>{
        lives.push({
          id: card.dataset.id,
          title: card.querySelector('.title')?.textContent?.trim() || 'Live',
          cover: card.querySelector('img')?.src,
          ts: +card.dataset.ts || Date.now()-Math.random()*1e7,
          status: card.dataset.status || 'ended',
          artist: card.dataset.artist || 'ALLEY'
        });
      });
    }

    // å·¥å…·æ¢ï¼ˆæ’åºï¼‰
    const holder = document.getElementById('liveEnded') || root;
    const toolbar = document.createElement('div');
    toolbar.className='live-sort';
    toolbar.innerHTML = `
      <button class="sort-chip active" data-sort="desc">æœ€æ–°å„ªå…ˆ</button>
      <button class="sort-chip" data-sort="asc">æœ€èˆŠå„ªå…ˆ</button>`;
    holder.before(toolbar);

    function draw(sort='desc'){
      const endedList = lives.filter(l=>l.status!=='live'); // åªç•«å›æ”¾
      endedList.sort((a,b)=> sort==='asc' ? (a.ts-b.ts) : (b.ts-a.ts));
      holder.innerHTML = endedList.map(l=>`
        <div class="live-card" data-id="${l.id}" data-ts="${l.ts}">
          <img class="cover" src="${l.cover||'https://picsum.photos/seed/l'+l.id+'/240/140'}" alt="">
          <div class="info">
            <div class="title">${l.title} <span class="verify-badge">âœ“</span></div>
            <div class="time" style="color:#9aa1ad">${new Date(l.ts).toLocaleDateString()}</div>
          </div>
        </div>
      `).join('');
      holder.querySelectorAll('.live-card').forEach(c=>{
        c.addEventListener('click', ()=>{
          if (window.openLiveDetail) return openLiveDetail(c.dataset.id);
          location.hash = '#live-'+c.dataset.id; // å…¼å®¹ï¼šæ²’æœ‰å‡½å¼å°±ç”¨ hash
        });
      });
    }
    draw('desc');

    toolbar.querySelectorAll('.sort-chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        toolbar.querySelectorAll('.sort-chip').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        draw(btn.dataset.sort);
      });
    });

    // é€²è¡Œä¸­å€å¡Šåå­—é¡¯ç¤ºç‚ºç´«è‰² + å‹¾
    document.querySelectorAll('.live-card[data-status="live"] .title').forEach(t=>{
      t.style.color = 'var(--accent)';
      if (!t.querySelector('.verify-badge')) t.insertAdjacentHTML('beforeend',' <span class="verify-badge">âœ“</span>');
    });

    // ç§»é™¤å³ä¸Šè§’é‚£è¡Œå­—ï¼ˆè‹¥å­˜åœ¨ï¼‰
    const sub = Array.from(document.querySelectorAll('*')).find(x=>x.textContent?.trim()==='ç²‰çµ²é™å®šèŠå¤©å®¤');
    if (sub) sub.remove();
    // ç§»é™¤ã€Œå³å°‡é–‹å§‹ã€å€å¡Šï¼ˆè‹¥å­˜åœ¨ï¼‰
    const upcoming = document.querySelector('.live-upcoming') || document.getElementById('liveUpcoming');
    if (upcoming) upcoming.remove();
  }

  /* ----------------------- Profileï¼šé¦–é é€²å…¥ï¼›nav æ”¹ã€Œå•†åº—ã€ ----------------------- */
  function patchNavToStore(){
    const nav = document.getElementById('bottomNav') || document.querySelector('.bottom-nav');
    if(!nav) return;
    // æŠŠæœ€å¾Œä¸€å€‹ tab æ”¹åç‚ºã€Œå•†åº—ã€
    const tabs = nav.querySelectorAll('[data-tab]');
    const last = tabs[tabs.length-1];
    if (last){
      last.dataset.tab = 'store';
      last.classList.add('tab-store');
      last.querySelector('.label').textContent = 'å•†åº—';
      last.addEventListener('click', ()=> openStore());
    }
  }
  function openStore(){
    const p = document.getElementById('storePage');
    if (!p){
      const container = document.getElementById('pages') || document.body;
      const el = document.createElement('section');
      el.id='storePage';
      el.innerHTML = `
        <h2 style="margin:16px 12px 8px">å•†åº—</h2>
        <div style="padding:0 12px 120px">
          <div style="margin:12px 0; font-weight:900">è³¼è²·æ„›å¿ƒï¼ˆå€‹äººï¼‰</div>
          <div class="profile-actions-row">
            <button data-artist="woochan" data-days="30" data-cost="1000">Woochan 30å¤©ï¼ˆ1000é»ï¼‰</button>
            <button data-artist="dohee"   data-days="30" data-cost="1000">Dohee 30å¤©ï¼ˆ1000é»ï¼‰</button>
            <button data-artist="annie"   data-days="30" data-cost="1000">Annie 30å¤©ï¼ˆ1000é»ï¼‰</button>
          </div>
          <div style="margin:16px 0; font-weight:900">è³¼è²·æ„›å¿ƒï¼ˆåœ˜é«”ï¼‰</div>
          <div class="profile-actions-row">
            <button data-artist="group"   data-days="30" data-cost="2400">ALlday 30å¤©ï¼ˆ2400é»ï¼‰</button>
          </div>
          <p style="margin-top:16px; color:#666">ï¼Šå¾Œå°é»æ•¸ç‚ºäººå·¥åŒæ­¥ï¼›è‹¥é»æ•¸ä¸è¶³æœƒæç¤ºï¼Œä¸æœƒè‡ªå‹•æ‰£ã€‚</p>
        </div>`;
      container.appendChild(el);
      el.querySelectorAll('button[data-cost]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const cost = +btn.dataset.cost, days=+btn.dataset.days, who=btn.dataset.artist;
          const wallet = +(localStorage.getItem('wallet')||'0');
          if (wallet >= cost){
            localStorage.setItem('wallet', wallet - cost);
            const key = who==='group' ? 'heartGroupDays' : `heart:${who}`;
            const left = +(localStorage.getItem(key)||'0');
            localStorage.setItem(key, left + days);
            alert('è³¼è²·æˆåŠŸï¼å·²åŠ å¤©æ•¸ï¼Œä¸¦æ‰£é™¤é»æ•¸ã€‚');
          }else{
            alert('é»æ•¸ä¸è¶³ã€‚å°‡ç”±ç®¡ç†å“¡æ–¼å¾Œå°åŠ å€¼å¾Œå†è³¼è²·ã€‚');
          }
        });
      });
    }
    // é¡¯ç¤º storePageï¼ˆä½ åŸæœ¬çš„åˆ‡é æ©Ÿåˆ¶å¯è‡ªè¡Œæ¥ï¼‰
    document.querySelectorAll('section[id$="Page"]').forEach(x=>x.style.display='none');
    document.getElementById('storePage').style.display='block';
  }

  /* ----------------------- å•Ÿå‹•ï¼šæŒ‰ä½ é é¢ç¾æ³ç›¡é‡è‡ªå‹•è²¼åˆ ----------------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    try{ renderStoryBar(); }catch(e){}
    try{ renderFeed(currentFilter); }catch(e){}

    // ç›´æ’­é ä¿®è£œ
    try{ renderLiveList(); }catch(e){}

    // Nav æ”¹å•†åº—
    try{ patchNavToStore(); }catch(e){}

    // è‹¥ä¸€é–‹å§‹å°±åœ¨ DM
    const dmBox = document.getElementById('dmThread')||document.getElementById('dmBox');
    if (dmBox && window.currentChat){ renderDm(window.currentChat); }
  });
})();
</script>
<!-- ================== /ONE-SHOT HOTFIX BUNDLE ================== -->
</body>
</html>
