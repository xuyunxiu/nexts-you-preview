<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEXT'S YOU — Preview</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
    }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #222; display: flex; justify-content: space-around;
      padding: 10px 0;
    }
    nav.hidden { display: none; }
    nav button {
      background: none; border: none; color: #fff; font-size: 16px;
    }
    .btn {
      display: inline-block; padding: 10px 20px; margin: 10px;
      border-radius: 6px; font-size: 16px; cursor: pointer;
    }
    .btn-red { background: red; color: #fff; }
    input { padding: 8px; border-radius: 4px; border: none; margin: 5px; }
    .topbar {
      display: flex; justify-content: space-between; align-items: center;
    }
    .hearts {
      font-size: 18px; color: pink;
    }
    .product {
      background: #222; margin: 10px; padding: 15px; border-radius: 8px;
    }

    /* --- DM 訊息與翻譯副泡泡 --- */
    .dm-topbar {
      display:flex;justify-content:space-between;align-items:center;
      padding:10px;background:#222;
      position:sticky;top:0;
    }
    .dm-messages {
      min-height:300px;
      padding:10px;
      text-align:left;
      background:#1a1a1a;
    }
    .msg {
      max-width:75%;padding:10px 14px;border-radius:16px;margin:6px 0;
      font-size:15px;line-height:1.4;word-break:break-word;
    }
    .msg.me {
      background:#5a4036;color:#fff;margin-left:auto;
      border-bottom-right-radius:4px;
    }
    .msg.artist {
      background:#fff;color:#111;
      border-bottom-left-radius:4px;
    }
    .sub-balloon {
      margin-top:6px;padding:8px 12px;background:#eee;color:#555;
      border-radius:12px;font-size:13px;line-height:1.3;
    }
    .dm-input {
      display:flex;gap:10px;padding:10px;background:#222;
      position:sticky;bottom:0;
    }
    .dm-input input {
      flex:1;padding:8px;border-radius:16px;border:none;
    }
    .dm-input button {
      border:none;background:red;color:#fff;
      padding:8px 14px;border-radius:50%;
    }
  </style>
</head>
<body>
  <!-- 登入頁 -->
  <section id="login" class="active">
    <h2>登入</h2>
    <button class="btn btn-red" onclick="login('line')">用 LINE 登入（模擬）</button>
    <br>
    <input type="text" id="inviteCode" placeholder="輸入邀請碼，例如 NEXT2025">
    <button class="btn" onclick="login('code')">使用邀請碼</button>
  </section>

  <!-- 首頁 -->
  <section id="home">
    <div class="topbar">
      <h2>首頁</h2>
    </div>
    <p>這裡是首頁內容！</p>
    <p><strong>我的分數：</strong><span id="points">0</span></p>
    <h3>商品區</h3>
    <div class="product">
      <p>7天 DM 權益 — 70 分</p>
      <button onclick="buyProduct(70,7)">購買</button>
    </div>
    <div class="product">
      <p>30天 DM 權益 — 250 分</p>
      <button onclick="buyProduct(250,30)">購買</button>
    </div>
  </section>

  <!-- DM -->
  <section id="dm">
    <div class="dm-topbar">
      <button onclick="showPage('home')">‹</button>
      <div>ALLDAY PROJECT — 團體 DM</div>
      <div style="display:flex;align-items:center;gap:12px">
        <button>▦</button>
        <div class="hearts">♡<span id="heartDays">0</span></div>
      </div>
    </div>
    <div id="dm-messages" class="dm-messages"></div>
    <div class="dm-input">
      <input id="dmInput" placeholder="輸入訊息…" />
      <button onclick="sendMessage()">➤</button>
    </div>
  </section>

  <!-- 相簿 -->
  <section id="gallery">
    <h2>相簿</h2>
    <p>藝人上傳的圖片會顯示在這裡。</p>
  </section>

  <!-- 直播 -->
  <section id="live">
    <h2>直播</h2>
    <p>文字直播或影片牆。</p>
  </section>

  <!-- 底部導覽 -->
  <nav id="nav" class="hidden">
    <button onclick="showPage('home')">首頁</button>
    <button onclick="showPage('dm')">DM</button>
    <button onclick="showPage('gallery')">相簿</button>
    <button onclick="showPage('live')">直播</button>
  </nav>

  <script>
    // 假的初始分數
    if (!localStorage.getItem('points')) {
      localStorage.setItem('points', 200);
    }

    // === 每位用戶獨立訊息 ===
    if (!localStorage.getItem('userId')) {
      localStorage.setItem('userId', 'u_' + Math.random().toString(36).slice(2,10));
    }
    const USER_ID = localStorage.getItem('userId');
    const DM_KEY = `dm_${USER_ID}`;

    if (!localStorage.getItem(DM_KEY)) {
      const seed = [
        { role:'artist', text:'歡迎來到 DM！', trans:'Welcome to DM!', ts: Date.now() }
      ];
      localStorage.setItem(DM_KEY, JSON.stringify(seed));
    }

    // 登入
    function login(method) {
      if (method === 'line' || (method === 'code' && document.getElementById('inviteCode').value.trim() === 'NEXT2025')) {
        localStorage.setItem('loggedIn', 'true');
        showPage('home');
        renderPoints();
      } else {
        alert('邀請碼錯誤！');
      }
    }

    // 切換頁面
    function showPage(page) {
      if (!localStorage.getItem('loggedIn') && page !== 'login') {
        page = 'login';
      }
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      const nav = document.getElementById('nav');
      if (localStorage.getItem('loggedIn') && page !== 'login') {
        nav.classList.remove('hidden');
      } else {
        nav.classList.add('hidden');
      }
      if (page === 'home') renderPoints();
      if (page === 'dm') { renderHearts(); renderDM(); }
    }

    // 分數顯示
    function renderPoints() {
      document.getElementById('points').textContent = localStorage.getItem('points');
    }

    // 購買
    function buyProduct(cost, days) {
      let points = parseInt(localStorage.getItem('points'));
      if (points >= cost) {
        points -= cost;
        localStorage.setItem('points', points);
        localStorage.setItem('purchaseDate', new Date().toISOString().split('T')[0]);
        localStorage.setItem('duration', days);
        alert(`✅ 已購買 ${days} 天 DM 權益！`);
        renderPoints();
      } else {
        alert('分數不足！');
      }
    }

    // Hearts (♡+N)
    function daysSince(dateStr) {
      if (!dateStr) return 0;
      const start = new Date(dateStr);
      const today = new Date();
      start.setHours(0,0,0,0);
      today.setHours(0,0,0,0);
      return Math.floor((today - start) / 86400000);
    }
    function renderHearts() {
      const start = localStorage.getItem('purchaseDate');
      const duration = parseInt(localStorage.getItem('duration') || 0);
      if (!start) {
        document.getElementById('heartDays').textContent = "0";
        return;
      }
      const n = daysSince(start);
      if (n <= duration) {
        document.getElementById('heartDays').textContent = n;
      } else {
        document.getElementById('heartDays').textContent = "0";
      }
    }

    // DM 渲染
    function renderDM(){
      const list = JSON.parse(localStorage.getItem(DM_KEY) || '[]');
      const box = document.getElementById('dm-messages');
      if (!box) return;
      box.innerHTML = '';
      list.forEach(m => {
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (m.role === 'fan' ? 'me' : 'artist');
        wrap.textContent = m.text;
        if (m.role === 'artist' && m.trans) {
          const sub = document.createElement('div');
          sub.className = 'sub-balloon';
          sub.textContent = m.trans;
          wrap.appendChild(sub);
        }
        box.appendChild(wrap);
      });
    }

    // 粉絲送出訊息
    function sendMessage(){
      const inp = document.getElementById('dmInput');
      const t = (inp.value || '').trim();
      if (!t) return;
      const list = JSON.parse(localStorage.getItem(DM_KEY) || '[]');
      list.push({ role:'fan', text:t, ts: Date.now() });
      localStorage.setItem(DM_KEY, JSON.stringify(list));
      inp.value = '';
      renderDM();
    }

    // 新增藝人訊息（手動觸發測試用）
    function addArtistMessage(text, translation){
      const list = JSON.parse(localStorage.getItem(DM_KEY) || '[]');
      list.push({ role:'artist', text, trans: translation || '', ts: Date.now() });
      localStorage.setItem(DM_KEY, JSON.stringify(list));
      renderDM();
    }

    // 預設
    window.onload = () => {
      if (localStorage.getItem('loggedIn')) {
        showPage('home');
      } else {
        showPage('login');
      }
    };
  </script>
</body>
</html>
