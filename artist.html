<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NEXT’S YOU — artist（整合版）</title>

<style>
/* ================= iOS 26 • Liquid Glass 視覺系統（刪舊貼新） ================= */
:root{
  /* 色票與材質（OKLCH/混色友好；fallback 仍是 HEX/RGBA） */
  color-scheme: light;

  /* Base tones */
  --bg: #eef2ff;
  --bg-2: #f6f7ff;
  --text:#11131a;
  --sub:#667085;
  --ghost:#9aa0b4;
  --line:#e7eaf3;

  /* Accent（淡紫藍調；具備亮度梯度） */
  --accent:#6a5acd;
  --accent2:#836fff;
  --accent-ink:#20185a;

  /* 狀態色 */
  --danger:#ff3b30;
  --success:#34c759;

  /* 卡片圓角與投影 */
  --radius:16px;
  --radius-lg:22px;
  --radius-xl:28px;
  --shadow-1: 0 6px 18px rgba(17,23,41,.12);
  --shadow-2: 0 12px 34px rgba(17,23,41,.14);
  --shadow-3: 0 22px 60px rgba(17,23,41,.18);

  /* 安全區與佈局量測 */
  --safe:env(safe-area-inset-bottom,0px);
  --kb-offset:0px;
  --footer-h:96px;
  --hud-h:68px;
  --reply-size:30px;
  --reply-gap:18px;
  --notice-h:0px;

  /* Liquid Glass 材質 */
  --glass-blur:14px;
  --glass-sat:180%;
  --glass-bg: rgba(255,255,255,.20);
  --glass-bg-2: rgba(255,255,255,.10);
  --glass-stroke: rgba(255,255,255,.42);
  --glass-sheen: radial-gradient(130% 80% at 28% 22%, rgba(255,255,255,.75), rgba(255,255,255,0) 62%);
  --ink:#11131a;
  --rail-bg1: rgba(255,255,255,.18);
  --rail-bg2: rgba(255,255,255,.78);
  --rail-stroke: rgba(255,255,255,.45);
  --rail-tint: rgba(123,109,255,.22);

  /* Artist 主題漸層（沿用） */
  --artist: linear-gradient(180deg, var(--accent), var(--accent2));

  /* 互動色塊 */
  --hover:#fff;

  /* DM 泡泡專用（保持白/灰，但升級質感） */
  --dm-left-bg:#ffffff;
  --dm-left-stroke:#e6e9f5;
  --dm-left-shadow: 0 4px 14px rgba(17,23,41,.10), 0 1px 0 rgba(255,255,255,.80) inset;
  --dm-right-bg:#6b7280;
  --dm-right-stroke: rgba(255,255,255,.18);
  --dm-right-shadow: 0 6px 16px rgba(0,0,0,.22), 0 1px 0 rgba(255,255,255,.20) inset;

  /* LIVE */
  --live-hair: var(--line);
}

/* 深色模式（可選） */
@media (prefers-color-scheme: dark){
  :root{
    color-scheme: dark;
    --bg:#0d0f17; --bg-2:#0f121c;
    --text:#e9edf5; --sub:#a6aec2; --ghost:#8791a8; --line:#1f2534;
    --hover: #101521;

    --glass-bg: rgba(20,22,30,.45);
    --glass-bg-2: rgba(16,18,26,.28);
    --glass-stroke: rgba(255,255,255,.20);

    --accent:#9da3ff; --accent2:#b7a5ff; --accent-ink:#cfd3ff;

    --dm-left-bg:#12131a; --dm-left-stroke:#252a39;
    --dm-left-shadow: 0 6px 18px rgba(0,0,0,.36), 0 1px 0 rgba(255,255,255,.06) inset;
    --dm-right-bg:#5f6a86; --dm-right-stroke: rgba(255,255,255,.16);
    --dm-right-shadow: 0 10px 20px rgba(0,0,0,.38), 0 1px 0 rgba(255,255,255,.08) inset;

    --live-hair:#2a3144;
  }
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  background: var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  overflow-x:hidden;
  /* 背景霧化暈染（Liquid Glass 背板） */
}
img{display:block;max-width:100%}
a{text-decoration:none;color:inherit}
button{font:inherit;cursor:pointer;background:transparent;border:none}

.ghost{color:var(--ghost)}
.sub{color:var(--sub)}
.soft{padding:16px}
.row{display:flex;align-items:center;gap:10px}

/* =================== 背景墨暈（iOS26） =================== */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(120% 80% at 0% 0%, #b8c6ff66 0%, transparent 42%),
    radial-gradient(100% 70% at 100% 12%, #c6b6ff66 0%, transparent 48%),
    radial-gradient(120% 80% at 40% 110%, #a9d3ff66 0%, transparent 50%),
    linear-gradient(180deg, var(--bg), var(--bg-2));
  filter:saturate(112%) blur(10px);
}

/* =================== 卡片/晶片 • Liquid Glass =================== */
.card{
  background: linear-gradient(180deg,var(--glass-bg),var(--glass-bg-2));
  border:1px solid var(--glass-stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow-2);
  backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;
  background:linear-gradient(180deg,rgba(255,255,255,.24),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}
.chip.danger{
  background:linear-gradient(180deg,#ff6b6b,#ff3b30);
  color:#fff; border-color:transparent;
  box-shadow:0 6px 14px rgba(255,59,48,.28);
}

/* ========== 高透淡紫玻璃按鈕（升級版） ========== */
.btnGlassViolet{
  position:relative; display:inline-flex; align-items:center; justify-content:center;
  min-width:56px; height:38px; padding:0 12px;
  border-radius:12px; font-size:14px; font-weight:900; letter-spacing:.25px;
  color:var(--accent-ink);
  border:1px solid rgba(255,255,255,.55);
  background:linear-gradient(180deg, rgba(198,186,255,.42), rgba(210,200,255,.16));
  backdrop-filter:saturate(180%) blur(14px);
  -webkit-backdrop-filter:saturate(180%) blur(14px);
  box-shadow:
    0 1px 0 rgba(255,255,255,.70) inset,
    0 -8px 20px rgba(0,0,0,.10) inset,
    0 10px 28px rgba(17,23,41,.18);
  -webkit-tap-highlight-color:transparent;
}
.btnGlassViolet::before{
  content:""; position:absolute; inset:1px; border-radius:inherit;
  background: var(--glass-sheen);
  pointer-events:none; mix-blend-mode:soft-light;
}
.btnGlassViolet:hover{ filter:saturate(1.05) }
.btnGlassViolet:active{
  transform:translateY(1px) scale(.985);
  box-shadow:
    0 1px 0 rgba(255,255,255,.70) inset,
    0 -6px 16px rgba(0,0,0,.10) inset,
    0 6px 18px rgba(17,23,41,.20);
}
.btnGlassViolet:disabled{
  opacity:.65; color:#847ac7; cursor:not-allowed; filter:saturate(.7);
}

/* 無 backdrop-filter 降級 */
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))){
  .card{ background:#fff }
  .chip{ background:#f2f4ff }
  .btnGlassViolet{ background:linear-gradient(180deg,#efeaff,#e6e0ff) }
}

/* =================== Page 容器與轉場 =================== */
section.page{
  display:none;
  padding:12px 12px calc(76px + var(--safe));
  min-height:100svh;
  container-type: inline-size;
}
section.page.active{display:block;animation:fade .22s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
body.nav-hidden section.page{padding-bottom:12px}

/* =================== Bottom Nav（Weverse 與 Bubbles） =================== */
nav#nav.weverse{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(10px + var(--safe));
  width:min(540px,92vw);
  z-index:40;

  display:flex; justify-content:space-evenly; gap:0;
  padding:10px 12px; border-radius:22px;

  background:linear-gradient(180deg, rgba(255,255,255,.42), rgba(255,255,255,.12));
  border:1px solid rgba(255,255,255,.45);
  box-shadow:
    0 1px 0 rgba(255,255,255,.70) inset,
    0 -10px 24px rgba(0,0,0,.12) inset,
    0 12px 30px rgba(17,23,41,.22);
  backdrop-filter:saturate(180%) blur(14px);
  -webkit-backdrop-filter:saturate(180%) blur(14px);
  transition:transform .25s ease;
}
nav#nav.weverse.hidden{ transform:translateX(-50%) translateY(120%) }
nav#nav.weverse .navItem{
  position:relative; flex:0 0 auto; min-width:66px;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:6px 0; color:#2f246f; font-weight:900; letter-spacing:.2px;
}
nav#nav.weverse .i{ width:22px;height:22px; display:grid; place-items:center }
nav#nav.weverse .i svg{ width:22px;height:22px; display:block }
nav#nav.weverse .t{ font-size:11.5px; line-height:1 }
nav#nav.weverse .navItem.active{ color:var(--accent) }
nav#nav.weverse .navItem:active{ transform:translateY(1px) }

/* Bubbles 版本（單顆） */
nav#nav.bubbles{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(10px + var(--safe)); width:min(540px,92vw);
  z-index:40; display:flex; gap:10px; padding:8px; border-radius:22px;
  background:transparent;
}
nav#nav.bubbles .navItem{
  flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:10px 0; border-radius:18px; border:1px solid rgba(255,255,255,.42);
  background:linear-gradient(180deg, rgba(255,255,255,.32), rgba(255,255,255,.10));
  color:#2f246f; font-weight:900; letter-spacing:.2px;
}
nav#nav.bubbles .navItem .i{ width:22px; height:22px; display:grid; place-items:center }
nav#nav.bubbles .navItem svg{ width:22px; height:22px; display:block }
nav#nav.bubbles .navItem .t{ font-size:12px; line-height:1 }
nav#nav.bubbles .navItem.active{
  background:linear-gradient(180deg, rgba(198,186,255,.62), rgba(210,200,255,.20));
  color:#20185a; border-color:rgba(255,255,255,.65);
  box-shadow:0 10px 26px rgba(106,90,205,.28);
}
body.nav-hidden nav#nav{ transform: translateX(-50%) translateY(120%) }

/* =================== 勳章（Verified） =================== */
.verified-badge{display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle}
.verified-badge svg{width:100%;height:100%;display:block}
.verified-badge .gear{stroke:#fff;stroke-width:.9;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
.verified-badge .tick{fill:#fff;filter:drop-shadow(0 1px 0 rgba(0,0,0,.18))}

/* =================== Weverse 版首頁（UI only） =================== */
#wvHome .rowHead{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 8px 8px;font-weight:900;font-size:18px;letter-spacing:.3px;
}
.onLiveCard,.merchCard{
  background:#121214;border:1px solid #1f2026;border-radius:18px;
  padding:6px 8px 10px;margin:8px 6px;color:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.22) inset;
}
.liveRow{display:flex;gap:12px;overflow-x:auto;padding:8px 4px 10px;scrollbar-width:none}
.liveRow::-webkit-scrollbar{display:none}
.liveItem{
  position:relative;flex:0 0 78%;height:160px;border-radius:14px;overflow:hidden;
  background:#222;cursor:pointer;
}
.liveItem img{width:100%;height:100%;object-fit:cover;display:block}
.liveItem .tag{
  position:absolute;left:8px;top:8px;padding:4px 8px;border-radius:999px;
  background:#ff3b30;color:#fff;font-size:12px;font-weight:900;letter-spacing:.2px;
}
.liveItem .meta{
  position:absolute;left:10px;right:10px;bottom:10px;display:flex;align-items:center;gap:8px;
  color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.6);font-weight:900
}
.merchTabs{display:flex;gap:8px;padding:0 6px 8px;overflow-x:auto;scrollbar-width:none}
.merchTabs::-webkit-scrollbar{display:none}
#wvHome .merchTabs .chip{background:#27282f;border-color:#30323a;color:#fff}
#wvHome .merchTabs .chip.active{background:#fff;color:#111;border-color:transparent}
.merchGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0 6px 8px}
.prod{
  background:#1a1b22;border:1px solid #292a33;border-radius:14px;overflow:hidden;color:#fff
}
.prod .ph{aspect-ratio:1/1;background:#222}
.prod .ph img{width:100%;height:100%;object-fit:cover;display:block}
.prod .name{padding:8px 10px 2px;font-weight:900}
.prod .price{padding:0 10px 10px;color:#cfd3e1;font-size:12px}

/* =================== Story Bar（首頁） =================== */
#storyWrap{
  position: sticky; top: 0; z-index: 5;
  background: linear-gradient(180deg, rgba(255,255,255,.32), rgba(255,255,255,.10));
  border-bottom: 1px solid var(--glass-stroke);
  backdrop-filter: saturate(160%) blur(10px);
  -webkit-backdrop-filter: saturate(160%) blur(10px);
}
#storyBar{display:flex; gap:12px; overflow-x:auto;padding:8px 8px 10px; scrollbar-width:none; border-bottom: none;}
#storyBar::-webkit-scrollbar{ display:none }
.story-item{flex:0 0 auto;width:64px;text-align:center;cursor:pointer;position:relative}
.story-item img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #d5d8f3;margin:0 auto}
.story-item .name{font-size:12px;margin-top:4px;color:#9aa1ad}
.story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18)}
.story-item.active .name{color:var(--accent);font-weight:700}
.story-item .dot{position:absolute;right:6px;top:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;box-shadow:0 0 0 2px #fff}
.story-item.pinned img{border-color:#111}

/* =================== 貼文動作列 + 評論列 =================== */
.post .actions{margin-top:10px;padding-top:10px;border-top:1px dashed #e1e4f0}
.reacts{display:flex;gap:8px;flex-wrap:wrap}
.react{
  display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:800;color:#35407a;
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
}
.react .num{opacity:.9}
.react.active{
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#fff;border-color:transparent;
  box-shadow:0 6px 18px rgba(123,109,255,.30);
}
.commentBar{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
.commentBar .left{display:flex;align-items:center;gap:12px;color:#6b7287;font-weight:800}
.commentBar .right button{color:#5b6ab0;font-weight:900}

/* =================== Home 抬頭（社群） =================== */
.homeTop{display:flex;align-items:center;justify-content:flex-start;padding:8px 12px 4px}
.homeTitle{font-weight:900;letter-spacing:.6px;font-size:22px;line-height:1}

/* =================== Post 卡結構 =================== */
/* 貼文列表頁：標題與 story bar 的間距 → 幾乎緊貼 */
#postList .pageTitle{ margin:8px 8px 0 !important; }  /* 下緣 0 */
#storyWrap{ margin-top:0 !important; }                /* 上緣 0（避免多一條縫） */
#storyBar{ padding:6px 8px 10px !important; }         /* 高度收窄成範例等級 */
  
/* 進場只有返回鍵；背景透明（沒有白白的） */
#postDetail .postHUD{
  position:sticky; top:0; z-index:8;
  padding:calc(8px + env(safe-area-inset-top,0px)) 8px 6px;
  background:transparent !important;
}
#postDetail .postHUD .center,
#postDetail .postHUD .hudBtn{ display:none; }   /* 名字＋翻譯鍵先藏起來 */

/* 捲動後才出現名字＋翻譯鍵，並給淡淡玻璃底 */
#postDetail.scrolled .postHUD{
  background:linear-gradient(180deg, rgba(245,247,255,.86), rgba(245,247,255,0));
}
#postDetail .postHUD .back svg{
  stroke:#111; stroke-width:2.6; stroke-linecap:round; stroke-linejoin:round; fill:none;
}
#postDetail.scrolled .postHUD .center,
#postDetail.scrolled .postHUD .hudBtn{ display:flex; }


/* 詳情頁改成滿版；移除卡片感 */
#postDetail .post{
  background:transparent !important;
  border:none !important; box-shadow:none !important;
  margin:0 !important; padding:0 !important;
}
#postDetail .post .hdr{ display:none !important; }  /* 去掉卡片抬頭 */
#postDetail .post .body{ margin:0 !important; }

/* 圖片滿版（兩側出血） */
#postDetail .post .hero{
  width:100vw; max-width:100vw; height:auto;
  display:block; margin:0 calc(50% - 50vw);
  border:none !important; border-radius:0 !important;
}

/* 動作列回到正文內邊距 */
#postDetail .actions{
  padding:10px 10px 0; border-top:none !important; margin-top:6px;
}
  
/* 留言清單 */
.cmtItem{ display:flex; gap:10px; align-items:flex-start; margin:10px 6px }
.cmtItem .avatar{ width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--line) }
.cmtBody{ flex:1; min-width:0 }
.cmtHead{ display:flex; align-items:center; justify-content:space-between; gap:10px }
.cmtName{ font-size:13px; font-weight:900 }
.cmtTime{ color:var(--ghost); font-size:12px }
.cmtText{ margin-top:4px }

/* 藝人回覆（玻璃） */
.artistReply{
  margin:8px 0 0 0; padding:8px 10px; border-radius:12px;
  background:linear-gradient(180deg,rgba(255,255,255,.30),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  color:inherit; display:flex; gap:8px; align-items:flex-start;
}
.artistReply .arName{ font-size:12px; font-weight:900; display:flex; align-items:center; gap:6px }
.artistReply .arText{ margin-top:2px }

/* 首頁：多圖才顯示的頁面指示點 */
.pageDots{ display:flex; gap:6px; justify-content:center; margin-top:6px; }
.pageDots .dot{ width:6px; height:6px; border-radius:50%; background:#cfd3e1; opacity:.85; }

/* Post 卡體 */
.post{margin:12px 6px}
.post .hdr{display:flex;align-items:center;gap:10px; position:relative; }
.post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.post .meta b{font-weight:900;display:flex;align-items:center;gap:6px}
.post .meta small{display:block;color:var(--ghost)}
.post .body{margin-top:8px}
.post .hero{width:100%;height:360px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.35)}

 /* 卡片上下加深（上、下緣壓暗；中段保留玻璃） */
.post.card{ position:relative; overflow:hidden; }
.post.card::before{
  content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg,
    rgba(0,0,0,.10), rgba(0,0,0,0) 18%,
    rgba(0,0,0,0) 82%, rgba(0,0,0,.10));
  mix-blend-mode:multiply;
}

/* =================== DM 列表卡（玻璃） =================== */
#dm .dmCard{
  display:flex;align-items:center;gap:12px;padding:12px;margin:10px 0;cursor:pointer;border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}
#dm .dmCard img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.nameBlock{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0}
.nameRow{display:flex;align-items:center;gap:8px;min-width:0}
.nameRow .stage{font-weight:900;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dmPreview{display:block;color:var(--ghost);max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.artistTag{
  display:inline-flex;align-items:center;justify-content:center;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;color:#2e2a6f;
  background:linear-gradient(90deg,#bca7ff 0%,#8fb4ff 64%,#ffffff 100%);border:1px solid #ded6ff;box-shadow:0 1px 6px rgba(106,90,205,.18)
}

/* =================== DM Detail（背景 + 遮罩） =================== */
#dmDetail{
  position:relative;
  background-color:var(--bg);
  background-position:center;background-repeat:no-repeat;background-size:cover;background-attachment:scroll;
}
#dmDetail::after{
  content:"";position:fixed;inset:0;pointer-events:none;
  background:rgba(0,0,0,var(--bgDim,.0));
  backdrop-filter:blur(var(--bgBlur,0px));
  z-index:-1;
}

/* PATCH #9 — DM HUD：最頂層 + 圖二素淨樣式（刪舊貼新） */
#dmDetail .chatHUD{
  /* 不捲動、不貼底，讓 thread 自己滾；但要有定位，z-index 才會生效 */
  position: relative;
  z-index: 70;                          /* ↑ 永遠壓在 thread（z:1）之上 */
  display: flex; align-items: center; justify-content: space-between;
  gap: 6px;
  /* 吃到安全區，避免瀏海/動態島；背景保持透明 */
  padding: calc(8px + env(safe-area-inset-top,0px)) 8px 6px;
  background: transparent;
}

/* 左右按鈕固定寬，避免擠壓中間標題 */
#dmDetail .chatHUD .back,
#dmDetail .chatHUD .hudBtn{
  width:44px; height:44px; flex:0 0 44px;
  display:grid; place-items:center;
}

/* 中段容器：置中標題，並允許縮略 */
#dmDetail .chatHUD .center{
  flex:1; min-width:0; display:flex; justify-content:center; align-items:center;
}

#dmTitle.artistName{
  color: var(--hud-ink, #111) !important;
  text-shadow: none !important; -webkit-text-stroke: 0 !important; mix-blend-mode: normal !important;
}

/* === HUD 字色統一由 --hud-ink 控（自動偵測產生），強制關閉混色/陰影 === */
#dmDetail .back svg{
  stroke: var(--hud-ink, #111) !important;
  stroke-width: 2.6; stroke-linecap: round; stroke-linejoin: round;
  fill: none; mix-blend-mode: normal !important; filter: none !important;
}
#dmDetail .hudBtn{
  color: var(--hud-ink, #111) !important;
  font-weight: 900; text-shadow: none !important; mix-blend-mode: normal !important;
}

/* 明確關掉先前的小底板（圖一的白底），避免被舊樣式殘留影響 */
#dmDetail .back::before,
#dmDetail .hudBtn::before{
  content:none !important;
}

/* thread 本來就 z-index:1；這裡只提醒確保值存在（若你之前改過可以保留） */
#dmDetail .thread{ z-index:1; }

/* 修正右上選單的位置：因為 HUD 高度已含安全區，這裡不再 +safe-area */
#dmMenu{ top: calc(var(--hud-h) + 6px) !important; }
  
/* Thread 佈局 */
:root{ --hud-h:56px; }
#dmDetail .thread{
  position:absolute; left:0; right:0; top:0;
  bottom: 0; /* 讓訊息可以延伸到 #dmFooter 背後 → rail 上會看到被模糊的訊息 */
  overflow-y:auto; -webkit-overflow-scrolling:touch;
  display:flex; flex-direction:column;
  padding: calc(var(--hud-h) + 4px) 2px calc(var(--notice-h) + 12px) !important;
  scrollbar-gutter:stable both-edges; z-index: 1;
}
#dmDetail .thread .msg + .msg{ margin-top:12px }
#endAnchor{ height:1px; flex:0 0 auto; }

/* 讓對話串底部永遠保留一塊「跟 noticeBar 一樣高」的空間 */
#dmDetail .thread::after{
  content: "";
  display: block;
  height: var(--notice-h, 0px);
  flex: 0 0 auto;
}
  
/* 浮動 noticeBar */
.noticeBar.is-floating{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: calc(var(--footer-h) + var(--kb-offset) + env(safe-area-inset-bottom,0px) + 4px) !important;
  z-index: 60; pointer-events: none;
}

/* ========== DM 氣泡（黑底白字，翻譯藍紫） ========== */
:root{ --bubble-px:10px; --bubble-py:8px; --bubble-r:12px; --msg-max:66%; }
#dmDetail .msg{ display:flex; align-items:flex-end; gap:6px; max-width:var(--msg-max); margin:0 6px; }
#dmDetail .msg.left{  flex-direction:row;        align-self:flex-start; }
#dmDetail .msg.right{ flex-direction:row-reverse; align-self:flex-end;  }
#dmDetail .msg + .msg{ margin-top:8px; }
#dmDetail .time{ display:block; margin-top:2px; font-size:11px; color:#8b93a7; white-space:nowrap; }
#dmDetail .msg.right .time{ color:#cfd3e1; }

/* 泡泡本體 */
#dmDetail .bubble{
  max-width:100%; padding:var(--bubble-py) var(--bubble-px);
  border-radius:18px; border:1px solid transparent; position:relative;
  font-size:15px; line-height:1.35;
}

/* 左（粉絲）：黑底白字（就算有翻譯也不改色） */
#dmDetail .msg.left .bubble:not(.mediaWrap):not(.voice){
  background:#11131a;
  color:#ffffff;
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 10px 22px rgba(0,0,0,.38), 0 1px 0 rgba(255,255,255,.08) inset;
  padding:12px 14px;
}
/* 釘原文字色白，不影響翻譯段落 */
#dmDetail .msg.left .bubble .fanText{ color:#ffffff !important; }
/* 粉絲側時間戳在黑底上用淺灰（補上缺失的大括號） */
#dmDetail .msg.left .time{ color:#cfd3e1 !important; }

/* 右（藝人）：灰底白字 */
#dmDetail .msg.right .bubble:not(.mediaWrap):not(.voice){
  background: var(--dm-right-bg);
  color:#fff;
  border:1px solid var(--dm-right-stroke);
  box-shadow: var(--dm-right-shadow);
}

/* 翻譯分隔線/文字（翻譯字保留藍紫） */
#dmDetail .bubble .transDivider{
  height:1px; margin:10px auto 8px; width:92%;
  background-image:linear-gradient(to right, rgba(255,255,255,.35) 33%, rgba(255,255,255,0) 0);
  background-size:6px 1px; background-repeat:repeat-x; background-position:center; opacity:.5;
}
#dmDetail .bubble .transText{ color:#8EA3FF; font-weight:800; }
#dmDetail .bubble .transBy{ display:none !important; }

/* 媒體泡泡：脫離泡泡樣式（維持原有寫法） */
#dmDetail .msg .bubble.mediaWrap{ background:transparent!important; border:none!important; padding:0; border-radius:0; color:inherit; }
#dmDetail .msg.right .bubble.mediaWrap{ background:transparent!important; border:none!important; }
#dmDetail .msgImg, #dmDetail .msgVideo{
  display:block; width:min(66vw,300px); height:auto;
  border-radius:12px; border:1px solid rgba(0,0,0,.08); overflow:hidden;
}

/* 語音泡泡（維持灰/白語意，但質感升級） */
#dmDetail .bubble.voice{
  border-radius:18px; border:1px solid var(--glass-stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.26),rgba(255,255,255,.12));
}
#dmDetail .msg.right .bubble.voice{
  background:#565b6c; color:#fff; border:1px solid rgba(255,255,255,.18);
  box-shadow:0 6px 16px rgba(0,0,0,.22);
}
#dmDetail .voiceUI{ display:flex; align-items:center; gap:8px; min-width:120px; }
#dmDetail .voicePlay{
  width:30px; height:30px; border-radius:50%; display:grid; place-items:center;
  background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.08); color:#2b356f;
}
#dmDetail .msg.right .voicePlay{ background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.28); color:#fff; }
#dmDetail .voicePlay svg{ width:16px; height:16px; fill:currentColor; }
#dmDetail .voiceDur{ margin-left:6px; font-variant-numeric:tabular-nums; min-width:46px; text-align:right; font-weight:800; opacity:.9; }
#dmDetail .msg.right .voiceDur{ color:#fff; }
.voiceBars{display:none!important}

/* 回覆卡（玻璃） */
#dmDetail .msg + .replyCard, #dmDetail .replyCard + .msg{ margin-top:12px; }
.replyCard{
  align-self:flex-end; max-width:74%; margin:14px 6px 0; padding:10px 12px; border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.30),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  box-shadow:0 8px 18px rgba(0,0,0,.10);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}
.replyCard .fromLabel{
  font-size:11px; font-weight:900; letter-spacing:.3px; color:#000;
  text-shadow:0 1px 0 rgba(255,255,255,.55), 0 2px 8px rgba(0,0,0,.35);
  margin-bottom:4px;
}

/* 氣泡旁的小圓 A（取代回覆箭頭） */
.replyBtn{ display:none !important; }
#dmDetail .bubble{ position:relative; }
.translateBtnA{
  position:absolute; top:50%; right:0;
  transform:translateY(-50%) translateX(calc(100% + var(--reply-gap)));
  width:var(--reply-size); height:var(--reply-size);
  border-radius:999px; display:grid; place-items:center;
  border:1px solid rgba(0,0,0,.08); background:rgba(255,255,255,.92);
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  color:#2f3564; font-weight:900; line-height:1; z-index:2;
  -webkit-tap-highlight-color:transparent;
}
.translateBtnA::after{ content:""; position:absolute; inset:4px; border-radius:50%; border:1.5px solid rgba(0,0,0,.10); }
.translateBtnA:active{ transform:translateY(-50%) translateX(calc(100% + var(--reply-gap))) scale(.97); }

/* DM Footer（輸入區外側玻璃 rail） */
.dmFooter{
  position:fixed;left:0;right:0;
  bottom:max(env(safe-area-inset-bottom,0px),var(--kb-offset));
  z-index:50; padding:6px 0 calc(8px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg, var(--rail-bg1), var(--rail-bg2));
  border-top:1px solid var(--rail-stroke);
  backdrop-filter:blur(var(--glass-blur));
  -webkit-backdrop-filter:blur(var(--glass-blur));
}
.dmFooter::before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(130% 90% at 10% 0%, var(--rail-tint), transparent 55%);
  mix-blend-mode: soft-light;
}

.dmInputBar{display:flex;align-items:center;gap:8px;padding:0 10px}
.iconBtn{width:30px;height:30px;display:grid;place-items:center;flex:0 0 auto;font-size:20px;line-height:1}

/* 內層輸入框維持白底黑字 */
.dmInputBar .box{
  flex:1;min-width:0;display:flex;align-items:center;height:44px;padding:0 14px;border-radius:20px;
  background:#fff; border:1px solid var(--line);
}
.dmInputBar input{flex:1;border:none;outline:none;background:transparent;font-size:16px;color:#000}
::placeholder{ color:#9aa0b4; opacity:1; }
.dmSend{width:30px;height:30px;color:#b2b7c8;display:grid;place-items:center}
.hasText .dmSend{color:#111}

/* === CommentDetail 與 PostDetail 的輸入框，100%跟 DM 一樣樣式（白底黑字） === */
/* 正確：PostDetail 也鎖定到內層的 .box */
.dmInputBar .box, #cdComposer .box, #pdComposer .box{
  background:#fff !important; 
  border:1px solid var(--line) !important;
}

/* 這段可以保留，字色/placeholder 會一致 */
.dmInputBar input, #cdComposer input, #pdComposer input{
  color:#000 !important; 
  background:transparent !important;
}

::placeholder { color: #9aa0b4; opacity: 1; }

/* PATCH — Notice pill（刪舊貼新；鎖成圖二的纖長尺寸） */
.noticeBar{
  display:inline-flex; align-items:center; justify-content:center;
  padding:6px 12px;                 /* 高度瘦、左右適中 */
  border-radius:12px;               /* 圓角一致 */
  font-size:13px; line-height:1.15; /* 小字＋緊實行高 */
  font-weight:900; letter-spacing:.3px;
  white-space:nowrap;               /* 禁止斷行，避免被撐高 */
  max-width:min(76vw,420px);

  /* 玻璃質感（跟圖二一樣淡） */
  background:linear-gradient(180deg,rgba(255,255,255,.20),rgba(255,255,255,.08));
  border:1px solid rgba(255,255,255,.38);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  box-shadow:0 8px 18px rgba(0,0,0,.08);

  /* 固定墨色，避免混色讓字看起來更粗更大 */
  color:#2f3564; text-shadow:none; mix-blend-mode:normal;
}

/* 浮在輸入列上方（你已有的定位，保留但一起替換） */
.noticeBar.is-floating{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(var(--footer-h) + var(--kb-offset) + env(safe-area-inset-bottom,0px) + 8px) !important;
  z-index:60; pointer-events:none;
}

/* Reply Chip */
.replyChip{position:relative;display:flex;align-items:center;gap:8px;margin:0 14px 8px;padding:8px 36px 8px 12px;border-radius:13px;border:1px solid rgba(255,255,255,.28);background:rgba(255,255,255,.12);backdrop-filter:saturate(140%) blur(1.5px)}
.replyChipLabel{font-size:12px;font-weight:900;letter-spacing:.35px;color:#7a86b7;margin-right:2px;user-select:none}
.replyChipText{flex:1;min-width:0;font-size:15px;line-height:1.25;font-weight:600;color:#2f3564;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.replyChipClose{position:absolute;top:6px;right:6px;width:28px;height:28px;display:grid;place-items:center;border:none;background:transparent;color:#6f78aa;border-radius:6px;cursor:pointer}
.replyChipClose:hover{background:rgba(255,255,255,.10)}
.replyChipClose svg{width:18px;height:18px;display:block}

  /* DM 專用 Rail（只影響 #dmFooter） */
#dmFooter{
  /* 讓 .dmFooter 內用到的 --rail-* 變數，改從 DM 專用的 --dm-rail-* 取值 */
  --rail-bg1:     var(--dm-rail-bg1, rgba(255,255,255,.18));
  --rail-bg2:     var(--dm-rail-bg2, rgba(255,255,255,.78));
  --rail-stroke:  var(--dm-rail-stroke, rgba(255,255,255,.45));
  --rail-tint:    var(--dm-rail-tint, rgba(123,109,255,.22));

  /* DM rail 要「能看見並模糊」後面的訊息 */
  backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
  -webkit-backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
}

  /* thread 底部永遠依 notice 高度+額外緩衝預留空間 */
#dmDetail .thread{
  padding-bottom: calc(var(--notice-h) + 20px) !important;  /* 原本是 +12px */
}

/* =================== Modal / 裁切工具 =================== */
.modal{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
.modal .panel{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(760px,94vw);
  background:linear-gradient(180deg,rgba(255,255,255,.30),rgba(255,255,255,.14));
  border:1px solid var(--glass-stroke);border-radius:18px;padding:14px;box-shadow:var(--shadow-2);
  backdrop-filter:saturate(160%) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(160%) blur(var(--glass-blur));
}

/* 裁切背景 */
#cropStage{position:relative;height:58vh;border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#f8f9ff;touch-action:none}
#cropStage img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:none;user-select:none;touch-action:none;transform-origin:center center;will-change:transform}
.cropCtrls{display:flex;align-items:center;gap:10px;margin:12px 0;flex-wrap:wrap}
.cropCtrls .spacer{flex:1}
.scaleRow{display:flex;align-items:center;gap:10px}
#scaleLabel{min-width:48px;text-align:right;color:#6b7280;font-weight:800}
#cropScale{-webkit-appearance:none;appearance:none;width:clamp(160px,36vw,280px);height:4px;border-radius:999px;outline:none;background:linear-gradient(90deg,var(--accent) var(--scaleFill,50%), #e1e4f0 0)}
#cropScale::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:1.5px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.15)}

/* 修剪視窗 */
.trimBox{display:flex;flex-direction:column;gap:10px}
.trimRow{display:flex;align-items:center;gap:10px}
.range{flex:1}
.tip{color:#667085;font-size:14px}
.btnRow{display:flex;gap:10px;justify-content:flex-end}
.btnPrimary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border:none}
.btn{padding:6px 14px;border-radius:999px;border:1px solid var(--line);background:#fff}
.btnMini{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900}

/* 日期/未讀分隔 */
.dayDivider{align-self:center;margin:10px 0;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.15);color:#fff;font-size:12px;font-weight:900;letter-spacing:.3px;backdrop-filter:blur(3px)}
.unreadLine{align-self:center;margin:8px 0;padding:6px 12px;border-radius:8px;background:rgba(106,90,205,.18);color:#2e2a6f;font-size:12px;font-weight:900;border:1px solid rgba(106,90,205,.35)}

/* 小工具 */
.badge{background:#ff3b30;color:#fff;font-size:12px;padding:2px 7px;border-radius:999px;min-width:22px;text-align:center}

/* 全螢幕媒體檢視器 */
#viewer{position:fixed;inset:0;z-index:90;display:none;background:rgba(0,0,0,.9)}
#viewer .stage{position:absolute;inset:0;display:grid;place-items:center}
#viewerImg,#viewerVideo{max-width:94vw;max-height:88vh;border-radius:12px}

/* 保底：關掉橫向滾動 */
#dmDetail, .thread { overflow-x: hidden; touch-action: pan-y; }

/* =================== LIVE（整合） =================== */
#live, #liveRoom { --live-hair: var(--line); }

/* 1) 頂部 HUD */
#live .liveHUD, #liveRoom .liveHUD{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 4px 6px;
  background:linear-gradient(180deg, rgba(245,247,255,.75), rgba(245,247,255,0));
}
#live .liveTag, #liveRoom .liveTag{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:999px;
  background:#ff2e2e; color:#fff; font-weight:900; font-size:12px;
  box-shadow:0 6px 20px rgba(255,46,46,.25);
  animation:blink 1.1s infinite;
}
#live .liveTag::after, #liveRoom .liveTag::after{ content:"●"; font-size:10px }
@keyframes blink{0%,55%{opacity:1}56%,100%{opacity:.35}}
#live .liveHearts, #liveRoom .liveHearts{ font-weight:900; color:#333; }

/* 2) 舞台 */
#live .liveStage{
  position:relative; height:44vh; min-height:300px;
  border:1px solid var(--live-hair); border-radius:18px;
  background:linear-gradient(180deg,#0f1c3a,#18224b);
  box-shadow:0 10px 28px rgba(0,0,0,.12) inset;
}

/* 3) 聊天串（粉絲端視覺） */
#live .liveThread, #liveRoom .liveThread{
  display:flex; flex-direction:column; gap:8px;
  height:calc(100vh - 280px);
  overflow-y:auto; padding:12px;
  border:1px solid var(--live-hair); border-radius:16px;
  background: radial-gradient(140% 120% at 0% 0%, #0e1630, #0b0f1f 60%, #0a0d18);
}
#live #liveChat > div,
#liveRoom #liveChat > div,
#live .liveThread   > div.msg,
#liveRoom .liveThread > div.msg{
  max-width:72%; align-self:flex-end;
  padding:10px 12px; border-radius:14px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#fff; box-shadow:var(--shadow-1); border:1px solid transparent;
}
#live #liveChat > div.host, #liveRoom #liveChat > div.host{
  align-self:flex-start; background:var(--artist); color:inherit; border:1px solid var(--live-hair);
}
#live #liveChat > div.fan, #liveRoom #liveChat > div.fan{ align-self:flex-end; }
#live #liveChat > div.welcome, #liveRoom #liveChat > div.welcome{ align-self:center; background:#ffeaa7; color:#111; }

/* 名稱 / 時間戳 */
#live #liveChat .name, #liveRoom #liveChat .name{ font-size:11px; color:#c8d1ff; font-weight:900; letter-spacing:.35px; }
#live #liveChat .time, #liveRoom #liveChat .time{ display:block; margin-top:2px; font-size:11px; color:#cfd3e1; text-align:right; }
#live #liveChat .host .time, #liveRoom #liveChat .host .time{ color:#b8c2db }

/* 4) 輸入列（含愛心鍵） */
#live .liveInputBar, #liveRoom .liveInputBar{
  display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--live-hair);
  position:sticky; bottom:0;
  background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95));
  backdrop-filter:blur(10px);
}
#live .liveInputBar input, #liveRoom .liveInputBar input{
  flex:1; border:1px solid var(--live-hair); padding:12px; border-radius:14px; background:var(--hover);
}
#live .liveInputBar button, #liveRoom .liveInputBar button{ min-width:60px; border:none; border-radius:12px; font-weight:900; cursor:pointer; }
#live #liveHeartBtn, #liveRoom #liveHeartBtn{
  min-width:44px; height:44px; border-radius:12px; border:1px solid var(--live-hair);
  background:linear-gradient(180deg,#ffb3d9,#ffc9f1);
}
#live #liveHeartBtn:active, #liveRoom #liveHeartBtn:active{ transform:scale(.96) }

/* 5) 飛心動畫 */
#live .flying-heart, #liveRoom .flying-heart{ position:fixed; z-index:50; font-size:18px; pointer-events:none; animation:floatUp 1.1s ease forwards; }
@keyframes floatUp{ 0%{ opacity:0; transform:translateY(10px) scale(.9) } 10%{ opacity:1 } 100%{ opacity:0; transform:translateY(-120px) scale(1.6) } }

/* 6) 暫離遮罩 */
#live .pausedMask{ position:absolute; inset:0; display:none; place-items:center; z-index:2; border-radius:inherit; background:rgba(0,0,0,.42); color:#fff; font-weight:900; text-shadow:0 2px 12px rgba(0,0,0,.35); backdrop-filter:blur(2px); }

/* 7) 直播結束覆蓋畫面 */
#live .liveEndedScene, #liveRoom .liveEndedScene{ position:fixed; inset:0; z-index:60; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; }
#live .liveEndedScene img, #liveRoom .liveEndedScene img{ width:120px; height:120px; border-radius:50%; border:2px solid #fff; object-fit:cover; }

/* 8) 主按鈕樣式 */
#live .btnPrimary, #liveRoom .btnPrimary{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border:1px solid transparent; box-shadow:0 6px 18px rgba(106,90,205,.25); }

/* 9) LIVE 卡片邊框 */
#live .card{ border-color: rgba(231,234,243,.6); }

/* --- 兼容現有 LIVE 純文字結構 (.liveStage + .chatList + .liveMsg) --- */
#live .chatList{
  position:absolute; inset:0; padding:14px 12px;
  display:flex; flex-direction:column; gap:10px;
  overflow-y:auto; -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain; scrollbar-width:none;
}
#live .chatList::-webkit-scrollbar{ display:none }

#live .liveMsg{ max-width:78%; display:flex; flex-direction:column; gap:4px }
#live .liveMsg.artist{ align-self:flex-end }
#live .liveMsg.fan{ align-self:flex-start }

#live .liveMsg .name{
  font-size:11px; color:#c8d1ff; font-weight:900; letter-spacing:.35px;
}

/* 粉絲（白底） */
#live .liveMsg .bubble{
  padding:10px 12px; border-radius:14px;
  background:#fff; color:#111;
  border:1px solid var(--live-hair);
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

/* 主持人（藝人）泡泡 */
#live .liveMsg.artist .bubble{
  background: var(--artist);
  color: var(--artist-fg, #111);
  border:1px solid var(--live-hair);
  box-shadow:0 8px 18px rgba(106,90,205,.25);
}

/* 時間戳 */
#live .liveMsg .time{ font-size:11px; color:#aebbe9; align-self:flex-end }
#live .liveMsg.fan .time{ color:#b8c2db }

/* LIVE 輸入 */
#live .liveInput{
  display:flex; gap:8px; align-items:center; margin-top:12px;
  position:sticky; bottom:0; padding-top:8px;
  background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95));
  backdrop-filter:blur(10px); border-top:1px solid var(--line);
}
#live .liveInput input{ flex:1; height:44px; padding:0 12px; background:#fff; border:1px solid var(--line); border-radius:14px; }

/* ===== FAB：高透圓形 ===== */
.fabNew{
  position: fixed; right: 16px; bottom: calc(88px + var(--safe));
  width: 64px; height: 64px; border-radius: 50%;
  background: linear-gradient(180deg, rgba(255,255,255,.42), rgba(255,255,255,.12));
  border: 1px solid rgba(255,255,255,.55);
  backdrop-filter: saturate(180%) blur(14px);
  -webkit-backdrop-filter: saturate(180%) blur(14px);
  box-shadow:
    0 1px 0 rgba(255,255,255,.70) inset,
    0 -8px 20px rgba(0,0,0,.10) inset,
    0 10px 28px rgba(17,23,41,.18);
  display: grid; place-items: center;
  font-size: 28px; font-weight: 900; line-height: 1;
  color: var(--accent); cursor: pointer; z-index: 45;
  -webkit-tap-highlight-color: transparent;
}
.fabNew::before{ content:""; position:absolute; inset:1px; border-radius:50%; background: var(--glass-sheen); pointer-events:none; mix-blend-mode:soft-light; }
.fabNew:active{ transform: scale(.98); box-shadow:
  0 1px 0 rgba(255,255,255,.70) inset,
  0 -6px 16px rgba(0,0,0,.10) inset,
  0 6px 18px rgba(17,23,41,.20);
}
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))){
  .fabNew{ background: rgba(255,255,255,.9); }
}

/* === [PATCH-CSS-1] Story Bar 與頁面標題間距（1-1 / 3-1）=== */
#postList .pageTitle{ margin:8px 8px 0 !important; } /* 標題更貼近 */
#storyWrap{
  position: sticky; top: 0; z-index: 5;
  margin-top: 0 !important;
  background: linear-gradient(180deg, rgba(255,255,255,.32), rgba(255,255,255,.10));
  border-bottom: 1px solid var(--glass-stroke);
  backdrop-filter: saturate(160%) blur(10px);
  -webkit-backdrop-filter: saturate(160%) blur(10px);
}
#storyBar{ padding:6px 8px 10px !important; border-bottom: none; }
.translate-btn{ position:absolute; right:0; top:0; padding:4px 10px; font-size:12px; line-height:1; }

/* Switch */
.switch{position:relative;display:inline-block;width:46px;height:26px;vertical-align:middle}
.switch input{display:none}
.switch .slider{position:absolute;inset:0;background:#d8dcec;border:1px solid var(--line);border-radius:999px;transition:.18s}
.switch .slider:before{content:"";position:absolute;width:22px;height:22px;left:2px;top:50%;transform:translateY(-50%);background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.18);transition:.18s}
.switch input:checked + .slider{background:linear-gradient(180deg,var(--accent),var(--accent2));border-color:transparent}
.switch input:checked + .slider:before{transform:translate(20px,-50%)}

/* 無障礙：減少動效 */
@media (prefers-reduced-motion: reduce){
  *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important }
}
  /* PATCH #8-A（新增）— 固定墨色、不受背景影響，且不使用陰影 */
.ink-fixed{
  color: var(--text) !important;
  mix-blend-mode: normal !important;
  text-shadow: none !important;
  filter: none !important;
  -webkit-text-stroke: 0 !important;
}

/* 若該區域背景偏亮或偏花，可用這個「微底色板」（不是陰影） */
/* 在背景太花又很亮時，給 HUD 一片很淡的透明白底板（由 JS 決定是否掛 .ink-plate） */
.ink-plate{ position: relative; isolation: isolate; }
.ink-plate::before{
  content:""; position:absolute; inset:-2px; border-radius:8px;
  background: rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.06); z-index:-1;
}
  /* PATCH #8-B（刪舊貼新）— 主要按鈕文字永遠可見、禁用任何混色/陰影 */
.btnPrimary{
  color:#fff !important;
  -webkit-text-fill-color:#fff !important;
  text-shadow:none !important;
  mix-blend-mode:normal !important;
  filter:none !important;
}
.btnPrimary:disabled{ opacity:.6 }
</style>
</head>
<body>

<!-- ====================== HOME ====================== -->
<section id="home" class="page active">
  <div id="wvHome" style="padding-bottom:80px">
    <!-- On LIVE -->
    <div class="onLiveCard">
      <div class="rowHead"><b>On LIVE</b><small class="ghost">01 | 03</small></div>
      <div id="homeLiveRow" class="liveRow"></div>
    </div>

    <!-- Merch -->
    <div class="merchCard">
      <div class="rowHead"><b>Merch</b></div>
      <div class="merchTabs">
        <button class="chip active">全部</button>
        <button class="chip">BLACKPINK</button>
        <button class="chip">SEVENTEEN</button>
      </div>
      <div id="homeMerchGrid" class="merchGrid"></div>
    </div>
  </div>
</section>

<!-- ====================== POST DETAIL (Artist) ====================== -->
<section id="postDetail" class="page">
  <div class="homeTitle">社群</div>

  <!-- 貼文詳情 HUD（照圖2/圖3） -->
  <div class="postHUD" id="pdHUD"> 
    <button class="back" onclick="goBack()" aria-label="Back">
      <svg viewBox="0 0 24 24"><path d="M15 19 8 12l7-7"/></svg>
    </button>
    <div class="center">
      <img id="pdAvatar" src="" alt="" onerror="imgFallback(this)">
      <div class="meta">
        <b id="pdName">ANNIE</b>
        <small id="pdTime" class="ghost"></small>
      </div>
    </div>
    <button class="hudBtn" id="pdTransHUD" title="翻譯">가/A</button>
  </div>

  <div id="postDetailWrap" style="padding:0 6px 12px"></div>

  <!-- 留言輸入列（照抄 commentDetail 樣式） -->
<div class="dmFooter" id="pdComposer">
  <div class="dmInputBar">
    <div class="box"><input id="cmtInput" placeholder="請輸入訊息" /></div>
    <button class="dmSend" id="postCmtSend" aria-label="Send" disabled>
      <svg viewBox="0 0 24 24"><path d="M3.4 12.6l16.7-7.2c.6-.3 1.2.3.9.9l-7.2 16.7c-.3.7-1.3.6-1.5-.1l-2.1-6.1-6.1-2.1c-.7-.2-.8-1.2-.1-1.5z" fill="currentColor"/></svg>
    </button>
  </div>
</div>
</section>

<!-- ====================== COMMENT DETAIL ====================== -->
<section id="commentDetail" class="page">
  <div class="pageTitle" style="display:flex;align-items:center;gap:6px">
    <button class="back" onclick="goBack()" aria-label="Back" style="width:44px;height:44px;border:none;background:transparent;display:grid;place-items:center">
      <svg viewBox="0 0 24 24" width="22" height="22"><path d="M15 19 8 12l7-7" stroke="#5b6ab0" stroke-width="2.6" fill="none"/></svg>
    </button>
  </div>

  <!-- 粉絲原留言（主樓） -->
  <div id="cdRoot" style="padding:0 6px 8px"></div>

  <!-- 僅 ADP 的回覆 開關 -->
  <div style="display:flex;align-items:center;justify-content:flex-end;padding:4px 12px 8px;gap:8px">
    <span class="ghost" style="font-weight:900">僅其他藝人的回覆</span>
    <label class="switch"><input id="cdOnlyAdp" type="checkbox"><span class="slider"></span></label>
  </div>

  <!-- 回覆清單 -->
  <div id="cdList" style="padding:0 6px 120px"></div>

  <!-- 回覆輸入列（沿用你的 DM 玻璃樣式） -->
  <div class="dmFooter" id="cdComposer">
    <div class="dmInputBar">
      <div class="box"><input id="cdInput" placeholder="請輸入訊息" /></div>
      <button class="dmSend" id="cdSend" aria-label="Send" disabled>
        <svg viewBox="0 0 24 24"><path d="M3.4 12.6l16.7-7.2c.6-.3 1.2.3.9.9l-7.2 16.7c-.3.7-1.3.6-1.5-.1l-2.1-6.1-6.1-2.1c-.7-.2-.8-1.2-.1-1.5z" fill="currentColor"/></svg>
      </button>
    </div>
  </div>
</section>

<!-- PATCH — #postList 結構（刪舊貼新） -->
<section id="postList" class="page">
  <div class="pageTitle">貼文</div>

  <div id="storyWrap">
    <div id="storyBar"></div>
  </div>

  <div id="feedWrap" style="padding:0 6px 12px"></div>
</section>

<!-- ====================== DM LIST ====================== -->
<section id="dm" class="page">
  <div class="pageTitle">DM</div>
  <div id="dmList"></div>
</section>

<!-- ====================== DM DETAIL ====================== -->
<section id="dmDetail" class="page">
  <div class="chatHUD" id="dmHUD">
    <button class="back" onclick="goBack()" aria-label="Back"><svg viewBox="0 0 24 24"><path d="M15 19 8 12l7-7"/></svg></button>
    <div class="center"><b id="dmTitle" class="artistName">ANNIE</b></div>
    <button class="hudBtn" title="更多" onclick="toggleDmMenu()">⋯</button>
  </div>

  <div id="dmThread" class="thread"></div>

  <!-- Footer -->
  <div class="dmFooter" id="dmFooter">
    <div id="replyChip" class="replyChip" style="display:none">
      <span class="replyChipLabel">回覆：</span>
      <span id="replyChipText" class="replyChipText">—</span>
      <button class="replyChipClose" onclick="clearReply()"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg></button>
    </div>

    <div class="dmInputBar">
      <button class="iconBtn" id="btnCamera" aria-label="相機/相簿"><span class="camEmoji">📸</span></button>
      <div class="box"><input id="dmMessageInput" placeholder="請呼叫粉絲暱稱 @@@ " /></div>
      <button class="iconBtn" id="btnMic" aria-label="語音"><span class="micEmoji">🎙️</span></button>
      <button class="dmSend" id="dmSendBtn" aria-label="Send" disabled>
        <svg viewBox="0 0 24 24"><path d="M3.4 12.6l16.7-7.2c.6-.3 1.2.3.9.9l-7.2 16.7c-.3.7-1.3.6-1.5-.1l-2.1-6.1-6.1-2.1c-.7-.2-.8-1.2-.1-1.5z" fill="currentColor"/></svg>
      </button>

      <input id="pickMedia" type="file" accept="image/*,video/*" multiple style="display:none">
      <input id="pickVoice" type="file" accept="audio/*,video/*" style="display:none">
    </div>
  </div> 

  <!-- 右上 … 選單 -->
  <div id="dmMenu" class="card soft"
       style="display:none; position:fixed; right:10px;
              z-index:80">
    <div class="row" style="flex-direction:column;gap:6px">
      <button class="chip" onclick="renameChat(); hideDmMenu()">更改聊天室名稱</button>
      <button class="chip" onclick="startPickBg(); hideDmMenu()">更改背景</button>
    </div>
  </div>
</section>

<!-- ====================== STORE = Profile ====================== -->
<section id="store" class="page">
  <div id="homeHeader" style="display:block;margin:6px 6px 10px">
    <div class="me" style="display:flex;align-items:center;gap:10px">
      <img id="meAvatar" src="https://picsum.photos/80?u=artist" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
      <div>
        <div id="meNickname" style="font-weight:900">Annie</div>
        <div class="id" id="meId" style="font-size:12px;color:var(--ghost)">ARTIST-00001</div>
      </div>
    </div>
    <button class="chip" id="btnEditNick" style="margin-left:auto;display:inline-flex">✏️ 更改我的暱稱</button>
  </div>
</section>

<!-- ====================== 背景：挑圖 / 裁切 / 預覽 ====================== -->
<input id="bgChooser" type="file" accept="image/*" style="display:none">

<div id="cropModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">裁切背景</b>
    <div id="cropStage"><img id="cropImg" alt=""></div>
    <div class="cropCtrls">
      <button class="btnMini" id="btnRotate">↻ 旋轉</button>
      <div class="spacer"></div>
      <div class="scaleRow">
        <button class="btnMini" id="zoomOut">－</button>
        <input id="cropScale" type="range" min="50" max="250" value="100">
        <button class="btnMini" id="zoomIn">＋</button>
        <span id="scaleLabel">100%</span>
      </div>
      <div class="spacer"></div>
      <button class="chip" onclick="rePickBg()">返回選圖片</button>
      <button class="chip btnPrimary" onclick="applyCrop()">下一步</button>
    </div>
  </div>
</div>

<div id="previewModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">預覽背景</b>
    <div style="height:48vh;border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#000">
      <div id="bgPreviewMini" style="height:100%;background-position:center;background-size:cover;background-repeat:no-repeat"></div>
    </div>
    <div class="cropCtrls" style="justify-content:flex-end">
      <button class="chip" onclick="backToCrop()">返回</button>
      <button class="chip btnPrimary" onclick="confirmPreview()">確認</button>
    </div>
  </div>
</div>

<!-- ====================== 語音修剪（可試聽） ====================== -->
<div id="trimModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">修剪語音（可試聽）</b>
    <div class="trimBox">
      <video id="trimMedia" playsinline style="display:none"></video>
      <div class="trimRow">
        <button class="btn" id="trimPlay">▶️ 播放</button>
        <div class="vBar" style="flex:1"><div id="trimFill" class="vFill" style="background:#6a5acd;height:6px;border-radius:999px;width:0%"></div></div>
        <div id="trimClock" class="vTime">0:00</div>
      </div>
      <div class="trimRow">
        <span class="ghost" style="width:36px">起點</span>
        <input id="trimStart" class="range" type="range" min="0" max="1000" value="0">
        <span id="trimStartLabel" class="ghost">0.0s</span>
      </div>
      <div class="trimRow">
        <span class="ghost" style="width:36px">終點</span>
        <input id="trimEnd" class="range" type="range" min="0" max="1000" value="1000">
        <span id="trimEndLabel" class="ghost">0.0s</span>
      </div>
      <div class="tip">提示：播放時會自動從「起點」開始，跑到「終點」就停止。</div>
      <div class="btnRow">
        <button class="btn" onclick="closeTrim()">取消</button>
        <button class="btn btnPrimary" id="trimUse">使用這段</button>
      </div>
    </div>
  </div>
</div>

<!-- ====================== LIVE（純文字版） ====================== -->
<section id="live" class="page">
  <div class="pageTitle">直播</div>

  <div id="liveHUD" class="liveHUD" style="display:none">
    <span class="liveTag">LIVE</span>
    <span class="liveHearts">💗 <span id="liveHeartCount">0</span></span>
  </div>

  <!-- 新：和粉絲端同一套 liveThread / msg 氣泡 -->
  <div id="liveChat" class="liveThread">
    <div class="msg welcome">尚未開始直播</div>
  </div>

  <div id="livePaused" class="pausedMask" style="display:none">主持人暫時離開中</div>

  <div class="liveInputBar">
    <button id="liveHeartBtn" title="送愛心">💗</button>
    <input id="liveInputBox" placeholder="請輸入訊息" disabled />
    <button id="liveSend" class="chip btnPrimary" disabled>送出</button>
  </div>

  <div class="ctrlRow" style="margin-top:8px">
    <button id="liveStart" class="chip btnPrimary">開始</button>
    <div class="spacer"></div>
    <button id="livePause" class="chip" style="display:none">暫時離開</button>
    <button id="liveEnd" class="chip danger" style="display:none">結束直播</button>
  </div>
</section>

<!-- ====================== Bottom Nav ====================== -->
<nav id="nav" class="weverse">
  <button id="tabHome" class="navItem active" onclick="showPage('home')">
    <span class="i" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1z" fill="currentColor"/></svg>
    </span>
    <span class="t">首頁</span>
  </button>

  <button id="tabPosts" class="navItem" onclick="showPage('postList')">
    <span class="i"><svg viewBox="0 0 24 24"><path d="M4 4h7v7H4zM13 4h7v5h-7zM13 11h7v9h-7zM4 13h7v7H4z" fill="currentColor"/></svg></span>
    <span class="t">貼文</span>
  </button>

  <button id="tabDM" class="navItem" onclick="showPage('dm')">
    <span class="i"><svg viewBox="0 0 24 24"><path d="M3 5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9l-5 4v-4H5a2 2 0 0 1-2-2z" fill="currentColor"/></svg></span>
    <span class="t">DM</span>
  </button>

<button id="tabLive" class="navItem" onclick="showPage('live')">
  <span class="i" aria-hidden="true">
    <svg viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="10" rx="2" fill="currentColor"/>
      <rect x="8" y="19" width="8" height="2" rx="1" fill="currentColor"/>
    </svg>
  </span>
  <span class="t">直播</span>
</button>

  <button id="tabStore" class="navItem" onclick="showPage('store')">
    <span class="i"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm8 8H4a1 1 0 0 1-1-1 7 7 0 0 1 14 0 1 1 0 0 1-1 1Z" fill="currentColor"/></svg></span>
    <span class="t">我</span>
  </button>
</nav>

<!-- 全螢幕媒體檢視器 -->
<div id="viewer">
  <div class="stage">
    <img id="viewerImg" alt="" style="display:none">
    <video id="viewerVideo" controls playsinline style="display:none"></video>
  </div>
  <button id="viewerClose" aria-label="close" style="
    position:fixed;right:14px;top:14px;z-index:95;border:none;border-radius:10px;
    background:rgba(255,255,255,.14);backdrop-filter:blur(6px);color:#fff;padding:6px 10px;">✕</button>
</div>
<script>
  
/* ===================== 工具 ===================== */
function imgFallback(img){
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
  img.src = 'data:image/svg+xml;charset=UTF-8,' + svg; img.onerror = null;
}
const LS = {
  get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){ console.warn('localStorage full?', e); } },
  getStr(k,def=''){ const v=localStorage.getItem(k); return v ?? def },
  setStr(k,v){ try{ localStorage.setItem(k,v) }catch(e){ console.warn('localStorage full?', e); } }
};
const fmtTime = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const s2clock = s => { s = Math.max(0, s||0); const m = Math.floor(s/60), r = Math.floor(s%60); return `${m}:${r.toString().padStart(2,'0')}`; };
const mmss = sec => { sec = Math.max(0, Math.floor(sec || 0)); const m = Math.floor(sec/60), s = sec % 60; return `${m}:${s.toString().padStart(2,'0')}`; };
const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]));
function timeAgo(ts){
  const now = Date.now();
  const diff = Math.max(0, now - (ts || 0));
  const sec = Math.floor(diff/1000);

  if (sec < 60) return '現在';
  const min = Math.floor(sec/60);
  if (min < 60) return `${min} 分鐘前`;
  const hr = Math.floor(min/60);
  if (hr < 24) return `${hr} 小時前`;

  const d = new Date(ts);
  const thisYear = new Date().getFullYear();
  const m = d.getMonth()+1, day = d.getDate();
  return (d.getFullYear() === thisYear) ? `${m}月${day}日` : `${d.getFullYear()}/${m}月${day}日`;
}

function makeTranslateBtn(msg){
  const b = document.createElement('button');
  b.className = 'translateBtnA';            // ← 修正類名
  b.setAttribute('aria-label','翻譯');
  b.textContent = 'A';
  b.addEventListener('click', (e)=>{
    e.stopPropagation();
    LS.setStr(`dmTranslated:${msg.id}`, '1'); // 標記已翻譯
    renderThread();
  }, { once:true });
  return b;
}

/* 2) 工具：綁定「右滑回覆」（像 LINE） */
function bindSwipeReply(hostEl, msg){
  let startX=0, startY=0, dx=0, dy=0, dragging=false, triggered=false;
  const THRESH = 48;            // 觸發距離
  const ANGLE  = 28;            // 垂直容差

  function onStart(e){
    const p = ('touches' in e) ? e.touches[0] : e;
    startX=p.clientX; startY=p.clientY; dx=0; dy=0; dragging=true; triggered=false;
  }
  function onMove(e){
    if(!dragging) return;
    const p = ('touches' in e) ? e.touches[0] : e;
    dx = p.clientX - startX; dy = p.clientY - startY;
    // 僅偵測右滑；上下太多就視為滾動
    if(dx>THRESH && Math.abs(dy)<ANGLE && !triggered){
      triggered = true; dragging = false;
      replyDraft = { text: msg.text };
      const chip = document.getElementById('replyChip');
      const tip  = document.getElementById('replyChipText');
      if(chip && tip){
        chip.style.display='flex';
        tip.textContent = (msg.text||'').slice(0,42);
      }
      document.getElementById('dmMessageInput')?.focus();
      scrollToEndDuring(600);
    }
  }
  function onEnd(){ dragging=false; }

  hostEl.addEventListener('touchstart', onStart, {passive:true});
  hostEl.addEventListener('touchmove',  onMove,  {passive:true});
  hostEl.addEventListener('touchend',   onEnd,   {passive:true});
  hostEl.addEventListener('pointerdown', onStart, {passive:true});
  hostEl.addEventListener('pointermove', onMove,  {passive:true});
  hostEl.addEventListener('pointerup',   onEnd,   {passive:true});
}

// 在 htmlpreview.github.io 用 raw.githack（有 CORS），其他情境用相對路徑
const BASE = (location.hostname === 'htmlpreview.github.io')
  ? 'https://raw.githack.com/xuyunxiu/nexts-you-preview/main/'
  : './';

const DATASRC = {
  artists: BASE + 'data/artists.json',
  posts:   BASE + 'data/posts.json',
  thread:  BASE + 'data/group_msgs.json'
};

async function loadJSON(url, fallback){
  try{
    const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){
    console.warn('fetch fallback', url, e);
    return typeof fallback === 'function' ? fallback() : (fallback ?? []);
  }
}

async function bootFromJSON(){
  const [aa, pp, mm] = await Promise.all([
    loadJSON(DATASRC.artists, ()=>ARTISTS),
    loadJSON(DATASRC.posts,   ()=>POSTS),
    loadJSON(DATASRC.thread,  ()=>GROUP_MSGS)
  ]);

  ARTISTS    = Array.isArray(aa)?aa:ARTISTS;
  POSTS      = Array.isArray(pp)?pp:POSTS;
  GROUP_MSGS = Array.isArray(mm)?mm:GROUP_MSGS;

  LS.set('artistsCache', ARTISTS);
  LS.set('artistPosts', POSTS);
  LS.set('groupMsgs', GROUP_MSGS);

  renderStoryBar();
  renderFeed(currentFilter);
  renderDmList();
  if ((PAGE_STACK[PAGE_STACK.length-1]||'') === 'dmDetail') renderThread();
}

/* ===== 評論數工具（統一口徑） ===== */
function totalComments(p){ return Array.isArray(p?.cmts) ? p.cmts.length : 0; }
function refreshCommentCountUI(postId){
  const p = POSTS.find(x => x.id === postId);
  const n = totalComments(p);
  document.querySelectorAll(`.post[data-post="${postId}"] .cmtCount`)
    .forEach(el => el.textContent = String(n));
}
  
document.addEventListener('DOMContentLoaded', () => {
  bootFromJSON();
  recalcHud();
});


/* ===== IndexedDB：媒體存這裡 ===== */
const MEDIA_DB = (()=> {
  const DB_NAME='nxu-media-db', STORE='media';
  let db=null; const urlCache=new Map();
  function open(){ return new Promise((res,rej)=>{
    if(db) return res(db);
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{ const d=e.target.result; if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE); };
    req.onsuccess=()=>{ db=req.result; res(db); };
    req.onerror=()=>rej(req.error);
  });}
  async function put(blob){ const d=await open(); return new Promise((res,rej)=>{
    const id='m'+Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(blob,id);
    tx.oncomplete=()=>res(id); tx.onerror=()=>rej(tx.error);
  });}
  async function getBlob(id){ const d=await open(); return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(id);
    req.onsuccess=()=>res(req.result||null); req.onerror=()=>rej(req.error);
  });}
  async function getURL(id){ if(urlCache.has(id)) return urlCache.get(id);
    const p=(async ()=>{ const blob=await getBlob(id); return blob? URL.createObjectURL(blob) : ''; })();
    urlCache.set(id,p); return p;
  }
  return { put, getURL };
})();

/* 只允許同時播放一條 */
let ACTIVE_AUDIO = null;  function stopActive(){ if (ACTIVE_AUDIO){ ACTIVE_AUDIO.pause(); ACTIVE_AUDIO._owner?.classList.remove('playing'); ACTIVE_AUDIO = null; } }

// 新增：離開 DM／切到背景 時，統一停掉所有可能的播放
function haltDmMedia(){
  // 語音泡泡（單例控制）
  try{ stopActive(); }catch(_){}

  // DM 內任何 <audio>/<video>（包含你用來當語音播放器的 <video>）
  document.querySelectorAll('#dmThread audio, #dmThread video').forEach(m=>{
    try{ m.pause(); }catch(_){}
  });

  // 修剪視窗的試聽
  const t = document.getElementById('trimMedia');
  if (t) { try{ t.pause(); }catch(_){} }

  // 全螢幕檢視器
  const vv = document.getElementById('viewerVideo');
  if (vv) { try{ vv.pause(); }catch(_){} }
  closeViewer();
}
  
/* ===== 個人資料／假資料 ===== */
const STAGE_NAME = LS.getStr('artistStage','ANNIE');
let   NICKNAME   = LS.getStr('artistNickname','Annie');      // 自己看到的暱稱
let   AVATAR     = LS.getStr('artistAvatar','https://picsum.photos/80?u=artist');
const ME = { id:'me', name:STAGE_NAME, avatar:AVATAR };

let ARTISTS = [
  {id:'me',name:STAGE_NAME,avatar:AVATAR},
  {id:'all',name:'ALL',avatar:'https://picsum.photos/80?u=all'},
  {id:'dohee',name:'DOHEE',avatar:'https://picsum.photos/80?u=dh'},
  {id:'woo',name:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc'}
];
let POSTS = LS.get('artistPosts',[
  {id:'p3',artistId:'dohee',artistStage:'DOHEE',avatar:'https://picsum.photos/80?u=dh',text:'練舞練到爆汗 💃',img:'https://picsum.photos/1200?u=dh1',ts:Date.now()-1000*60*40},
  {id:'p2',artistId:'woo',artistStage:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc',text:'今天吃拉麵 🍜',img:'https://picsum.photos/1200?u=wc1',ts:Date.now()-1000*60*50},
  {id:'p1',artistId:'me',artistStage:STAGE_NAME,avatar:ME.avatar,text:'大家好，我是 Annie ✨',img:'',ts:Date.now()-1000*60*60}
]);
const FANS=[{id:'f1',name:'Michelle',avatar:'https://picsum.photos/40?u=f1'},{id:'f2',name:'粉絲 B',avatar:'https://picsum.photos/40?u=f2'}];

let GROUP_MSGS=LS.get('groupMsgs',[
  {id:'m1',from:'fan',fanId:'f1',text:'偶像好～',ts:Date.now()-1000*60*45},
  {id:'m2',from:'fan',fanId:'f2',text:'今天吃什麼？',ts:Date.now()-1000*60*43},
  {id:'m3',from:'artist',text:'我午餐吃了沙拉 🥗',ts:Date.now()-1000*60*40,replyTo:{text:'今天吃什麼？'}}
]);
const lastSeen = LS.get('lastSeen', {});

  // === Modal helpers（open/close + 舊名相容）===
function openModal(id){ const m = document.getElementById(id); if(m) m.style.display='block'; }
function closeModal(id){ const m = document.getElementById(id); if(m) m.style.display='none'; }
function closeCrop(){ closeModal('cropModal'); }
function closePreview(){ closeModal('previewModal'); }

function dataURLtoBlob(dataURL){
  const [meta, b64] = dataURL.split(',');
  const mime = (meta.match(/data:(.*?);/)||[])[1] || 'image/jpeg';
  const bin = atob(b64);
  const len = bin.length;
  const u8  = new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
  return new Blob([u8], {type:mime});
}
  
/* ===================== 導航 ===================== */
const HIDE_NAV_IN = ['dmDetail','composerArtist','postDetail','commentDetail'];
let PAGE_STACK = ['home'];

function syncNavVisibility(){
  const nav = document.getElementById('nav');
  const cur = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  const mustHide = HIDE_NAV_IN.includes(cur) || (cur === 'live' && LIVE_ON);
  nav.classList.toggle('hidden', mustHide);
  document.body.classList.toggle('nav-hidden', mustHide); // ← 新增：讓 CSS 能收掉底部 padding
}  
function showPage(id, opts = {}) {
  // 上一頁
  const prev = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  if (prev === 'dmDetail' && id !== 'dmDetail') haltDmMedia();

  const target = document.getElementById(id);
  if (!target) { console.warn('Page not found:', id); return; }

  document.querySelectorAll('section.page.active').forEach(s => s.classList.remove('active'));
  target.classList.add('active');

  const top = PAGE_STACK[PAGE_STACK.length - 1];
  if (top !== id) PAGE_STACK.push(id);

  const tabMap = { home: 'tabHome', postList: 'tabPosts', dm: 'tabDM', store: 'tabStore', live: 'tabLive' };
  document.querySelectorAll('#nav .navItem').forEach(b => b.classList.remove('active'));
  const tabId = tabMap[id];
  if (tabId) document.getElementById(tabId)?.classList.add('active');

  syncNavVisibility();

  switch (id) {
    case 'home':
      renderHomeWeverse();
      break;

    case 'dm':
      renderDmList();
      break;

    case 'dmDetail':
      requestAnimationFrame(() => {
        measureHUD();
        measureFooter();
        renderThread();
        applyChatBg();      // 先掛背景
        recalcHud();        // 再依背景決定 HUD 字色 / 是否加淡底板
        bindBottomObserver();
        bindScrollGuard();
        autoStick = true;
        scrollToEndDuring(800);
        setTimeout(hardStickBottom, 0);
        updateNoticeBanner();
      });
      break;

    case 'composerArtist': {
      const who = document.getElementById('composerWho');
      if (who) who.textContent = NICKNAME;
      break;
    }

      case 'postDetail':
      if (CURRENT_POST_ID) {
        renderPostDetail(CURRENT_POST_ID);
        requestAnimationFrame(bindPostDetailHUD);
      }
      break;

    case 'postList':
      renderStoryBar();
      renderFeed(currentFilter);
      break;

    case 'live':
      break;
  }
}
  
function goBack() {
  const from = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  if (from === 'dmDetail') haltDmMedia();
  PAGE_STACK.pop();
  const prev = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  showPage(prev);
}

/* Weverse 版首頁：只處理 UI，不動資料層 */
function renderHomeWeverse(){
  // On LIVE 列表（點了就進直播頁）
  const liveRow = document.getElementById('homeLiveRow');
  if (liveRow){
    const lives = [
      {thumb:'https://picsum.photos/800/400?u=live1', title:'Voice Only', name:'Hebi.'},
      {thumb:'https://picsum.photos/800/400?u=live2', title:'라이브 드루와✌️', name:'TEMPEST'},
      {thumb:'https://picsum.photos/800/400?u=live3', title:'LIVE', name:'FUM'}
    ];
    liveRow.innerHTML = lives.map(x=>`
      <div class="liveItem" onclick="showPage('live')">
        <img src="${x.thumb}" onerror="imgFallback(this)" alt="">
        <span class="tag">LIVE</span>
        <div class="meta">${x.name}</div>
      </div>
    `).join('');
  }

  // Merch 假資料（UI 用）
  const merch = document.getElementById('homeMerchGrid');
  if (merch){
    const items = [
      {img:'https://picsum.photos/800?u=hoodie',  name:'SWEATSHIRT (M.GREY)', price:'USD $62.17'},
      {img:'https://picsum.photos/800?u=sticker', name:'Deco Sticker',        price:'USD $7.08'},
      {img:'https://picsum.photos/800?u=bag',     name:'Tote Bag',            price:'USD $24.90'},
      {img:'https://picsum.photos/800?u=cap',     name:'Logo Cap',            price:'USD $31.50'}
    ];
    merch.innerHTML = items.map(p=>`
      <div class="prod">
        <div class="ph"><img src="${p.img}" onerror="imgFallback(this)" alt=""></div>
        <div class="name">${p.name}</div>
        <div class="price">${p.price}</div>
      </div>
    `).join('');
  }
}
  
/* ===================== HOME：Story Bar / Feed ===================== */
let currentFilter='me';

function hasNewDots(artistId){
  if(artistId==='me'||artistId==='all') return false;
  const seen=lastSeen[artistId]||0;
  const latest=Math.max(0,...POSTS.filter(p=>p.artistId===artistId).map(p=>p.ts));
  return latest>seen;
}

function renderStoryBar(){
  const bar = document.getElementById('storyBar');
  if(!bar) return;

  const others=ARTISTS.filter(a=>a.id!=='me'&&a.id!=='all');
  others.sort((a,b)=>{
    const la=Math.max(0,...POSTS.filter(p=>p.artistId===a.id).map(p=>p.ts));
    const lb=Math.max(0,...POSTS.filter(p=>p.artistId===b.id).map(p=>p.ts));
    return lb-la;
  });
  const order=[ARTISTS.find(a=>a.id==='me'),ARTISTS.find(a=>a.id==='all'),...others];
  bar.innerHTML=order.map(a=>{
    const active=(currentFilter===a.id)?'active':'';
    const pinned=(a.id==='me'||a.id==='all')?'pinned':'';
    const dot=hasNewDots(a.id)?'<span class="dot"></span>':'';
    const label = (a.id==='me') ? 'ME' : a.name;
    return `<div class="story-item ${active} ${pinned}" data-id="${a.id}"
             role="button" tabindex="0" aria-label="查看 ${label} 的貼文">
      <img src="${a.avatar}" alt="${label} 的頭像" onerror="imgFallback(this)">${dot}
      <div class="name">${label}</div>
    </div>`;
  }).join('');

  bar.querySelectorAll('.story-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id=el.dataset.id; currentFilter=id;
      if(id!=='all') lastSeen[id]=Date.now(); LS.set('lastSeen', lastSeen);
      renderStoryBar(); renderFeed(currentFilter); window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

function feedOf(filter){
  if(filter==='all') return POSTS.slice().sort((a,b)=>b.ts-a.ts);
  if(filter==='me')  return POSTS.filter(p=>p.artistId==='me').sort((a,b)=>b.ts-a.ts);
  return POSTS.filter(p=>p.artistId===filter).sort((a,b)=>b.ts-a.ts);
}

function VB(size=18){
  const gid='vbGrad-'+Math.random().toString(36).slice(2,8);
  return `<span class="verified-badge" style="width:${size}px;height:${size}px">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs><linearGradient id="${gid}" x1="0" y="0" x2="1" y="1">
        <stop offset="0%" stop-color="#6fb3ff"/><stop offset="58%" stop-color="#7b6dff"/><stop offset="92%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e9ecff"/>
      </linearGradient></defs>
      <path class="gear" fill="url(#${gid})" d="M12 2.3 14 4l2.9-.6.9 2.7 2.7.9-.6 2.9L22 12l-2.1 2.1.6 2.9-2.7.9-.9 2.7-2.9-.6L12 21.7 10 20l-2.9.6-.9-2.7-2.7-.9.6-2.9L2 12l2.1-2.1-.6-2.9 2.7-.9.9-2.7L10 4l2-1.7z"/>
      <path class="tick" d="M10.4 12.8 8.7 11.2l1.1-1.1 1.2 1.2 3-3 1.1 1.1-3.8 3.8a1 1 0 0 1-1.4 0z"/></svg>
  </span>`;
}

function renderFeed(filter='me'){
  const wrap = document.getElementById('feedWrap');
  if(!wrap) return;

  const list = feedOf(filter);
  if(!list.length){
    wrap.innerHTML = `<div class="ghost" style="text-align:center;margin-top:20vh">尚無貼文</div>`;
    return;
  }

  wrap.innerHTML = list.map(p=>{
    const stage = (p.artistStage||STAGE_NAME||'').toString().toUpperCase();
    const displayName = (p.artistId==='me') ? NICKNAME.toUpperCase() : stage;

    return `
    <div class="post card soft" data-post="${p.id}">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}" alt="${escapeHtml(displayName)} 的頭像" onerror="imgFallback(this)">
        <div class="meta">
          <b class="stage">${escapeHtml(displayName)} ${VB(18)}</b>
          <small class="ghost">${new Date(p.ts).toLocaleString()}</small>
        </div>
        <button class="chip translate-btn" title="翻譯">가/A</button>
      </div>

      <div class="body">
  <p id="postText-${p.id}">${escapeHtml(p.text)}</p>
  ${p.img ? `<img class="hero" src="${p.img}" alt="貼文圖片" onerror="imgFallback(this)">` : ``}
  ${Array.isArray(p.imgs) && p.imgs.length > 1
      ? `<div class="pageDots">${p.imgs.map(()=>'<span class="dot"></span>').join('')}</div>` 
      : ``}
</div>

      <div class="actions">
        ${renderReactionsBar(p.id)}
        <div class="commentBar">
          <div class="left">💬 <span class="cmtCount">${totalComments(p)}</span> 則評論</div>
          <div class="right"><button class="addCmt">發表評論</button></div>
        </div>
      </div>
    </div>`;
  }).join('');

  // 回填「貼文翻譯」狀態
  list.forEach(p=>{
    if (LS.getStr(`postTranslated:${p.id}`) === '1') {
      _translateState[p.id] = true;
      const el = document.getElementById(`postText-${p.id}`);
      if (el) {
        el.dataset.origin = el.textContent;
        el.textContent = `（已翻譯）${el.dataset.origin}`;
      }
    }
  });
}

/* ====== Fan 規則：6 種反應 + 單選 ====== */
const REACTION_TYPES = [
  {key:'heart', icon:'💜'},
  {key:'clap',  icon:'👏'},
  {key:'laugh', icon:'🤣'},
  {key:'panda', icon:'🐼'},
  {key:'tear',  icon:'🥲'},
  {key:'cheer', icon:'🥳'}
];
function getReactions(postId){ return LS.get(`reactions:${postId}`, {}); }
function setReactions(postId, data){ LS.set(`reactions:${postId}`, data); }
function getMyReactions(postId){ return LS.get(`myReacts:${postId}`, {}); }
function setMyReactions(postId, data){ LS.set(`myReacts:${postId}`, data); }
function formatCount(n){
  if(n>=1000000) return Math.round(n/100000)/10+'M';
  if(n>=1000)    return Math.round(n/100)/10+'K';
  return n ? String(n) : '';
}
function renderReactionsBar(postId){
  const data = getReactions(postId);
  const mine = getMyReactions(postId);
  return `<div class="reacts" data-react-for="${postId}">
    ${REACTION_TYPES.map(r=>{
      const active = mine[r.key] ? ' active' : '';
      const num = formatCount(data[r.key]||0);
      return `<button class="react${active}" data-react="${r.key}">${r.icon} <span class="num">${num}</span></button>`;
    }).join('')}
  </div>`;
}
function toggleReaction(postId, type){
  let data = getReactions(postId);
  let mine = getMyReactions(postId);

  if(mine[type]){
    delete mine[type];
    data[type] = Math.max((data[type]||0)-1, 0);
  }else{
    for(const k in mine){ if(mine[k]) data[k] = Math.max((data[k]||0)-1, 0); }
    mine = {[type]: true};
    data[type] = (data[type]||0) + 1;
  }
  setMyReactions(postId, mine);
  setReactions(postId, data);

  // 同步刷新同貼文所有區塊
  document.querySelectorAll(`.reacts[data-react-for="${postId}"]`)
    .forEach(area => { area.outerHTML = renderReactionsBar(postId); });
}
  
 function renderPostList(){
  const wrap = document.getElementById('postListWrap'); if(!wrap) return;
  const all = (POSTS||[]).slice().sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = all.map(p=>`
    <div class="post card soft" data-post="${p.id}">
      <div class="hdr">
        <img class="avatar" src="${p.avatar||ME.avatar}" onerror="imgFallback(this)">
        <div class="meta">
          <b class="stage">${(p.artistId==='me'?NICKNAME:(p.artistStage||STAGE_NAME)).toUpperCase()}</b>
          <small class="ghost">${timeAgo(p.ts)}</small>
        </div>
      </div>
      <div class="body">
        <p id="postText-${p.id}">${escapeHtml(p.text||'')}</p>
        ${p.img?`<img class="hero" src="${p.img}" onerror="imgFallback(this)">`:''}
      </div>
      <div class="actions">
        ${renderReactionsBar(p.id)}
        <div class="commentBar">
          <div class="left">💬 <span class="cmtCount">${(p.cmts||[]).filter(c=>!c.replyTo).length}</span> 則評論</div>
          <div class="right"><button class="addCmt">發表評論</button></div>
        </div>
      </div>
    </div>
  `).join('');
} 

/* ====== Fan 規則：貼文翻譯 ====== */
const _translateState = {};
function togglePostTranslate(postId){
  const el = document.getElementById(`postText-${postId}`); if(!el) return;
  _translateState[postId] = !_translateState[postId];
  if(_translateState[postId]){
    el.dataset.origin = el.textContent;
    el.textContent = `（已翻譯）${el.dataset.origin}`;
  }else{
    el.textContent = el.dataset.origin || el.textContent;
  }
  LS.setStr(`postTranslated:${postId}`, _translateState[postId] ? '1' : '0');
} 
  
 let CURRENT_THREAD = { postId:null, rootId:null };

function openCommentDetail(postId, rootId){
  CURRENT_THREAD = { postId, rootId };
  showPage('commentDetail');
  renderCommentDetail();
}

function commentById(p, id){
  return (p.cmts||[]).find(c=>c.id===id) || null;
}

function renderCommentDetail(){
  const wrapRoot = document.getElementById('cdRoot');
  const listEl   = document.getElementById('cdList');
  const p = POSTS.find(x=>x.id===CURRENT_THREAD.postId); if(!p) return;
  const root = commentById(p, CURRENT_THREAD.rootId);    if(!root) return;

  // 主樓（粉絲留言）
  wrapRoot.innerHTML = `
    <div class="card soft" style="display:flex;gap:10px;align-items:flex-start;margin:10px 6px">
      <img src="${root.avatar || 'https://picsum.photos/40?u=fan'}" onerror="imgFallback(this)"
           style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <b style="font-size:13px">${escapeHtml((root.name||'粉絲').toString().toUpperCase())}</b>
          <small class="ghost">${timeAgo(root.ts || p.ts)}</small>
        </div>
        <div style="margin-top:4px">${escapeHtml(root.text||'')}</div>
        <div class="ghost" style="margin-top:6px;display:flex;align-items:center;gap:16px">
          <span>♡ ${formatCount(root.likes||0)}</span>
          <span>🗨️ ${(p.cmts||[]).filter(c=>c.replyTo===root.id).length}</span>
        </div>
      </div>
    </div>`;

  const onlyAdp = document.getElementById('cdOnlyAdp').checked;
  let replies = (p.cmts||[]).filter(c => c.replyTo === root.id);
  if (onlyAdp) replies = replies.filter(c => c.from === 'artist');

  listEl.innerHTML = replies.length ? replies.map(c=>{
    const isArtist = c.from === 'artist';
    const name = isArtist
      ? (c.artistId==='me' ? NICKNAME : (c.artistStage || c.name || 'ARTIST'))
      : (c.name || '粉絲');
    const avatar = isArtist
      ? (c.artistId==='me' ? ME.avatar : (c.avatar || 'https://picsum.photos/40?u=artist'))
      : (c.avatar || 'https://picsum.photos/40?u=fan');
    return `
      <div class="card soft" style="display:flex;gap:10px;align-items:flex-start;margin:10px 6px">
        <img src="${avatar}" onerror="imgFallback(this)"
             style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <b style="font-size:13px">${escapeHtml(String(name).toUpperCase())}${isArtist ? ' '+VB(14) : ''}</b>
            <small class="ghost">${timeAgo(c.ts || p.ts)}</small>
          </div>
          <div style="margin-top:4px">${escapeHtml(c.text || '')}</div>
        </div>
      </div>`;
  }).join('') : `<div class="ghost" style="text-align:center;margin:14px 0">尚無回覆</div>`;

  measureFooter(); // 讓底部輸入列高度正確讓位
}

// 開關
document.getElementById('cdOnlyAdp')?.addEventListener('change', renderCommentDetail);

// 送出回覆（藝人）
const cdInput = document.getElementById('cdInput');
const cdSend  = document.getElementById('cdSend');
function updateCdComposer(){
  const has = (cdInput.value||'').trim().length>0;
  cdSend.disabled = !has;
  document.getElementById('cdComposer').classList.toggle('hasText', has);
}
cdInput?.addEventListener('input', updateCdComposer);
cdInput?.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendThreadReply(); }});
cdSend?.addEventListener('click', sendThreadReply);

function sendThreadReply(){
  const t=(cdInput.value||'').trim(); if(!t) return;
  const p=POSTS.find(x=>x.id===CURRENT_THREAD.postId); if(!p) return;
  p.cmts = p.cmts || [];
  p.cmts.push({
    id:'c'+Date.now(),
    from:'artist', artistId:'me', artistStage:STAGE_NAME, avatar:ME.avatar,
    text:t, replyTo:CURRENT_THREAD.rootId, ts:Date.now()
  });
  LS.set('artistPosts', POSTS);
  cdInput.value=''; updateCdComposer();
  renderCommentDetail();
  refreshCommentCountUI(p.id);
  // 若你停留在貼文詳情時，更新那邊的數字
  if (CURRENT_POST_ID) renderPostDetail(CURRENT_POST_ID);
} 

/* ===================== DM 列表 ===================== */
function getRoomTitle(){ return NICKNAME; }
function lastPreview(m){
  if(!m) return '（無訊息）';
  if(m.type==='image') return '[照片]';
  if(m.type==='video') return '[影片]';
  if(m.type==='audio' || m.type==='voice') return '［語音訊息］';
  return m.text || '（無訊息）';
}
function renderDmList(){
  const box=document.getElementById('dmList');
  const last=GROUP_MSGS[GROUP_MSGS.length-1];
  box.innerHTML=`<div class="dmCard" onclick="showPage('dmDetail')">
    <img src="${ME.avatar}" alt="聊天室頭像" onerror="imgFallback(this)">
    <div class="nameBlock">
      <div class="nameRow" style="align-items:center;gap:8px">
        <span class="artistTag">ARTIST</span>
        <div class="stage">${escapeHtml(getRoomTitle().toUpperCase())}</div>
      </div>
      <small class="ghost" style="display:block;max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(lastPreview(last))}</small>
    </div><span></span></div>`;
}

/* ===================== 語音泡泡（有影像軌用 <video>） ===================== */
function voiceWidthByDur(sec){
  const d = Math.max(0, sec||0);
  const minW=120, maxW=220, cap=60; // 0s→140px，60s+→280px
  const w = minW + (Math.min(d,cap)/cap)*(maxW-minW);
  return Math.round(w);
}
function buildVoiceUI(msg){
  const segStart = Number(msg.segStart || msg.start || 0);
  const segEnd   = Number(msg.segEnd   || msg.end   || 0);

  const ui  = document.createElement('div'); ui.className='voiceUI';
  const btn = document.createElement('button'); btn.className='voicePlay';
  btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;

  const bars = document.createElement('div'); bars.className='voiceBars';
  for(let i=0;i<12;i++){ const b=document.createElement('div'); b.className='voiceBar'; bars.appendChild(b); }

  const dur = document.createElement('div'); dur.className='voiceDur'; dur.textContent = '0:00';
  ui.append(btn,bars,dur);

  const media = document.createElement(msg.isVideo ? 'video' : 'audio');
  media.src = msg.src;
  media.preload = 'metadata';
  media.style.display = 'none';
  if (msg.isVideo) { media.playsInline = true; media.setAttribute('webkit-playsinline',''); }
  ui.appendChild(media);
  media._owner = ui;

  function toPlay(){
    stopActive();
    try{ media.currentTime = segStart || 0; }catch(_){}
    media.play().then(()=>{
      ACTIVE_AUDIO = media;
      ui.classList.add('playing');
      btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>`;
    }).catch(()=>{});
  }
  function toPause(){
    media.pause();
    ui.classList.remove('playing');
    btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
    if (ACTIVE_AUDIO===media) ACTIVE_AUDIO=null;
  }
  btn.onclick = ()=> media.paused ? toPlay() : toPause();

  media.addEventListener('loadedmetadata', ()=>{
    const d = (segEnd>segStart) ? (segEnd - segStart) : (media.duration||0);
    dur.textContent = mmss(d||0);
    ui.style.width = voiceWidthByDur(d||0) + 'px';
  });

  media.addEventListener('timeupdate', ()=>{
    const total  = (segEnd>segStart) ? (segEnd - segStart) : (media.duration||0);
    const played = Math.max(0, (media.currentTime || 0) - (segStart||0));
    const left   = Math.max(0, total - played);
    dur.textContent = mmss(Math.ceil(left));
    if(segEnd>segStart && media.currentTime >= segEnd - 0.05){ toPause(); }
  });

  media.addEventListener('ended', toPause);

  return ui;
}
  
/* ===================== DM Thread（渲染） ===================== */
let replyDraft=null;

async function resolveMediaSrc(m){
  if(m.src) return m.src;                   // 舊資料（DataURL）仍可顯示
  if(m.mediaId) return await MEDIA_DB.getURL(m.mediaId); // 新流程（IndexedDB）
  return '';
}

/* 日期分隔文字 */
function dayLabel(ts){
  const d=new Date(ts), now=new Date();
  const ymd = (x)=>[x.getFullYear(),x.getMonth(),x.getDate()].join('-');
  const diffDays = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - new Date(d.getFullYear(),d.getMonth(),d.getDate()))/86400000);
  if(ymd(d)===ymd(now)) return '今天';
  if(diffDays===1) return '昨天';
  if(diffDays>=7){
    return `${d.getMonth()+1}月${d.getDate()}日`;
  }
  return `${d.getMonth()+1}月${d.getDate()}日`; // 一週內非今/昨，仍顯示月日
}

function renderThread(){
  const box=document.getElementById('dmThread'); box.innerHTML='';
   let lastDivider='';
   GROUP_MSGS.forEach(m=>{
    /* 日期分隔 */
    const label=dayLabel(m.ts);
    if(label!==lastDivider){
      const div=document.createElement('div'); div.className='dayDivider'; div.textContent=label;
      box.appendChild(div); lastDivider=label;
    }
    const wrap=document.createElement('div');
    const isMedia=(m.type==='image'||m.type==='video');
    wrap.className='msg '+(m.from==='artist'?'right':'left')+(isMedia?' media':'');
    const timeEl=document.createElement('div');
    timeEl.className='time'+(m.from==='artist'?'':' dark');
    timeEl.textContent=fmtTime(m.ts);

    const bubble=document.createElement('div'); bubble.className='bubble';

    if(m.type==='image'){
      const img=document.createElement('img');
      img.className='msgImg';
      img.alt='聊天圖片';
      bubble.classList.add('mediaWrap');
      bubble.appendChild(img);
      resolveMediaSrc(m).then(url=>{ img.src=url; img.addEventListener('click',()=>openViewer(url,'img', img)); }).catch(()=>{});
    }else if(m.type==='video'){
      const v=document.createElement('video'); v.className='msgVideo'; v.controls=true; v.playsInline=true; v.setAttribute('webkit-playsinline','');
      bubble.classList.add('mediaWrap');
      bubble.appendChild(v);
      resolveMediaSrc(m).then(url=>{ v.src=url; v.addEventListener('click',()=>openViewer(url,'video', v)); }).catch(()=>{});
    }else if(m.type==='voice'){
      resolveMediaSrc(m).then(url=>{
        bubble.classList.add('voice');
        const ui = buildVoiceUI({src:url, segStart:m.start, segEnd:m.end, isVideo:m.isVideo});
        bubble.appendChild(ui);
      });
    } else {
  if(m.from === 'fan'){
    const already = LS.getStr(`dmTranslated:${m.id}`, '0') === '1';

    if (already){
      // 已翻譯：原文 + 置中虛線 + 淺藍紫粗體翻譯
      const orig = document.createElement('div');
      orig.className = 'fanText';
      orig.textContent = m.text || '';

      const hr = document.createElement('div');
      hr.className = 'transDivider';

      const tran = document.createElement('div');
      tran.className = 'transText';
      tran.textContent = m.text || ''; // ← 之後串接翻譯 API 再替換字串

      bubble.append(orig, hr, tran);
    } else {
      // 未翻譯：只顯示原文；泡泡右側掛 A 鈕（位置=舊回覆鍵）
      const txt = document.createElement('div');
      txt.className = 'fanText';
      txt.textContent = m.text || '';
      bubble.appendChild(txt);

      // A 在泡泡右側
      bubble.appendChild( makeTranslateBtn(m) );
    }
  } else {
    // 右側藝人純文字維持原樣
    bubble.textContent = m.text || '';
  }
}

    // 放在 renderThread() 內，建立完 bubble 之後：
if (m.from === 'fan' && !m.type) {
  let sx = 0, dx = 0, dragging = false;

  bubble.addEventListener('pointerdown', (e)=>{
    dragging = true; sx = e.clientX; dx = 0;
    try{ bubble.setPointerCapture(e.pointerId); }catch(_){}
  });
  bubble.addEventListener('pointermove', (e)=>{
    if (!dragging) return;
    dx = e.clientX - sx;
    // 微移動視覺回饋（不必要可拿掉）
    bubble.style.transform = `translateX(${Math.max(0, Math.min(48, dx))}px)`;
  });
  const end = ()=>{
    if (!dragging) return;
    dragging = false;
    bubble.style.transform = '';
    // 右滑超過 36px 視為回覆
    if (dx > 36) {
      replyDraft = { text: m.text };
      document.getElementById('replyChip').style.display='flex';
      document.getElementById('replyChipText').textContent = (m.text||'').slice(0,42);
      document.getElementById('dmMessageInput').focus();
      scrollToEndDuring(600);
    }
  };
  bubble.addEventListener('pointerup', end);
  bubble.addEventListener('pointercancel', end);
}

    wrap.append(bubble,timeEl); box.appendChild(wrap);

    if(m.from==='artist'&&m.replyTo&&m.replyTo.text){
      const rc=document.createElement('div'); rc.className='replyCard';
      rc.innerHTML=`<div class="fromLabel">FROM FAN</div><div class="fanText">${escapeHtml(m.replyTo.text)}</div>`;
      box.appendChild(rc);
    }
  });

  
  if(!box.querySelector('#threadPad')){ const pad=document.createElement('div'); pad.id='threadPad'; box.appendChild(pad); }
  if(!box.querySelector('#endAnchor')){ const a=document.createElement('div'); a.id='endAnchor'; box.appendChild(a); }

  ensureNoticeRow(); 
}
  
/* 把 notice 掛在輸入列容器（固定位置渲染） */
function ensureNoticeRow(){
  const host = document.getElementById('dmDetail');   // ← 原本是 dmFooter
  if(!host) return null;
  let n = document.getElementById('noticeRow');
  if(!n){
    n = document.createElement('div');
    n.id = 'noticeRow';
    n.className = 'noticeBar is-floating';
    n.setAttribute('role','status');
    n.setAttribute('aria-live','polite');
    n.textContent = '粉絲在等你的訊息喔 🤩';
    host.appendChild(n);                               // ← 改這裡
  }
  tuneNoticePad();
  return n;
}

function clearNoticeNow(){ /* 常駐：不用清除 */ }

// === Demo：插入一則「未翻譯」的粉絲訊息，預覽未按 A 的樣子 ===
window.demoFanMsgPreview = function(){
  const id = 'fanDemo_' + Date.now().toString(36);
  GROUP_MSGS.push({
    id,
    from:'fan',
    text:'（DEMO）這是粉絲的新留言，尚未按 A 翻譯！🎉',
    ts: Date.now()
  });

  // 明確標記為「尚未翻譯」
  try { LS.setStr(`dmTranslated:${id}`, '0'); } catch(_) {}

  // 存回 & 直接切到 DM 詳情看效果
  LS.set('groupMsgs', GROUP_MSGS);
  if ((PAGE_STACK[PAGE_STACK.length-1]||'') !== 'dmDetail') showPage('dmDetail');
  renderThread(); renderDmList(); hardStickBottom(); updateNoticeBanner();
};

// 想立即看就解除註解這行：
// demoFanMsgPreview();
  
/* ===================== 系統通知 ===================== */
function getLastTs(role){
  let t=0; for(const m of GROUP_MSGS){ if(!role || m.from===role){ if(m.ts>t) t=m.ts; } } return t;
}
 /* 顯示 notice；推一下卷軸到底，避免和最後一條同排 */
function updateNoticeBanner(){
  const n = ensureNoticeRow(); if(!n) return;
  n.style.display = 'block';

  requestAnimationFrame(()=>{        // 等插進 DOM
    tuneNoticePad();                 // 量到高度並更新 padding / 墊片
    requestAnimationFrame(()=>{      // 等樣式套用
      scrollToEndDuring(600);
    });
  });
}
function tuneNoticePad(){
  const n = document.getElementById('noticeRow');
  const h = (n && getComputedStyle(n).display !== 'none')
    ? Math.ceil((n.getBoundingClientRect().height || 0) + 18)  // ← 18px 緩衝
    : 0;

  document.documentElement.style.setProperty('--notice-h', h + 'px');

  const pad = document.getElementById('threadPad');
  if (pad) pad.style.setProperty('height', h + 'px', 'important');
}
  
/* ===================== 送訊息 / 回覆 ===================== */
function clearReply(){
  replyDraft=null;
  document.getElementById('replyChip').style.display='none';
  scrollToEndDuring(400);
}

function sendArtistMsg(){
  const inp=document.getElementById('dmMessageInput');
  let t=(inp.value||'').trim();
  if(!t) return;

  GROUP_MSGS.push({
    id:'u'+Date.now(),
    from:'artist',
    text:t,
    ts:Date.now(),
    replyTo:replyDraft?{text:replyDraft.text}:null
  });

  LS.set('groupMsgs', GROUP_MSGS);
  inp.value=''; updateComposerUI(); clearReply(); renderThread(); renderDmList();
  clearNoticeNow();
  hardStickBottom();
  updateNoticeBanner();
}

document.getElementById('dmSendBtn').addEventListener('click', sendArtistMsg);

const dmInput = document.getElementById('dmMessageInput');
dmInput.addEventListener('keydown', e=>{
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendArtistMsg(); }
});
const sendBtn = document.getElementById('dmSendBtn');
const footerEl = document.getElementById('dmFooter');
function updateComposerUI(){
  const has = (dmInput.value||'').trim().length>0;
  footerEl.classList.toggle('hasText', has);
  sendBtn.disabled = !has;
}
dmInput.addEventListener('input', updateComposerUI);
dmInput.addEventListener('focus', ()=>{
  setTimeout(hardStickBottom,0);
  setTimeout(hardStickBottom,200);
  setTimeout(hardStickBottom,600);
});

/* ===================== 媒體上傳 ===================== */
const pickMedia = document.getElementById('pickMedia');
const pickVoice = document.getElementById('pickVoice');

document.getElementById('btnCamera').addEventListener('click', ()=>pickMedia.click());
document.getElementById('btnMic').addEventListener('click', ()=>pickVoice.click());

pickMedia.addEventListener('change', async e=>{
  const files=[...e.target.files];
  for(const f of files){
    const id = await MEDIA_DB.put(f);
    const isVideo = f.type.startsWith('video/');
    GROUP_MSGS.push({
      id:'m'+Date.now()+Math.random(),
      from:'artist',
      type:isVideo?'video':'image',
      mediaId:id,
      ts:Date.now()
    });
  }
  LS.set('groupMsgs', GROUP_MSGS);
  renderThread(); renderDmList(); clearNoticeNow(); hardStickBottom(); updateNoticeBanner();
  e.target.value='';
});

/* ===================== 語音修剪（可試聽） ===================== */
let trimState = { blob:null, url:'', dur:0, start:0, end:0 };
const trimModal = document.getElementById('trimModal');
const trimMedia = document.getElementById('trimMedia');
const trimPlay  = document.getElementById('trimPlay');
const trimStart = document.getElementById('trimStart');
const trimEnd   = document.getElementById('trimEnd');
const trimStartLabel=document.getElementById('trimStartLabel');
const trimEndLabel=document.getElementById('trimEndLabel');
const trimClock = document.getElementById('trimClock');
const trimFill  = document.getElementById('trimFill');
const trimUse   = document.getElementById('trimUse');

pickVoice.addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  trimState.blob = f;
  trimState.url  = URL.createObjectURL(f);
  trimMedia.src = trimState.url;
  trimMedia.load();
  trimOpen();
  e.target.value='';
});

function trimOpen(){
  trimModal.style.display='block';
  trimPlay.disabled=true; trimUse.disabled=true;
  trimMedia.addEventListener('loadedmetadata', onLoadedMeta, {once:true});
  trimMedia.addEventListener('timeupdate', onTick);
}

function onLoadedMeta(){
  const d = trimMedia.duration || 0;
  trimState.dur = d;
  trimState.start = 0; trimState.end = d;
  trimStart.value = 0; trimEnd.value = 1000;
  trimStartLabel.textContent = '0.0s';
  trimEndLabel.textContent = d ? `${d.toFixed(1)}s` : '0.0s';
  trimClock.textContent = '0:00';
  trimPlay.disabled=false; trimUse.disabled=false;
}

function onTick(){
  const st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  const cur = trimMedia.currentTime;
  const w = (ed>st)? ((cur-st)/(ed-st))*100 : 0;
  trimFill.style.width = Math.max(0,Math.min(100,w)) + '%';
  trimClock.textContent = s2clock(Math.max(0, cur-st));
  if(cur>=ed-0.02){ trimMedia.pause(); }
}

function closeTrim(){
  trimModal.style.display='none';
  try{ URL.revokeObjectURL(trimState.url); }catch(_){}
  trimMedia.pause(); trimMedia.src=''; trimFill.style.width='0%';
}

function val2sec(v){ return (Number(v)/1000) * (trimState.dur||0); }

function syncRange(which){
  let st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  if(ed<=st){
    if(which==='start') ed = Math.min(trimState.dur, st + 0.3);
    else st = Math.max(0, ed - 0.3);
  }
  trimState.start = st; trimState.end = ed;
  trimStartLabel.textContent = `${st.toFixed(1)}s`;
  trimEndLabel.textContent   = `${ed.toFixed(1)}s`;
}
trimStart.addEventListener('input', ()=>{ syncRange('start'); });
trimEnd.addEventListener('input',   ()=>{ syncRange('end'); });

let playing=false;
trimPlay.addEventListener('click', ()=>{
  if(!playing){
    try{ trimMedia.currentTime = trimState.start; }catch(_){}
    trimMedia.play().catch(()=>{});
    trimPlay.textContent='⏸ 暫停'; playing=true;
  }else{
    trimMedia.pause(); trimPlay.textContent='▶️ 播放'; playing=false;
  }
});
trimMedia.addEventListener('pause', ()=>{ trimPlay.textContent='▶️ 播放'; playing=false; });

trimUse.addEventListener('click', async ()=>{
  const dur = Math.max(0, (trimState.end||0) - (trimState.start||0));
  if(!confirm(`要發送 ${mmss(dur)} 的語音片段嗎？`)) return;

  const id = await MEDIA_DB.put(trimState.blob);
  GROUP_MSGS.push({
    id:'v'+Date.now()+Math.random(),
    from:'artist',
    type:'voice',
    isVideo: trimState.blob.type.startsWith('video/'),
    mediaId:id,
    start:trimState.start,
    end:trimState.end,
    ts:Date.now()
  });
  LS.set('groupMsgs', GROUP_MSGS);
  closeTrim(); renderThread(); renderDmList(); clearNoticeNow(); hardStickBottom(); updateNoticeBanner();
});

/* ===================== DM 菜單 / 改名（穩健版） ===================== */
(function initDmMenu(){
  let _bound = false;
  function getMenu(){ return document.getElementById('dmMenu'); }

  window.toggleDmMenu = function toggleDmMenu(){
    const m = getMenu(); if (!m) return;
    const show = m.style.display !== 'block';
    m.style.display = show ? 'block' : 'none';
    m.setAttribute('aria-hidden', show ? 'false' : 'true');
  };

  window.hideDmMenu = function hideDmMenu(){
    const m = getMenu(); if (!m) return;
    m.style.display = 'none';
    m.setAttribute('aria-hidden', 'true');
  };

  // 只綁一次全域點擊關閉
  if (!_bound) {
    document.addEventListener('click', (e)=>{
      const m = getMenu(); if (!m) return;
      const isOpen = m.style.display === 'block';
      if (!isOpen) return;
      const clickedInside = m.contains(e.target);
      const clickedHudBtn = !!e.target.closest('.hudBtn');
      if (!clickedInside && !clickedHudBtn) window.hideDmMenu();
    }, { passive:true });
    _bound = true;
  }
})();

/* 更改聊天室名稱（= 藝人暱稱） */
function renameChat(){
  const cur = getRoomTitle();
  const n = prompt('更改聊天室名稱（同：藝人暱稱）', cur);
  if (n === null) return;                 // 取消
  const val = (n || '').trim();
  if (!val) return;                       // 空值不處理

  NICKNAME = val;
  LS.setStr('artistNickname', NICKNAME);

  const t1 = document.getElementById('dmTitle');      if (t1) t1.textContent = NICKNAME.toUpperCase();
  const t2 = document.getElementById('meNickname');   if (t2) t2.textContent = NICKNAME;
  const t3 = document.getElementById('composerWho');  if (t3) t3.textContent = NICKNAME;

  renderDmList(); // 更新 DM 列表預覽
}

/* === 裁切背景：旋轉 / 縮放 / 拖曳（穩健版） === */
let cropDataURL = '', cropDeg = 0, cropTx = 0, cropTy = 0;
let natW = 0, natH = 0;                 // 來源圖尺寸（像素）
let baseScale = 1;                      // 讓影像 cover 舞台的基準縮放
let CROP_RESULT_URL = '';

const chooser     = document.getElementById('bgChooser');
const cropImg     = document.getElementById('cropImg');
const cropStage   = document.getElementById('cropStage');
const cropScaleEl = document.getElementById('cropScale');
const scaleLabel  = document.getElementById('scaleLabel');

if (cropImg) cropImg.setAttribute('draggable', 'false');

function startPickBg(){ chooser?.click(); }

chooser?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    cropDataURL = String(ev.target.result || '');
    if (!cropImg) return;
    cropImg.onload = ()=>{
      natW = Math.max(1, cropImg.naturalWidth  || 1);
      natH = Math.max(1, cropImg.naturalHeight || 1);
      cropDeg = 0; cropTx = 0; cropTy = 0;
      if (cropScaleEl) cropScaleEl.value = 100;
      updateScaleUI();

      openModal('cropModal');
      // 等面板完成 layout 再量測
      requestAnimationFrame(computeBaseScaleAfterOpen);
    };
    cropImg.src = cropDataURL;
  };
  reader.readAsDataURL(f);
});

/* — 計算基準縮放（cover）— */
function computeBaseScale(){
  if (!cropStage) return 1;
  const sw = Math.max(1, cropStage.clientWidth);
  const sh = Math.max(1, cropStage.clientHeight);
  const imgW = (cropDeg % 180 === 0) ? natW : natH;
  const imgH = (cropDeg % 180 === 0) ? natH : natW;
  if (!imgW || !imgH) return 1;
  baseScale = Math.max(sw / imgW, sh / imgH);
  clampPan();
  return baseScale;
}
function computeBaseScaleAfterOpen(){
  if (!cropStage) return;
  let tries = 0;
  const tick = ()=>{
    if (cropStage.clientWidth && cropStage.clientHeight) {
      computeBaseScale();
      updateCropTransform();
    } else if (tries++ < 24) {
      requestAnimationFrame(tick);
    }
  };
  requestAnimationFrame(tick);
}

/* — 縮放倍率（UI/實際）— */
function uiScale(){  return (Number(cropScaleEl?.value || 100) / 100); }
function cssScale(){ return baseScale * uiScale(); }

/* — 旋轉後外接矩形大小 — */
function rotatedBounds(w, h, rad){
  const c = Math.cos(rad), s = Math.sin(rad);
  return { w: Math.abs(w*c) + Math.abs(h*s),
           h: Math.abs(w*s) + Math.abs(h*c) };
}

/* — 拖曳邊界（避免露白）— */
function clampPan(){
  if (!cropStage) return;
  const sw = Math.max(1, cropStage.clientWidth);
  const sh = Math.max(1, cropStage.clientHeight);
  const s  = cssScale();
  const rad = cropDeg * Math.PI / 180;
  const bb = rotatedBounds(natW*s, natH*s, rad);
  const maxX = Math.max(0, (bb.w - sw)/2);
  const maxY = Math.max(0, (bb.h - sh)/2);
  cropTx = Math.max(-maxX, Math.min(maxX, cropTx));
  cropTy = Math.max(-maxY, Math.min(maxY, cropTy));
}

/* — 套用 transform 到預覽影像 — */
function updateCropTransform(){
  clampPan();
  if (!cropImg) return;
  cropImg.style.transform =
    `translate(-50%,-50%) translate(${Math.round(cropTx)}px, ${Math.round(cropTy)}px) rotate(${cropDeg}deg) scale(${cssScale()})`;
}

/* — 更新 UI 文字/進度條 — */
function updateScaleUI(){
  const v = Number(cropScaleEl?.value || 100);
  if (scaleLabel) scaleLabel.textContent = `${v}%`;
  document.documentElement.style.setProperty('--scaleFill', `${v}%`);
}

/* — 控制鍵 — */
document.getElementById('btnRotate')?.addEventListener('click', ()=>{
  cropDeg = (cropDeg + 90) % 360;
  computeBaseScale();
  updateCropTransform();
});
document.getElementById('zoomIn')?.addEventListener('click', ()=>{
  if (!cropScaleEl) return;
  cropScaleEl.value = Math.min(250, Number(cropScaleEl.value) + 5);
  onScaleInput();
});
document.getElementById('zoomOut')?.addEventListener('click', ()=>{
  if (!cropScaleEl) return;
  cropScaleEl.value = Math.max(50, Number(cropScaleEl.value) - 5);
  onScaleInput();
});
function onScaleInput(){ updateScaleUI(); updateCropTransform(); }
cropScaleEl?.addEventListener('input', onScaleInput, { passive:true });

/* — 拖曳（Pointer Events）— */
let dragging = false, sx = 0, sy = 0, bx = 0, by = 0;
cropImg?.addEventListener('pointerdown', (e)=>{
  dragging = true;
  try{ cropImg.setPointerCapture(e.pointerId); }catch(_){}
  sx = e.clientX; sy = e.clientY; bx = cropTx; by = cropTy;
});
cropImg?.addEventListener('pointermove', (e)=>{
  if (!dragging) return;
  cropTx = bx + (e.clientX - sx);
  cropTy = by + (e.clientY - sy);
  updateCropTransform();
});
['pointerup','pointercancel','lostpointercapture'].forEach(evt=>{
  cropImg?.addEventListener(evt, ()=>{ dragging = false; });
});

/* — 匯出裁切結果（考慮 DPR）— */
function exportCroppedDataURL(mime='image/jpeg', quality=.85){
  if (!cropStage || !cropImg) return '';
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const sw  = Math.max(1, cropStage.clientWidth);
  const sh  = Math.max(1, cropStage.clientHeight);
  const canvas = document.createElement('canvas');
  canvas.width  = Math.round(sw * dpr);
  canvas.height = Math.round(sh * dpr);
  const ctx = canvas.getContext('2d', {alpha:false});
  if (!ctx) return '';
  ctx.imageSmoothingQuality = 'high';
  ctx.scale(dpr, dpr);
  ctx.translate(sw/2, sh/2);
  ctx.translate(cropTx, cropTy);
  ctx.rotate(cropDeg * Math.PI/180);
  ctx.scale(cssScale(), cssScale());
  try{
    ctx.drawImage(cropImg, -natW/2, -natH/2);
  }catch(_){}
  let out = '';
  try{ out = canvas.toDataURL(mime, quality); }catch(_){}
  return out;
}

/* — 下一步 → 預覽 — */
function applyCrop(){
  CROP_RESULT_URL = exportCroppedDataURL();
  const mini = document.getElementById('bgPreviewMini');
  if (mini) mini.style.backgroundImage = CROP_RESULT_URL ? `url("${CROP_RESULT_URL}")` : '';
  closeCrop();
  openModal('previewModal');
}

/* — 將裁切套到 DM 背景（含儲存）— */
function applyChatBg(forceUrl){
  const panel = document.getElementById('dmDetail'); if (!panel) return;
  const setBg = (u)=>{
    if (u) {
      // 僅允許本地來源（data:/blob:）
      if (!(u.startsWith('data:') || u.startsWith('blob:'))) {
        console.warn('Blocked non-local background URL');
        return;
      }
      panel.style.backgroundImage = `url("${u}")`;
      const opt = LS.get('chatBgOpt', { dim:0.18, blur:6 });
      document.documentElement.style.setProperty('--bgDim',  String(opt.dim));
      document.documentElement.style.setProperty('--bgBlur', `${opt.blur}px`);
    } else {
      panel.style.backgroundImage = '';
      document.documentElement.style.setProperty('--bgDim',  '0');
      document.documentElement.style.setProperty('--bgBlur', '0px');
    }
  };

  if (forceUrl) { setBg(forceUrl); return; }

  const url = LS.getStr('chatBg','');
  if (url) { setBg(url); return; }

  const id = LS.getStr('chatBgId','');
  if (id) {
    MEDIA_DB.getURL(id).then(u=> setBg(u||'')).catch(()=> setBg(''));
  } else {
    setBg('');
  }
}

async function confirmPreview(){
  if (!CROP_RESULT_URL){ closePreview(); return; }

  // 先立即顯示
  applyChatBg(CROP_RESULT_URL);

  // 儲存：先試 localStorage，失敗就 IndexedDB
  try{
    LS.setStr('chatBg', CROP_RESULT_URL);
    if (LS.getStr('chatBg','') !== CROP_RESULT_URL) throw new Error('ls-mismatch');
  }catch(_){
    try{
      const blob = dataURLtoBlob(CROP_RESULT_URL);
      const id   = await MEDIA_DB.put(blob);
      LS.setStr('chatBg','');
      LS.setStr('chatBgId', id);
      const u = await MEDIA_DB.getURL(id);
      if (u) applyChatBg(u);
    }catch(err){
      console.warn('Save chatBg fallback failed:', err);
    }
  }
  closePreview();
}

  // 亮度計算（sRGB → 相對亮度）
function _luma(r,g,b){
  const srgb = [r,g,b].map(v=>v/255).map(v => v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
  return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
}

// 取 HUD 區域平均亮度（畫面頂端約 64~72px）
async function _sampleHudLuma(url){
  return new Promise(res=>{
    if(!url){ res(null); return; }
    const ok = url.startsWith('data:') || url.startsWith('blob:');
    if(!ok){ res(null); return; }               // 僅允許本地來源，避開汙染
    const img = new Image(); img.decoding='async';
    img.onload = ()=>{
      try{
        const vw = Math.max(1, window.innerWidth), vh = Math.max(1, window.innerHeight);
        const h  = Math.min(80, Math.max(56, Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hud-h'))||64)));
        const c  = document.createElement('canvas'); c.width = vw; c.height = h;
        const ctx = c.getContext('2d', { willReadFrequently:true });
        ctx.drawImage(img, 0, 0, vw, vh, 0, 0, vw, h);  // 只取頂部條
        const data = ctx.getImageData(0, 0, vw, h).data;
        let sum=0, step=4*4;               // 跳採樣，加速
        for(let i=0;i<data.length;i+=step){ sum += _luma(data[i],data[i+1],data[i+2]); }
        const n = Math.ceil(data.length/step);
        res(sum / Math.max(1,n));
      }catch(_){ res(null); }
    };
    img.onerror = ()=>res(null);
    img.src = url;
  });
}

// 依背景亮度 + 遮罩強度決定字色 / 是否加底板
async function _decideHudInk(url){
  const dim = (LS.get('chatBgOpt', {dim:.18, blur:6})||{}).dim ?? .18;  // 你已有的遮罩
  const l = await _sampleHudLuma(url);  // 0(黑) ~ 1(白)；null=未知
  // 遮罩會把背景往暗壓，粗略補償
  const eff = (l==null) ? null : Math.max(0, Math.min(1, l*(1-dim)));

  // 預設：依系統主題
  const preferDark = matchMedia('(prefers-color-scheme: dark)').matches;
  let ink = preferDark ? '#e9edf5' : '#111';   // 沒得算時的保底
  let needPlate = false;

  if(eff!=null){
    // 門檻：偏暗 → 白字；偏亮 → 黑字；中間帶 + 亮又花時 → 加底板
    if(eff < 0.50) ink = '#ffffff';
    else ink = '#111111';

    // 高亮且遮罩很低 → 容易雜訊，鋪個超淡底板
    if(eff > 0.62 && dim < 0.14) needPlate = true;
  }

  return { ink, needPlate };
}

// 套用到 DOM（設定 CSS 變數 + 視需要掛 ink-plate）
function _applyHudInk({ink, needPlate}){
  document.documentElement.style.setProperty('--hud-ink', ink);
  const hudCenter = document.querySelector('#dmDetail .chatHUD .center');
  if(hudCenter){
    hudCenter.classList.toggle('ink-plate', !!needPlate);
  }
}

// 對外：隨叫隨算（你可在任何情境呼叫）
window.recalcHud = function recalcHud(){
  const url = LS.getStr('chatBg','');
  const id  = LS.getStr('chatBgId','');
  const apply = (u)=>{ _decideHudInk(u).then(_applyHudInk); };

  if(url){ apply(url); return; }
  if(id){
    MEDIA_DB.getURL(id).then(u=>apply(u||'')).catch(()=>_applyHudInk({ink:matchMedia('(prefers-color-scheme: dark)').matches?'#e9edf5':'#111', needPlate:false}));
    return;
  }
  _applyHudInk({ink:matchMedia('(prefers-color-scheme: dark)').matches?'#e9edf5':'#111', needPlate:false});
};

 /* 取畫面底部等高於輸入列的亮度（保留你原本邏輯，收斂成工具函式） */
async function _sampleStripLuma(url){
  return new Promise(res=>{
    if(!url || !(url.startsWith('data:')||url.startsWith('blob:'))) { res(null); return; }
    const img=new Image(); img.decoding='async';
    img.onload=()=>{
      try{
        const vw = Math.max(1, innerWidth), vh = Math.max(1, innerHeight);
        const fh = Math.min(120, Math.max(56, Math.round(
          parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-h')) || 84
        )));
        const c  = document.createElement('canvas'); c.width = vw; c.height = fh;
        const ctx = c.getContext('2d',{willReadFrequently:true});
        // 取「畫面底部」等高於輸入列的區域
        ctx.drawImage(img, 0, vh-fh, vw, fh, 0, 0, vw, fh);
        const data=ctx.getImageData(0,0,vw,fh).data;
        let sum=0, step=16;
        for(let i=0;i<data.length;i+=step){
          const l = v=>{v/=255; v=v<=.03928? v/12.92:Math.pow((v+.055)/1.055,2.4); return v;}
          const Y = .2126*l(data[i]) + .7152*l(data[i+1]) + .0722*l(data[i+2]);
          sum+=Y;
        }
        res(sum/Math.ceil(data.length/step));
      }catch(_){ res(null); }
    };
    img.onerror=()=>res(null); 
    img.src=url;
  });
}

/* 只改 DM 的 rail（#dmFooter）的玻璃配色；不動別的頁面 */
async function recalcDmRailGlass(){
  const dim = (LS.get('chatBgOpt', {dim:.18, blur:6})||{}).dim ?? .18;
  const url = LS.getStr('chatBg',''); 
  const id  = LS.getStr('chatBgId','');
  const footer = document.getElementById('dmFooter');
  if (!footer) return;

  const apply = (eff)=>{
    // 預設（底部偏暗）：淺色玻璃 + 淡藍紫光
    let bg1='rgba(255,255,255,.18)',
        bg2='rgba(255,255,255,.78)',
        stroke='rgba(255,255,255,.45)',
        tint='rgba(123,109,255,.26)';

    // 若底部很亮 → 換成深色玻璃，避免發白；仍保藍紫調
    if (eff != null && eff > 0.58){
      bg1='rgba(16,18,26,.28)';
      bg2='rgba(16,18,26,.68)';
      stroke='rgba(0,0,0,.35)';
      tint='rgba(90,80,210,.22)';
    }

    // 僅設定在 #dmFooter（其它頁面完全不受影響）
    footer.style.setProperty('--dm-rail-bg1',    bg1);
    footer.style.setProperty('--dm-rail-bg2',    bg2);
    footer.style.setProperty('--dm-rail-stroke', stroke);
    footer.style.setProperty('--dm-rail-tint',   tint);
  };

  const go = async (u)=>{
    if (!u) { apply(null); return; }
    const L = await _sampleStripLuma(u);         // 取畫面底部亮度
    const eff = (L==null) ? null : L*(1-dim);    // 扣掉你設定的遮罩強度
    apply(eff);
  };

  if (url) {
    await go(url);
  } else if (id) {
    try {
      const u = await MEDIA_DB.getURL(id);
      await go(u||'');
    } catch {
      apply(null);
    }
  } else {
    apply(null);
  }
}
  
// 使用者調整遮罩/模糊時，立即重算
window.onBgOptChanged = function onBgOptChanged(dim, blur){
  LS.set('chatBgOpt', { dim, blur });
  recalcHud();
};

// === 單一版 recalcHud（合併且不再呼叫不存在的 recalcRailGlass） ===
window.recalcHud = async function recalcHud(){
  const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
  const url = LS.getStr('chatBg','');
  const id  = LS.getStr('chatBgId','');

  const applyInk = (u)=> _decideHudInk(u).then(_applyHudInk);

  if (url) {
    applyInk(url);
  } else if (id) {
    try {
      const u = await MEDIA_DB.getURL(id);
      applyInk(u || '');
    } catch {
      _applyHudInk({ ink: prefersDark ? '#e9edf5' : '#111', needPlate:false });
    }
  } else {
    _applyHudInk({ ink: prefersDark ? '#e9edf5' : '#111', needPlate:false });
  }

  // 只在 DM 詳情頁時，順便重算底部玻璃色調
  if ((PAGE_STACK[PAGE_STACK.length-1] || '') === 'dmDetail') {
    await recalcDmRailGlass();
  }
};

function backToCrop(){ closePreview(); openModal('cropModal'); }
function rotateCrop(){ cropDeg = (cropDeg + 90) % 360; computeBaseScale(); updateCropTransform(); }

function rePickBg(){
  closeCrop();
  try{ if (chooser) chooser.value = ''; }catch(_){}
  cropDeg=0; cropTx=0; cropTy=0;
  if (cropScaleEl) cropScaleEl.value=100;
  updateScaleUI();
  setTimeout(()=> chooser && chooser.click(), 0);
}

/* ===================== 尺寸量測 & 貼底（強化版） ===================== */
function measureFooter(){
  // 依「可見性」優先：postDetail → commentDetail → dmDetail
  const order = ['#pdComposer', '#cdComposer', '#dmFooter'];
  let f = null;

  for (const sel of order) {
    const el = document.querySelector(sel);
    if (el) {
      const rect = el.getBoundingClientRect();
      const visible = rect.width > 0 && rect.height > 0 && getComputedStyle(el).display !== 'none';
      if (visible) { f = el; break; }
    }
  }
  // 後備：都不可見時，還是選到任一存在的元素
  if (!f) f = document.getElementById('pdComposer') || document.getElementById('cdComposer') || document.getElementById('dmFooter');

  const h = Math.ceil((f?.getBoundingClientRect().height || 0));
  document.documentElement.style.setProperty('--footer-h', `${h}px`);
  tuneNoticePad();
}
  
function measureHUD(){
  const el = document.getElementById('dmHUD'); if (!el) return;
  const raw = Math.round(el.getBoundingClientRect().height || 56);
  const h = Math.min(Math.max(raw, 44), 72);
  document.documentElement.style.setProperty('--hud-h', `${h}px`);
}

function stickBottomNow(){
  const t = document.getElementById('dmThread'); if (!t) return;
  document.getElementById('endAnchor')?.scrollIntoView({ block:'end' });
  t.scrollTop = t.scrollHeight + 9999;
}
let autoStick = true;
function scrollToEndDuring(ms=800){
  if (!autoStick) return;
  const end = performance.now() + ms;
  (function loop(){
    if (!autoStick) return;
    stickBottomNow();
    if (performance.now() < end) requestAnimationFrame(loop);
  })();
}
function hardStickBottom(){
  const t = document.getElementById('dmThread'); if (!t) return;
  t.scrollTop = t.scrollHeight + 9999;
  let frames = 36;
  (function pump(){
    t.scrollTop = t.scrollHeight + 9999;
    if (--frames > 0) requestAnimationFrame(pump);
  })();
}

function bindScrollGuard(){
  const t = document.getElementById('dmThread'); if (!t) return;
  const nearBottom = ()=> ((t.scrollHeight - t.clientHeight) - t.scrollTop) < 6;
  autoStick = nearBottom();
  t.addEventListener('scroll', ()=>{
    autoStick = nearBottom();
  }, { passive:true });
}
let _bottomIO = null;

function bindBottomObserver(){
  const t = document.getElementById('dmThread');
  if (!t) return;

  // 確保尾端錨點存在
  let a = document.getElementById('endAnchor');
  if (!a) {
    a = document.createElement('div');
    a.id = 'endAnchor';
    t.appendChild(a);
  }

  // 重新綁前先清掉舊 observer
  if (_bottomIO) {
    try { _bottomIO.disconnect(); } catch(_) {}
    _bottomIO = null;
  }

  // 觀察尾端錨點是否在視口內 → 決定 autoStick
  _bottomIO = new IntersectionObserver(
    (entries)=>{ autoStick = entries.some(e=>e.isIntersecting); },
    { root: t, threshold: 0.98 }
  );
  _bottomIO.observe(a);
}
  
/* ===================== Composer（首頁草稿） ===================== */
function previewComposeMedia(e){
  const box  = document.getElementById('composePreview');
  const hint = document.getElementById('composeFilesHint');
  if (!box) return;
  box.innerHTML = '';
  const files = [...(e.target.files || [])];
  if (!files.length){
    if (hint) hint.textContent = '未選取檔案';
    return;
  }
  if (hint) hint.textContent = `已選 ${files.length} 個檔案`;
  files.forEach(f=>{
    const url = URL.createObjectURL(f);
    const isVideo = f.type.startsWith('video/');
    const el = document.createElement(isVideo ? 'video' : 'img');
    el.src = url;
    if (isVideo) el.controls = true;
    const done = ()=> { try{ URL.revokeObjectURL(url); }catch(_){} };
    el.onload = done; el.onloadeddata = done;
    el.style.width='110px'; el.style.height='110px';
    el.style.objectFit='cover'; el.style.borderRadius='12px';
    el.style.border='1px solid var(--line)';
    box.appendChild(el);
  });
}
function publishDraft(){
  alert('先存草稿＆預覽；發佈規則等我們接首頁串流。');
  showPage('home');
}

/* ===================== 暱稱按鈕 / FAB ===================== */
document.getElementById('btnEditNick')?.addEventListener('click', ()=>{
  const v = prompt('輸入新的暱稱（= 聊天室名稱）', NICKNAME);
  if (!v) return;
  const nv = v.trim(); if (!nv) return;

  NICKNAME = nv;
  LS.setStr('artistNickname', NICKNAME);

  const me = document.getElementById('meNickname'); if (me) me.textContent = NICKNAME;
  const tt = document.getElementById('dmTitle');    if (tt) tt.textContent = NICKNAME.toUpperCase();
  const cw = document.getElementById('composerWho'); if (cw) cw.textContent = NICKNAME;

  renderDmList();
});

document.getElementById('fabNew')?.addEventListener('click', () => {
  if (document.getElementById('composerArtist')) {
    showPage('composerArtist');
  } else {
    alert('（尚未實作）');
  }
});

/* ===================== 首頁卡片點擊委派（防重複綁定） ===================== */
(function bindPostCardDelegation(){
  if (window.__postDelegationBound) return;
  window.__postDelegationBound = true;

  document.addEventListener('click', (e)=>{
    const postEl = e.target.closest('.post');
    if (!postEl) return;

    const postId = postEl.getAttribute('data-post');
    const post = POSTS.find(x=>x.id === postId);
    if (!post) return;

    // 反應（單選）
    const rBtn = e.target.closest('.react');
    if (rBtn) {
      const key = rBtn.getAttribute('data-react');
      if (key) toggleReaction(postId, key);
      return;
    }

    // 翻譯按鈕：不跳詳情
    if (e.target.closest('.translate-btn')) return;

    // 發表評論 → 跳詳情並聚焦輸入框
    if (e.target.classList.contains('addCmt')) {
      openPostDetail(postId, { focusInput:true });
      return;
    }

    // 其餘點擊卡片空白處 → 跳詳情
    openPostDetail(postId);
  });
})();

/* ===================== Post 詳情（藝人端） ===================== */
let CURRENT_POST_ID = null;
let PD_FILTER_OTHERS = false; // 「僅其他藝人的回覆」

function openPostDetail(postId, opts={}){
  CURRENT_POST_ID = postId;
  showPage('postDetail');
  if (opts.focusInput) setTimeout(()=> document.getElementById('cmtInput')?.focus(), 0);
}

function renderPostDetail(postId){
  const p = POSTS.find(x=>x.id === postId); if (!p) return;
  const wrap = document.getElementById('postDetailWrap'); if (!wrap) return;

  // HUD
  const stage = (p.artistStage || STAGE_NAME || '').toString().toUpperCase();
  const displayName = (p.artistId === 'me') ? NICKNAME.toUpperCase() : stage;
  const av = document.getElementById('pdAvatar'); if (av) av.src = p.avatar || ME.avatar;
  const nm = document.getElementById('pdName');  if (nm) nm.innerHTML = escapeHtml(displayName) + ' ' + VB(16);
  const tm = document.getElementById('pdTime');  if (tm) tm.textContent = timeAgo(p.ts);
  const hudBtn = document.getElementById('pdTransHUD'); if (hudBtn) hudBtn.onclick = ()=> togglePostTranslate(p.id);
  const totalC = totalComments(p);

  wrap.innerHTML = `
    <div class="post card soft" data-post="${p.id}">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}" alt="${escapeHtml(displayName)} 的頭像" onerror="imgFallback(this)">
        <div class="meta">
          <b class="stage">${escapeHtml(displayName)} ${VB(18)}</b>
          <small class="ghost">${timeAgo(p.ts)}</small>
        </div>
        <button class="chip translate-btn" onclick="event.stopPropagation(); togglePostTranslate('${p.id}')" title="翻譯">가/A</button>
      </div>

      <div class="body">
        <p id="postText-${p.id}">${escapeHtml(p.text)}</p>
        ${p.img ? `<img class="hero" src="${p.img}" alt="貼文圖片" onerror="imgFallback(this)">` : ``}
      </div>

      <div class="actions">
        ${renderReactionsBar(p.id)}
        <div class="commentBar">
          <div class="left">💬 <span class="cmtCount">${totalComments(p)}</span> 則評論</div>
          <div class="right"></div>
        </div>
      </div>
    </div>

    <!-- 僅其他藝人回覆開關（圖五/圖六） -->
    <div style="display:flex;align-items:center;justify-content:flex-end;padding:6px 12px 2px;gap:8px">
      <span class="ghost" style="font-weight:900">僅其他藝人的回覆</span>
      <label class="switch"><input id="pdOnlyAdp" type="checkbox" ${PD_FILTER_OTHERS?'checked':''}><span class="slider"></span></label>
    </div>

    <div id="cmtList" style="padding:0 6px 120px"></div>
  `;

  renderPostComments(p);
  measureFooter();
}

  /* PATCH — PostDetail 捲動門檻（刪舊貼新） */
function bindPostDetailHUD(){
  const page = document.getElementById('postDetail');
  function threshold(){
    const hero = document.querySelector('#postDetail .hero');
    return hero ? hero.getBoundingClientRect().height * 0.55 : 180; // 約 55% 圖高
  }
  function onScroll(){
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    if (y > threshold()) page.classList.add('scrolled');
    else page.classList.remove('scrolled');
  }
  // 去重綁
  if (window.__pdHUDScroll) window.removeEventListener('scroll', window.__pdHUDScroll, {passive:true});
  window.__pdHUDScroll = onScroll;
  window.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
}

/* 在 renderPostDetail(postId) 的最後附加一行（刪舊貼新） */
bindPostDetailHUD();

/* PATCH — PostDetail 捲動門檻（刪舊貼新） */
function bindPostDetailHUD(){
  const page = document.getElementById('postDetail');
  function threshold(){
    const hero = document.querySelector('#postDetail .hero');
    return hero ? hero.getBoundingClientRect().height * 0.55 : 180; // 約 55% 圖高
  }
  function onScroll(){
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    if (y > threshold()) page.classList.add('scrolled');
    else page.classList.remove('scrolled');
  }
  // 去重綁
  if (window.__pdHUDScroll) window.removeEventListener('scroll', window.__pdHUDScroll, {passive:true});
  window.__pdHUDScroll = onScroll;
  window.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
}

function renderPostComments(p){
  const listEl = document.getElementById('cmtList'); if (!listEl) return;

  // 只看主樓（粉絲）留言
  const roots = (p.cmts || []).filter(c => !c.replyTo && c.from !== 'artist')
                 .sort((a,b)=> (a.ts||0)-(b.ts||0));

  // 「僅其他藝人回覆」= 只渲染其他藝人的回覆（不含我）
  function artistRepliesOf(rootId){
    let replies = (p.cmts||[]).filter(x => x.replyTo === rootId && x.from === 'artist');
    if (PD_FILTER_OTHERS) replies = replies.filter(r => (r.artistId||'') !== 'me');
    return replies.sort((a,b)=> (a.ts||0)-(b.ts||0));
  }

  if (!roots.length){
    listEl.innerHTML = `<div class="ghost" style="text-align:center;margin:14px 0">尚無評論</div>`;
    return;
  }

  listEl.innerHTML = roots.map(root=>{
    const rootName = (root.name || '粉絲').toString().toUpperCase();
    const rootAv   = root.avatar || 'https://picsum.photos/40?u=fan';
    const replies  = artistRepliesOf(root.id);

    const repliesHTML = replies.map(r=>{
      const nm = (r.artistId==='me' ? NICKNAME : (r.artistStage || r.name || 'ARTIST')).toString().toUpperCase();
      const av = (r.artistId==='me' ? ME.avatar : (r.avatar || 'https://picsum.photos/40?u=artist'));
      return `
        <div class="artistReply">
          <img src="${av}" onerror="imgFallback(this)" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
          <div style="flex:1;min-width:0">
            <div class="arName">${escapeHtml(nm)} ${VB(14)}</div>
            <div class="arText">${escapeHtml(r.text||'')}</div>
          </div>
        </div>`;
    }).join('');

    return `
      <!-- 主樓（粉絲）可點進 commentdetail -->
      <div class="card soft commentItem"
           data-post="${p.id}" data-cmt="${root.id}" data-root="${root.id}" data-from="fan"
           style="display:flex;gap:10px;align-items:flex-start;margin:10px 6px">
        <img src="${rootAv}" onerror="imgFallback(this)"
             style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <b style="font-size:13px">${escapeHtml(rootName)}</b>
            <small class="ghost">${timeAgo(root.ts || p.ts)}</small>
          </div>
          <div style="margin-top:4px">${escapeHtml(root.text || '')}</div>
          <div class="ghost" style="margin-top:6px;display:flex;align-items:center;gap:16px">
            <span>♡ ${formatCount(root.likes||0)}</span>
            <span>🗨️ ${replies.length}</span>
          </div>
          ${repliesHTML}
        </div>
      </div>`;
  }).join('');
}

/* — 送出留言（藝人身分）— */
function sendPostComment(){
  const input = document.getElementById('cmtInput'); if (!input) return;
  const t = (input.value || '').trim(); if (!t) return;
  const p = POSTS.find(x=>x.id === CURRENT_POST_ID); if (!p) return;

  p.cmts = p.cmts || [];
  p.cmts.push({
    id:'c'+Date.now(),
    from:'artist', artistId:'me',
    artistStage: STAGE_NAME, avatar: ME.avatar,
    text: t, ts: Date.now()
  });
  LS.set('artistPosts', POSTS);

  input.value = '';
  renderPostDetail(CURRENT_POST_ID);

refreshCommentCountUI(p.id);
}

/* — 綁定貼文詳情輸入列（只綁一次）— */
(function bindOpenCmtOnce(){
  if (window.__openCmtBound) return;
  window.__openCmtBound = true;

  document.addEventListener('click', (e)=>{
    const el = e.target.closest('.commentItem');
    if(!el) return;

    const isFan  = (el.dataset.from === 'fan');
    const isRoot = (el.dataset.root === el.dataset.cmt) || !el.dataset.reply;
    if (!(isFan && isRoot)) return; // 不是粉絲主樓 → 不要跳

    const postId = el.dataset.post;
    const rootId = el.dataset.root || el.dataset.cmt;
    if (postId && rootId) openCommentDetail(postId, rootId);
  }, { passive:true });
})();

  /* 貼文詳情輸入列：跟 commentDetail 一樣的互動 */
(function bindPdComposer(){
  const input = document.getElementById('cmtInput');
  const btn   = document.getElementById('postCmtSend');
  const host  = document.getElementById('pdComposer');

  function sync(){
    const has = (input?.value || '').trim().length > 0;
    if (btn) btn.disabled = !has;
    host?.classList.toggle('hasText', has);
  }

  input?.addEventListener('input', sync);
  input?.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      sendPostComment();
    }
  });
  btn?.addEventListener('click', sendPostComment);
  sync();
})();
  
/* ===== 文字直播：邏輯 ===== */
let LIVE_ON = false;
let LIVE_PAUSED = false;

function livePushArtist(text){
  const box = document.getElementById('liveChat'); if(!box) return;
  box.querySelector('.welcome')?.remove();
  const el = document.createElement('div');
  el.className = 'msg host';
  el.innerHTML = `${escapeHtml(text)}<span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

function livePushFan(name, text){
  const box = document.getElementById('liveChat'); if(!box) return;
  const el = document.createElement('div');
  el.className = 'msg fan';
  el.innerHTML = `<div class="name">${escapeHtml(name)}</div>${escapeHtml(text)}<span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

// （可供「快速操作」或測試呼叫）window.liveFan(name,text)
window.liveFan = livePushFan;

// 開始／暫停／結束
function liveStart(){
  if(LIVE_ON) return;
  LIVE_ON = true; LIVE_PAUSED = false;

  document.getElementById('liveHUD').style.display = 'flex';
  
  // UI 切換
  document.getElementById('liveStart').style.display = 'none';
  document.getElementById('livePause').style.display = '';
  document.getElementById('liveEnd').style.display = '';
  document.getElementById('liveInputBox').disabled = false;
  document.getElementById('liveSend').disabled = false;

  syncNavVisibility();
  livePushArtist('（直播開始）');
}

function liveTogglePause(){
  if(!LIVE_ON) return;
  LIVE_PAUSED = !LIVE_PAUSED;
  const mask = document.getElementById('livePaused'); // 可能不存在
  const btn  = document.getElementById('livePause');
  if(LIVE_PAUSED){
    if(mask) mask.style.display = 'grid';
    btn.textContent = '恢復';
    livePushArtist('（主持人暫時離開）');
  }else{
    if(mask) mask.style.display = 'none';
    btn.textContent = '暫時離開';
    livePushArtist('（主持人回來了）');
  }
}

function liveEnd(){
  if(!LIVE_ON) return;
  if(!confirm('要結束此次直播嗎？')) return;

  LIVE_ON = false; LIVE_PAUSED = false;

  document.getElementById('liveHUD').style.display = 'none';
  document.getElementById('livePaused').style.display = 'none';
  document.getElementById('liveStart').style.display = '';
  document.getElementById('livePause').style.display = 'none';
  document.getElementById('liveEnd').style.display = 'none';
  document.getElementById('liveInputBox').disabled = true;
  document.getElementById('liveSend').disabled = true;

  syncNavVisibility();
  livePushArtist('（直播已結束）');

  const o = document.createElement('div');
  o.className = 'liveEndedScene';
  o.innerHTML = `<div class="text">直播已結束</div>`;
  document.body.appendChild(o);
  setTimeout(()=> o.remove(), 1200);
}

// 送出（藝人 → 右側）
function liveSend(){
  if(!LIVE_ON || LIVE_PAUSED) return;
  const inp = document.getElementById('liveInputBox');
  const t = (inp.value||'').trim(); if(!t) return;
  livePushArtist(t);
  inp.value = '';
}

/* 綁定按鈕（在 DOMContentLoaded 之後就有了） */
document.addEventListener('DOMContentLoaded', ()=>{
  // 讓底部 nav 的「直播」可以開這頁
  const tab = document.getElementById('tabLive');
  if(tab) tab.setAttribute('onclick',"showPage('live')");

  document.getElementById('liveStart')?.addEventListener('click', liveStart);
  document.getElementById('livePause')?.addEventListener('click', liveTogglePause);
  document.getElementById('liveEnd')?.addEventListener('click', liveEnd);
  document.getElementById('liveSend')?.addEventListener('click', liveSend);
  document.getElementById('liveInputBox')?.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); liveSend(); }
  });
  // 進頁面時算一次
  syncNavVisibility();
});

// 愛心數＆動畫
(function(){
  let liveHearts = 0;
  const heartBtn = document.getElementById('liveHeartBtn');
  const heartCnt = document.getElementById('liveHeartCount');

  function spawnHeart(el){
    const r = el.getBoundingClientRect();
    const n = 2 + Math.floor(Math.random()*2); // 2~3 顆
    for(let i=0;i<n;i++){
      const h = document.createElement('div');
      h.className = 'flying-heart';
      h.textContent = '💗';
      document.body.appendChild(h);
      const x = r.left + r.width/2 + (Math.random()*30-15);
      const y = r.top  + (Math.random()*10-5);
      h.style.left = x+'px'; h.style.top = y+'px';
      h.animate(
        [
          { transform:'translate(0,0) scale(1)', opacity:1 },
          { transform:`translate(${(Math.random()*40-20)}px,-120px) scale(1.6)`, opacity:0 }
        ],
        { duration: 900 + Math.random()*300, easing:'ease-out' }
      ).onfinish = ()=> h.remove();
    }
  }

  if(heartBtn){
    heartBtn.addEventListener('click', ()=>{
      liveHearts++;
      if(heartCnt) heartCnt.textContent = liveHearts;
      spawnHeart(heartBtn);
    });
  }

  // UI 跟著開播/暫離/結束變化（不覆蓋你的業務邏輯）
  const hud      = document.getElementById('liveHUD');
  const inp      = document.getElementById('liveInputBox');
  const sendBtn  = document.getElementById('liveSend');
  const btnStart = document.getElementById('liveStart');
  const btnPause = document.getElementById('livePause');
  const btnEnd   = document.getElementById('liveEnd');

  btnStart?.addEventListener('click', ()=>{
    hud.style.display = 'flex';
    inp.disabled = false; sendBtn.disabled = false;
    btnStart.style.display = 'none';
    btnPause.style.display = ''; btnEnd.style.display = '';
  });

  btnPause?.addEventListener('click', ()=>{
    // 只做視覺提示；實際狀態由你原本 JS 處理
    btnPause.textContent = (btnPause.textContent.includes('暫時離開')) ? '恢復' : '暫時離開';
  });
})();
  

/* ===================== 啟動 ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  const el1 = document.getElementById('meNickname');
  if (el1) el1.textContent = NICKNAME;
  document.getElementById('dmTitle').textContent = NICKNAME.toUpperCase();
  const el2 = document.getElementById('composerWho');
  if (el2) el2.textContent = NICKNAME;
  document.getElementById('meId') && (document.getElementById('meId').textContent='ARTIST-00001');
  document.getElementById('meAvatar') && (document.getElementById('meAvatar').src=AVATAR);
  const pdMe = document.getElementById('pdMeAvatar');
  if (pdMe) pdMe.src = ME.avatar;
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'pdOnlyAdp'){
    PD_FILTER_OTHERS = e.target.checked;
    if (CURRENT_POST_ID) renderPostDetail(CURRENT_POST_ID);
  }
});
  
  // 只有點「粉絲」留言才進評論詳情
  (function bindOpenCmtOnce(){
  if (window.__openCmtBound) return;
  window.__openCmtBound = true;

  document.addEventListener('click', (e)=>{
    const el = e.target.closest('.commentItem');
    if(!el) return;

    const postId = el.dataset.post;
    const rootId = el.dataset.root || el.dataset.cmt; // 保底取 root

    if (postId && rootId) openCommentDetail(postId, rootId);
  }, { passive:true });
})();

  renderStoryBar();
  renderFeed(currentFilter);
  syncNavVisibility();

  measureHUD(); measureFooter(); updateComposerUI();
  renderThread();
  recalcHud();
  updateNoticeBanner();

  scrollToEndDuring(800);
  setTimeout(hardStickBottom,0);
  renderHomeWeverse();
});

/* 監看 footer 高度變化（鍵盤/回覆 chip） */
(()=>{ const footer=document.getElementById('dmFooter'); if(!footer) return;
  if('ResizeObserver' in window){ new ResizeObserver(()=>{ measureFooter(); scrollToEndDuring(600); }).observe(footer); }
})();

/* iOS Safari：視窗/鍵盤變化（visualViewport） */
;(function () {
  const vv = window.visualViewport;

  function applyVV() {
    if (!vv) return;
    const offset = Math.max(0, window.innerHeight - vv.height);
    document.documentElement.style.setProperty('--kb-offset', offset + 'px');
    measureFooter();
    scrollToEndDuring(600);
  }

  if (vv) {
    vv.addEventListener('resize', applyVV);
    vv.addEventListener('scroll', applyVV);
    applyVV();
  }

  window.addEventListener('resize', () => {
    measureHUD();
    measureFooter();
    scrollToEndDuring(600);
  });

  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      measureHUD();
      measureFooter();
      scrollToEndDuring(800);
    }, 120);
  });

  window.addEventListener('pageshow', () => {
    measureFooter();
    scrollToEndDuring(800);
  });

  // 前/後景切換：在這裡停掉 DM 內所有媒體
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      haltDmMedia();
    } else {
      scrollToEndDuring(600);
    }
  });

  // 字體載入完成後再貼一次底，避免字體跳動影響卷軸
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => scrollToEndDuring(800));
  }
})();

/* ====== 全螢幕媒體檢視器 ====== */
let CURRENT_INLINE_MEDIA = null;

function openViewer(url, kind, srcEl){
  stopActive(); // 先把任何語音播放關掉
  if (srcEl && srcEl.tagName === 'VIDEO') { try{ srcEl.pause(); }catch(_){} }
  CURRENT_INLINE_MEDIA = srcEl || null;

  const v = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');

  img.style.display='none'; vid.style.display='none';
  if(kind==='img'){ img.src=url; img.style.display='block'; }
  else{ vid.src=url; vid.style.display='block'; }

  v.style.display='block';
}

function closeViewer(){
  const v = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');
  v.style.display='none';
  img.src=''; vid.src='';
}

/* 只點「背景」才關；點內容不關 */
(function initViewerGuard(){
  const v = document.getElementById('viewer');
  const stage = v.querySelector('.stage');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');
  const btn = document.getElementById('viewerClose');

  // 點背景關閉
  v.addEventListener('click', e=>{
    if(e.target === v) closeViewer();
  });

  // 阻擋事件往外冒泡（點內容不關閉）
  [stage,img,vid].forEach(el=>{
    el.addEventListener('click', e=> e.stopPropagation());
  });

  // 關閉鈕
  btn?.addEventListener('click', e=>{ e.stopPropagation(); closeViewer(); });

  // Esc 關閉（鍵盤）
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && v.style.display==='block') closeViewer(); });
})();
</script>
</body>
</html>
