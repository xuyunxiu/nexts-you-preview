<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NEXT’S YOU — artist（整合版）</title>

<style>
:root{
  --bg:#f5f7ff; --card:#fff; --text:#1a1a1a; --sub:#667085; --line:#e7eaf3; --ghost:#9aa0b4;
  --accent:#6a5acd; --accent2:#836fff; --ok:#10b981; --danger:#ff4d4f;
  --radius:16px; --shadow:0 12px 34px rgba(18,24,40,.08);
  --safe:env(safe-area-inset-bottom,0px);
  --kb-offset:0px;
  --footer-h:72px;
  --hud-h:68px;
  --reply-size:30px;
  --reply-gap:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
img{display:block;max-width:100%}
a{text-decoration:none;color:inherit} button{font:inherit;cursor:pointer}

.ghost{color:var(--ghost)} .sub{color:var(--sub)} .soft{padding:16px} .row{display:flex;align-items:center;gap:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f3f5ff;border:1px solid var(--line);font-size:12px}

/* pages */
section.page{display:none;padding:12px 12px calc(76px + var(--safe));min-height:100svh}
section.page.active{display:block;animation:fade .22s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* bottom nav */
nav#nav{
  position:fixed;left:0;right:0;bottom:0;z-index:40;background:var(--card);border-top:1px solid var(--line);
  display:flex;justify-content:space-around;gap:6px;padding:10px 8px calc(12px + var(--safe));
  backdrop-filter:saturate(140%) blur(10px);transition:transform .25s ease;
}
nav#nav.hidden{transform:translateY(120%)}
nav#nav button{flex:1;border:none;background:transparent;padding:8px 0 6px;border-radius:12px;color:var(--sub);font-weight:800;font-size:13px}
nav#nav button.active{color:var(--accent);background:#f5f3ff;border:1px solid var(--line)}

/* header (home) */
#homeHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 6px 10px}
#homeHeader .me{display:flex;align-items:center;gap:10px}
#homeHeader .me img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
#homeHeader .me .id{font-size:12px;color:var(--ghost)}

/* Verified 勳章 */
.verified-badge{display:inline-block;width:18px;height:18px;margin-left:6px;vertical-align:middle}
.verified-badge svg{width:100%;height:100%;display:block}
.verified-badge .gear{stroke:#fff;stroke-width:.9;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
.verified-badge .tick{fill:#fff;filter:drop-shadow(0 1px 0 rgba(0,0,0,.18))}

/* story bar */
#storyWrap{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(245,247,255,.96),rgba(245,247,255,.90));backdrop-filter:blur(6px)}
#storyBar{display:flex;gap:12px;overflow-x:auto;padding:10px 8px 12px;border-bottom:1px solid var(--line);scrollbar-width:none}
#storyBar::-webkit-scrollbar{display:none}
.story-item{flex:0 0 auto;width:64px;text-align:center;cursor:pointer;position:relative}
.story-item img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #d5d8f3}
.story-item .name{font-size:12px;margin-top:4px;color:#9aa1ad}
.story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18)}
.story-item.active .name{color:var(--accent);font-weight:700}
.story-item .dot{position:absolute;right:6px;top:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;box-shadow:0 0 0 2px #fff}
.story-item.pinned img{border-color:#111}

/* post card */
.post{margin:12px 6px}
.post .hdr{display:flex;align-items:center;gap:10px}
.post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.post .meta b{font-weight:900;display:flex;align-items:center;gap:6px}
.post .meta small{display:block;color:var(--ghost)}
.post .body{margin-top:8px}
.post .hero{width:100%;height:360px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

/* DM 列表 */
#dm .dmCard{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card);margin:10px 0;cursor:pointer}
#dm .dmCard img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.nameBlock{display:flex;flex-direction:column;gap:6px}
.nameRow{display:flex;align-items:center;gap:8px}
.nameRow .stage{font-weight:900;letter-spacing:.3px}

/* —— 方框 ARTIST 勳章 —— */
.artistTag{
  display:inline-flex;align-items:center;justify-content:center;
  padding:3px 8px;border-radius:6px;font-size:10px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;
  color:#2e2a6f;background:linear-gradient(90deg,#bca7ff 0%,#8fb4ff 64%,#ffffff 100%);
  border:1px solid #ded6ff;box-shadow:0 1px 6px rgba(106,90,205,.18);
}

/* ===== DM Detail ===== */
#dmDetail{
  position:relative;background:#000;background-position:center;background-repeat:no-repeat;background-size:cover;background-attachment:scroll;
}
#dmDetail::after{content:"";position:fixed;inset:0;pointer-events:none;background:rgba(0,0,0,var(--bgDim,.0));backdrop-filter:blur(var(--bgBlur,0px));z-index:-1}

/* header */
.chatHUD{display:flex;align-items:center;justify-content:space-between;padding:4px 0 8px}
.chatHUD .center{flex:1;min-width:0}
.titleCol{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
.artistName{font-weight:900;letter-spacing:.6px;font-size:18px}
.hudBtn{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:var(--card)}
.back{width:44px;height:44px;border:none;background:transparent;border-radius:0;padding:0;display:grid;place-items:center}
.back svg{width:22px;height:22px;stroke:#5b6ab0;stroke-width:2.6;fill:none}

/* thread */
.thread{position:absolute;left:0;right:0;top:var(--hud-h);bottom:0;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;padding:8px 2px;scrollbar-gutter:stable both-edges}
.thread .msg + .msg{margin-top:12px}
#threadPad{height:calc(var(--footer-h) + var(--kb-offset) + env(safe-area-inset-bottom,0px) + 2px);flex:0 0 auto;pointer-events:none}
#endAnchor{height:1px;flex:0 0 auto}

.msg{display:flex;align-items:flex-end;gap:8px;max-width:88%;margin:0 6px}
.msg.left{flex-direction:row;align-self:flex-start}
.msg.right{flex-direction:row-reverse;align-self:flex-end}
.time{font-size:11px;color:rgba(255,255,255,.88);text-shadow:0 1px 2px rgba(0,0,0,.35)}
.time.dark{color:#8b93a7}
.bubble{max-width:100%;padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.92);position:relative}
.msg.right .bubble{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
.fromLabel{font-size:11px;font-weight:900;color:#6b78a8;margin-bottom:4px}
.fanText{color:#111}

/* 回覆卡 */
.replyCard{align-self:flex-end;max-width:74%;margin:14px 6px 0;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.86);
  border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 18px rgba(0,0,0,.12);backdrop-filter:saturate(140%) blur(1.5px);word-break:break-word}
.replyCard .fromLabel{font-size:11px;font-weight:900;letter-spacing:.3px;color:#6d78aa;margin-bottom:4px}
.thread .msg + .replyCard,.thread .replyCard + .msg{margin-top:12px}

/* 回覆箭頭 */
.replyBtn{position:absolute;top:50%;right:calc(-1*(var(--reply-size) + var(--reply-gap)));transform:translateY(-50%);width:var(--reply-size);height:var(--reply-size);
  border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.92);box-shadow:0 6px 14px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;z-index:2}
.replyBtn svg{width:calc(var(--reply-size)*0.53);height:calc(var(--reply-size)*0.53);opacity:.85}

/* Composer */
.dmFooter{position:fixed;left:0;right:0;bottom:0;z-index:50;background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.96));
  backdrop-filter:blur(10px);border-top:1px solid var(--line);padding:10px 0 calc(10px + env(safe-area-inset-bottom))}
.dmInputBar{display:flex;align-items:center;gap:10px;padding:0 12px}
.dmInputBar .box{flex:1;min-width:0;display:flex;align-items:center;background:#fff;border:1px solid var(--line);border-radius:22px;height:42px;padding:0 14px}
.dmInputBar input{flex:1;border:none;outline:none;background:transparent;font-size:17px}

/* 左右 icon：置中 + 像素微調 */
.iconBtn{width:42px;height:42px;border-radius:14px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;flex:0 0 auto;font-size:22px;line-height:1}
.iconBtn span{display:block;line-height:1}
.camEmoji{transform:translate(-1px, .5px)}
.micEmoji{transform:translate(-.5px, .5px)}

/* 發送鍵：置中 + 上移 0.5px */
.dmSend{width:42px;height:42px;border:none;border-radius:14px;background:#e9ecf4;color:#b2b7c8;display:grid;place-items:center}
.dmSend svg{width:20px;height:20px;display:block;transform:translateY(-.5px)}
.hasText .dmSend{background:#111;color:#fff}

/* 媒體（圖片/影片） */
.msgImg{max-width:min(68vw,300px);border-radius:12px;border:1px solid rgba(0,0,0,.08)}
.msgVideo{width:min(68vw,300px);height:auto;border-radius:12px;border:1px solid rgba(0,0,0,.08)}

/* ===== 語音泡泡（LINE 風） ===== */
.bubble.voice{padding:12px 14px;border-radius:18px}
.voiceUI{display:flex;align-items:center;gap:12px;min-width:210px}
.voicePlay{
  flex:0 0 auto;width:32px;height:32px;border-radius:50%;
  display:grid;place-items:center;background:rgba(255,255,255,.24);
  border:1px solid rgba(255,255,255,.32);color:#2b356f;
}
.msg.left .voicePlay{background:#f1f3ff;border-color:#e5e8f5;color:#2b356f}
.msg.right .voicePlay{background:rgba(255,255,255,.20);border-color:rgba(255,255,255,.34);color:#fff}
.voicePlay svg{width:16px;height:16px;display:block;fill:currentColor}
.voiceBars{position:relative;flex:1;height:18px;display:flex;align-items:flex-end;gap:4px}
.voiceBar{width:4px;height:8px;border-radius:3px;background:rgba(42,57,124,.25);transition:height .18s ease, background .18s ease;}
.msg.right .voiceBar{background:rgba(255,255,255,.55)}
.voiceUI.playing .voiceBar{animation:vbob .9s ease-in-out infinite}
.voiceUI.playing .voiceBar:nth-child(odd){animation-delay:.12s}
@keyframes vbob{0%,100%{height:6px}40%{height:18px}70%{height:10px}}
.voiceDur{font-variant-numeric:tabular-nums;min-width:44px;text-align:right;font-weight:800;opacity:.85}
.msg.right .voiceDur{color:#fff}

/* Reply Chip */
.replyChip{position:relative;display:flex;align-items:center;gap:8px;margin:0 14px 8px;padding:8px 36px 8px 12px;border-radius:13px;border:1px solid rgba(255,255,255,.28);
  background:rgba(255,255,255,.12);backdrop-filter:saturate(140%) blur(1.5px)}
.replyChipLabel{font-size:12px;font-weight:900;letter-spacing:.35px;color:#7a86b7;margin-right:2px;user-select:none}
.replyChipText{flex:1;min-width:0;font-size:15px;line-height:1.25;font-weight:600;color:#2f3564;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.replyChipClose{position:absolute;top:6px;right:6px;width:28px;height:28px;display:grid;place-items:center;border:none;background:transparent;color:#6f78aa;border-radius:6px;cursor:pointer}
.replyChipClose:hover{background:rgba(255,255,255,.10)}
.replyChipClose svg{width:18px;height:18px;display:block}

/* Modal（背景裁切/預覽/語音修剪） */
.modal{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
.modal .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(760px,94vw);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 12px 34px rgba(18,24,40,.16)}
#cropStage{height:58vh;border:1px dashed var(--line);border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#f8f9ff}
#cropStage img{max-width:none;user-select:none;transform-origin:center center}
.cropCtrls{display:flex;align-items:center;gap:10px;margin:12px 0}
.cropCtrls .spacer{flex:1}

/* 修剪視窗 */
.trimBox{display:flex;flex-direction:column;gap:10px}
.trimRow{display:flex;align-items:center;gap:10px}
.range{flex:1}
.tip{color:#667085;font-size:14px}
.btnRow{display:flex;gap:10px;justify-content:flex-end}
.btnPrimary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border:none}
.btn{padding:6px 14px;border-radius:999px;border:1px solid var(--line);background:#fff}

/* 小工具 */
.badge{background:#ff3b30;color:#fff;font-size:12px;padding:2px 7px;border-radius:999px;min-width:22px;text-align:center}
</style>
</head>
<body>

<!-- ====================== HOME（藝人） ====================== -->
<section id="home" class="page active">
  <div id="homeHeader">
    <div class="me">
      <img id="meAvatar" src="https://picsum.photos/80?u=artist" onerror="imgFallback(this)">
      <div>
        <div id="meNickname" style="font-weight:900">Annie</div>
        <div class="id" id="meId">ARTIST-00001</div>
      </div>
    </div>
    <button class="chip" id="btnEditNick">✏️ 更改我的暱稱</button>
  </div>

  <div id="storyWrap"><div id="storyBar"></div></div>
  <div id="feedWrap"></div>

  <button class="fab" id="fabNew" style="
    position:fixed;right:16px;bottom:calc(86px + var(--safe));z-index:35;width:56px;height:56px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);
    background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:900;font-size:22px;box-shadow:0 12px 28px rgba(106,90,205,.28);">＋</button>
</section>

<!-- ====================== DM LIST ====================== -->
<section id="dm" class="page">
  <div class="row" style="justify-content:space-between;margin:2px 0 10px">
    <b style="font-weight:900">訊息</b>
  </div>
  <div id="dmList"></div>
</section>

<!-- ====================== DM DETAIL ====================== -->
<section id="dmDetail" class="page">
  <div class="chatHUD" id="dmHUD">
    <button class="back" onclick="goBack()" aria-label="Back"><svg viewBox="0 0 24 24"><path d="M15 19 8 12l7-7"/></svg></button>
    <div class="center"><div class="titleCol"><span class="artistTag">ARTIST</span><b id="dmTitle" class="artistName">ANNIE</b></div></div>
    <button class="hudBtn" title="更多" onclick="toggleDmMenu()">⋯</button>
  </div>

  <div id="dmThread" class="thread"></div>

  <!-- Footer -->
  <div class="dmFooter" id="dmFooter">
    <div id="replyChip" class="replyChip" style="display:none">
      <span class="replyChipLabel">回覆：</span>
      <span id="replyChipText" class="replyChipText">—</span>
      <button class="replyChipClose" onclick="clearReply()"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg></button>
    </div>

    <!-- 輸入列：📸 & 🎙️ 叫原生選單 -->
    <div class="dmInputBar">
      <button class="iconBtn" id="btnCamera" aria-label="相機/相簿"><span class="camEmoji">📸</span></button>
      <div class="box"><input id="dmMessageInput" placeholder="輸入訊息…" /></div>
      <button class="iconBtn" id="btnMic" aria-label="語音"><span class="micEmoji">🎙️</span></button>
      <button class="dmSend" id="dmSendBtn" aria-label="Send" disabled>
        <svg viewBox="0 0 24 24"><path d="M3.4 12.6l16.7-7.2c.6-.3 1.2.3.9.9l-7.2 16.7c-.3.7-1.3.6-1.5-.1l-2.1-6.1-6.1-2.1c-.7-.2-.8-1.2-.1-1.5z" fill="currentColor"/></svg>
      </button>

      <!-- 隱藏挑選器 -->
      <input id="pickMedia" type="file" accept="image/*,video/*" multiple style="display:none">
      <input id="pickVoice" type="file" accept="audio/*,video/*" style="display:none">
    </div>
  </div>

  <!-- 右上 … 選單 -->
  <div id="dmMenu" class="card soft" style="display:none">
    <div class="row" style="flex-direction:column;gap:6px">
      <button class="chip" onclick="renameChat(); hideDmMenu()">更改聊天室名稱</button>
      <button class="chip" onclick="startPickBg(); hideDmMenu()">更改背景</button>
    </div>
  </div>
</section>

<!-- ====================== 背景：挑圖 / 裁切 / 預覽 ====================== -->
<input id="bgChooser" type="file" accept="image/*" style="display:none">
<div id="cropModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">裁切背景</b>
    <div id="cropStage"><img id="cropImg" alt=""></div>
    <div class="cropCtrls">
      <button class="chip" onclick="rotateCrop()">↻ 旋轉 90°</button>
      <label class="chip">縮放 <input id="cropScale" type="range" min="80" max="220" value="140" style="vertical-align:middle"></label>
      <div class="spacer"></div>
      <button class="chip" onclick="closeCrop()">取消</button>
      <button class="chip btnPrimary" onclick="applyCrop()">下一步</button>
    </div>
  </div>
</div>
<div id="previewModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">預覽背景</b>
    <div style="height:48vh;border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#000">
      <div id="bgPreviewMini" style="height:100%;background-position:center;background-size:cover;background-repeat:no-repeat"></div>
    </div>
    <div class="cropCtrls" style="justify-content:flex-end">
      <button class="chip" onclick="closePreview()">返回</button>
      <button class="chip btnPrimary" onclick="confirmPreview()">確認</button>
    </div>
  </div>
</div>

<!-- ====================== 語音修剪（可試聽） ====================== -->
<div id="trimModal" class="modal">
  <div class="panel">
    <b style="font-weight:900">修剪語音（可試聽）</b>
    <div class="trimBox">
      <video id="trimMedia" playsinline style="display:none"></video>

      <div class="trimRow">
        <button class="btn" id="trimPlay">▶️ 播放</button>
        <div class="vBar" style="flex:1"><div id="trimFill" class="vFill" style="background:#6a5acd;height:6px;border-radius:999px;width:0%"></div></div>
        <div id="trimClock" class="vTime">0:00</div>
      </div>

      <div class="trimRow">
        <span class="ghost" style="width:36px">起點</span>
        <input id="trimStart" class="range" type="range" min="0" max="1000" value="0">
        <span id="trimStartLabel" class="ghost">0.0s</span>
      </div>
      <div class="trimRow">
        <span class="ghost" style="width:36px">終點</span>
        <input id="trimEnd" class="range" type="range" min="0" max="1000" value="1000">
        <span id="trimEndLabel" class="ghost">0.0s</span>
      </div>

      <div class="tip">提示：播放時會自動從「起點」開始，跑到「終點」就停止。</div>
      <div class="btnRow">
        <button class="btn" onclick="closeTrim()">取消</button>
        <button class="btn btnPrimary" id="trimUse">使用這段</button>
      </div>
    </div>
  </div>
</div>

<!-- ====================== Composer（＋） ====================== -->
<section id="composerArtist" class="page">
  <div class="row" style="gap:10px;margin-bottom:10px">
    <button class="back" onclick="goBack()" aria-label="Back"><svg viewBox="0 0 24 24"><path d="M15 19 8 12l7-7"/></svg></button>
    <b style="font-weight:900">NEXT ONE</b>
    <div class="sub" id="composerWho" style="margin-left:auto;font-weight:800;letter-spacing:.3px">—</div>
  </div>

  <div class="soft card" id="composeBox">
    <textarea id="composeText" rows="4" placeholder="在想些什麼？（輸入 @@@ 可自動帶入粉絲名稱示範）"></textarea>
    <div id="composePreview" class="row" style="flex-wrap:wrap;gap:8px;margin-top:10px"></div>
  </div>

  <div class="row" style="gap:10px;margin-top:12px">
    <label class="chip">選擇檔案
      <input id="composeMedia" type="file" multiple accept="image/*,video/*" onchange="previewComposeMedia(event)" style="display:none">
    </label>
    <span id="composeFilesHint" class="ghost">未選取檔案</span>
    <button class="chip btnPrimary" onclick="publishDraft()">發佈（暫存流程）</button>
  </div>
</section>

<!-- ====================== Bottom Nav ====================== -->
<nav id="nav">
  <button id="tabHome" class="active" onclick="showPage('home')">首頁</button>
  <button id="tabDM" onclick="showPage('dm')">DM</button>
  <button id="tabLive" onclick="showPage('live')">直播</button>
  <button id="tabStore" onclick="showPage('store')">商店</button>
</nav>

<script>
/* ---------- 小工具 ---------- */
function imgFallback(img){
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
  img.src = 'data:image/svg+xml;charset=UTF-8,' + svg; img.onerror = null;
}
const LS = {
  get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
  getStr(k,def=''){ const v=localStorage.getItem(k); return v ?? def },
  setStr(k,v){ localStorage.setItem(k,v) }
};
const fmtTime = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const s2clock = s => { s = Math.max(0, s||0); const m = Math.floor(s/60), r = Math.floor(s%60); return `${m}:${r.toString().padStart(2,'0')}`; };
/* 顯示 mm:ss（純長度用） */
const mmss = sec => { sec = Math.max(0, Math.floor(sec || 0)); const m = Math.floor(sec/60), s = sec % 60; return `${m}:${s.toString().padStart(2,'0')}`; };
/* 轉義（避免 XSS / 也避免程式炸掉） */
const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]));
/* 僅允許同時播放一條 */
let ACTIVE_AUDIO = null;
function stopActive(){ if (ACTIVE_AUDIO){ ACTIVE_AUDIO.pause(); ACTIVE_AUDIO._owner?.classList.remove('playing'); ACTIVE_AUDIO = null; } }

/* 舞台名/暱稱/頭像 */
const STAGE_NAME = LS.getStr('artistStage','ANNIE');
let   NICKNAME   = LS.getStr('artistNickname','Annie');
let   AVATAR     = LS.getStr('artistAvatar','https://picsum.photos/80?u=artist');
const ME = { id:'me', name:STAGE_NAME, avatar:AVATAR };

/* 假資料 */
const ARTISTS = [
  {id:'me',name:STAGE_NAME,avatar:AVATAR},
  {id:'all',name:'ALL',avatar:'https://picsum.photos/80?u=all'},
  {id:'dohee',name:'DOHEE',avatar:'https://picsum.photos/80?u=dh'},
  {id:'woo',name:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc'}
];
const POSTS = LS.get('artistPosts',[
  {id:'p3',artistId:'dohee',artistStage:'DOHEE',avatar:'https://picsum.photos/80?u=dh',text:'練舞練到爆汗 💃',img:'https://picsum.photos/1200?u=dh1',ts:Date.now()-1000*60*40},
  {id:'p2',artistId:'woo',artistStage:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc',text:'今天吃拉麵 🍜',img:'https://picsum.photos/1200?u=wc1',ts:Date.now()-1000*60*50},
  {id:'p1',artistId:'me',artistStage:STAGE_NAME,avatar:ME.avatar,text:'大家好，我是 Annie ✨',img:'',ts:Date.now()-1000*60*60}
]);
const FANS=[{id:'f1',name:'Michelle',avatar:'https://picsum.photos/40?u=f1'},{id:'f2',name:'粉絲 B',avatar:'https://picsum.photos/40?u=f2'}];

/* 訊息 */
let GROUP_MSGS=LS.get('groupMsgs',[
  {id:'m1',from:'fan',fanId:'f1',text:'偶像好～',ts:Date.now()-1000*60*45},
  {id:'m2',from:'fan',fanId:'f2',text:'今天吃什麼？',ts:Date.now()-1000*60*43},
  {id:'m3',from:'artist',text:'我午餐吃了沙拉 🥗',ts:Date.now()-1000*60*40,replyTo:{text:'今天吃什麼？'}}
]);
const lastSeen = LS.get('lastSeen', {});

/* ---------- 導航 ---------- */
const HIDE_NAV_IN=['dmDetail','composerArtist'];
let PAGE_STACK=['home'];
function showPage(id){
  document.querySelectorAll('section.page').forEach(s=>s.classList.remove('active'));
  const page=document.getElementById(id); if(page) page.classList.add('active');
  if(PAGE_STACK[PAGE_STACK.length-1]!==id) PAGE_STACK.push(id);

  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
  ({home:'tabHome',dm:'tabDM',live:'tabLive',store:'tabStore'}[id]||null) &&
    document.getElementById({home:'tabHome',dm:'tabDM',live:'tabLive',store:'tabStore'}[id]).classList.add('active');

  const nav=document.getElementById('nav');
  if(HIDE_NAV_IN.includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');

  if(id==='home'){ renderStoryBar(); renderFeed(currentFilter); }
  if(id==='dm'){ renderDmList(); }
  if(id==='dmDetail'){
    measureHUD(); measureFooter(); renderThread(); applyChatBg();
    autoStick=true; scrollToEndDuring(1000);
    bindBottomObserver(); bindScrollGuard();
    setTimeout(hardStickBottom, 0);
  }
  if(id==='composerArtist'){ document.getElementById('composerWho').textContent=NICKNAME; }
}
function goBack(){ PAGE_STACK.pop(); const prev=PAGE_STACK[PAGE_STACK.length-1]||'home'; showPage(prev); }

/* ---------- HOME：Story bar ---------- */
let currentFilter='me';
function hasNewDots(artistId){
  if(artistId==='me'||artistId==='all') return false;
  const seen=lastSeen[artistId]||0;
  const latest=Math.max(0,...POSTS.filter(p=>p.artistId===artistId).map(p=>p.ts));
  return latest>seen;
}
function renderStoryBar(){
  const bar=document.getElementById('storyBar');
  const others=ARTISTS.filter(a=>a.id!=='me'&&a.id!=='all');
  others.sort((a,b)=>{
    const la=Math.max(0,...POSTS.filter(p=>p.artistId===a.id).map(p=>p.ts));
    const lb=Math.max(0,...POSTS.filter(p=>p.artistId===b.id).map(p=>p.ts));
    return lb-la;
  });
  const order=[ARTISTS.find(a=>a.id==='me'),ARTISTS.find(a=>a.id==='all'),...others];
  bar.innerHTML=order.map(a=>{
    const active=(currentFilter===a.id)?'active':'';
    const pinned=(a.id==='me'||a.id==='all')?'pinned':'';
    const dot=hasNewDots(a.id)?'<span class="dot"></span>':'';
    return `<div class="story-item ${active} ${pinned}" data-id="${a.id}">
      <img src="${a.avatar}" onerror="imgFallback(this)">${dot}
      <div class="name">${a.name}</div></div>`;
  }).join('');
  bar.querySelectorAll('.story-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id=el.dataset.id; currentFilter=id;
      if(id!=='all') lastSeen[id]=Date.now(); LS.set('lastSeen', lastSeen);
      renderStoryBar(); renderFeed(currentFilter); window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

/* ---------- HOME：Feed ---------- */
function feedOf(filter){
  if(filter==='all') return POSTS.slice().sort((a,b)=>b.ts-a.ts);
  if(filter==='me')  return POSTS.filter(p=>p.artistId==='me').sort((a,b)=>b.ts-a.ts);
  return POSTS.filter(p=>p.artistId===filter).sort((a,b)=>b.ts-a.ts); /* 修：a_ts -> a.ts */
}
function VB(size=18){
  const gid='vbGrad-'+Math.random().toString(36).slice(2,8);
  return `<span class="verified-badge" style="width:${size}px;height:${size}px">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs><linearGradient id="${gid}" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#6fb3ff"/><stop offset="58%" stop-color="#7b6dff"/><stop offset="92%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e9ecff"/>
      </linearGradient></defs>
      <path class="gear" fill="url(#${gid})" d="M12 2.3 14 4l2.9-.6.9 2.7 2.7.9-.6 2.9L22 12l-2.1 2.1.6 2.9-2.7.9-.9 2.7-2.9-.6L12 21.7 10 20l-2.9.6-.9-2.7-2.7-.9.6-2.9L2 12l2.1-2.1-.6-2.9 2.7-.9.9-2.7L10 4l2-1.7z"/>
      <path class="tick" d="M10.4 12.8 8.7 11.2l1.1-1.1 1.2 1.2 3-3 1.1 1.1-3.8 3.8a1 1 0 0 1-1.4 0z"/></svg>
  </span>`;
}
function renderFeed(filter='me'){
  const wrap=document.getElementById('feedWrap');
  const list=feedOf(filter);
  if(!list.length){ wrap.innerHTML=`<div class="ghost" style="text-align:center;margin-top:20vh">尚無貼文</div>`; return; }
  wrap.innerHTML=list.map(p=>{
    const stage=(p.artistStage||STAGE_NAME||'').toString().toUpperCase();
    return `<div class="card soft post">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}" onerror="imgFallback(this)">
        <div class="meta">
          <b class="stage">${escapeHtml(stage)} ${VB(18)}</b>
          <small class="ghost">${new Date(p.ts).toLocaleString()}</small>
        </div>
      </div>
      <div class="body"><p>${escapeHtml(p.text)}</p>
      ${p.img?`<img class="hero" src="${p.img}" onerror="imgFallback(this)">`:``}</div>
    </div>`;
  }).join('');
}

/* ---------- DM List ---------- */
function getRoomTitle(){ return NICKNAME; }
function lastPreview(m){
  if(!m) return '（無訊息）';
  if(m.type==='image') return '[照片]';
  if(m.type==='video') return '[影片]';
  if(m.type==='audio' || m.type==='voice') return '[語音]';
  return m.text || '（無訊息）';
}
function renderDmList(){
  const box=document.getElementById('dmList');
  const last=GROUP_MSGS[GROUP_MSGS.length-1];
  box.innerHTML=`<div class="dmCard" onclick="showPage('dmDetail')">
    <img src="${ME.avatar}" onerror="imgFallback(this)">
    <div class="nameBlock">
      <div class="nameRow"><span class="artistTag">ARTIST</span><div class="stage">${escapeHtml(getRoomTitle().toUpperCase())}</div></div>
      <small class="ghost" style="display:block;max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(lastPreview(last))}</small>
    </div><span></span></div>`;
}

/* ---------- 語音泡泡建立（整段覆蓋版） ---------- */
function buildVoiceUI(msg){
  const segStart = Number(msg.segStart || msg.start || 0);
  const segEnd   = Number(msg.segEnd   || msg.end   || 0);

  const ui  = document.createElement('div'); ui.className='voiceUI';
  const btn = document.createElement('button'); btn.className='voicePlay';
  btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;

  const bars = document.createElement('div'); bars.className='voiceBars';
  for(let i=0;i<12;i++){ const b=document.createElement('div'); b.className='voiceBar'; bars.appendChild(b); }

  const dur = document.createElement('div'); dur.className='voiceDur'; dur.textContent = '0:00';
  ui.append(btn,bars,dur);

  // ▲ 重點：有影像軌就用 <video>，否則 <audio>
  const media = document.createElement(msg.isVideo ? 'video' : 'audio');
  media.src = msg.src;
  media.preload = 'metadata';
  media.style.display = 'none';
  if (msg.isVideo) { media.playsInline = true; } // 只要播放音軌，不用顯示畫面
  ui.appendChild(media);
  media._owner = ui;

  function toPlay(){
    stopActive();
    try{ media.currentTime = segStart || 0; }catch(_){}
    media.play().then(()=>{
      ACTIVE_AUDIO = media;
      ui.classList.add('playing');
      btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>`;
    }).catch(()=>{});
  }
  function toPause(){
    media.pause();
    ui.classList.remove('playing');
    btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
    if (ACTIVE_AUDIO===media) ACTIVE_AUDIO=null;
  }
  btn.onclick = ()=> media.paused ? toPlay() : toPause();

  media.addEventListener('loadedmetadata', ()=>{
    const d = (segEnd>segStart) ? (segEnd - segStart) : (media.duration||0);
    dur.textContent = mmss(d||0);
  });
  media.addEventListener('timeupdate', ()=>{
    if(segEnd>segStart && media.currentTime >= segEnd - 0.05){ toPause(); }
  });
  media.addEventListener('ended', toPause);

  return ui;
}

/* ---------- DM Thread（核心） ---------- */
let replyDraft=null;
function renderThread(){
  const box=document.getElementById('dmThread'); box.innerHTML='';

  GROUP_MSGS.forEach(m=>{
    const wrap=document.createElement('div');
    wrap.className='msg '+(m.from==='artist'?'right':'left');

    const timeEl=document.createElement('div');
    timeEl.className='time'+(m.from==='artist'?'':' dark');
    timeEl.textContent=fmtTime(m.ts);

    const bubble=document.createElement('div'); bubble.className='bubble';

    if(m.type==='image'){
      bubble.innerHTML = `<img class="msgImg" src="${m.src}" alt="">`;
    }else if(m.type==='video'){
      bubble.innerHTML = `<video class="msgVideo" src="${m.src}" controls playsinline></video>`;
    }else if(m.type==='voice'){
      bubble.classList.add('voice');
      const ui = buildVoiceUI({src:m.src, segStart:m.start, segEnd:m.end, isVideo:m.isVideo});
      bubble.appendChild(ui);
    }else{
      if(m.from==='fan'){
        const lab=document.createElement('div'); lab.className='fromLabel'; lab.textContent='FROM FAN';
        const txt=document.createElement('div'); txt.className='fanText'; txt.innerHTML=escapeHtml(m.text);
        bubble.append(lab,txt);
      }else{
        bubble.innerHTML=escapeHtml(m.text);
      }
    }

    wrap.append(bubble,timeEl); box.appendChild(wrap);

    if(m.from==='artist'&&m.replyTo&&m.replyTo.text){
      const rc=document.createElement('div'); rc.className='replyCard';
      rc.innerHTML=`<div class="fromLabel">FROM FAN</div><div class="fanText">${escapeHtml(m.replyTo.text)}</div>`;
      box.appendChild(rc);
    }

    if(m.from==='fan' && !m.type){
      const btn=document.createElement('button'); btn.className='replyBtn';
      btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 4l-1.4 1.4L16.2 11H4v2h12.2l-5.6 5.6L12 20l8-8z" fill="currentColor"/></svg>`;
      btn.onclick=()=>{
        replyDraft={text:m.text};
        document.getElementById('replyChip').style.display='flex';
        document.getElementById('replyChipText').textContent=m.text.slice(0,42);
        document.getElementById('dmMessageInput').focus();
        scrollToEndDuring(600);
      };
      bubble.appendChild(btn);
    }
  });

  if(!box.querySelector('#threadPad')){ const pad=document.createElement('div'); pad.id='threadPad'; box.appendChild(pad); }
  if(!box.querySelector('#endAnchor')){ const a=document.createElement('div'); a.id='endAnchor'; box.appendChild(a); }

  scrollToEndDuring(600);
}

/* ---------- 送訊息 / 回覆 ---------- */
function clearReply(){ replyDraft=null; document.getElementById('replyChip').style.display='none'; scrollToEndDuring(400); }
function sendArtistMsg(){
  const inp=document.getElementById('dmMessageInput');
  let t=(inp.value||'').trim(); 
  if(!t) return;

  GROUP_MSGS.push({
    id:'u'+Date.now(),
    from:'artist',
    text:t,
    ts:Date.now(),
    replyTo:replyDraft?{text:replyDraft.text}:null
  });

  LS.set('groupMsgs', GROUP_MSGS);
  inp.value=''; updateComposerUI(); clearReply(); renderThread(); renderDmList();
  hardStickBottom();
}
document.getElementById('dmSendBtn').addEventListener('click', sendArtistMsg);
const dmInput = document.getElementById('dmMessageInput');
dmInput.addEventListener('keydown', e=>{
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendArtistMsg(); }
});
const sendBtn = document.getElementById('dmSendBtn');
const footerEl = document.getElementById('dmFooter');
function updateComposerUI(){
  const has = (dmInput.value||'').trim().length>0;
  footerEl.classList.toggle('hasText', has);
  sendBtn.disabled = !has;
}
dmInput.addEventListener('input', updateComposerUI);
dmInput.addEventListener('focus', ()=>{
  setTimeout(hardStickBottom,0);
  setTimeout(hardStickBottom,200);
  setTimeout(hardStickBottom,600);
});

/* ---------- 媒體：📸 / 🎙️ ---------- */
const pickMedia = document.getElementById('pickMedia');
const pickVoice = document.getElementById('pickVoice');
document.getElementById('btnCamera').addEventListener('click', ()=>pickMedia.click());
document.getElementById('btnMic').addEventListener('click', ()=>pickVoice.click());
function toDataURL(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror= rej; fr.readAsDataURL(file);
  });
}
/* 📸：直接進聊天室（照片/影片） */
pickMedia.addEventListener('change', async e=>{
  const files=[...e.target.files];
  for(const f of files){
    const data = await toDataURL(f);
    const isVideo = f.type.startsWith('video/');
    GROUP_MSGS.push({ id:'m'+Date.now()+Math.random(), from:'artist', type:isVideo?'video':'image', src:data, ts:Date.now() });
  }
  LS.set('groupMsgs', GROUP_MSGS);
  renderThread(); renderDmList(); hardStickBottom();
  e.target.value='';
});

/* 🎙️：先進修剪視窗（支援 audio / mov / mp4） */
let trimState = { blob:null, url:'', dur:0, start:0, end:0 };
const trimModal = document.getElementById('trimModal');
const trimMedia = document.getElementById('trimMedia');
const trimPlay  = document.getElementById('trimPlay');
const trimStart = document.getElementById('trimStart');
const trimEnd   = document.getElementById('trimEnd');
const trimStartLabel=document.getElementById('trimStartLabel');
const trimEndLabel=document.getElementById('trimEndLabel');
const trimClock = document.getElementById('trimClock');
const trimFill  = document.getElementById('trimFill');
const trimUse   = document.getElementById('trimUse');

pickVoice.addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  trimState.blob = f;
  trimState.url  = URL.createObjectURL(f);
  trimMedia.src = trimState.url;
  trimMedia.load();
  trimOpen();
  e.target.value='';
});
function trimOpen(){
  trimModal.style.display='block';
  trimPlay.disabled=true; trimUse.disabled=true;
  trimMedia.addEventListener('loadedmetadata', onLoadedMeta, {once:true});
  trimMedia.addEventListener('timeupdate', onTick);
}
function onLoadedMeta(){
  const d = trimMedia.duration || 0;
  trimState.dur = d;
  trimState.start = 0; trimState.end = d;
  trimStart.value = 0; trimEnd.value = 1000;
  trimStartLabel.textContent = '0.0s';
  trimEndLabel.textContent = d ? `${d.toFixed(1)}s` : '0.0s';
  trimClock.textContent = '0:00';
  trimPlay.disabled=false; trimUse.disabled=false;
}
function onTick(){
  const st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  const cur = trimMedia.currentTime;
  const w = (ed>st)? ((cur-st)/(ed-st))*100 : 0;
  trimFill.style.width = Math.max(0,Math.min(100,w)) + '%';
  trimClock.textContent = s2clock(Math.max(0, cur-st));
  if(cur>=ed-0.02){ trimMedia.pause(); }
}
function closeTrim(){
  trimModal.style.display='none';
  try{ URL.revokeObjectURL(trimState.url); }catch(_){}
  trimMedia.pause(); trimMedia.src=''; trimFill.style.width='0%';
}
function val2sec(v){ return (Number(v)/1000) * (trimState.dur||0); }
function syncRange(which){
  let st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  if(ed<=st){ if(which==='start') ed = Math.min(trimState.dur, st + 0.3); else st = Math.max(0, ed - 0.3); }
  trimState.start = st; trimState.end = ed;
  trimStartLabel.textContent = `${st.toFixed(1)}s`;
  trimEndLabel.textContent   = `${ed.toFixed(1)}s`;
}
trimStart.addEventListener('input', ()=>{ syncRange('start'); });
trimEnd.addEventListener('input',   ()=>{ syncRange('end'); });

let playing=false;
trimPlay.addEventListener('click', ()=>{
  if(!playing){
    try{ trimMedia.currentTime = trimState.start; }catch(_){}
    trimMedia.play().catch(()=>{});
    trimPlay.textContent='⏸ 暫停'; playing=true;
  }else{
    trimMedia.pause(); trimPlay.textContent='▶️ 播放'; playing=false;
  }
});
trimMedia.addEventListener('pause', ()=>{ trimPlay.textContent='▶️ 播放'; playing=false; });

trimUse.addEventListener('click', async ()=>{
  const dur = Math.max(0, (trimState.end||0) - (trimState.start||0));
  if(!confirm(`要發送 ${mmss(dur)} 的語音片段嗎？`)) return;

  const data = await toDataURL(trimState.blob);
  GROUP_MSGS.push({
    id:'v'+Date.now()+Math.random(),
    from:'artist',
    type:'voice',
    isVideo: trimState.blob.type.startsWith('video/'),
    src:data,
    start:trimState.start,
    end:trimState.end,
    ts:Date.now()
  });
  LS.set('groupMsgs', GROUP_MSGS);
  closeTrim(); renderThread(); renderDmList(); hardStickBottom();
});

/* ---------- DM 菜單 ---------- */
function toggleDmMenu(){ const m=document.getElementById('dmMenu'); m.style.display=(m.style.display==='block')?'none':'block'; }
function hideDmMenu(){ document.getElementById('dmMenu').style.display='none'; }
document.addEventListener('click',(e)=>{
  const m=document.getElementById('dmMenu');
  if(m.style.display==='block'&&!m.contains(e.target)&&!e.target.closest('.hudBtn')) hideDmMenu();
});

/* ---------- 改名 ---------- */
function renameChat(){
  const cur=getRoomTitle(); const n=prompt('更改聊天室名稱（同：藝人暱稱）', cur); if(!n) return;
  NICKNAME=n.trim()||cur; LS.setStr('artistNickname', NICKNAME);
  document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
  document.getElementById('meNickname').textContent=NICKNAME;
  document.getElementById('composerWho').textContent=NICKNAME; renderDmList();
}

/* ---------- 背景：挑圖/裁切/預覽/套用 ---------- */
let cropDataURL='', cropDeg=0, cropScale=1.4;
const chooser=document.getElementById('bgChooser');
function startPickBg(){ chooser.click(); }
chooser.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    cropDataURL=ev.target.result;
    document.getElementById('cropImg').src=cropDataURL;
    cropDeg=0; document.getElementById('cropScale').value=140; cropScale=1.4;
    updateCropTransform(); openModal('cropModal');
  };
  reader.readAsDataURL(f);
});
function rotateCrop(){ cropDeg=(cropDeg+90)%360; updateCropTransform(); }
document.getElementById('cropScale').addEventListener('input', e=>{ cropScale=(+e.target.value)/100; updateCropTransform(); });
function updateCropTransform(){ const img=document.getElementById('cropImg'); img.style.transform=`scale(${cropScale}) rotate(${cropDeg}deg)`; }
function applyCrop(){ document.getElementById('bgPreviewMini').style.backgroundImage=`url("${cropDataURL}")`; closeCrop(); openModal('previewModal'); }
function confirmPreview(){
  if(cropDataURL) LS.setStr('artistChatBg', cropDataURL);
  LS.setStr('artistChatBgScale','100'); LS.setStr('artistChatBgBlur','0'); LS.setStr('artistChatBgDim','25');
  applyChatBg(); closePreview();
}
function openModal(id){ document.getElementById(id).style.display='block'; }
function closeCrop(){ document.getElementById('cropModal').style.display='none'; }
function closePreview(){ document.getElementById('previewModal').style.display='none'; }
function applyChatBg(){
  const url=LS.getStr('artistChatBg',''); const blur=LS.getStr('artistChatBgBlur','2'); const dim=LS.getStr('artistChatBgDim','25');
  const el=document.getElementById('dmDetail');
  if(!url){ el.style.backgroundImage='none'; el.style.setProperty('--bgDim','0'); el.style.setProperty('--bgBlur','0px'); }
  else{
    el.style.backgroundImage=`url("${url}")`;
    el.style.setProperty('--bgDim', dim/100);
    el.style.setProperty('--bgBlur', `${blur}px`);
  }
}

/* ---------- 尺寸量測 & 貼底核心 ---------- */
function measureFooter(){
  const f=document.getElementById('dmFooter'); if(!f) return;
  const h=Math.ceil(f.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--footer-h', h + 'px');
}
function measureHUD(){
  const hEl=document.getElementById('dmHUD'); if(!hEl) return;
  const h=Math.ceil(hEl.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--hud-h', h + 'px');
}
function stickBottomNow(){
  const t=document.getElementById('dmThread'); if(!t) return;
  document.getElementById('endAnchor')?.scrollIntoView({block:'end'});
  t.scrollTop = t.scrollHeight + 9999;
}
function scrollToEndDuring(ms=800){
  if(!autoStick) return;
  const end=performance.now()+ms;
  function loop(){ if(!autoStick) return; stickBottomNow(); if(performance.now()<end) requestAnimationFrame(loop); }
  requestAnimationFrame(loop);
}
function hardStickBottom(){
  const t=document.getElementById('dmThread'); if(!t) return;
  t.scrollTop = t.scrollHeight + 9999;
  let frames=36;
  function pump(){ t.scrollTop = t.scrollHeight + 9999; if(--frames>0) requestAnimationFrame(pump); }
  requestAnimationFrame(()=>requestAnimationFrame(pump));
}
let autoStick=true;
function bindScrollGuard(){
  const t=document.getElementById('dmThread'); if(!t) return;
  const nearBottom = ()=>((t.scrollHeight - t.clientHeight) - t.scrollTop) < 6;
  autoStick = nearBottom();
  t.addEventListener('scroll', ()=>{ autoStick = nearBottom(); }, {passive:true});
}
function bindBottomObserver(){
  const t=document.getElementById('dmThread'), a=document.getElementById('endAnchor');
  if(!t || !a) return;
  try{
    const io = new IntersectionObserver((entries)=>{
      const e = entries[0]; autoStick = e.isIntersecting && e.intersectionRatio >= 0.96;
    },{root:t,threshold:[0.01,0.5,0.96],rootMargin:'0px 0px -1px 0px'});
    io.observe(a);
  }catch(_){}
}

/* ---------- Composer（首頁草稿） ---------- */
function previewComposeMedia(e){
  const box=document.getElementById('composePreview'); const hint=document.getElementById('composeFilesHint');
  box.innerHTML=''; if(!e.target.files.length){ hint.textContent='未選取檔案'; return; }
  hint.textContent=`已選 ${e.target.files.length} 個檔案`;
  [...e.target.files].forEach(f=>{
    const url=URL.createObjectURL(f); const isVideo=f.type.startsWith('video/');
    const el=document.createElement(isVideo?'video':'img');
    el.src=url; el.controls=isVideo; el.onload=el.onloadeddata=()=>URL.revokeObjectURL(url);
    el.style.width='110px'; el.style.height='110px'; el.style.objectFit='cover'; el.style.borderRadius='12px'; el.style.border='1px solid var(--line)';
    box.appendChild(el);
  });
}
function publishDraft(){ alert('先存草稿＆預覽；發佈規則等我們接首頁串流。'); showPage('home'); }

/* ---------- 暱稱按鈕 ---------- */
document.getElementById('btnEditNick').addEventListener('click', ()=>{
  const v=prompt('輸入新的暱稱（= 聊天室名稱）', NICKNAME);
  if(v&&v.trim()){
    NICKNAME=v.trim(); LS.setStr('artistNickname', NICKNAME);
    document.getElementById('meNickname').textContent=NICKNAME;
    document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
    document.getElementById('composerWho').textContent=NICKNAME; renderDmList();
  }
});

/* ---------- 啟動 ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('meNickname').textContent=NICKNAME;
  document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
  document.getElementById('composerWho').textContent=NICKNAME;
  document.getElementById('meId').textContent='ARTIST-00001';
  document.getElementById('meAvatar').src=AVATAR;

  renderStoryBar(); renderFeed(currentFilter); renderDmList();

  measureHUD(); measureFooter(); updateComposerUI();
  if(document.getElementById('dmThread')){ scrollToEndDuring(800); setTimeout(hardStickBottom,0); }
});

/* 監看 footer 高度變化（鍵盤彈起 / 回覆 chip 出現） */
(()=>{ const footer=document.getElementById('dmFooter'); if(!footer) return;
  if('ResizeObserver' in window){ new ResizeObserver(()=>{ measureFooter(); scrollToEndDuring(600); }).observe(footer); }
})();

/* iOS Safari：視窗/鍵盤變化（visualViewport） */
;(function(){
  const vv=window.visualViewport;
  function applyVV(){
    if(!vv) return;
    const offset=Math.max(0, window.innerHeight - vv.height);
    document.documentElement.style.setProperty('--kb-offset', offset + 'px');
    measureFooter(); scrollToEndDuring(600);
  }
  if(vv){ vv.addEventListener('resize', applyVV); vv.addEventListener('scroll', applyVV); applyVV(); }
  window.addEventListener('resize', ()=>{ measureHUD(); measureFooter(); scrollToEndDuring(600); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ measureHUD(); measureFooter(); scrollToEndDuring(800); },120); });
  window.addEventListener('pageshow', ()=>{ measureFooter(); scrollToEndDuring(800); });
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ scrollToEndDuring(600); } });
  if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=>scrollToEndDuring(800)); }
})();
</script>
</body>
</html>
