<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>NEXTâ€™S YOU â€” Fan App (å–®é ç‰ˆÂ·å®Œæ•´ä¿®æ­£ç‰ˆ)</title>
<style>
  :root{
    --bg:#f5f7ff; --card:#fff; --text:#1a1a1a; --sub:#667085; --line:#e7eaf3; --ghost:#9aa0b4;
    --accent:#6a5acd; --accent2:#836fff; --ok:#10b981; --danger:#ff4d4f;
    --radius:16px; --shadow:0 12px 34px rgba(18,24,40,.08);
    --safe: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    overflow-x:hidden
  }
  img{display:block;max-width:100%} a{text-decoration:none;color:inherit} button{font:inherit;cursor:pointer}
  .ghost{color:var(--ghost)} .sub{color:var(--sub)} .soft{padding:16px} .row{display:flex;align-items:center;gap:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;background:#f3f5ff;border:1px solid var(--line);font-size:12px}

  /* pages */
  section.page{display:none;padding:12px 12px calc(76px + var(--safe))}
  section.page.active{display:block;animation:fade .22s ease}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* bottom nav */
  nav#nav{
    position:fixed;left:0;right:0;bottom:0;z-index:40;background:var(--card);border-top:1px solid var(--line);
    display:flex;justify-content:space-around;gap:6px;padding:10px 8px calc(12px + var(--safe));backdrop-filter:saturate(140%) blur(10px);
    transition:transform .25s ease;
  }
  nav#nav.hidden{transform:translateY(120%)}
  nav#nav button{flex:1;border:none;background:transparent;padding:8px 0 6px;border-radius:12px;color:var(--sub);font-weight:800;font-size:13px}
  nav#nav button.active{color:var(--accent);background:#f5f3ff;border:1px solid var(--line)}

  /* header (home) */
  #homeHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 6px 10px}
  #homeHeader .me{display:flex;align-items:center;gap:10px}
  #homeHeader .me img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  #homeHeader .me .id{font-size:12px;color:var(--ghost)}

  /* story bar */
  #storyWrap{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(245,247,255,.96),rgba(245,247,255,.90));backdrop-filter:blur(6px)}
  #storyBar{display:flex;gap:12px;overflow-x:auto;padding:10px 8px 12px;border-bottom:1px solid var(--line);scrollbar-width:none}
  #storyBar::-webkit-scrollbar{display:none}
  .story-item{flex:0 0 auto;width:64px;text-align:center;cursor:pointer;position:relative}
  .story-item img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #d5d8f3}
  .story-item .name{font-size:12px;margin-top:4px;color:#9aa1ad}
  .story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18)}
  .story-item.active .name{color:var(--accent);font-weight:700}
  .story-item .dot{position:absolute;right:6px;top:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;box-shadow:0 0 0 2px #fff}
  .story-item.pinned img{border-color:#111}

  /* post card */
  .post{margin:12px 6px}
  .post .hdr{display:flex;align-items:center;gap:10px}
  .post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  .post .meta b{font-weight:900;display:flex;align-items:center;gap:6px}
  .post .meta small{display:block;color:var(--ghost)}
  .post .body{margin-top:8px}
  .post .hero{width:100%;height:360px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

  /* verifyï¼ˆæ–°ç‰ˆï¼‰ */
  .verify{
    display:inline-flex;align-items:center;justify-content:center;
    width:16px;height:16px;border-radius:5px;
    background:linear-gradient(180deg,#8ea2ff,#6a5acd);
    color:#fff;font-size:11px;font-weight:900;
    box-shadow:0 0 0 2px #fff;
  }

  /* DM list */
  #dm .dmCard{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card);margin:10px 0;cursor:pointer}
  #dm .dmCard .left{display:flex;align-items:center;gap:12px}
  #dm .dmCard img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  .nameBlock{display:flex;flex-direction:column;gap:4px}
  .nm{display:flex;align-items:center;gap:8px}
  .nm b{font-size:18px;letter-spacing:.4px}
  /* ARTIST å¾½ç« ï¼ˆæ–¹æ¡†ï¼‰ */
  .artistTag{
    display:inline-flex;align-items:center;justify-content:center;
    padding:4px 10px;border-radius:8px;border:1px solid #ded6ff;
    background:linear-gradient(90deg,#cbb9ff 0%,#8fb4ff 62%,#ffffff 100%);
    color:#2e2a6f;font-size:11px;font-weight:900;letter-spacing:.7px;
    box-shadow:0 4px 12px rgba(106,90,205,.20)
  }

  /* ===== DM Detail ===== */
  #dmDetail{
    position:relative; min-height:100vh; padding:12px 12px calc(80px + var(--safe));
    background-attachment:fixed; background-position:center; background-repeat:no-repeat; background-size:cover;
  }
  /* èƒŒæ™¯æ³›å…‰è¦†å±¤ï¼ˆå›ºå®šä¸è·Ÿè‘—æ²å‹•ï¼‰ */
  #dmDetail::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:rgba(0,0,0,var(--bgDim,.0)); backdrop-filter:blur(var(--bgBlur,0px));
  }
  .chatHUD{position:relative; z-index:1; display:flex;align-items:center;justify-content:space-between;gap:10px}
  .hudBtn,.back{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:var(--card)}
  .titleRow{display:flex;align-items:center;gap:8px}
  .statusHint{font-size:12px;color:#9aa0b4;margin-top:4px}

  /* thread */
  .thread{position:relative; z-index:1; display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow-y:auto;padding:8px 2px}
  .msg{position:relative; display:flex;flex-direction:column;max-width:78%;margin:6px 0}
  .msg.left{align-self:flex-start}
  .msg.right{align-self:flex-end}
  .bubble{max-width:100%;padding:12px 14px;border-radius:18px;border:1px solid var(--line);background:#fff;position:relative}
  .msg.right .bubble{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
  .labelBox{margin:-6px 0 8px}
  .labelBox .l1{font-size:12px;font-weight:900;color:#7a88b0}
  .labelBox .l2{font-size:11px;color:#a3adc5}
  .quote{font-size:13px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.85);color:#394360;border:1px solid #e6e9f7}
  .msg.right .quote{background:rgba(255,255,255,.88);color:#394360}
  /* æ™‚é–“ï¼šå·¦è¨Šæ¯æ”¾å·¦å´ã€å³è¨Šæ¯æ”¾å³å´ */
  .time{position:absolute;bottom:-18px;font-size:11px;color:rgba(255,255,255,.90)}
  .msg.left  .time{left:0;transform:translateX(calc(-100% - 6px)); color:rgba(0,0,0,.45)}
  .msg.right .time{right:0;transform:translateX(calc(100% + 6px)); color:rgba(255,255,255,.85)}

  /* å›è¦†ç®­é ­ï¼ˆåœ“å½¢åŠé€æ˜ï¼‰ */
  .replyBtn{
    position:absolute; right:-42px; top:50%; transform:translateY(-50%);
    width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.5);
    background:rgba(255,255,255,.55); backdrop-filter:blur(6px);
    display:flex;align-items:center;justify-content:center; font-size:16px; color:#59627c;
  }

  /* å›è¦† chipï¼ˆè¼¸å…¥åˆ—ä¸Šæ–¹ï¼‰ */
  .replyChip{display:none;align-items:center;gap:8px;margin:0 12px 8px}
  .replyPill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.72);border:1px solid #dfe3fb;border-radius:12px;padding:6px 10px}
  .replyPill .tag{font-size:12px;font-weight:900;color:#7a86b7}
  .replyPill .txt{font-size:12px;color:#6c7696;max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .replyPill .x{border:none;background:transparent;color:#97a0b8;font-size:16px}

  /* è¼¸å…¥åˆ—ï¼ˆæ»¿ç‰ˆã€å›ºå®šåº•éƒ¨ã€è¼ƒå°ï¼‰ */
  .dmFooter{
    position:sticky;left:0;right:0;bottom:0;z-index:5;
    padding:8px 12px calc(8px + var(--safe));
    background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.92));
    backdrop-filter:blur(6px); border-top:1px solid rgba(255,255,255,.35);
  }
  .dmInputBar{display:flex;align-items:center;gap:10px;width:100%}
  .dmInputBar .box{flex:1;min-width:0;display:flex;align-items:center;background:#fff;border:1px solid var(--line);border-radius:999px;padding:0 14px;height:44px}
  .dmInputBar input{flex:1;border:none;outline:none;background:transparent;font-size:16px}
  .dmSend{min-width:56px;height:44px;border:none;border-radius:14px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:900}

  /* å³ä¸Š â€¦ é¸å–® */
  #dmMenu{position:fixed;right:12px;top:64px;display:none;z-index:70}
  #dmMenu .chip{width:100%;justify-content:center}

  /* èƒŒæ™¯ç·¨è¼¯å™¨ */
  #bgEditor{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
  #bgEditor .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%); width:min(720px,92vw);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  #bgPreview{height:42vh;border:1px dashed var(--line);border-radius:12px;background-size:var(--bgScale,cover);background-position:center;background-repeat:no-repeat;position:relative;overflow:hidden}
  #bgOverlay{position:absolute;inset:0;background:rgba(0,0,0,var(--bgDim,.25));backdrop-filter:blur(var(--bgBlur,0px))}
  .rangeRow{display:flex;align-items:center;gap:10px;margin:12px 0}
  .rangeRow label{min-width:60px;color:#556}
  .rangeRow output{margin-left:auto;color:#667;font-variant-numeric:tabular-nums}

  /* composer */
  #composerArtist .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  #composerArtist .rightName{margin-left:auto;color:#9aa1ad;font-weight:800;letter-spacing:.3px}
  #composeBox{min-height:42vh}
  #composeText{width:100%;border:none;outline:none;font-size:16px}
  #composePreview>img,#composePreview>video{width:110px;height:110px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}
</style>
</head>
<body>

<!-- ====================== HOMEï¼ˆè—äººï¼‰ ====================== -->
<section id="home" class="page active">
  <div id="homeHeader">
    <div class="me">
      <img id="meAvatar" src="https://picsum.photos/80?u=artist" onerror="imgFallback(this)">
      <div>
        <div id="meNickname" style="font-weight:900">Annie</div>
        <div class="id" id="meId">ARTIST-00001</div>
      </div>
    </div>
    <button class="chip" id="btnEditNick">âœï¸ æ›´æ”¹æˆ‘çš„æš±ç¨±</button>
  </div>

  <div id="storyWrap"><div id="storyBar"></div></div>
  <div id="feedWrap"></div>

  <button class="dmSend" id="fabNew" style="position:fixed;right:16px;bottom:calc(86px + var(--safe));z-index:35;width:56px;border-radius:50%">ï¼‹</button>
</section>

<!-- ====================== DM LIST ====================== -->
<section id="dm" class="page">
  <div class="row" style="justify-content:space-between;margin:2px 0 10px">
    <b style="font-weight:900">è¨Šæ¯</b>
  </div>
  <div id="dmList"></div>
</section>

<!-- ====================== DM DETAILï¼ˆè—äººç¾¤èŠï¼‰ ====================== -->
<section id="dmDetail" class="page">
  <!-- é ‚éƒ¨ HUD -->
  <div class="chatHUD">
    <div class="left"><button class="back" onclick="goBack()">â†</button></div>
    <div class="center">
      <div class="titleRow">
        <span class="artistTag">ARTIST</span>
        <b id="dmTitle" style="letter-spacing:.6px">ANNIE</b>
      </div>
      <div class="statusHint" id="statusHint">ï¼ˆé»å³ä¸Šã€Œâ€¦ã€å¯æ›´æ”¹èŠå¤©å®¤åç¨±ï¼èƒŒæ™¯ï¼‰</div>
    </div>
    <div class="right"><button class="hudBtn" title="æ›´å¤š" onclick="toggleDmMenu()">â‹¯</button></div>
  </div>

  <!-- DM Thread -->
  <div id="dmThread" class="thread"></div>

  <!-- å›è¦† chip -->
  <div id="replyChip" class="replyChip">
    <div class="replyPill">
      <span class="tag">å›è¦†</span>
      <span id="replyChipText" class="txt"></span>
      <button class="x" onclick="clearReply()">Ã—</button>
    </div>
  </div>

  <!-- Footer / Input -->
  <div class="dmFooter">
    <div class="dmInputBar">
      <div class="box"><input id="dmMessageInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦" /></div>
      <button class="dmSend" id="dmSendBtn" title="é€å‡º">âœˆï¸</button>
    </div>
  </div>

  <!-- å³ä¸Š â€¦ é¸å–® -->
  <div id="dmMenu" class="card soft">
    <div class="row" style="flex-direction:column;gap:6px">
      <button class="chip" onclick="renameChat(); closeDmMenu()">æ›´æ”¹èŠå¤©å®¤åç¨±</button>
      <button class="chip" onclick="triggerBgPicker()">æ›´æ”¹èƒŒæ™¯</button>
    </div>
  </div>
  <input id="bgFile" type="file" accept="image/*" style="display:none">
</section>

<!-- ====================== èƒŒæ™¯ç·¨è¼¯å™¨ ====================== -->
<div id="bgEditor">
  <div class="panel">
    <b style="font-weight:900">èƒŒæ™¯è¨­å®š</b>
    <div id="bgPreview"><div id="bgOverlay"></div></div>
    <div class="rangeRow"><label>ç¸®æ”¾</label><input id="bgScale" type="range" min="100" max="220" value="140"><output id="bgScaleOut">140%</output></div>
    <div class="rangeRow"><label>æ¨¡ç³Š</label><input id="bgBlur" type="range" min="0" max="8" value="2"><output id="bgBlurOut">2px</output></div>
    <div class="rangeRow"><label>æš—åº¦</label><input id="bgDim" type="range" min="0" max="70" value="25"><output id="bgDimOut">25%</output></div>
    <div class="row" style="justify-content:flex-end">
      <button class="chip" onclick="closeBgEditor()">å–æ¶ˆ</button>
      <button class="chip" onclick="previewApplyBg()">é è¦½</button>
      <button class="dmSend" style="width:auto;padding:8px 14px;border-radius:10px" onclick="applyBg()">ç¢ºèª</button>
    </div>
  </div>
</div>

<!-- ====================== Composerï¼ˆï¼‹ï¼‰ ====================== -->
<section id="composerArtist" class="page">
  <div class="topbar">
    <button class="back" onclick="goBack()">â†</button>
    <b style="font-weight:900">NEXT ONE</b>
    <div class="rightName" id="composerWho">â€”</div>
  </div>

  <div id="composeBox" class="soft card">
    <textarea id="composeText" rows="4" placeholder="åœ¨æƒ³äº›ä»€éº¼ï¼Ÿ"></textarea>
    <div id="composePreview" class="row" style="flex-wrap:wrap;gap:8px;margin-top:10px"></div>
  </div>

  <div class="row" style="gap:10px;margin-top:12px">
    <label class="chip">é¸æ“‡æª”æ¡ˆ
      <input id="composeMedia" type="file" multiple accept="image/*,video/*" onchange="previewComposeMedia(event)" style="display:none">
    </label>
    <span id="composeFilesHint" class="ghost">æœªé¸å–æª”æ¡ˆ</span>
    <button class="dmSend" style="border-radius:10px" onclick="publishDraft()">ç™¼ä½ˆï¼ˆæš«å­˜æµç¨‹ï¼‰</button>
  </div>
</section>

<!-- ====================== Bottom Nav ====================== -->
<nav id="nav">
  <button id="tabHome" class="active" onclick="showPage('home')">é¦–é </button>
  <button id="tabDM" onclick="showPage('dm')">DM</button>
  <button id="tabLive" onclick="showPage('live')">ç›´æ’­</button>
  <button id="tabStore" onclick="showPage('store')">å•†åº—</button>
</nav>

<script>
/* ---------- å°å·¥å…· ---------- */
function imgFallback(img){
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
  img.src = 'data:image/svg+xml;charset=UTF-8,' + svg; img.onerror = null;
}
const LS = {
  get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
  getStr(k,def=''){ const v=localStorage.getItem(k); return v ?? def },
  setStr(k,v){ localStorage.setItem(k,v) }
};
const fmtTime = ts => {
  const d=new Date(ts);
  const h=d.getHours(); const m=('0'+d.getMinutes()).slice(-2);
  const ap= h>=12?'ä¸‹åˆ':'ä¸Šåˆ'; const hr=(h%12)||12;
  return `${ap}${hr}:${m}`;
};
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ç³»çµ±èˆå°åï¼ˆä¸å—æš±ç¨±å½±éŸ¿ï¼‰ */
const STAGE_NAME = LS.getStr('artistStage','ANNIE');
let   NICKNAME   = LS.getStr('artistNickname','Annie'); // DM é¡¯ç¤ºæš±ç¨±
let   AVATAR     = LS.getStr('artistAvatar','https://picsum.photos/80?u=artist');

/* ---------- å‡è³‡æ–™ ---------- */
const ME = { id:'me', name:STAGE_NAME, avatar:AVATAR };
const ARTISTS = [
  {id:'me', name:STAGE_NAME, avatar:AVATAR},
  {id:'all', name:'ALL', avatar:'https://picsum.photos/80?u=all'},
  {id:'dohee', name:'DOHEE', avatar:'https://picsum.photos/80?u=dh'},
  {id:'woo', name:'WOOCHAN', avatar:'https://picsum.photos/80?u=wc'}
];
const POSTS = LS.get('artistPosts', [
  { id:'p3', artistId:'dohee', artistStage:'DOHEE',   avatar:'https://picsum.photos/80?u=dh', text:'ç·´èˆç·´åˆ°çˆ†æ±— ğŸ’ƒ', img:'https://picsum.photos/1200?u=dh1', ts: Date.now()-1000*60*40 },
  { id:'p2', artistId:'woo',   artistStage:'WOOCHAN', avatar:'https://picsum.photos/80?u=wc', text:'ä»Šå¤©åƒæ‹‰éºµ ğŸœ',   img:'https://picsum.photos/1200?u=wc1', ts: Date.now()-1000*60*50 },
  { id:'p1', artistId:'me',    artistStage:STAGE_NAME, avatar:ME.avatar, text:'å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ Annie âœ¨', img:'', ts: Date.now()-1000*60*60 }
]);
const FANS = [
  {id:'f1', name:'Michelle', avatar:'https://picsum.photos/40?u=f1'},
  {id:'f2', name:'ç²‰çµ² B',   avatar:'https://picsum.photos/40?u=f2'}
];
let GROUP_MSGS = LS.get('groupMsgs', [
  {id:'m1', from:'fan', fanId:'f1', text:'å¶åƒå¥½ï½', ts:Date.now()-1000*60*45},
  {id:'m2', from:'fan', fanId:'f2', text:'ä»Šå¤©åƒä»€éº¼ï¼Ÿ', ts:Date.now()-1000*60*43},
  {id:'m3', from:'artist', text:'æˆ‘åˆé¤åƒäº†æ²™æ‹‰ ğŸ¥—', ts:Date.now()-1000*60*40, replyTo:{text:'ä»Šå¤©åƒä»€éº¼ï¼Ÿ'}}
]);
const lastSeen = LS.get('lastSeen', {});

/* ---------- å°èˆª ---------- */
const HIDE_NAV_IN = ['dmDetail','composerArtist'];
let PAGE_STACK = ['home'];
function showPage(id){
  document.querySelectorAll('section.page').forEach(s=>s.classList.remove('active'));
  const page = document.getElementById(id); if(page) page.classList.add('active');
  if(PAGE_STACK[PAGE_STACK.length-1]!==id) PAGE_STACK.push(id);

  // nav tab
  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
  ({home:'tabHome', dm:'tabDM', live:'tabLive', store:'tabStore'}[id] || null) &&
    document.getElementById({home:'tabHome', dm:'tabDM', live:'tabLive', store:'tabStore'}[id]).classList.add('active');

  // hide nav?
  const nav = document.getElementById('nav');
  if(HIDE_NAV_IN.includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');

  // per-page render
  if(id==='home'){ renderStoryBar(); renderFeed(currentFilter); }
  if(id==='dm'){ renderDmList(); }
  if(id==='dmDetail'){ renderThread(); applyChatBg(); }
  if(id==='composerArtist'){ document.getElementById('composerWho').textContent = NICKNAME; }
}
function goBack(){
  PAGE_STACK.pop();
  const prev = PAGE_STACK[PAGE_STACK.length-1] || 'home';
  showPage(prev);
}

/* ---------- HOMEï¼šStory bar ---------- */
let currentFilter = 'me';
function hasNewDots(artistId){
  if(artistId==='me' || artistId==='all') return false;
  const seen = lastSeen[artistId] || 0;
  const latest = Math.max(0, ...POSTS.filter(p=>p.artistId===artistId).map(p=>p.ts));
  return latest > seen;
}
function renderStoryBar(){
  const bar = document.getElementById('storyBar');
  const others = ARTISTS.filter(a=> a.id!=='me' && a.id!=='all');
  others.sort((a,b)=>{
    const la = Math.max(0,...POSTS.filter(p=>p.artistId===a.id).map(p=>p.ts));
    const lb = Math.max(0,...POSTS.filter(p=>p.artistId===b.id).map(p=>p.ts));
    return lb - la;
  });
  const order = [ARTISTS.find(a=>a.id==='me'), ARTISTS.find(a=>a.id==='all'), ...others];
  bar.innerHTML = order.map(a=>{
    const active = (currentFilter===a.id) ? 'active':'';
    const pinned = (a.id==='me' || a.id==='all') ? 'pinned':'';
    const dot = hasNewDots(a.id)? '<span class="dot"></span>':'';
    return `<div class="story-item ${active} ${pinned}" data-id="${a.id}">
      <img src="${a.avatar}" onerror="imgFallback(this)">${dot}
      <div class="name">${a.name}</div>
    </div>`;
  }).join('');
  bar.querySelectorAll('.story-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id = el.dataset.id;
      currentFilter = id;
      if(id!=='all') lastSeen[id] = Date.now();
      LS.set('lastSeen', lastSeen);
      renderStoryBar();
      renderFeed(currentFilter);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}

/* ---------- HOMEï¼šFeedï¼ˆèˆå°å + è—å‹¾ï¼‰ ---------- */
function feedOf(filter){
  if(filter==='all') return POSTS.slice().sort((a,b)=>b.ts-a.ts);
  if(filter==='me')  return POSTS.filter(p=>p.artistId==='me').sort((a,b)=>b.ts-a.ts);
  return POSTS.filter(p=>p.artistId===filter).sort((a,b)=>b.ts-a.ts);
}
function renderFeed(filter='me'){
  const wrap = document.getElementById('feedWrap');
  const list = feedOf(filter);
  if(!list.length){ wrap.innerHTML = `<div class="ghost" style="text-align:center;margin-top:20vh">å°šç„¡è²¼æ–‡</div>`; return; }
  wrap.innerHTML = list.map(p=>`
    <div class="card soft post">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}" onerror="imgFallback(this)">
        <div class="meta">
          <b>${escapeHtml((p.artistStage || p.artistName || '').toString().toUpperCase())} <span class="verify">âœ“</span></b>
          <small class="ghost">${new Date(p.ts).toLocaleString()}</small>
        </div>
      </div>
      <div class="body">
        <p>${escapeHtml(p.text)}</p>
        ${p.img? `<img class="hero" src="${p.img}" onerror="imgFallback(this)">` : ``}
      </div>
    </div>
  `).join('');
}
document.getElementById('fabNew').addEventListener('click', ()=> showPage('composerArtist'));

/* ---------- DM List ---------- */
function getRoomTitle(){ return NICKNAME.toUpperCase(); }
function renderDmList(){
  const box=document.getElementById('dmList');
  const last=GROUP_MSGS[GROUP_MSGS.length-1];
  box.innerHTML=`
    <div class="dmCard" onclick="showPage('dmDetail')">
      <div class="left">
        <img src="${ME.avatar}" onerror="imgFallback(this)">
        <div class="nameBlock">
          <span class="artistTag">ARTIST</span>
          <div class="nm"><b>${escapeHtml(getRoomTitle())}</b></div>
          <small class="ghost" style="display:block;max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(last?last.text:'ï¼ˆç„¡è¨Šæ¯ï¼‰')}</small>
        </div>
      </div>
    </div>`;
}

/* ---------- DM Thread ---------- */
let replyDraft = null; // { text }
function renderThread(){
  const box = document.getElementById('dmThread'); box.innerHTML='';
  GROUP_MSGS.forEach(m=>{
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (m.from==='artist'?'right':'left');

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    if(m.from==='fan'){
      const lb = document.createElement('div');
      lb.className='labelBox';
      lb.innerHTML = `<div class="l1">FROM FAN</div><div class="l2">ï¼ˆç²‰çµ²çš„è¨Šæ¯ï¼‰</div>`;
      bubble.appendChild(lb);
      bubble.insertAdjacentHTML('beforeend', `<div>${escapeHtml(m.text)}</div>`);
    }else{
      bubble.insertAdjacentHTML('beforeend', `<div>${escapeHtml(m.text)}</div>`);
      if(m.replyTo && m.replyTo.text){
        bubble.insertAdjacentHTML('beforeend', `<div class="quote"><b class="ghost">FROM FANï¼š</b>${escapeHtml(m.replyTo.text)}</div>`);
      }
    }

    wrap.appendChild(bubble);

    // æ™‚é–“ï¼ˆå·¦å³å„è‡ªé å¤–å´ï¼‰
    const t = document.createElement('div');
    t.className='time';
    t.textContent = fmtTime(m.ts);
    wrap.appendChild(t);

    // ç²‰çµ²è¨Šæ¯æ‰æœ‰å›è¦†éµ
    if(m.from==='fan'){
      const btn = document.createElement('button');
      btn.className = 'replyBtn'; btn.innerHTML = 'â†’';
      btn.onclick = ()=>{
        replyDraft = { text: m.text };
        const chip = document.getElementById('replyChip');
        chip.style.display = 'flex';
        document.getElementById('replyChipText').textContent = m.text;
        document.getElementById('dmMessageInput').focus();
      };
      bubble.appendChild(btn);
    }

    box.appendChild(wrap);
  });
  box.scrollTop = box.scrollHeight;
}
function clearReply(){ replyDraft = null; document.getElementById('replyChip').style.display='none'; }
function sendArtistMsg(){
  const inp = document.getElementById('dmMessageInput');
  let t = (inp.value||'').trim(); if(!t) return;

  // @@@ -> è‡ªå‹•å¸¶å…¥ç²‰çµ²åï¼ˆç¤ºç¯„å–ç¬¬ä¸€ä½ç²‰çµ²ï¼‰
  const firstFan = FANS[0]?.name || 'ç²‰çµ²';
  t = t.replaceAll('@@@', firstFan);

  GROUP_MSGS.push({ id:'u'+Date.now(), from:'artist', text:t, ts:Date.now(), replyTo: replyDraft? {text:replyDraft.text}: null });
  LS.set('groupMsgs', GROUP_MSGS);
  inp.value=''; clearReply(); renderThread(); renderDmList();
}
document.getElementById('dmSendBtn').addEventListener('click', sendArtistMsg);
document.getElementById('dmMessageInput').addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendArtistMsg(); }
});

/* ---------- DM èœå–® ---------- */
function toggleDmMenu(){
  const m = document.getElementById('dmMenu');
  const show = (m.style.display==='none'||!m.style.display);
  m.style.display = show?'block':'none';
  if(show){
    // é»å¤–é¢è‡ªå‹•æ”¶
    setTimeout(()=>{
      const closer = (ev)=>{
        if(!m.contains(ev.target) && ev.target.id!=='hudBtn'){ closeDmMenu(); document.removeEventListener('click', closer); }
      };
      document.addEventListener('click', closer);
    },0);
  }
}
function closeDmMenu(){ document.getElementById('dmMenu').style.display='none'; }
function renameChat(){
  const cur = NICKNAME;
  const n = prompt('æ›´æ”¹èŠå¤©å®¤åç¨±ï¼ˆåŒï¼šè—äººæš±ç¨±ï¼‰', cur);
  if(!n) return;
  NICKNAME = n.trim() || cur;
  LS.setStr('artistNickname', NICKNAME);
  document.getElementById('dmTitle').textContent = NICKNAME.toUpperCase();
  document.getElementById('meNickname').textContent = NICKNAME;
  document.getElementById('composerWho').textContent = NICKNAME;
  renderDmList();
}

/* ---------- èƒŒæ™¯ï¼šæŒ‘é¸ -> ç·¨è¼¯ -> å¥—ç”¨ ---------- */
function triggerBgPicker(){ closeDmMenu(); document.getElementById('bgFile').click(); }
document.getElementById('bgFile').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    document.getElementById('bgPreview').style.backgroundImage = `url("${ev.target.result}")`;
    document.getElementById('bgPreview').dataset.url = ev.target.result;
    openBgEditor(); updateBgPreview();
  };
  reader.readAsDataURL(f);
});
function openBgEditor(){
  document.getElementById('bgEditor').style.display='block';
  const url = document.getElementById('bgPreview').dataset.url || LS.getStr('artistChatBg','');
  if(url) document.getElementById('bgPreview').style.backgroundImage = `url("${url}")`;
  document.getElementById('bgScale').value = LS.getStr('artistChatBgScale','140');
  document.getElementById('bgBlur').value  = LS.getStr('artistChatBgBlur','2');
  document.getElementById('bgDim').value   = LS.getStr('artistChatBgDim','25');
  updateBgPreview();
}
function closeBgEditor(){ document.getElementById('bgEditor').style.display='none'; }
function updateBgPreview(){
  const s=document.getElementById('bgScale').value;
  const b=document.getElementById('bgBlur').value;
  const d=document.getElementById('bgDim').value;
  document.getElementById('bgPreview').style.setProperty('--bgScale', `${s}%`);
  document.getElementById('bgOverlay').style.setProperty('--bgBlur', `${b}px`);
  document.getElementById('bgOverlay').style.setProperty('--bgDim',  `${d/100}`);
  document.getElementById('bgScaleOut').value = s+'%';
  document.getElementById('bgBlurOut').value  = b+'px';
  document.getElementById('bgDimOut').value   = d+'%';
}
['bgScale','bgBlur','bgDim'].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateBgPreview, {passive:true});
});
function previewApplyBg(){ applyChatBg(); }
function applyBg(){
  const url = document.getElementById('bgPreview').dataset.url || LS.getStr('artistChatBg','');
  const scale = document.getElementById('bgScale').value;
  const blur  = document.getElementById('bgBlur').value;
  const dim   = document.getElementById('bgDim').value;
  if(url) LS.setStr('artistChatBg', url);
  LS.setStr('artistChatBgScale', scale);
  LS.setStr('artistChatBgBlur',  blur);
  LS.setStr('artistChatBgDim',   dim);
  applyChatBg(); closeBgEditor();
}
function applyChatBg(){
  const url = LS.getStr('artistChatBg','');
  const scale = LS.getStr('artistChatBgScale','140');
  const blur  = LS.getStr('artistChatBgBlur','2');
  const dim   = LS.getStr('artistChatBgDim','25');
  const el = document.getElementById('dmDetail');
  if(!url){
    el.style.background='none';
    el.style.setProperty('--bgDim','0'); el.style.setProperty('--bgBlur','0px');
  }else{
    el.style.backgroundImage = `url("${url}")`;
    el.style.backgroundSize  = `${scale}%`;
    el.style.backgroundPosition='center';
    el.style.backgroundRepeat='no-repeat';
    el.style.setProperty('--bgDim',  dim/100);
    el.style.setProperty('--bgBlur', `${blur}px`);
  }
}

/* ---------- Composer ---------- */
function previewComposeMedia(e){
  const box = document.getElementById('composePreview');
  const hint = document.getElementById('composeFilesHint');
  box.innerHTML = '';
  if(!e.target.files.length){ hint.textContent='æœªé¸å–æª”æ¡ˆ'; return; }
  hint.textContent = `å·²é¸ ${e.target.files.length} å€‹æª”æ¡ˆ`;
  [...e.target.files].forEach(f=>{
    const url = URL.createObjectURL(f);
    const isVideo = f.type.startsWith('video/');
    const el = document.createElement(isVideo?'video':'img');
    el.src = url; el.controls = isVideo;
    el.onload = el.onloadeddata = ()=>URL.revokeObjectURL(url);
    box.appendChild(el);
  });
}
function publishDraft(){
  alert('å…ˆå­˜è‰ç¨¿ï¼†é è¦½ï¼›ç™¼ä½ˆè¦å‰‡ç­‰æˆ‘å€‘æ¥é¦–é ä¸²æµã€‚');
  showPage('home');
}

/* ---------- æš±ç¨± = èŠå¤©å®¤åç¨±ï¼ˆä¸å½±éŸ¿èˆå°åï¼‰ ---------- */
document.getElementById('btnEditNick').addEventListener('click', ()=>{
  const v = prompt('è¼¸å…¥æ–°çš„æš±ç¨±ï¼ˆ= èŠå¤©å®¤åç¨±ï¼‰', NICKNAME);
  if(v && v.trim()){
    NICKNAME = v.trim();
    LS.setStr('artistNickname', NICKNAME);
    document.getElementById('meNickname').textContent = NICKNAME;
    document.getElementById('dmTitle').textContent = NICKNAME.toUpperCase();
    document.getElementById('composerWho').textContent = NICKNAME;
    renderDmList();
  }
});

/* ---------- å•Ÿå‹• ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // é ­åƒ/æš±ç¨±/ID
  document.getElementById('meNickname').textContent = NICKNAME;
  document.getElementById('dmTitle').textContent = NICKNAME.toUpperCase();
  document.getElementById('composerWho').textContent = NICKNAME;
  document.getElementById('meId').textContent = 'ARTIST-00001';
  document.getElementById('meAvatar').src = AVATAR;

  renderStoryBar(); renderFeed(currentFilter);
  renderDmList();

  // é»èƒŒæ™¯ç·¨è¼¯å™¨å¤–æ¡†å¯é—œé–‰
  document.getElementById('bgEditor').addEventListener('click', (e)=>{ if(e.target.id==='bgEditor') closeBgEditor(); });
});
</script>
</body>
</html>
