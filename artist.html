<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NEXTâ€™S YOU â€” artistï¼ˆæ•´åˆç‰ˆï¼‰</title>

<style>
:root{
  /* æ—¢æœ‰è¨­è¨ˆç³»çµ± */
  --bg:#f5f7ff; --card:#fff; --text:#1a1a1a; --sub:#667085; --line:#e7eaf3; --ghost:#9aa0b4;
  --hover:#fff;
  --accent:#6a5acd; --accent2:#836fff; --ok:#10b981; --danger:#ff4d4f;
  --radius:16px; --shadow:0 12px 34px rgba(18,24,40,.08);
  --safe:env(safe-area-inset-bottom,0px);
  --kb-offset:0px;
  --footer-h:96px;
  --hud-h:68px;
  --reply-size:30px;
  --reply-gap:18px;

  /* Liquid Glass åŸºåº• */
  --glass-blur:14px;
  --glass-bg:rgba(255,255,255,.16);
  --glass-bg-2:rgba(255,255,255,.10);
  --glass-stroke:rgba(255,255,255,.28);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
img{display:block;max-width:100%}
a{text-decoration:none;color:inherit}
button{font:inherit;cursor:pointer}

.ghost{color:var(--ghost)}
.sub{color:var(--sub)}
.soft{padding:16px}
.row{display:flex;align-items:center;gap:10px}

/* ========== å¡ç‰‡/æ™¶ç‰‡ â†’ æ¶²æ…‹ç»ç’ƒ ========== */
.card{
  background:linear-gradient(180deg,var(--glass-bg),var(--glass-bg-2));
  border:1px solid var(--glass-stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter:saturate(160%) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(160%) blur(var(--glass-blur));
}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;
  background:linear-gradient(180deg,rgba(255,255,255,.24),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}

/* ========== Pages ========== */
section.page{display:none;padding:12px 12px calc(76px + var(--safe));min-height:100svh}
section.page.active{display:block;animation:fade .22s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
/* ç•¶åº•éƒ¨ nav è¢«è—èµ·ä¾†æ™‚ï¼Œæ”¶æ–‚åº•éƒ¨ paddingï¼ˆé¿å…ç©ºç™½ï¼‰ */
body.nav-hidden section.page{padding-bottom:12px}

/* ========== Bottom Nav â†’ æ¶²æ…‹ç»ç’ƒ ========== */
nav#nav{
  position:fixed;left:0;right:0;bottom:0;z-index:40;
  display:flex;justify-content:space-around;gap:6px;
  padding:10px 8px calc(12px + var(--safe));
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.08));
  border-top:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(160%) blur(var(--glass-blur));
  transition:transform .25s ease;
}
nav#nav.hidden{transform:translateY(120%)}
nav#nav button{flex:1;border:none;background:transparent;padding:8px 0 6px;border-radius:12px;color:var(--sub);font-weight:900;font-size:13px}
nav#nav button.active{
  color:var(--accent);
  background:linear-gradient(180deg,rgba(255,255,255,.28),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
}

/* ========== Verified å‹³ç«  ========== */
.verified-badge{display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle}
.verified-badge svg{width:100%;height:100%;display:block}
.verified-badge .gear{stroke:#fff;stroke-width:.9;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
.verified-badge .tick{fill:#fff;filter:drop-shadow(0 1px 0 rgba(0,0,0,.18))}

/* ========== Story barï¼ˆé¦–é ï¼‰ ========== */
#storyWrap{
  position:sticky;top:0;z-index:5;
  background:linear-gradient(180deg,rgba(245,247,255,.96),rgba(245,247,255,.90));
  backdrop-filter:blur(6px)
}
#storyBar{display:flex;gap:12px;overflow-x:auto;padding:10px 8px 12px;border-bottom:1px solid var(--line);scrollbar-width:none}
#storyBar::-webkit-scrollbar{display:none}
.story-item{flex:0 0 auto;width:64px;text-align:center;cursor:pointer;position:relative}
.story-item img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #d5d8f3;margin:0 auto}
.story-item .name{font-size:12px;margin-top:4px;color:#9aa1ad}
.story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18)}
.story-item.active .name{color:var(--accent);font-weight:700}
.story-item .dot{position:absolute;right:6px;top:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;box-shadow:0 0 0 2px #fff}
.story-item.pinned img{border-color:#111}

/* ========== è²¼æ–‡å‹•ä½œåˆ— + è©•è«–åˆ— ========== */
.post .actions{margin-top:10px;padding-top:10px;border-top:1px dashed #e1e4f0}
.reacts{display:flex;gap:8px;flex-wrap:wrap}
.react{
  display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:800;color:#35407a;
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
}
.react .num{opacity:.9}
.react.active{
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#fff;border-color:transparent;
  box-shadow:0 6px 18px rgba(123,109,255,.30);
}
.commentBar{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
.commentBar .left{display:flex;align-items:center;gap:12px;color:#6b7287;font-weight:800}
.commentBar .right button{border:none;background:transparent;color:#5b6ab0;font-weight:900}

/* ========== Home æŠ¬é ­ï¼ˆç¤¾ç¾¤ï¼‰ ========== */
.homeTop{display:flex;align-items:center;justify-content:flex-start;padding:8px 12px 4px}
.homeTitle{font-weight:900;letter-spacing:.6px;font-size:22px;line-height:1}

/* ========== Post å¡çµæ§‹ ========== */
.post{margin:12px 6px}
.post .hdr{display:flex;align-items:center;gap:10px}
.post .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.post .meta b{font-weight:900;display:flex;align-items:center;gap:6px}
.post .meta small{display:block;color:var(--ghost)}
.post .body{margin-top:8px}
.post .hero{width:100%;height:360px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.35)}

/* ========== DM åˆ—è¡¨å¡ â†’ æ¶²æ…‹ç»ç’ƒ ========== */
#dm .dmCard{
  display:flex;align-items:center;gap:12px;padding:12px;margin:10px 0;cursor:pointer;border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}
#dm .dmCard img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
.nameBlock{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0}
.nameRow{display:flex;align-items:center;gap:8px;min-width:0}
.nameRow .stage{font-weight:900;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dmPreview{display:block;color:var(--ghost);max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.artistTag{display:inline-flex;align-items:center;justify-content:center;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;color:#2e2a6f;background:linear-gradient(90deg,#bca7ff 0%,#8fb4ff 64%,#ffffff 100%);border:1px solid #ded6ff;box-shadow:0 1px 6px rgba(106,90,205,.18)}

/* ========== DM Detailï¼ˆèƒŒæ™¯ + é®ç½©ï¼‰ ========== */
#dmDetail{position:relative;background-color:var(--bg);background-position:center;background-repeat:no-repeat;background-size:cover;background-attachment:scroll;}
#dmDetail::after{content:"";position:fixed;inset:0;pointer-events:none;background:rgba(0,0,0,var(--bgDim,.0));backdrop-filter:blur(var(--bgBlur,0px));z-index:-1}

/* ========== DM HUD ========== */
.chatHUD{display:flex;align-items:center;justify-content:space-between;padding:4px 0 8px}
.back,.hudBtn{width:44px;height:44px;border:none;background:transparent;display:grid;place-items:center}
.back svg{width:22px;height:22px;stroke:#5b6ab0;stroke-width:2.6;fill:none}
.hudBtn{color:#fff;mix-blend-mode:difference;text-shadow:0 0 1px rgba(0,0,0,.65),0 0 8px rgba(0,0,0,.25)}
.chatHUD .center{flex:1;min-width:0;display:flex;justify-content:center}
.artistName{font-weight:900;letter-spacing:.6px;font-size:18px}

/* ========== Thread ä½ˆå±€ ========== */
.thread{position:absolute;left:0;right:0;top:var(--hud-h);bottom:0;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;padding:8px 2px;scrollbar-gutter:stable both-edges}
.thread .msg + .msg{margin-top:12px}
#threadPad{height:calc(var(--footer-h) + var(--kb-offset) + env(safe-area-inset-bottom,0px) + 2px);flex:0 0 auto;pointer-events:none}
#endAnchor{height:1px;flex:0 0 auto}

/* ========== æ°£æ³¡ & ä½ç½®ï¼ˆå·¦ç™½ã€ç¿»è­¯ç»ç’ƒã€å³å“ç‰Œï¼‰ ========== */
:root{ --bubble-px:10px; --bubble-py:7px; --bubble-r:13px; --msg-max:78%; }
.msg{display:flex;align-items:flex-end;gap:6px;max-width:var(--msg-max);margin:0 6px}
.msg.left{flex-direction:row;align-self:flex-start}
.msg.right{flex-direction:row-reverse;align-self:flex-end}
.time{font-size:11px;color:rgba(255,255,255,.88);text-shadow:0 1px 2px rgba(0,0,0,.35);white-space:nowrap}
.time.dark{color:#8b93a7;white-space:nowrap}

/* åŸºæœ¬æ³¡æ³¡å¤–å‹ï¼ˆèƒŒæ™¯äº¤ç”±å·¦å³ï¼æ¨¡å¼æ±ºå®šï¼‰ */
.bubble{
  max-width:100%;
  padding:var(--bubble-py) var(--bubble-px);
  border-radius:var(--bubble-r);
  border:1px solid transparent;
  position:relative;
}

/* å·¦å´ï¼šé è¨­ï¼ç´”ç™½ï¼ˆéåª’é«”ã€éèªéŸ³ï¼‰ */
.msg.left .bubble:not(.mediaWrap):not(.voice){
  background:#fff;
  border-color:#e5e7f2;
  color:#111;
  backdrop-filter:none;
  -webkit-backdrop-filter:none;
}

/* å·¦å´ï¼šç¿»è­¯æ¨¡å¼ï¼ç»ç’ƒï¼ˆæ³¡æ³¡ä¸­å‡ºç¾ .transDivider å³è¦–ç‚ºç¿»è­¯ç‰ˆï¼‰ */
.msg.left .bubble:has(.transDivider){
  background:linear-gradient(180deg,rgba(255,255,255,.26),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  color:#111;
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.8));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.8));
}

/* å³å´ï¼šå“ç‰Œæ¼¸å±¤ */
.msg.right .bubble{
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#fff;border-color:transparent;
  box-shadow:0 6px 18px rgba(106,90,205,.28);
}

/* FROM FANï¼ˆæ³¡æ³¡å…§ï¼‰æ”¹é»‘è‰²ï¼›ä¸å½±éŸ¿ replyCard çš„ FROM FAN */
.msg .bubble .fromLabel{font-size:11px;font-weight:900;color:#111;margin-bottom:4px}
.fanText{color:#111}

/* DM å³ä¸Šè§’é¸å–®ï¼ˆæµ®å±¤ï¼‰â†’ ç»ç’ƒ */
#dmMenu{
  position:absolute;top:52px;right:8px;z-index:60;padding:8px;border-radius:12px;
  background:linear-gradient(180deg,rgba(255,255,255,.26),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  box-shadow:var(--shadow);
  backdrop-filter:saturate(160%) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(160%) blur(var(--glass-blur));
}
#dmMenu .chip{width:100%;justify-content:flex-start}

/* ç¿»è­¯ UI */
.bubble .translate-in{
  display:inline-flex;align-items:center;gap:6px;margin-top:8px;font-size:12px;padding:4px 10px;
  border-radius:999px;border:1px solid #e3e6ef;background:#f1f3f6;color:#6f7a94;cursor:pointer;user-select:none;
}
.bubble .translate-in svg{width:14px;height:14px;opacity:.7}
.bubble .transDivider{height:1px;background:#e3e6ef;margin:8px 0}
.bubble .by{margin-top:2px;font-size:10px;color:var(--ghost)}

/* å›è¦†å¡ â†’ ç»ç’ƒ */
.replyCard{
  align-self:flex-end;max-width:74%;margin:14px 6px 0;padding:10px 12px;border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.30),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  box-shadow:0 8px 18px rgba(0,0,0,.10);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.7));
}
.replyCard .fromLabel{font-size:11px;font-weight:900;letter-spacing:.3px;color:#6d78aa;margin-bottom:4px}
.thread .msg + .replyCard,.thread .replyCard + .msg{margin-top:12px}

/* å›è¦†ç®­é ­ï¼ˆä½¿ç”¨ transform æ¨å‡ºå»ï¼Œä¸ä½”ç‰ˆå¯¬ï¼‰ */
.replyBtn{
  position:absolute;top:50%;right:0;
  transform:translateY(-50%) translateX(calc(100% + var(--reply-gap)));
  width:var(--reply-size);height:var(--reply-size);border-radius:999px;
  border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.92);
  box-shadow:0 6px 14px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;z-index:2
}
.replyBtn svg{width:calc(var(--reply-size)*0.53);height:calc(var(--reply-size)*0.53);opacity:.85}

/* ========== DM Footerï¼ˆè¼¸å…¥å€ï¼‰â†’ ç»ç’ƒ ========== */
.dmFooter{
  position:fixed;left:0;right:0;
  bottom:max(env(safe-area-inset-bottom,0px),var(--kb-offset));
  z-index:50;
  padding:6px 0 calc(8px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg,rgba(255,255,255,.20),rgba(255,255,255,.90));
  border-top:1px solid var(--glass-stroke);
  backdrop-filter:blur(var(--glass-blur));
  -webkit-backdrop-filter:blur(var(--glass-blur));
}
.dmInputBar{display:flex;align-items:center;gap:8px;padding:0 10px}
.iconBtn{width:30px;height:30px;border:none;background:transparent;display:grid;place-items:center;flex:0 0 auto;font-size:20px;line-height:1}
.dmInputBar .box{
  flex:1;min-width:0;display:flex;align-items:center;height:44px;padding:0 14px;border-radius:20px;
  background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
}
.dmInputBar input{flex:1;border:none;outline:none;background:transparent;font-size:16px}
.dmSend{width:30px;height:30px;border:none;background:transparent;color:#b2b7c8;display:grid;place-items:center}
.hasText .dmSend{color:#111}

/* ========== ç³»çµ±é€šçŸ¥ â†’ ç»ç’ƒè† å›Šï¼ˆå–®ä¸€ç‰ˆæœ¬ï¼‰ ========== */
.noticeBar{
  align-self:center;margin:8px 0;padding:6px 12px;border-radius:999px;
  font-size:12px;font-weight:900;letter-spacing:.3px;color:#2e2a6f;
  background:linear-gradient(180deg,rgba(255,255,255,.28),rgba(255,255,255,.12));
  border:1px solid var(--glass-stroke);
  backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
  -webkit-backdrop-filter:saturate(160%) blur(calc(var(--glass-blur)*.6));
}
/* é‡˜åœ¨è¼¸å…¥åˆ—ä¸Šæ–¹ï¼šç•¶ noticeBar æ”¾åœ¨ .dmFooter å…§æ™‚ï¼Œå›ºå®šåœ¨å…¶ä¸Šç·£ */
.dmFooter .noticeBar{
  position:absolute;left:50%;transform:translateX(-50%);
  top:-40px;margin:0;pointer-events:none;
}

/* ========== åª’é«”ï¼ˆåœ–ç‰‡/å½±ç‰‡ï¼‰å°ºå¯¸ä¸€è‡´ã€è„«é›¢æ³¡æ³¡ ========== */
.msg .bubble.mediaWrap{background:transparent!important;border:none!important;padding:0;border-radius:0;color:inherit}
.msg.right .bubble.mediaWrap{background:transparent!important;border:none!important}
.msgImg,.msgVideo{
  display:block;width:min(66vw,300px);height:auto;border-radius:12px;border:1px solid rgba(0,0,0,.08);overflow:hidden;
}

/* ========== èªéŸ³æ³¡æ³¡ï¼ˆå·¦ç»ç’ƒï¼å³å“ç‰Œï¼‰ ========== */
.bubble.voice{
  border-radius:18px;border:1px solid var(--glass-stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.26),rgba(255,255,255,.12));
}
.msg.right .bubble.voice{background:linear-gradient(180deg,var(--accent),var(--accent2));border-color:transparent;color:#fff}
.voiceUI{display:flex;align-items:center;gap:10px;min-width:140px}
.voicePlay{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08);color:#2b356f}
.msg.right .voicePlay{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.28);color:#fff}
.voicePlay svg{width:16px;height:16px;fill:currentColor}
.voiceBars{display:none!important}
.voiceDur{margin-left:6px;font-variant-numeric:tabular-nums;min-width:46px;text-align:right;font-weight:800;opacity:.9}
.msg.right .voiceDur{color:#fff}

/* Reply Chip */
.replyChip{position:relative;display:flex;align-items:center;gap:8px;margin:0 14px 8px;padding:8px 36px 8px 12px;border-radius:13px;border:1px solid rgba(255,255,255,.28);background:rgba(255,255,255,.12);backdrop-filter:saturate(140%) blur(1.5px)}
.replyChipLabel{font-size:12px;font-weight:900;letter-spacing:.35px;color:#7a86b7;margin-right:2px;user-select:none}
.replyChipText{flex:1;min-width:0;font-size:15px;line-height:1.25;font-weight:600;color:#2f3564;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.replyChipClose{position:absolute;top:6px;right:6px;width:28px;height:28px;display:grid;place-items:center;border:none;background:transparent;color:#6f78aa;border-radius:6px;cursor:pointer}
.replyChipClose:hover{background:rgba(255,255,255,.10)}
.replyChipClose svg{width:18px;height:18px;display:block}

/* ========== Modal é¢æ¿ â†’ ç»ç’ƒ ========== */
.modal{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
.modal .panel{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(760px,94vw);
  background:linear-gradient(180deg,rgba(255,255,255,.30),rgba(255,255,255,.14));
  border:1px solid var(--glass-stroke);border-radius:18px;padding:14px;box-shadow:var(--shadow);
  backdrop-filter:saturate(160%) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(160%) blur(var(--glass-blur));
}

/* ===== è£åˆ‡èƒŒæ™¯ ===== */
#cropStage{position:relative;height:58vh;border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#f8f9ff;touch-action:none}
#cropStage img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:none;user-select:none;touch-action:none;transform-origin:center center;will-change:transform}
.cropCtrls{display:flex;align-items:center;gap:10px;margin:12px 0;flex-wrap:wrap}
.cropCtrls .spacer{flex:1}
.scaleRow{display:flex;align-items:center;gap:10px}
#scaleLabel{min-width:48px;text-align:right;color:#6b7280;font-weight:800}
#cropScale{-webkit-appearance:none;appearance:none;width:clamp(160px,36vw,280px);height:4px;border-radius:999px;outline:none;background:linear-gradient(90deg,var(--accent) var(--scaleFill,50%), #e1e4f0 0)}
#cropScale::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:1.5px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.15)}

/* ä¿®å‰ªè¦–çª— */
.trimBox{display:flex;flex-direction:column;gap:10px}
.trimRow{display:flex;align-items:center;gap:10px}
.range{flex:1}
.tip{color:#667085;font-size:14px}
.btnRow{display:flex;gap:10px;justify-content:flex-end}
.btnPrimary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border:none}
.btn{padding:6px 14px;border-radius:999px;border:1px solid var(--line);background:#fff}
.btnMini{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900}

/* æ—¥æœŸ/æœªè®€åˆ†éš” */
.dayDivider{align-self:center;margin:10px 0;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.15);color:#fff;font-size:12px;font-weight:900;letter-spacing:.3px;backdrop-filter:blur(3px)}
.unreadLine{align-self:center;margin:8px 0;padding:6px 12px;border-radius:8px;background:rgba(106,90,205,.18);color:#2e2a6f;font-size:12px;font-weight:900;border:1px solid rgba(106,90,205,.35)}

/* å°å·¥å…· */
.badge{background:#ff3b30;color:#fff;font-size:12px;padding:2px 7px;border-radius:999px;min-width:22px;text-align:center}

/* å…¨è¢å¹•åª’é«”æª¢è¦–å™¨ */
#viewer{position:fixed;inset:0;z-index:90;display:none;background:rgba(0,0,0,.9)}
#viewer .stage{position:absolute;inset:0;display:grid;place-items:center}
#viewerImg,#viewerVideo{max-width:94vw;max-height:88vh;border-radius:12px}

/* A. ä¿åº•ï¼šé—œæ‰æ©«å‘æ»¾å‹• */
#dmDetail, .thread { overflow-x: hidden; touch-action: pan-y; }

/* ========== LIVEï¼ˆæ•´åˆï¼‰ ========== */
#live, #liveRoom { --live-hair: var(--line); }

/* 1) é ‚éƒ¨ HUDï¼šLIVE æ¨™ï¼‹æ„›å¿ƒæ•¸ */
#live .liveHUD, #liveRoom .liveHUD{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 4px 6px;
  background:linear-gradient(180deg, rgba(245,247,255,.75), rgba(245,247,255,0));
}
#live .liveTag, #liveRoom .liveTag{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:999px;
  background:#ff2e2e; color:#fff; font-weight:900; font-size:12px;
  box-shadow:0 6px 20px rgba(255,46,46,.25);
  animation:blink 1.1s infinite;
}
#live .liveTag::after, #liveRoom .liveTag::after{ content:"â—"; font-size:10px }
@keyframes blink{0%,55%{opacity:1}56%,100%{opacity:.35}}
#live .liveHearts, #liveRoom .liveHearts{ font-weight:900; color:#333; }

/* 2) èˆå°ï¼ˆå¯é¸ï¼Œä¿ç•™ä½ çš„éœ€æ±‚ï¼‰ */
#live .liveStage{
  position:relative; height:44vh; min-height:300px;
  border:1px solid var(--live-hair); border-radius:18px;
  background:linear-gradient(180deg,#0f1c3a,#18224b);
  box-shadow:0 10px 28px rgba(0,0,0,.12) inset;
}

/* 3) èŠå¤©ä¸²ï¼ˆç²‰çµ²ç«¯è¦–è¦ºï¼‰ */
#live .liveThread, #liveRoom .liveThread{
  display:flex; flex-direction:column; gap:8px;
  height:calc(100vh - 280px);
  overflow-y:auto; padding:12px;
  border:1px solid var(--live-hair); border-radius:16px;
  background: radial-gradient(140% 120% at 0% 0%, #0e1630, #0b0f1f 60%, #0a0d18);
}
#live #liveChat > div,
#liveRoom #liveChat > div,
#live .liveThread   > div.msg,
#liveRoom .liveThread > div.msg{
  max-width:72%; align-self:flex-end;
  padding:10px 12px; border-radius:14px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#fff; box-shadow:var(--shadow); border:1px solid transparent;
}
#live #liveChat > div.host, #liveRoom #liveChat > div.host{
  align-self:flex-start; background:var(--artist); color:inherit; border:1px solid var(--live-hair);
}
#live #liveChat > div.fan, #liveRoom #liveChat > div.fan{ align-self:flex-end; }
#live #liveChat > div.welcome, #liveRoom #liveChat > div.welcome{ align-self:center; background:#ffeaa7; color:#111; }

/* åç¨± / æ™‚é–“æˆ³ */
#live #liveChat .name, #liveRoom #liveChat .name{ font-size:11px; color:#c8d1ff; font-weight:900; letter-spacing:.35px; }
#live #liveChat .time, #liveRoom #liveChat .time{ display:block; margin-top:2px; font-size:11px; color:#cfd3e1; text-align:right; }
#live #liveChat .host .time, #liveRoom #liveChat .host .time{ color:#b8c2db }

/* 4) è¼¸å…¥åˆ—ï¼ˆå«æ„›å¿ƒéµï¼‰ */
#live .liveInputBar, #liveRoom .liveInputBar{
  display:flex; gap:8px; padding:10px 0; border-top:1px solid var(--live-hair);
  position:sticky; bottom:0;
  background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95));
  backdrop-filter:blur(10px);
}
#live .liveInputBar input, #liveRoom .liveInputBar input{
  flex:1; border:1px solid var(--live-hair); padding:12px; border-radius:14px; background:var(--hover);
}
#live .liveInputBar button, #liveRoom .liveInputBar button{ min-width:60px; border:none; border-radius:12px; font-weight:900; cursor:pointer; }
#live #liveHeartBtn, #liveRoom #liveHeartBtn{
  min-width:44px; height:44px; border-radius:12px; border:1px solid var(--live-hair);
  background:linear-gradient(180deg,#ffb3d9,#ffc9f1);
}
#live #liveHeartBtn:active, #liveRoom #liveHeartBtn:active{ transform:scale(.96) }

/* 5) é£›å¿ƒå‹•ç•« */
#live .flying-heart, #liveRoom .flying-heart{ position:fixed; z-index:50; font-size:18px; pointer-events:none; animation:floatUp 1.1s ease forwards; }
@keyframes floatUp{ 0%{ opacity:0; transform:translateY(10px) scale(.9) } 10%{ opacity:1 } 100%{ opacity:0; transform:translateY(-120px) scale(1.6) } }

/* 6) æš«é›¢é®ç½© */
#live .pausedMask{ position:absolute; inset:0; display:none; place-items:center; z-index:2; border-radius:inherit; background:rgba(0,0,0,.42); color:#fff; font-weight:900; text-shadow:0 2px 12px rgba(0,0,0,.35); backdrop-filter:blur(2px); }

/* 7) ç›´æ’­çµæŸè¦†è“‹ç•«é¢ */
#live .liveEndedScene, #liveRoom .liveEndedScene{ position:fixed; inset:0; z-index:60; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; }
#live .liveEndedScene img, #liveRoom .liveEndedScene img{ width:120px; height:120px; border-radius:50%; border:2px solid #fff; object-fit:cover; }

/* 8) ä¸»æŒ‰éˆ•æ¨£å¼ */
#live .btnPrimary, #liveRoom .btnPrimary{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border:1px solid transparent; box-shadow:0 6px 18px rgba(106,90,205,.25); }

/* 9) LIVE å¡ç‰‡é‚Šæ¡† */
#live .card{ border-color: rgba(231,234,243,.6); }

/* --- å…¼å®¹ä½ ç¾æœ‰çš„ LIVE ç´”æ–‡å­—çµæ§‹ (.liveStage + .chatList + .liveMsg) --- */
#live .chatList{ position:absolute; inset:0; padding:14px 12px; display:flex; flex-direction:column; gap:10px; overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; scrollbar-width:none; }
#live .chatList::-webkit-scrollbar{ display:none }
#live .liveMsg{ max-width:78%; display:flex; flex-direction:column; gap:4px }
#live .liveMsg.artist{ align-self:flex-end }
#live .liveMsg.fan{ align-self:flex-start }
#live .liveMsg .name{ font-size:11px; color:#c8d1ff; font-weight:900; letter-spacing:.35px; }
#live .liveMsg .bubble{ padding:10px 12px; border-radius:14px; background:#fff; color:#111; border:1px solid #e5e7f2; box-shadow:0 4px 10px rgba(0,0,0,.08); }
#live .liveMsg.artist .bubble{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(106,90,205,.25); }
#live .liveMsg .time{ font-size:11px; color:#aebbe9; align-self:flex-end }
#live .liveMsg.fan .time{ color:#b8c2db }

/* ä½ çš„ .liveInput ä¹Ÿè£œé½Šï¼ˆæ²¿ç”¨æ–°é¢¨æ ¼ï¼‰ */
#live .liveInput{ display:flex; gap:8px; align-items:center; margin-top:12px; position:sticky; bottom:0; padding-top:8px; background:linear-gradient(180deg,rgba(255,255,255,.3),rgba(255,255,255,.95)); backdrop-filter:blur(10px); border-top:1px solid var(--line); }
#live .liveInput input{ flex:1; height:44px; padding:0 12px; background:#fff; border:1px solid var(--line); border-radius:14px; }
#live .liveInput .chip{ min-height:44px }

/* ===== FABï¼šåœ“å½¢ãƒ»é«˜é€æ¶²æ…‹ç»ç’ƒ ===== */
.fabNew{
  position: fixed;
  right: 16px;
  bottom: calc(88px + var(--safe));
  width: 64px; height: 64px;
  border-radius: 50%;

  /* é«˜é€ + æ¨¡ç³Šï¼ˆæ ¸å¿ƒï¼‰ */
  background: linear-gradient(180deg, rgba(255,255,255,.42), rgba(255,255,255,.12));
  border: 1px solid rgba(255,255,255,.55);
  backdrop-filter: saturate(180%) blur(14px);
  -webkit-backdrop-filter: saturate(180%) blur(14px);

  /* ç«‹é«”æ„Ÿï¼ˆå…§å¤–é™°å½± + é«˜å…‰ï¼‰ */
  box-shadow:
    0 1px 0 rgba(255,255,255,.70) inset,   /* ä¸Šç·£é«˜å…‰ */
    0 -8px 20px rgba(0,0,0,.10) inset,     /* å…§é™°å½± */
    0 10px 28px rgba(17,23,41,.18);        /* å¤–æ“´æ•£é™°å½± */

  display: grid; place-items: center;
  font-size: 28px; font-weight: 900; line-height: 1;

  /* åŠ è™Ÿç”¨å“ç‰Œè‰²ï¼Œå°æ¯”æ¸…æ¥š */
  color: var(--accent);
  cursor: pointer; z-index: 45;
  -webkit-tap-highlight-color: transparent;
}
.fabNew::before{
  /* ç»ç’ƒä¸Šçš„äº®æ–‘ï¼ˆä¸å½±éŸ¿é»æ“Šï¼‰ */
  content:""; position:absolute; inset:1px; border-radius:50%;
  background: radial-gradient(130% 80% at 28% 22%, rgba(255,255,255,.75), rgba(255,255,255,0) 62%);
  pointer-events:none; mix-blend-mode:soft-light;
}
.fabNew:active{ transform: scale(.98); box-shadow:
  0 1px 0 rgba(255,255,255,.70) inset,
  0 -6px 16px rgba(0,0,0,.10) inset,
  0 6px 18px rgba(17,23,41,.20);
}

/* ç„¡ backdrop-filter çš„é™ç´šï¼šçµ¦ä¸€å€‹æ¯”è¼ƒå¯¦çš„ç™½åº• */
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))){
  .fabNew{ background: rgba(255,255,255,.9); }
}
/* Page Title */
.pageTitle{ padding:8px 12px 4px; font-weight:900; letter-spacing:.6px; font-size:22px; line-height:1; }
/* ç¿»è­¯æŒ‰éˆ•æ“ºé ­åƒåˆ—å³ä¸Š */
.post .hdr{ position:relative; }
.translate-btn{
  position:absolute; right:0; top:0;
  padding:4px 10px; font-size:12px; line-height:1;
}
</style>
</head>
  <body>

<!-- ====================== HOME ====================== -->
 <section id="home" class="page active">
  <!-- é é¢æŠ¬é ­ï¼ˆç¤¾ç¾¤ï¼‰ -->
  <div class="homeTop">
    <div class="homeTitle">ç¤¾ç¾¤</div>
  </div>
   
  <!-- Story bar -->
  <div id="storyWrap">
    <div id="storyBar"></div>
  </div>

  <!-- å‹•æ…‹ç‰† -->
  <div id="feedWrap" style="padding:0 6px 12px"></div>

  <!-- ç™¼æ–‡ FABï¼ˆå°æ‡‰ä½ æ—¢æœ‰çš„ #fabNew ç›£è½ï¼‰ -->
  <button id="fabNew" aria-label="æ–°å¢è²¼æ–‡" class="fabNew" title="æ–°å¢è²¼æ–‡">
  <svg class="fabPlus" viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
  </svg>
</button>
</section>
    
<!-- ====================== DM LIST ====================== -->
<section id="dm" class="page">
  <div class="pageTitle">DM</div>
  <div id="dmList"></div>
</section>

<!-- ====================== DM DETAIL ====================== -->
<section id="dmDetail" class="page">
  <div class="chatHUD" id="dmHUD">
    <button class="back" onclick="goBack()" aria-label="Back"><svg viewBox="0 0 24 24"><path d="M15 19 8 12l7-7"/></svg></button>
    <div class="center"><b id="dmTitle" class="artistName">ANNIE</b></div>
    <button class="hudBtn" title="æ›´å¤š" onclick="toggleDmMenu()">â‹¯</button>
  </div>

  <div id="dmThread" class="thread"></div>
  
  <!-- Footer -->
    <div class="dmFooter" id="dmFooter">
    <div id="replyChip" class="replyChip" style="display:none">
      <span class="replyChipLabel">å›è¦†ï¼š</span>
      <span id="replyChipText" class="replyChipText">â€”</span>
      <button class="replyChipClose" onclick="clearReply()"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg></button>
    </div>

    <div class="dmInputBar">
      <button class="iconBtn" id="btnCamera" aria-label="ç›¸æ©Ÿ/ç›¸ç°¿"><span class="camEmoji">ğŸ“¸</span></button>
      <div class="box"><input id="dmMessageInput" placeholder="è«‹å‘¼å«ç²‰çµ²æš±ç¨± @@@ " /></div>
      <button class="iconBtn" id="btnMic" aria-label="èªéŸ³"><span class="micEmoji">ğŸ™ï¸</span></button>
      <button class="dmSend" id="dmSendBtn" aria-label="Send" disabled>
        <svg viewBox="0 0 24 24"><path d="M3.4 12.6l16.7-7.2c.6-.3 1.2.3.9.9l-7.2 16.7c-.3.7-1.3.6-1.5-.1l-2.1-6.1-6.1-2.1c-.7-.2-.8-1.2-.1-1.5z" fill="currentColor"/></svg>
      </button>

      <input id="pickMedia" type="file" accept="image/*,video/*" multiple style="display:none">
      <input id="pickVoice" type="file" accept="audio/*,video/*" style="display:none">
    </div>
  </div>

  <!-- å³ä¸Š â€¦ é¸å–® -->
  <div id="dmMenu" class="card soft" style="display:none">
    <div class="row" style="flex-direction:column;gap:6px">
      <button class="chip" onclick="renameChat(); hideDmMenu()">æ›´æ”¹èŠå¤©å®¤åç¨±</button>
      <button class="chip" onclick="startPickBg(); hideDmMenu()">æ›´æ”¹èƒŒæ™¯</button>
    </div>
  </div>
</section>

<!-- ====================== STORE = Profile ====================== -->
<section id="store" class="page">
  <div id="homeHeader" style="display:block;margin:6px 6px 10px">
    <div class="me" style="display:flex;align-items:center;gap:10px">
      <img id="meAvatar" src="https://picsum.photos/80?u=artist" onerror="imgFallback(this)" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)">
      <div>
        <div id="meNickname" style="font-weight:900">Annie</div>
        <div class="id" id="meId" style="font-size:12px;color:var(--ghost)">ARTIST-00001</div>
      </div>
    </div>
    <button class="chip" id="btnEditNick" style="margin-left:auto;display:inline-flex">âœï¸ æ›´æ”¹æˆ‘çš„æš±ç¨±</button>
  </div>
</section>

<!-- ====================== èƒŒæ™¯ï¼šæŒ‘åœ– / è£åˆ‡ / é è¦½ ====================== -->
<input id="bgChooser" type="file" accept="image/*" style="display:none">
<div id="cropModal" class="modal"><div class="panel">
  <b style="font-weight:900">è£åˆ‡èƒŒæ™¯</b>
  <div id="cropStage"><img id="cropImg" alt=""></div>
  <div class="cropCtrls">
  <button class="btnMini" id="btnRotate">â†» æ—‹è½‰</button>
  <div class="spacer"></div>
  <div class="scaleRow">
    <button class="btnMini" id="zoomOut">ï¼</button>
    <input id="cropScale" type="range" min="50" max="250" value="100">
    <button class="btnMini" id="zoomIn">ï¼‹</button>
    <span id="scaleLabel">100%</span>
  </div>
  <div class="spacer"></div>
  <!-- è£åˆ‡èƒŒæ™¯ modal è£¡ -->
<!-- è£åˆ‡èƒŒæ™¯ modal è£¡ -->
<button class="chip" onclick="rePickBg()">è¿”å›é¸åœ–ç‰‡</button>
  <button class="chip btnPrimary" onclick="applyCrop()">ä¸‹ä¸€æ­¥</button>
</div>
</div></div>

<div id="previewModal" class="modal"><div class="panel">
  <b style="font-weight:900">é è¦½èƒŒæ™¯</b>
  <div style="height:48vh;border:1px dashed var(--line);border-radius:12px;overflow:hidden;background:#000">
    <div id="bgPreviewMini" style="height:100%;background-position:center;background-size:cover;background-repeat:no-repeat"></div>
  </div>
  <div class="cropCtrls" style="justify-content:flex-end">
    <!-- é è¦½èƒŒæ™¯ modal è£¡ -->
<button class="chip" onclick="backToCrop()">è¿”å›</button>
    <button class="chip btnPrimary" onclick="confirmPreview()">ç¢ºèª</button>
  </div>
</div></div>

<!-- ====================== èªéŸ³ä¿®å‰ªï¼ˆå¯è©¦è½ï¼‰ ====================== -->
<div id="trimModal" class="modal"><div class="panel">
  <b style="font-weight:900">ä¿®å‰ªèªéŸ³ï¼ˆå¯è©¦è½ï¼‰</b>
  <div class="trimBox">
    <video id="trimMedia" playsinline style="display:none"></video>
    <div class="trimRow">
      <button class="btn" id="trimPlay">â–¶ï¸ æ’­æ”¾</button>
      <div class="vBar" style="flex:1"><div id="trimFill" class="vFill" style="background:#6a5acd;height:6px;border-radius:999px;width:0%"></div></div>
      <div id="trimClock" class="vTime">0:00</div>
    </div>
    <div class="trimRow">
      <span class="ghost" style="width:36px">èµ·é»</span>
      <input id="trimStart" class="range" type="range" min="0" max="1000" value="0">
      <span id="trimStartLabel" class="ghost">0.0s</span>
    </div>
    <div class="trimRow">
      <span class="ghost" style="width:36px">çµ‚é»</span>
      <input id="trimEnd" class="range" type="range" min="0" max="1000" value="1000">
      <span id="trimEndLabel" class="ghost">0.0s</span>
    </div>
    <div class="tip">æç¤ºï¼šæ’­æ”¾æ™‚æœƒè‡ªå‹•å¾ã€Œèµ·é»ã€é–‹å§‹ï¼Œè·‘åˆ°ã€Œçµ‚é»ã€å°±åœæ­¢ã€‚</div>
    <div class="btnRow">
      <button class="btn" onclick="closeTrim()">å–æ¶ˆ</button>
      <button class="btn btnPrimary" id="trimUse">ä½¿ç”¨é€™æ®µ</button>
    </div>
  </div>
</div></div>

<!-- ====================== LIVEï¼ˆç´”æ–‡å­—ç‰ˆï¼‰ ====================== -->
 <section id="live" class="page">
  <div class="pageTitle">ç›´æ’­</div>
   
  <div id="liveHUD" class="liveHUD" style="display:none">
    <span class="liveTag">LIVE</span>
    <span class="liveHearts">ğŸ’— <span id="liveHeartCount">0</span></span>
  </div>

  <!-- æ–°ï¼šå’Œç²‰çµ²ç«¯åŒä¸€å¥— liveThread / msg æ°£æ³¡ -->
  <div id="liveChat" class="liveThread">
    <div class="msg welcome">å°šæœªé–‹å§‹ç›´æ’­</div>
  </div>

 <div id="livePaused" class="pausedMask" style="display:none">ä¸»æŒäººæš«æ™‚é›¢é–‹ä¸­</div>
   
  <div class="liveInputBar">
    <button id="liveHeartBtn" title="é€æ„›å¿ƒ">ğŸ’—</button>
    <input id="liveInputBox" placeholder="è¼¸å…¥ç›´æ’­è¨Šæ¯â€¦" disabled />
    <button id="liveSend" class="chip btnPrimary" disabled>é€å‡º</button>
  </div>

  <div class="ctrlRow" style="margin-top:8px">
    <button id="liveStart" class="chip btnPrimary">é–‹å§‹</button>
    <div class="spacer"></div>
    <button id="livePause" class="chip" style="display:none">æš«æ™‚é›¢é–‹</button>
    <button id="liveEnd" class="chip danger" style="display:none">çµæŸç›´æ’­</button>
  </div>
</section>

<!-- ====================== Bottom Nav ====================== -->
<nav id="nav">
  <button id="tabHome" class="active" onclick="showPage('home')">é¦–é </button>
  <button id="tabDM" onclick="showPage('dm')">DM</button>
  <button id="tabLive" onclick="showPage('live')">ç›´æ’­</button>
  <button id="tabStore" onclick="showPage('store')">æˆ‘</button>
</nav>

<!-- å…¨è¢å¹•åª’é«”æª¢è¦–å™¨ -->
<div id="viewer">
  <div class="stage">
    <img id="viewerImg" alt="" style="display:none">
    <video id="viewerVideo" controls playsinline style="display:none"></video>
  </div>
  <button id="viewerClose" aria-label="close" style="
    position:fixed;right:14px;top:14px;z-index:95;border:none;border-radius:10px;
    background:rgba(255,255,255,.14);backdrop-filter:blur(6px);color:#fff;padding:6px 10px;">âœ•</button>
</div>
<script>
  
/* ===================== å·¥å…· ===================== */
function imgFallback(img){
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
  img.src = 'data:image/svg+xml;charset=UTF-8,' + svg; img.onerror = null;
}
const LS = {
  get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){ console.warn('localStorage full?', e); } },
  getStr(k,def=''){ const v=localStorage.getItem(k); return v ?? def },
  setStr(k,v){ try{ localStorage.setItem(k,v) }catch(e){ console.warn('localStorage full?', e); } }
};
const fmtTime = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const s2clock = s => { s = Math.max(0, s||0); const m = Math.floor(s/60), r = Math.floor(s%60); return `${m}:${r.toString().padStart(2,'0')}`; };
const mmss = sec => { sec = Math.max(0, Math.floor(sec || 0)); const m = Math.floor(sec/60), s = sec % 60; return `${m}:${s.toString().padStart(2,'0')}`; };
const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m]));

/* ===== IndexedDBï¼šåª’é«”å­˜é€™è£¡ ===== */
const MEDIA_DB = (()=> {
  const DB_NAME='nxu-media-db', STORE='media';
  let db=null; const urlCache=new Map();
  function open(){ return new Promise((res,rej)=>{
    if(db) return res(db);
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{ const d=e.target.result; if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE); };
    req.onsuccess=()=>{ db=req.result; res(db); };
    req.onerror=()=>rej(req.error);
  });}
  async function put(blob){ const d=await open(); return new Promise((res,rej)=>{
    const id='m'+Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    const tx=d.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(blob,id);
    tx.oncomplete=()=>res(id); tx.onerror=()=>rej(tx.error);
  });}
  async function getBlob(id){ const d=await open(); return new Promise((res,rej)=>{
    const tx=d.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(id);
    req.onsuccess=()=>res(req.result||null); req.onerror=()=>rej(req.error);
  });}
  async function getURL(id){ if(urlCache.has(id)) return urlCache.get(id);
    const p=(async ()=>{ const blob=await getBlob(id); return blob? URL.createObjectURL(blob) : ''; })();
    urlCache.set(id,p); return p;
  }
  return { put, getURL };
})();

/* åªå…è¨±åŒæ™‚æ’­æ”¾ä¸€æ¢ */
let ACTIVE_AUDIO = null;  function stopActive(){ if (ACTIVE_AUDIO){ ACTIVE_AUDIO.pause(); ACTIVE_AUDIO._owner?.classList.remove('playing'); ACTIVE_AUDIO = null; } }

// æ–°å¢ï¼šé›¢é–‹ DMï¼åˆ‡åˆ°èƒŒæ™¯ æ™‚ï¼Œçµ±ä¸€åœæ‰æ‰€æœ‰å¯èƒ½çš„æ’­æ”¾
function haltDmMedia(){
  // èªéŸ³æ³¡æ³¡ï¼ˆå–®ä¾‹æ§åˆ¶ï¼‰
  try{ stopActive(); }catch(_){}

  // DM å…§ä»»ä½• <audio>/<video>ï¼ˆåŒ…å«ä½ ç”¨ä¾†ç•¶èªéŸ³æ’­æ”¾å™¨çš„ <video>ï¼‰
  document.querySelectorAll('#dmThread audio, #dmThread video').forEach(m=>{
    try{ m.pause(); }catch(_){}
  });

  // ä¿®å‰ªè¦–çª—çš„è©¦è½
  const t = document.getElementById('trimMedia');
  if (t) { try{ t.pause(); }catch(_){} }

  // å…¨è¢å¹•æª¢è¦–å™¨
  const vv = document.getElementById('viewerVideo');
  if (vv) { try{ vv.pause(); }catch(_){} }
  closeViewer();
}
  
/* ===== å€‹äººè³‡æ–™ï¼å‡è³‡æ–™ ===== */
const STAGE_NAME = LS.getStr('artistStage','ANNIE');
let   NICKNAME   = LS.getStr('artistNickname','Annie');      // è‡ªå·±çœ‹åˆ°çš„æš±ç¨±
let   AVATAR     = LS.getStr('artistAvatar','https://picsum.photos/80?u=artist');
const ME = { id:'me', name:STAGE_NAME, avatar:AVATAR };

const ARTISTS = [
  {id:'me',name:STAGE_NAME,avatar:AVATAR},
  {id:'all',name:'ALL',avatar:'https://picsum.photos/80?u=all'},
  {id:'dohee',name:'DOHEE',avatar:'https://picsum.photos/80?u=dh'},
  {id:'woo',name:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc'}
];
const POSTS = LS.get('artistPosts',[
  {id:'p3',artistId:'dohee',artistStage:'DOHEE',avatar:'https://picsum.photos/80?u=dh',text:'ç·´èˆç·´åˆ°çˆ†æ±— ğŸ’ƒ',img:'https://picsum.photos/1200?u=dh1',ts:Date.now()-1000*60*40},
  {id:'p2',artistId:'woo',artistStage:'WOOCHAN',avatar:'https://picsum.photos/80?u=wc',text:'ä»Šå¤©åƒæ‹‰éºµ ğŸœ',img:'https://picsum.photos/1200?u=wc1',ts:Date.now()-1000*60*50},
  {id:'p1',artistId:'me',artistStage:STAGE_NAME,avatar:ME.avatar,text:'å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ Annie âœ¨',img:'',ts:Date.now()-1000*60*60}
]);
const FANS=[{id:'f1',name:'Michelle',avatar:'https://picsum.photos/40?u=f1'},{id:'f2',name:'ç²‰çµ² B',avatar:'https://picsum.photos/40?u=f2'}];

let GROUP_MSGS=LS.get('groupMsgs',[
  {id:'m1',from:'fan',fanId:'f1',text:'å¶åƒå¥½ï½',ts:Date.now()-1000*60*45},
  {id:'m2',from:'fan',fanId:'f2',text:'ä»Šå¤©åƒä»€éº¼ï¼Ÿ',ts:Date.now()-1000*60*43},
  {id:'m3',from:'artist',text:'æˆ‘åˆé¤åƒäº†æ²™æ‹‰ ğŸ¥—',ts:Date.now()-1000*60*40,replyTo:{text:'ä»Šå¤©åƒä»€éº¼ï¼Ÿ'}}
]);
const lastSeen = LS.get('lastSeen', {});

  // === Modal helpersï¼ˆopen/close + èˆŠåç›¸å®¹ï¼‰===
function openModal(id){ const m = document.getElementById(id); if(m) m.style.display='block'; }
function closeModal(id){ const m = document.getElementById(id); if(m) m.style.display='none'; }
function closeCrop(){ closeModal('cropModal'); }
function closePreview(){ closeModal('previewModal'); }

function dataURLtoBlob(dataURL){
  const [meta, b64] = dataURL.split(',');
  const mime = (meta.match(/data:(.*?);/)||[])[1] || 'image/jpeg';
  const bin = atob(b64);
  const len = bin.length;
  const u8  = new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
  return new Blob([u8], {type:mime});
}
  
/* ===================== å°èˆª ===================== */
const HIDE_NAV_IN = ['dmDetail','composerArtist'];
let PAGE_STACK = ['home'];

function syncNavVisibility(){
  const nav = document.getElementById('nav');
  const cur = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  const mustHide = HIDE_NAV_IN.includes(cur) || (cur === 'live' && LIVE_ON);
  nav.classList.toggle('hidden', mustHide);
  document.body.classList.toggle('nav-hidden', mustHide); // â† æ–°å¢ï¼šè®“ CSS èƒ½æ”¶æ‰åº•éƒ¨ padding
}  
function showPage(id){
  const prev = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  // ä¸Šä¸€é æ˜¯ dmDetailã€è€Œä¸”è¦åˆ‡å»åˆ¥é  â†’ åœæ‰ DM è£¡æ‰€æœ‰è²éŸ³/å½±ç‰‡
  if (prev === 'dmDetail' && id !== 'dmDetail') { haltDmMedia(); }

  const target = document.getElementById(id);
  if(!target){ console.warn('Page not found:', id); return; }
  document.querySelectorAll('section.page').forEach(s => s.classList.remove('active'));
  target.classList.add('active');
  if (PAGE_STACK[PAGE_STACK.length - 1] !== id) PAGE_STACK.push(id);

  document.querySelectorAll('#nav button').forEach(b => b.classList.remove('active'));
  ({home:'tabHome', dm:'tabDM', live:'tabLive', store:'tabStore'}[id]) &&
    document.getElementById({home:'tabHome', dm:'tabDM', live:'tabLive', store:'tabStore'}[id]).classList.add('active');

  syncNavVisibility();


  // 5) å„é é€²å ´æ™‚è¦åšçš„äº‹
  if (id === 'home') {
    renderStoryBar();
    renderFeed(currentFilter);
  }
  if (id === 'dm') {
    renderDmList();
  }
  if (id === 'dmDetail') {
    measureHUD();
    measureFooter();
    renderThread();
    applyChatBg();
    bindBottomObserver();
    bindScrollGuard();
    autoStick = true;
    scrollToEndDuring(800);
    setTimeout(hardStickBottom, 0);
    updateNoticeBanner();
  }
  if (id === 'composerArtist') {
    const who = document.getElementById('composerWho');
    if (who) who.textContent = NICKNAME;
  }
}

function goBack(){
  const from = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  // æ–°å¢ï¼šå¾ DM è©³ç´°é è¿”å›æ™‚ï¼Œå…ˆåœåª’é«”
  if (from === 'dmDetail') haltDmMedia();

  PAGE_STACK.pop();
  const prev = PAGE_STACK[PAGE_STACK.length - 1] || 'home';
  showPage(prev);
}

/* ===================== HOMEï¼šStory Bar / Feed ===================== */
let currentFilter='me';
function hasNewDots(artistId){
  if(artistId==='me'||artistId==='all') return false;
  const seen=lastSeen[artistId]||0;
  const latest=Math.max(0,...POSTS.filter(p=>p.artistId===artistId).map(p=>p.ts));
  return latest>seen;
}
function renderStoryBar(){
  const bar = document.getElementById('storyBar');
  if(!bar) return; // â† å®¹å™¨ä¸å­˜åœ¨å°±å…ˆè·³é

  const others=ARTISTS.filter(a=>a.id!=='me'&&a.id!=='all');
  others.sort((a,b)=>{
    const la=Math.max(0,...POSTS.filter(p=>p.artistId===a.id).map(p=>p.ts));
    const lb=Math.max(0,...POSTS.filter(p=>p.artistId===b.id).map(p=>p.ts));
    return lb-la;
  });
  const order=[ARTISTS.find(a=>a.id==='me'),ARTISTS.find(a=>a.id==='all'),...others];
  bar.innerHTML=order.map(a=>{
    const active=(currentFilter===a.id)?'active':'';
    const pinned=(a.id==='me'||a.id==='all')?'pinned':'';
    const dot=hasNewDots(a.id)?'<span class="dot"></span>':'';
    const label = (a.id==='me') ? 'ME' : a.name;
    return `<div class="story-item ${active} ${pinned}" data-id="${a.id}"
             role="button" tabindex="0" aria-label="æŸ¥çœ‹ ${label} çš„è²¼æ–‡">
  <img src="${a.avatar}" alt="${label} çš„é ­åƒ" onerror="imgFallback(this)">${dot}
  <div class="name">${label}</div>
</div>`;
  }).join('');

  bar.querySelectorAll('.story-item').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id=el.dataset.id; currentFilter=id;
      if(id!=='all') lastSeen[id]=Date.now(); LS.set('lastSeen', lastSeen);
      renderStoryBar(); renderFeed(currentFilter); window.scrollTo({top:0,behavior:'smooth'});
    });
  });
}
function feedOf(filter){
  if(filter==='all') return POSTS.slice().sort((a,b)=>b.ts-a.ts);
  if(filter==='me')  return POSTS.filter(p=>p.artistId==='me').sort((a,b)=>b.ts-a.ts);
  return POSTS.filter(p=>p.artistId===filter).sort((a,b)=>b.ts-a.ts);
}
function VB(size=18){
  const gid='vbGrad-'+Math.random().toString(36).slice(2,8);
  return `<span class="verified-badge" style="width:${size}px;height:${size}px">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs><linearGradient id="${gid}" x1="0" y="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#6fb3ff"/><stop offset="58%" stop-color="#7b6dff"/><stop offset="92%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e9ecff"/>
      </linearGradient></defs>
      <path class="gear" fill="url(#${gid})" d="M12 2.3 14 4l2.9-.6.9 2.7 2.7.9-.6 2.9L22 12l-2.1 2.1.6 2.9-2.7.9-.9 2.7-2.9-.6L12 21.7 10 20l-2.9.6-.9-2.7-2.7-.9.6-2.9L2 12l2.1-2.1-.6-2.9 2.7-.9.9-2.7L10 4l2-1.7z"/>
      <path class="tick" d="M10.4 12.8 8.7 11.2l1.1-1.1 1.2 1.2 3-3 1.1 1.1-3.8 3.8a1 1 0 0 1-1.4 0z"/></svg>
  </span>`;
}
function reactBtnHTML(p, key, icon){
  const mine = LS.getStr(`myreact:${p.id}`, '');
  const on   = (mine === key) ? ' active' : '';
  const n    = p.reacts?.[key] || 0;
  return `<button class="react${on}" data-react="${key}">${icon} <span class="num">${n || ''}</span></button>`;
} 
function renderFeed(filter='me'){
  const wrap = document.getElementById('feedWrap');
  if(!wrap) return;

  const list = feedOf(filter);
  if(!list.length){
    wrap.innerHTML = `<div class="ghost" style="text-align:center;margin-top:20vh">å°šç„¡è²¼æ–‡</div>`;
    return;
  }

  wrap.innerHTML = list.map(p=>{
    p.reacts = p.reacts || {thumb:0,heart:0,joy:0,shock:0,cry:0};
    p.cmts   = p.cmts   || [];
    const stage = (p.artistStage||STAGE_NAME||'').toString().toUpperCase();
    const displayName = (p.artistId==='me') ? NICKNAME.toUpperCase() : stage;

    return `
    <div class="post card soft" data-post="${p.id}">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}" alt="${escapeHtml(displayName)} çš„é ­åƒ" onerror="imgFallback(this)">
        <div class="meta">
          <b class="stage">${escapeHtml(displayName)} ${VB(18)}</b>
          <small class="ghost">${new Date(p.ts).toLocaleString()}</small>
        </div>
      </div>
      <div class="body">
        <p>${escapeHtml(p.text)}</p>
        ${p.img ? `<img class="hero" src="${p.img}" alt="è²¼æ–‡åœ–ç‰‡" onerror="imgFallback(this)">` : ``}
      </div>
      <div class="actions">
        <div class="reacts">
          ${reactBtnHTML(p,'thumb','ğŸ‘')}
          ${reactBtnHTML(p,'heart','â¤ï¸')}
          ${reactBtnHTML(p,'joy','ğŸ¤£')}
          ${reactBtnHTML(p,'shock','ğŸ˜²')}
          ${reactBtnHTML(p,'cry','ğŸ¥²')}
        </div>
        <div class="commentBar">
          <div class="left">ğŸ’¬ <span class="cmtCount">${p.cmts.length}</span> å‰‡è©•è«–</div>
          <div class="right"><button class="addCmt">ç™¼è¡¨è©•è«–</button></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

/* ===================== DM åˆ—è¡¨ ===================== */
function getRoomTitle(){ return NICKNAME; }
function lastPreview(m){
  if(!m) return 'ï¼ˆç„¡è¨Šæ¯ï¼‰';
  if(m.type==='image') return '[ç…§ç‰‡]';
  if(m.type==='video') return '[å½±ç‰‡]';
  if(m.type==='audio' || m.type==='voice') return 'ï¼»èªéŸ³è¨Šæ¯ï¼½';
  return m.text || 'ï¼ˆç„¡è¨Šæ¯ï¼‰';
}
function renderDmList(){
  const box=document.getElementById('dmList');
  const last=GROUP_MSGS[GROUP_MSGS.length-1];
  box.innerHTML=`<div class="dmCard" onclick="showPage('dmDetail')">
    <img src="${ME.avatar}" alt="èŠå¤©å®¤é ­åƒ" onerror="imgFallback(this)">
    <div class="nameBlock">
      <div class="nameRow" style="align-items:center;gap:8px">
        <span class="artistTag">ARTIST</span>
        <div class="stage">${escapeHtml(getRoomTitle().toUpperCase())}</div>
      </div>
      <small class="ghost" style="display:block;max-width:62vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(lastPreview(last))}</small>
    </div><span></span></div>`;
}

/* ===================== èªéŸ³æ³¡æ³¡ï¼ˆæœ‰å½±åƒè»Œç”¨ <video>ï¼‰ ===================== */
function voiceWidthByDur(sec){
  const d = Math.max(0, sec||0);
  const minW=140, maxW=280, cap=60; // 0sâ†’140pxï¼Œ60s+â†’280px
  const w = minW + (Math.min(d,cap)/cap)*(maxW-minW);
  return Math.round(w);
}
function buildVoiceUI(msg){
  const segStart = Number(msg.segStart || msg.start || 0);
  const segEnd   = Number(msg.segEnd   || msg.end   || 0);

  const ui  = document.createElement('div'); ui.className='voiceUI';
  const btn = document.createElement('button'); btn.className='voicePlay';
  btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;

  const bars = document.createElement('div'); bars.className='voiceBars';
  for(let i=0;i<12;i++){ const b=document.createElement('div'); b.className='voiceBar'; bars.appendChild(b); }

  const dur = document.createElement('div'); dur.className='voiceDur'; dur.textContent = '0:00';
  ui.append(btn,bars,dur);

  const media = document.createElement(msg.isVideo ? 'video' : 'audio');
  media.src = msg.src;
  media.preload = 'metadata';
  media.style.display = 'none';
  if (msg.isVideo) { media.playsInline = true; media.setAttribute('webkit-playsinline',''); }
  ui.appendChild(media);
  media._owner = ui;

  function toPlay(){
    stopActive();
    try{ media.currentTime = segStart || 0; }catch(_){}
    media.play().then(()=>{
      ACTIVE_AUDIO = media;
      ui.classList.add('playing');
      btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>`;
    }).catch(()=>{});
  }
  function toPause(){
    media.pause();
    ui.classList.remove('playing');
    btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
    if (ACTIVE_AUDIO===media) ACTIVE_AUDIO=null;
  }
  btn.onclick = ()=> media.paused ? toPlay() : toPause();

  media.addEventListener('loadedmetadata', ()=>{
    const d = (segEnd>segStart) ? (segEnd - segStart) : (media.duration||0);
    dur.textContent = mmss(d||0);
    ui.style.width = voiceWidthByDur(d||0) + 'px';
  });

  media.addEventListener('timeupdate', ()=>{
    const total  = (segEnd>segStart) ? (segEnd - segStart) : (media.duration||0);
    const played = Math.max(0, (media.currentTime || 0) - (segStart||0));
    const left   = Math.max(0, total - played);
    dur.textContent = mmss(Math.ceil(left));
    if(segEnd>segStart && media.currentTime >= segEnd - 0.05){ toPause(); }
  });

  media.addEventListener('ended', toPause);

  return ui;
}
  
/* ===================== DM Threadï¼ˆæ¸²æŸ“ï¼‰ ===================== */
let replyDraft=null;

async function resolveMediaSrc(m){
  if(m.src) return m.src;                   // èˆŠè³‡æ–™ï¼ˆDataURLï¼‰ä»å¯é¡¯ç¤º
  if(m.mediaId) return await MEDIA_DB.getURL(m.mediaId); // æ–°æµç¨‹ï¼ˆIndexedDBï¼‰
  return '';
}

/* æ—¥æœŸåˆ†éš”æ–‡å­— */
function dayLabel(ts){
  const d=new Date(ts), now=new Date();
  const ymd = (x)=>[x.getFullYear(),x.getMonth(),x.getDate()].join('-');
  const diffDays = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - new Date(d.getFullYear(),d.getMonth(),d.getDate()))/86400000);
  if(ymd(d)===ymd(now)) return 'ä»Šå¤©';
  if(diffDays===1) return 'æ˜¨å¤©';
  if(diffDays>=7){
    return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
  }
  return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`; // ä¸€é€±å…§éä»Š/æ˜¨ï¼Œä»é¡¯ç¤ºæœˆæ—¥
}

function renderThread(){
  const box=document.getElementById('dmThread'); box.innerHTML='';
   let lastDivider='';
   GROUP_MSGS.forEach(m=>{
    /* æ—¥æœŸåˆ†éš” */
    const label=dayLabel(m.ts);
    if(label!==lastDivider){
      const div=document.createElement('div'); div.className='dayDivider'; div.textContent=label;
      box.appendChild(div); lastDivider=label;
    }
    const wrap=document.createElement('div');
    const isMedia=(m.type==='image'||m.type==='video');
    wrap.className='msg '+(m.from==='artist'?'right':'left')+(isMedia?' media':'');
    const timeEl=document.createElement('div');
    timeEl.className='time'+(m.from==='artist'?'':' dark');
    timeEl.textContent=fmtTime(m.ts);

    const bubble=document.createElement('div'); bubble.className='bubble';

    if(m.type==='image'){
      const img=document.createElement('img');
img.className='msgImg';
img.alt='èŠå¤©åœ–ç‰‡';
      bubble.classList.add('mediaWrap');
      bubble.appendChild(img);
      resolveMediaSrc(m).then(url=>{ img.src=url; img.addEventListener('click',()=>openViewer(url,'img', img)); }).catch(()=>{});
    }else if(m.type==='video'){
      const v=document.createElement('video'); v.className='msgVideo'; v.controls=true; v.playsInline=true; v.setAttribute('webkit-playsinline','');
      bubble.classList.add('mediaWrap');
      bubble.appendChild(v);
      resolveMediaSrc(m).then(url=>{ v.src=url; v.addEventListener('click',()=>openViewer(url,'video', v)); }).catch(()=>{});
    }else if(m.type==='voice'){
      resolveMediaSrc(m).then(url=>{
        bubble.classList.add('voice');
        const ui = buildVoiceUI({src:url, segStart:m.start, segEnd:m.end, isVideo:m.isVideo});
        bubble.appendChild(ui);
      });
    }else{
  if(m.from==='fan'){
    const showTrans = LS.getStr(`dmTranslated:${m.id}`,'0') === '1';
    const lab = document.createElement('div'); lab.className='fromLabel'; lab.textContent='FROM FAN';

    if(showTrans){
      const orig = document.createElement('div'); orig.className='fanText'; orig.innerHTML=escapeHtml(m.text);
      const div  = document.createElement('div'); div.className='transDivider';
      const tran = document.createElement('div'); tran.style.fontWeight='800';
      tran.textContent = m.text; // TODOï¼šä¸²ç¿»è­¯ API å¾Œæ”¹æˆè­¯æ–‡
      const by   = document.createElement('div'); by.className='by'; by.textContent='Translated by Papago';
      bubble.append(lab, orig, div, tran, by);
    }else{
      const txt = document.createElement('div'); txt.className='fanText'; txt.innerHTML=escapeHtml(m.text);
      const btn = document.createElement('div');
      btn.className='translate-in';
      btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 4h18v2H3V4zm8 4h2v2h-2V8zm-6 0h4v2H5V8zm0 4h14v2H5v-2zm0 4h10v2H5v-2z" fill="currentColor"/></svg> Translate`;
      btn.onclick = ()=>{ LS.setStr(`dmTranslated:${m.id}`, '1'); renderThread(); };
      bubble.append(lab, txt, btn);
    }
  }else{
    bubble.innerHTML=escapeHtml(m.text);
  }
}
    wrap.append(bubble,timeEl); box.appendChild(wrap);

    if(m.from==='artist'&&m.replyTo&&m.replyTo.text){
      const rc=document.createElement('div'); rc.className='replyCard';
      rc.innerHTML=`<div class="fromLabel">FROM FAN</div><div class="fanText">${escapeHtml(m.replyTo.text)}</div>`;
      box.appendChild(rc);
    }

    if(m.from==='fan' && !m.type){
      const btn=document.createElement('button'); btn.className='replyBtn';
      btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 4l-1.4 1.4L16.2 11H4v2h12.2l-5.6 5.6L12 20l8-8z" fill="currentColor"/></svg>`;
      btn.onclick=()=>{
        replyDraft={text:m.text};
        document.getElementById('replyChip').style.display='flex';
        document.getElementById('replyChipText').textContent=m.text.slice(0,42);
        document.getElementById('dmMessageInput').focus();
        scrollToEndDuring(600);
      };
      bubble.appendChild(btn);
    }
  });
  
  
  if(!box.querySelector('#threadPad')){ const pad=document.createElement('div'); pad.id='threadPad'; box.appendChild(pad); }
  if(!box.querySelector('#endAnchor')){ const a=document.createElement('div'); a.id='endAnchor'; box.appendChild(a); }

  ensureNoticeRow(); 
}
  
// ä»¥å‰æŠŠ noticeBar å¡åˆ° thread è£¡ â†’ æ”¹æˆå¡åˆ° .dmFooter è£¡
function ensureNoticeRow(){
  const footer = document.getElementById('dmFooter');
  if(!footer) return null;
  let n = document.getElementById('noticeRow');
  if(!n){
    n = document.createElement('div');
    n.id = 'noticeRow';
    n.className = 'noticeBar';
    n.setAttribute('role','status');
    n.setAttribute('aria-live','polite');
    n.textContent = 'ç²‰çµ²åœ¨ç­‰ä½ çš„è¨Šæ¯å–” ğŸ¤©';
    footer.appendChild(n);              // â† é—œéµï¼šæ›åœ¨è¼¸å…¥åˆ—å®¹å™¨
  }
  return n;
}

function clearNoticeNow(){ /* å¸¸é§ï¼šä¸ç”¨æ¸…é™¤ */ }
  
/* ===================== ç³»çµ±é€šçŸ¥ ===================== */
function getLastTs(role){
  let t=0; for(const m of GROUP_MSGS){ if(!role || m.from===role){ if(m.ts>t) t=m.ts; } } return t;
}
 function updateNoticeBanner() {
  const n = ensureNoticeRow(); if (!n) return;
  n.style.display = 'block';     // â† æ°¸é é¡¯ç¤º
}
  
/* ===================== é€è¨Šæ¯ / å›è¦† ===================== */
function clearReply(){ replyDraft=null; document.getElementById('replyChip').style.display='none'; scrollToEndDuring(400); }
function sendArtistMsg(){
  const inp=document.getElementById('dmMessageInput');
  let t=(inp.value||'').trim(); 
  if(!t) return;

  GROUP_MSGS.push({
    id:'u'+Date.now(),
    from:'artist',
    text:t,
    ts:Date.now(),
    replyTo:replyDraft?{text:replyDraft.text}:null
  });

  LS.set('groupMsgs', GROUP_MSGS);
  inp.value=''; updateComposerUI(); clearReply(); renderThread(); renderDmList();
  clearNoticeNow();
  hardStickBottom();
  updateNoticeBanner();
}
document.getElementById('dmSendBtn').addEventListener('click', sendArtistMsg);
const dmInput = document.getElementById('dmMessageInput');
dmInput.addEventListener('keydown', e=>{
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendArtistMsg(); }
});
const sendBtn = document.getElementById('dmSendBtn');
const footerEl = document.getElementById('dmFooter');
function updateComposerUI(){
  const has = (dmInput.value||'').trim().length>0;
  footerEl.classList.toggle('hasText', has);
  sendBtn.disabled = !has;
}
dmInput.addEventListener('input', updateComposerUI);
dmInput.addEventListener('focus', ()=>{
  setTimeout(hardStickBottom,0);
  setTimeout(hardStickBottom,200);
  setTimeout(hardStickBottom,600);
});

/* ===================== åª’é«”ä¸Šå‚³ ===================== */
const pickMedia = document.getElementById('pickMedia');
const pickVoice = document.getElementById('pickVoice');
document.getElementById('btnCamera').addEventListener('click', ()=>pickMedia.click());
document.getElementById('btnMic').addEventListener('click', ()=>pickVoice.click());

pickMedia.addEventListener('change', async e=>{
  const files=[...e.target.files];
  for(const f of files){
    const id = await MEDIA_DB.put(f);
    const isVideo = f.type.startsWith('video/');
    GROUP_MSGS.push({ id:'m'+Date.now()+Math.random(), from:'artist', type:isVideo?'video':'image', mediaId:id, ts:Date.now() });
  }
  LS.set('groupMsgs', GROUP_MSGS);
  renderThread(); renderDmList(); clearNoticeNow(); hardStickBottom(); updateNoticeBanner();
  e.target.value='';
});

/* èªéŸ³ä¿®å‰ª */
let trimState = { blob:null, url:'', dur:0, start:0, end:0 };
const trimModal = document.getElementById('trimModal');
const trimMedia = document.getElementById('trimMedia');
const trimPlay  = document.getElementById('trimPlay');
const trimStart = document.getElementById('trimStart');
const trimEnd   = document.getElementById('trimEnd');
const trimStartLabel=document.getElementById('trimStartLabel');
const trimEndLabel=document.getElementById('trimEndLabel');
const trimClock = document.getElementById('trimClock');
const trimFill  = document.getElementById('trimFill');
const trimUse   = document.getElementById('trimUse');

pickVoice.addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  trimState.blob = f;
  trimState.url  = URL.createObjectURL(f);
  trimMedia.src = trimState.url;
  trimMedia.load();
  trimOpen();
  e.target.value='';
});
function trimOpen(){
  trimModal.style.display='block';
  trimPlay.disabled=true; trimUse.disabled=true;
  trimMedia.addEventListener('loadedmetadata', onLoadedMeta, {once:true});
  trimMedia.addEventListener('timeupdate', onTick);
}
function onLoadedMeta(){
  const d = trimMedia.duration || 0;
  trimState.dur = d;
  trimState.start = 0; trimState.end = d;
  trimStart.value = 0; trimEnd.value = 1000;
  trimStartLabel.textContent = '0.0s';
  trimEndLabel.textContent = d ? `${d.toFixed(1)}s` : '0.0s';
  trimClock.textContent = '0:00';
  trimPlay.disabled=false; trimUse.disabled=false;
}
function onTick(){
  const st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  const cur = trimMedia.currentTime;
  const w = (ed>st)? ((cur-st)/(ed-st))*100 : 0;
  trimFill.style.width = Math.max(0,Math.min(100,w)) + '%';
  trimClock.textContent = s2clock(Math.max(0, cur-st));
  if(cur>=ed-0.02){ trimMedia.pause(); }
}
function closeTrim(){
  trimModal.style.display='none';
  try{ URL.revokeObjectURL(trimState.url); }catch(_){}
  trimMedia.pause(); trimMedia.src=''; trimFill.style.width='0%';
}
function val2sec(v){ return (Number(v)/1000) * (trimState.dur||0); }
function syncRange(which){
  let st = val2sec(trimStart.value), ed = val2sec(trimEnd.value);
  if(ed<=st){ if(which==='start') ed = Math.min(trimState.dur, st + 0.3); else st = Math.max(0, ed - 0.3); }
  trimState.start = st; trimState.end = ed;
  trimStartLabel.textContent = `${st.toFixed(1)}s`;
  trimEndLabel.textContent   = `${ed.toFixed(1)}s`;
}
trimStart.addEventListener('input', ()=>{ syncRange('start'); });
trimEnd.addEventListener('input',   ()=>{ syncRange('end'); });

let playing=false;
trimPlay.addEventListener('click', ()=>{
  if(!playing){
    try{ trimMedia.currentTime = trimState.start; }catch(_){}
    trimMedia.play().catch(()=>{});
    trimPlay.textContent='â¸ æš«åœ'; playing=true;
  }else{
    trimMedia.pause(); trimPlay.textContent='â–¶ï¸ æ’­æ”¾'; playing=false;
  }
});
trimMedia.addEventListener('pause', ()=>{ trimPlay.textContent='â–¶ï¸ æ’­æ”¾'; playing=false; });

trimUse.addEventListener('click', async ()=>{
  const dur = Math.max(0, (trimState.end||0) - (trimState.start||0));
  if(!confirm(`è¦ç™¼é€ ${mmss(dur)} çš„èªéŸ³ç‰‡æ®µå—ï¼Ÿ`)) return;

  const id = await MEDIA_DB.put(trimState.blob);
  GROUP_MSGS.push({
    id:'v'+Date.now()+Math.random(),
    from:'artist',
    type:'voice',
    isVideo: trimState.blob.type.startsWith('video/'),
    mediaId:id,
    start:trimState.start,
    end:trimState.end,
    ts:Date.now()
  });
  LS.set('groupMsgs', GROUP_MSGS);
  closeTrim(); renderThread(); renderDmList(); clearNoticeNow(); hardStickBottom(); updateNoticeBanner();
});

/* ===================== DM èœå–® / æ”¹å ===================== */
function toggleDmMenu(){ const m=document.getElementById('dmMenu'); m.style.display=(m.style.display==='block')?'none':'block'; }
function hideDmMenu(){ document.getElementById('dmMenu').style.display='none'; }
document.addEventListener('click',(e)=>{
  const m=document.getElementById('dmMenu');
  if(m.style.display==='block'&&!m.contains(e.target)&&!e.target.closest('.hudBtn')) hideDmMenu();
});
function renameChat(){
  const cur=getRoomTitle(); const n=prompt('æ›´æ”¹èŠå¤©å®¤åç¨±ï¼ˆåŒï¼šè—äººæš±ç¨±ï¼‰', cur); if(!n) return;
  NICKNAME=n.trim()||cur; LS.setStr('artistNickname', NICKNAME);
  document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
  document.getElementById('meNickname')?.textContent && (document.getElementById('meNickname').textContent=NICKNAME);
  document.getElementById('composerWho')?.textContent && (document.getElementById('composerWho').textContent=NICKNAME);
  renderDmList();
}

/* === è£åˆ‡èƒŒæ™¯ï¼šæ—‹è½‰ / ç¸®æ”¾ / æ‹–æ›³ï¼ˆæ–°ç‰ˆï¼šæœƒçœŸçš„è£åˆ‡ï¼‰ === */
let cropDataURL = '', cropDeg = 0, cropTx = 0, cropTy = 0;
let natW = 0, natH = 0;         // åŸåœ–åƒç´ 
let baseScale = 1;              // è®“å½±åƒã€Œå‰›å¥½é‹ªæ»¿èˆå°ã€çš„åŸºæº–ç¸®æ”¾ï¼ˆcoverï¼‰
let CROP_RESULT_URL = '';
const chooser     = document.getElementById('bgChooser');
const cropImg     = document.getElementById('cropImg');
cropImg.setAttribute('draggable','false');
const cropStage   = document.getElementById('cropStage');
const cropScaleEl = document.getElementById('cropScale');
const scaleLabel  = document.getElementById('scaleLabel');

function startPickBg(){ chooser?.click(); }

chooser?.addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    cropDataURL = ev.target.result;
    cropImg.onload = ()=>{
      natW = cropImg.naturalWidth;
      natH = cropImg.naturalHeight;
      cropDeg = 0; cropTx = 0; cropTy = 0;
      cropScaleEl.value = 100;
      updateScaleUI();

      // å…ˆæ‰“é–‹é¢æ¿ï¼Œç­‰æœ‰å¯¦éš›å°ºå¯¸å¾Œå†ç®— baseScale
      openModal('cropModal');
      requestAnimationFrame(()=>{ computeBaseScaleAfterOpen(); });
    };
    cropImg.src = cropDataURL;
  };
  reader.readAsDataURL(f);
});

function computeBaseScale(){
  const sw = cropStage.clientWidth, sh = cropStage.clientHeight;
  if(!sw || !sh) return 0;                 // é¢æ¿æœªé¡¯ç¤ºæ™‚å°ºå¯¸ç‚º 0ï¼Œå…ˆè·³é
  const imgW = (cropDeg % 180 === 0) ? natW : natH;
  const imgH = (cropDeg % 180 === 0) ? natH : natW;
  baseScale = Math.max(sw / imgW, sh / imgH);
  clampPan();
  return baseScale;
}

function computeBaseScaleAfterOpen(){
  let tries = 0;
  const tick = ()=>{
    // é¢æ¿æ‰“é–‹å¾Œï¼Œç­‰åˆ°èˆå°çœŸçš„æœ‰å¯¬é«˜å†ç®—ï¼ˆiOS æœ‰æ™‚éœ€è¦å¤šå¹€ï¼‰
    if (cropStage.clientWidth && cropStage.clientHeight) {
      computeBaseScale();
      updateCropTransform();
    } else if (tries++ < 20) {
      requestAnimationFrame(tick);
    }
  };
  // å…ˆç­‰ä¸€å¹€ï¼Œé¿å… display:block çš„ä½ˆå±€é‚„æ²’å®Œæˆ
  requestAnimationFrame(tick);
}  

function uiScale(){                   // ç›®å‰æ»‘æ¡¿å€ç‡ï¼ˆç›¸å°åŸºæº–ï¼‰
  return (Number(cropScaleEl?.value || 100) / 100);
}
function cssScale(){                  // å¯¦éš›å¥—åˆ° <img> çš„ç¸®æ”¾
  return baseScale * uiScale();
}

function rotatedBounds(w, h, rad){    // æ—‹è½‰å¾Œå¤–æ¥çŸ©å½¢
  const c = Math.cos(rad), s = Math.sin(rad);
  return { w: Math.abs(w*c) + Math.abs(h*s),
           h: Math.abs(w*s) + Math.abs(h*c) };
}

function clampPan(){
  const sw = cropStage.clientWidth, sh = cropStage.clientHeight;
  const s  = cssScale();
  const rad = cropDeg * Math.PI / 180;
  const bb = rotatedBounds(natW*s, natH*s, rad); // å½±åƒå¤–æ¡†ï¼ˆpxï¼‰
  const maxX = Math.max(0, (bb.w - sw)/2);
  const maxY = Math.max(0, (bb.h - sh)/2);
  cropTx = Math.max(-maxX, Math.min(maxX, cropTx));
  cropTy = Math.max(-maxY, Math.min(maxY, cropTy));
}

function updateCropTransform(){
  clampPan();
  cropImg.style.transform =
    `translate(-50%,-50%) translate(${cropTx}px, ${cropTy}px) rotate(${cropDeg}deg) scale(${cssScale()})`;
}

function updateScaleUI(){
  const v = Number(cropScaleEl?.value || 100);
  scaleLabel && (scaleLabel.textContent = v + '%');
  document.documentElement.style.setProperty('--scaleFill', v + '%');
}

document.getElementById('btnRotate')?.addEventListener('click', ()=>{
  cropDeg = (cropDeg + 90) % 360;
  computeBaseScale();                 // æ—‹è½‰å¾Œé‡ç®—åŸºæº–ç¸®æ”¾
  updateCropTransform();
});
document.getElementById('zoomIn')?.addEventListener('click', ()=>{
  cropScaleEl.value = Math.min(250, Number(cropScaleEl.value)+5); onScaleInput();
});
document.getElementById('zoomOut')?.addEventListener('click', ()=>{
  cropScaleEl.value = Math.max(50, Number(cropScaleEl.value)-5); onScaleInput();
});
function onScaleInput(){ updateScaleUI(); updateCropTransform(); }
cropScaleEl?.addEventListener('input', onScaleInput);

/* æ‹–æ›³ï¼ˆæœ‰é‚Šç•Œï¼Œé¿å…éœ²ç™½ï¼‰ */
let dragging=false, sx=0, sy=0, bx=0, by=0;
cropImg?.addEventListener('pointerdown', e=>{
  dragging=true; cropImg.setPointerCapture(e.pointerId);
  sx=e.clientX; sy=e.clientY; bx=cropTx; by=cropTy;
});
cropImg?.addEventListener('pointermove', e=>{
  if(!dragging) return;
  cropTx = bx + (e.clientX - sx);
  cropTy = by + (e.clientY - sy);
  updateCropTransform();
});
['pointerup','pointercancel','lostpointercapture'].forEach(evt=>{
  cropImg?.addEventListener(evt, ()=>{ dragging=false; });
});

/* åŒ¯å‡ºçœŸæ­£è£åˆ‡å¾Œçš„åœ–ç‰‡ï¼ˆä¾èˆå°å°ºå¯¸ + è£ç½® DPRï¼‰ */
function exportCroppedDataURL(mime='image/jpeg', quality=.85){
  const dpr = window.devicePixelRatio || 1;
  const sw  = cropStage.clientWidth,  sh = cropStage.clientHeight;
  const canvas = document.createElement('canvas');
  canvas.width  = Math.round(sw * dpr);
  canvas.height = Math.round(sh * dpr);
  const ctx = canvas.getContext('2d', {alpha:false});
  ctx.imageSmoothingQuality = 'high';

  // æŠŠåº§æ¨™ç³»å…ˆæ”¾å¤§åˆ° CSS åƒç´  â†’ è£ç½®åƒç´ 
  ctx.scale(dpr, dpr);
  // ä»¥èˆå°ä¸­å¿ƒç‚ºåŸé»ï¼Œå¥—åŒä¸€å¥— transform
  ctx.translate(sw/2, sh/2);
  ctx.translate(cropTx, cropTy);
  ctx.rotate(cropDeg * Math.PI/180);
  ctx.scale(cssScale(), cssScale());
  ctx.drawImage(cropImg, -natW/2, -natH/2);   // ä»¥åœ–ç‰‡ä¸­å¿ƒå°é½Š

  return canvas.toDataURL(mime, quality);
}

/* æµç¨‹ï¼šä¸‹ä¸€æ­¥ â†’ é è¦½è£åˆ‡åœ– â†’ ç¢ºèªå¯«å…¥ä¸¦å¥—ç”¨ */
function applyCrop(){
  CROP_RESULT_URL = exportCroppedDataURL();        // ç›´æ¥å­˜èµ·ä¾†
  const mini = document.getElementById('bgPreviewMini');
  if(mini) mini.style.backgroundImage = `url("${CROP_RESULT_URL}")`;
  closeCrop(); openModal('previewModal');
}

// æŠŠè£åˆ‡çµæœå¥—åˆ° DM èƒŒæ™¯ï¼Œæ”¯æ´ï¼šç›´æ¥å‚³å…¥ URLã€LSã€æˆ– IndexedDB å¾Œæ´
function applyChatBg(forceUrl){
  const panel = document.getElementById('dmDetail');
  if(!panel) return;

  const setBg = (u)=>{
    if(u){
  // åƒ…å…è¨±æœ¬åœ°è£åˆ‡çµæœï¼ˆdata:/blob:ï¼‰ã€‚è¦é–‹æ”¾ https å†æ“´å……é€™è£¡ã€‚
  if(!(u.startsWith('data:') || u.startsWith('blob:'))){
    console.warn('Blocked non-local background URL');
    return;
  }
  panel.style.backgroundImage = `url(${u})`;
  const opt = LS.get('chatBgOpt', {dim:0.18, blur:6});
  document.documentElement.style.setProperty('--bgDim', String(opt.dim));
  document.documentElement.style.setProperty('--bgBlur', opt.blur + 'px');
}else{
  panel.style.backgroundImage = '';
  document.documentElement.style.setProperty('--bgDim', '0');
  document.documentElement.style.setProperty('--bgBlur', '0px');
}
};
  if (forceUrl) { setBg(forceUrl); return; }

  // å…ˆè©¦è‘—ç”¨ LS ç´”å­—ä¸²
  let url = LS.getStr('chatBg','');
  if (url) { setBg(url); return; }

  // å†ç”¨ IndexedDB å¾Œæ´
  const id = LS.getStr('chatBgId','');
  if (id) {
    MEDIA_DB.getURL(id).then(u=> setBg(u||'')).catch(()=> setBg(''));
  } else {
    setBg('');
  }
}

async function confirmPreview(){
  if (!CROP_RESULT_URL){ closePreview(); return; }

  // ç«‹åˆ»é¡¯ç¤ºï¼ˆä¸ç­‰æŒä¹…åŒ–ï¼‰
  applyChatBg(CROP_RESULT_URL);

  // å„²å­˜ï¼ˆå…ˆè©¦ LSï¼Œå¤±æ•—å°±å­˜ IndexedDBï¼‰
  try{
    LS.setStr('chatBg', CROP_RESULT_URL);
    if (LS.getStr('chatBg','') !== CROP_RESULT_URL) throw new Error('ls-mismatch');
  }catch(e){
    try{
      const blob = dataURLtoBlob(CROP_RESULT_URL);
      const id   = await MEDIA_DB.put(blob);
      LS.setStr('chatBg','');              // æ¸…æ‰å¤±æ•—çš„èˆŠå€¼
      LS.setStr('chatBgId', id);           // å­˜ idï¼Œé–‹é æ™‚å†è½‰æˆ ObjectURL
      // å†ä¿éšªä¸€æ¬¡ï¼šç”¨ DB å–å›çš„ URL å¥—ä¸Šï¼ˆé¿å…æŸäº›æ©Ÿå‹å° dataURL ä¸çˆ½ï¼‰
      const u = await MEDIA_DB.getURL(id);
      if (u) applyChatBg(u);
    }catch(err){
      console.warn('Save chatBg fallback failed:', err);
    }
  }

  closePreview();
}
  
function backToCrop(){ closePreview(); openModal('cropModal'); }

/* èˆŠå‡½å¼åç›¸å®¹ */
function rotateCrop(){ cropDeg=(cropDeg+90)%360; computeBaseScale(); updateCropTransform(); }

/* ===================== å°ºå¯¸é‡æ¸¬ & è²¼åº•æ ¸å¿ƒ ===================== */
function measureFooter(){
  const f=document.getElementById('dmFooter'); if(!f) return;
  const h=Math.ceil(f.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--footer-h', h + 'px');
}
function measureHUD(){
  const hEl=document.getElementById('dmHUD'); if(!hEl) return;
  const h=Math.ceil(hEl.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--hud-h', h + 'px');
}
function stickBottomNow(){
  const t=document.getElementById('dmThread'); if(!t) return;
  document.getElementById('endAnchor')?.scrollIntoView({block:'end'});
  t.scrollTop = t.scrollHeight + 9999;
}
function scrollToEndDuring(ms=800){
  if(!autoStick) return;
  const end=performance.now()+ms;
  function loop(){ if(!autoStick) return; stickBottomNow(); if(performance.now()<end) requestAnimationFrame(loop); }
  requestAnimationFrame(loop);
}
function hardStickBottom(){
  const t=document.getElementById('dmThread'); if(!t) return;
  t.scrollTop = t.scrollHeight + 9999;
  let frames=36;
  function pump(){ t.scrollTop = t.scrollHeight + 9999; if(--frames>0) requestAnimationFrame(pump); }
  requestAnimationFrame(()=>requestAnimationFrame(pump));
}
let autoStick=true;
function bindScrollGuard(){
  const t=document.getElementById('dmThread'); if(!t) return;
  const nearBottom = ()=>((t.scrollHeight - t.clientHeight) - t.scrollTop) < 6;
  autoStick = nearBottom();
  t.addEventListener('scroll', ()=>{
    const nb=nearBottom();
    autoStick = nb;
  }, {passive:true});
}
function bindBottomObserver(){
  const t=document.getElementById('dmThread'), a=document.getElementById('endAnchor');
  if(!t || !a) return;
  try{
    const io = new IntersectionObserver((entries)=>{
      const e = entries[0]; autoStick = e.isIntersecting && e.intersectionRatio >= 0.96;
    },{root:t,threshold:[0.01,0.5,0.96],rootMargin:'0px 0px -1px 0px'});
    io.observe(a);
  }catch(_){}
}

function rePickBg(){
  closeCrop();                  // é—œæ‰è£åˆ‡é¢æ¿
  try{ chooser.value=''; }catch(_){}   // æ¸…ç©ºï¼Œæ‰èƒ½é‡é¸åŒä¸€æª”
  // é‡ç½®ä¸€ä¸‹æš«å­˜ç‹€æ…‹ï¼ˆéå¿…éœ€ï¼Œä½†æ¯”è¼ƒä¹¾æ·¨ï¼‰
  cropDeg=0; cropTx=0; cropTy=0; cropScaleEl.value=100; updateScaleUI();
  // é‡æ–°æ‰“é–‹æŒ‘æª”ï¼ˆé€™æ˜¯ä½¿ç”¨è€…æ‰‹å‹¢è§¸ç™¼ï¼ŒiOS å¯ä»¥ï¼‰
  setTimeout(()=> chooser && chooser.click(), 0);
}
  

/* ===================== Composerï¼ˆé¦–é è‰ç¨¿ï¼‰ ===================== */
function previewComposeMedia(e){
  const box=document.getElementById('composePreview'); const hint=document.getElementById('composeFilesHint');
  box.innerHTML=''; if(!e.target.files.length){ hint.textContent='æœªé¸å–æª”æ¡ˆ'; return; }
  hint.textContent=`å·²é¸ ${e.target.files.length} å€‹æª”æ¡ˆ`;
  [...e.target.files].forEach(f=>{
    const url=URL.createObjectURL(f); const isVideo=f.type.startsWith('video/');
    const el=document.createElement(isVideo?'video':'img');
    el.src=url; el.controls=isVideo; el.onload=el.onloadeddata=()=>URL.revokeObjectURL(url);
    el.style.width='110px'; el.style.height='110px'; el.style.objectFit='cover'; el.style.borderRadius='12px'; el.style.border='1px solid var(--line)';
    box.appendChild(el);
  });
}
function publishDraft(){ alert('å…ˆå­˜è‰ç¨¿ï¼†é è¦½ï¼›ç™¼ä½ˆè¦å‰‡ç­‰æˆ‘å€‘æ¥é¦–é ä¸²æµã€‚'); showPage('home'); }

/* ===================== æš±ç¨±æŒ‰éˆ• ===================== */
document.getElementById('btnEditNick')?.addEventListener('click', ()=>{
  const v=prompt('è¼¸å…¥æ–°çš„æš±ç¨±ï¼ˆ= èŠå¤©å®¤åç¨±ï¼‰', NICKNAME);
  if(v&&v.trim()){
    NICKNAME=v.trim(); LS.setStr('artistNickname', NICKNAME);
    document.getElementById('meNickname')?.textContent && (document.getElementById('meNickname').textContent=NICKNAME);
    document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
    document.getElementById('composerWho')?.textContent && (document.getElementById('composerWho').textContent=NICKNAME);
    renderDmList();
  }
});
  // FABï¼šæ‰“é–‹è—äººç™¼æ–‡ Composer
document.getElementById('fabNew')?.addEventListener('click', ()=>{
if (document.getElementById('composerArtist')) showPage('composerArtist');
else alert('ç™¼æ–‡ç·¨è¼¯å™¨å°šæœªæ›ä¸Šé é¢ã€‚'); // æˆ–è€…æ”¹æˆ showPage('home')
});

  // â­ Action bar äº‹ä»¶ï¼ˆé»æ“Šåæ‡‰ / ç™¼è¡¨è©•è«–ï¼‰
document.addEventListener('click', (e)=>{
  const postEl = e.target.closest('.post');
  if(!postEl) return;
  const postId = postEl.getAttribute('data-post');
  const post = POSTS.find(x=>x.id===postId);
  if(!post) return;
  post.reacts = post.reacts || {thumb:0,heart:0,joy:0,shock:0,cry:0};
  post.cmts   = post.cmts   || [];

  // åæ‡‰ï¼ˆå–®é¸ï¼‹å¯å–æ¶ˆï¼‰
const rBtn = e.target.closest('.react');
if(rBtn){
  const key = rBtn.getAttribute('data-react');
  const storeKey = `myreact:${postId}`;
  const mine = LS.getStr(storeKey, '');

  post.reacts = post.reacts || {thumb:0,heart:0,joy:0,shock:0,cry:0};

  if(mine === key){
    // å–æ¶ˆ
    post.reacts[key] = Math.max((post.reacts[key]||0)-1, 0);
    LS.setStr(storeKey, '');
  }else{
    // æ›é¸ï¼ˆæ‰£èˆŠï¼‹åŠ æ–°ï¼‰
    if(mine){ post.reacts[mine] = Math.max((post.reacts[mine]||0)-1, 0); }
    post.reacts[key] = (post.reacts[key]||0) + 1;
    LS.setStr(storeKey, key);
  }
  LS.set('artistPosts', POSTS);

  // æ›´æ–°é€™å¼µå¡çš„æ‰€æœ‰æŒ‰éˆ•å¤–è§€èˆ‡æ•¸å­—
  const area = rBtn.closest('.reacts');
  const nowMine = LS.getStr(storeKey, '');
  area.querySelectorAll('.react').forEach(btn=>{
    const k = btn.getAttribute('data-react');
    btn.classList.toggle('active', nowMine === k);
    btn.querySelector('.num').textContent = post.reacts[k] || '';
  });
  return;
}

  // ç™¼è¡¨è©•è«–ï¼ˆç°¡æ˜“ï¼špromptï¼›ä½ è¦æ”¹ modal ä¹Ÿå¯ä»¥ï¼‰
  if(e.target.classList.contains('addCmt')){
    const t = (prompt('è¼¸å…¥ç•™è¨€')||'').trim();
    if(!t) return;
    post.cmts.push({id:'c'+Date.now(), text:t});
    LS.set('artistPosts', POSTS);
    postEl.querySelector('.cmtCount').textContent = post.cmts.length;
  }
});

/* ===== æ–‡å­—ç›´æ’­ï¼šé‚è¼¯ ===== */
let LIVE_ON = false;
let LIVE_PAUSED = false;

function livePushArtist(text){
  const box = document.getElementById('liveChat'); if(!box) return;
  box.querySelector('.welcome')?.remove();
  const el = document.createElement('div');
  el.className = 'msg host';
  el.innerHTML = `${escapeHtml(text)}<span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

function livePushFan(name, text){
  const box = document.getElementById('liveChat'); if(!box) return;
  const el = document.createElement('div');
  el.className = 'msg fan';
  el.innerHTML = `<div class="name">${escapeHtml(name)}</div>${escapeHtml(text)}<span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

// ï¼ˆå¯ä¾›ã€Œå¿«é€Ÿæ“ä½œã€æˆ–æ¸¬è©¦å‘¼å«ï¼‰window.liveFan(name,text)
window.liveFan = livePushFan;

// é–‹å§‹ï¼æš«åœï¼çµæŸ
function liveStart(){
  if(LIVE_ON) return;
  LIVE_ON = true; LIVE_PAUSED = false;

  document.getElementById('liveHUD').style.display = 'flex';
  
  // UI åˆ‡æ›
  document.getElementById('liveStart').style.display = 'none';
  document.getElementById('livePause').style.display = '';
  document.getElementById('liveEnd').style.display = '';
  document.getElementById('liveInputBox').disabled = false;
  document.getElementById('liveSend').disabled = false;

  syncNavVisibility();
  livePushArtist('ï¼ˆç›´æ’­é–‹å§‹ï¼‰');
}

function liveTogglePause(){
  if(!LIVE_ON) return;
  LIVE_PAUSED = !LIVE_PAUSED;
  const mask = document.getElementById('livePaused'); // å¯èƒ½ä¸å­˜åœ¨
  const btn  = document.getElementById('livePause');
  if(LIVE_PAUSED){
    if(mask) mask.style.display = 'grid';
    btn.textContent = 'æ¢å¾©';
    livePushArtist('ï¼ˆä¸»æŒäººæš«æ™‚é›¢é–‹ï¼‰');
  }else{
    if(mask) mask.style.display = 'none';
    btn.textContent = 'æš«æ™‚é›¢é–‹';
    livePushArtist('ï¼ˆä¸»æŒäººå›ä¾†äº†ï¼‰');
  }
}

function liveEnd(){
  if(!LIVE_ON) return;
  if(!confirm('è¦çµæŸæ­¤æ¬¡ç›´æ’­å—ï¼Ÿ')) return;

  LIVE_ON = false; LIVE_PAUSED = false;

  document.getElementById('liveHUD').style.display = 'none';
  document.getElementById('livePaused').style.display = 'none';
  document.getElementById('liveStart').style.display = '';
  document.getElementById('livePause').style.display = 'none';
  document.getElementById('liveEnd').style.display = 'none';
  document.getElementById('liveInputBox').disabled = true;
  document.getElementById('liveSend').disabled = true;

  syncNavVisibility();
  livePushArtist('ï¼ˆç›´æ’­å·²çµæŸï¼‰');

  const o = document.createElement('div');
  o.className = 'liveEndedScene';
  o.innerHTML = `<div class="text">ç›´æ’­å·²çµæŸ</div>`;
  document.body.appendChild(o);
  setTimeout(()=> o.remove(), 1200);
}

  
// é€å‡ºï¼ˆè—äºº â†’ å³å´ï¼‰
function liveSend(){
  if(!LIVE_ON || LIVE_PAUSED) return;
  const inp = document.getElementById('liveInputBox');
  const t = (inp.value||'').trim(); if(!t) return;
  livePushArtist(t);
  inp.value = '';
}

/* ç¶å®šæŒ‰éˆ•ï¼ˆåœ¨ DOMContentLoaded ä¹‹å¾Œå°±æœ‰äº†ï¼‰ */
document.addEventListener('DOMContentLoaded', ()=>{
  // è®“åº•éƒ¨ nav çš„ã€Œç›´æ’­ã€å¯ä»¥é–‹é€™é 
  const tab = document.getElementById('tabLive');
  if(tab) tab.setAttribute('onclick',"showPage('live')");

  document.getElementById('liveStart')?.addEventListener('click', liveStart);
  document.getElementById('livePause')?.addEventListener('click', liveTogglePause);
  document.getElementById('liveEnd')?.addEventListener('click', liveEnd);
  document.getElementById('liveSend')?.addEventListener('click', liveSend);
  document.getElementById('liveInputBox')?.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); liveSend(); }
  });
  // é€²é é¢æ™‚ç®—ä¸€æ¬¡
  syncNavVisibility();
});
// æ„›å¿ƒæ•¸ï¼†å‹•ç•«
(function(){
  let liveHearts = 0;
  const heartBtn = document.getElementById('liveHeartBtn');
  const heartCnt = document.getElementById('liveHeartCount');

  function spawnHeart(el){
    const r = el.getBoundingClientRect();
    const n = 2 + Math.floor(Math.random()*2); // 2~3 é¡†
    for(let i=0;i<n;i++){
      const h = document.createElement('div');
      h.className = 'flying-heart';
      h.textContent = 'ğŸ’—';
      document.body.appendChild(h);
      const x = r.left + r.width/2 + (Math.random()*30-15);
      const y = r.top  + (Math.random()*10-5);
      h.style.left = x+'px'; h.style.top = y+'px';
      h.animate(
        [
          { transform:'translate(0,0) scale(1)', opacity:1 },
          { transform:`translate(${(Math.random()*40-20)}px,-120px) scale(1.6)`, opacity:0 }
        ],
        { duration: 900 + Math.random()*300, easing:'ease-out' }
      ).onfinish = ()=> h.remove();
    }
  }

  if(heartBtn){
    heartBtn.addEventListener('click', ()=>{
      liveHearts++;
      if(heartCnt) heartCnt.textContent = liveHearts;
      spawnHeart(heartBtn);
    });
  }

  // UI è·Ÿè‘—é–‹æ’­/æš«é›¢/çµæŸè®ŠåŒ–ï¼ˆä¸è¦†è“‹ä½ çš„æ¥­å‹™é‚è¼¯ï¼‰
  const hud      = document.getElementById('liveHUD');
  const inp      = document.getElementById('liveInputBox');
  const sendBtn  = document.getElementById('liveSend');
  const btnStart = document.getElementById('liveStart');
  const btnPause = document.getElementById('livePause');
  const btnEnd   = document.getElementById('liveEnd');

  btnStart?.addEventListener('click', ()=>{
    hud.style.display = 'flex';
    inp.disabled = false; sendBtn.disabled = false;
    btnStart.style.display = 'none';
    btnPause.style.display = ''; btnEnd.style.display = '';
  });

  btnPause?.addEventListener('click', ()=>{
    // åªåšè¦–è¦ºæç¤ºï¼›å¯¦éš›ç‹€æ…‹ç”±ä½ åŸæœ¬ JS è™•ç†
    btnPause.textContent = (btnPause.textContent.includes('æš«æ™‚é›¢é–‹')) ? 'æ¢å¾©' : 'æš«æ™‚é›¢é–‹';
  });
})();
  

/* ===================== å•Ÿå‹• ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  const el1 = document.getElementById('meNickname');
if (el1) el1.textContent = NICKNAME;
  document.getElementById('dmTitle').textContent=NICKNAME.toUpperCase();
  const el2 = document.getElementById('composerWho');
if (el2) el2.textContent = NICKNAME;
  document.getElementById('meId') && (document.getElementById('meId').textContent='ARTIST-00001');
  document.getElementById('meAvatar') && (document.getElementById('meAvatar').src=AVATAR);

  renderStoryBar(); 

  measureHUD(); measureFooter(); updateComposerUI();
  renderThread();
  updateNoticeBanner();
  
  scrollToEndDuring(800);
  setTimeout(hardStickBottom,0);
  });

/* ç›£çœ‹ footer é«˜åº¦è®ŠåŒ–ï¼ˆéµç›¤/å›è¦† chipï¼‰ */
(()=>{ const footer=document.getElementById('dmFooter'); if(!footer) return;
  if('ResizeObserver' in window){ new ResizeObserver(()=>{ measureFooter(); scrollToEndDuring(600); }).observe(footer); }
})();

/* iOS Safariï¼šè¦–çª—/éµç›¤è®ŠåŒ–ï¼ˆvisualViewportï¼‰ */
;(function () {
  const vv = window.visualViewport;

  function applyVV() {
    if (!vv) return;
    const offset = Math.max(0, window.innerHeight - vv.height);
    document.documentElement.style.setProperty('--kb-offset', offset + 'px');
    measureFooter();
    scrollToEndDuring(600);
  }

  if (vv) {
    vv.addEventListener('resize', applyVV);
    vv.addEventListener('scroll', applyVV);
    applyVV();
  }

  window.addEventListener('resize', () => {
    measureHUD();
    measureFooter();
    scrollToEndDuring(600);
  });

  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      measureHUD();
      measureFooter();
      scrollToEndDuring(800);
    }, 120);
  });

  window.addEventListener('pageshow', () => {
    measureFooter();
    scrollToEndDuring(800);
  });

  // å‰/å¾Œæ™¯åˆ‡æ›ï¼šåœ¨é€™è£¡åœæ‰ DM å…§æ‰€æœ‰åª’é«”
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      haltDmMedia();
    } else {
      scrollToEndDuring(600);
    }
  });

  // å­—é«”è¼‰å…¥å®Œæˆå¾Œå†è²¼ä¸€æ¬¡åº•ï¼Œé¿å…å­—é«”è·³å‹•å½±éŸ¿å·è»¸
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => scrollToEndDuring(800));
  }
})();

/* ====== å…¨è¢å¹•åª’é«”æª¢è¦–å™¨ ====== */
let CURRENT_INLINE_MEDIA = null;

function openViewer(url, kind, srcEl){
  stopActive(); // å…ˆæŠŠä»»ä½•èªéŸ³æ’­æ”¾é—œæ‰
  if (srcEl && srcEl.tagName === 'VIDEO') { try{ srcEl.pause(); }catch(_){} }
  CURRENT_INLINE_MEDIA = srcEl || null;

  const v = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');

  img.style.display='none'; vid.style.display='none';
  if(kind==='img'){ img.src=url; img.style.display='block'; }
  else{ vid.src=url; vid.style.display='block'; }

  v.style.display='block';
}

function closeViewer(){
  const v = document.getElementById('viewer');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');
  v.style.display='none';
  img.src=''; vid.src='';
}

/* åªé»ã€ŒèƒŒæ™¯ã€æ‰é—œï¼›é»å…§å®¹ä¸é—œ */
(function initViewerGuard(){
  const v = document.getElementById('viewer');
  const stage = v.querySelector('.stage');
  const img = document.getElementById('viewerImg');
  const vid = document.getElementById('viewerVideo');
  const btn = document.getElementById('viewerClose');

  // é»èƒŒæ™¯é—œé–‰
  v.addEventListener('click', e=>{
    if(e.target === v) closeViewer();
  });

  // é˜»æ“‹äº‹ä»¶å¾€å¤–å†’æ³¡ï¼ˆé»å…§å®¹ä¸é—œé–‰ï¼‰
  [stage,img,vid].forEach(el=>{
    el.addEventListener('click', e=> e.stopPropagation());
  });

  // é—œé–‰éˆ•
  btn?.addEventListener('click', e=>{ e.stopPropagation(); closeViewer(); });

  // Esc é—œé–‰ï¼ˆéµç›¤ï¼‰
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && v.style.display==='block') closeViewer(); });
})();
</script>
</body>
</html>
