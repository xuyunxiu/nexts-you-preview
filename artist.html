<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NEXT‚ÄôS YOU ‚Äî Fan App (ÂñÆÈ†ÅÁâà)</title>

  <style>
    :root{
      --bg:#f5f7ff; --card:#fff; --text:#1a1a1a; --sub:#666; --line:#e6e8ef; --ghost:#9aa0b4;
      --accent:#6a5acd; --accent2:#836fff; --danger:#ff4d4f; --hover:#eef1ff;
      --radius:16px; --shadow:0 10px 35px rgba(26,26,26,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow-x:hidden}
    img{display:block;max-width:100%}
    button{font:inherit;cursor:pointer}
    .ghost{color:var(--ghost)} .sub{color:var(--sub)}
    .row{display:flex;align-items:center;gap:12px}
    .soft{padding:16px} .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:var(--hover);border:1px solid var(--line);font-size:12px}

    section.page{display:none;padding:12px 12px 88px}
    section.page.active{display:block;animation:fadeIn .24s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}

    /* Â∫ïÈÉ® Nav */
    nav#nav{position:fixed;left:0;right:0;bottom:0;z-index:40;background:var(--card);border-top:1px solid var(--line);
      display:flex;justify-content:space-around;gap:6px;padding:10px 8px 14px;backdrop-filter:saturate(140%) blur(10px);transition:transform .28s ease;}
    nav#nav.hidden{transform:translateY(120%)}
    nav#nav button{flex:1;border:none;background:transparent;padding:8px 0 6px;border-radius:12px;color:var(--sub);font-weight:800;font-size:13px}
    nav#nav button.active{color:var(--accent);background:var(--hover);border:1px solid var(--line)}

    /* Home */
    #homeHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 6px 8px}
    #homeHeader .me{display:flex;align-items:center;gap:10px}
    #homeHeader .me img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
    #homeHeader .me .id{font-size:12px;color:var(--ghost)}
    #storyWrap{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(245,247,255,.98),rgba(245,247,255,.92));backdrop-filter:blur(6px)}
    #storyBar{display:flex;gap:12px;overflow-x:auto;padding:10px 8px 12px;border-bottom:1px solid var(--line);scrollbar-width:none}
    #storyBar::-webkit-scrollbar{display:none}
    .story-item{flex:0 0 auto;width:64px;text-align:center;cursor:pointer;position:relative}
    .story-item img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #cfcfe9}
    .story-item .name{font-size:12px;margin-top:4px;color:#9aa1ad}
    .story-item.active img{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,90,205,.18)}
    .story-item.active .name{color:var(--accent);font-weight:700}
    .story-item .dot{position:absolute;right:6px;top:2px;width:8px;height:8px;background:var(--danger);border-radius:50%;box-shadow:0 0 0 2px #fff}

    .postCard{margin:12px 6px}
    .postCard .hdr{display:flex;align-items:center;gap:10px}
    .postCard .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
    .postCard .meta b{font-weight:900}
    .postCard .meta small{display:block;color:var(--ghost)}
    .postCard .body{margin-top:8px}
    .postCard .hero{width:100%;height:360px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}
    .postCard .actions{display:flex;gap:8px;margin-top:10px}
    .postCard .actions .chip{cursor:pointer}

    .fab{position:fixed;right:16px;bottom:86px;z-index:35;width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;border:1px solid var(--line);
      background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:900;font-size:22px;box-shadow:0 12px 28px rgba(106,90,205,.28);}

    /* DM list */
    #dm .dmCard{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card);margin:10px 0;cursor:pointer}
    #dm .dmCard .left{display:flex;align-items:center;gap:12px}
    #dm .dmCard img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
    .badge{background:#ff3b30;color:#fff;font-size:12px;padding:2px 7px;border-radius:999px;min-width:22px;text-align:center}

    /* DM detail HUD */
    .artistTag{display:inline-flex;align-items:center;justify-content:center;padding:3px 8px;height:18px;border-radius:8px;font-size:10px;font-weight:900;letter-spacing:.7px;text-transform:uppercase;color:#2e2a6f;background:linear-gradient(90deg,#cbb9ff 0%,#8fb4ff 62%,#ffffff 100%);border:1px solid #ded6ff;box-shadow:0 2px 8px rgba(106,90,205,.20)}
    .chatHUD{display:flex;align-items:center;justify-content:space-between;padding:4px 2px 8px}
    .hudBtn{width:42px;height:42px;border-radius:12px;border:1px solid var(--line);background:var(--card);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .chatHUD .subtitle{font-size:12px;color:#9aa0b4;margin-top:4px}

    /* DM thread & message */
    .thread{display:flex;flex-direction:column;gap:8px;height:calc(100vh - 210px);overflow-y:auto;padding:8px 2px}
    .dmMsg{display:flex;flex-direction:column;max-width:78%;margin:6px 0}
    .dmMsg.left{align-self:flex-start}.dmMsg.right{align-self:flex-end}
    .bubble{max-width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff}
    .dmMsg.right .bubble{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
    .label{font-size:10px;color:#7b89a6;font-weight:900;margin-bottom:4px}
    .time{font-size:11px;color:var(--ghost);margin-top:4px}

    /* ÂõûË¶ÜÈ†êË¶Ω */
    .replyPreview{max-width:260px;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.75);border:1px solid var(--line);font-size:12px;color:#556;backdrop-filter:blur(6px);margin:8px 0 0}
    .replyPreview.top{margin:0 0 8px}
    .replyTag{font-weight:900;margin-right:6px;color:#7a86b7}

    /* Á≤âÁµ≤Ê≥°Ê≥°Âè≥ÂÅ¥ ‚Ü©Ô∏é Èàï */
    .replyBtn{position:absolute;right:-12px;top:50%;transform:translateY(-50%);width:28px;height:28px;border-radius:999px;border:1px solid var(--line);background:var(--card);box-shadow:0 4px 12px rgba(0,0,0,.06);font-size:14px;cursor:pointer}

    /* Ëº∏ÂÖ•Âàó */
    .dmInputBar{gap:10px;padding:12px;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.55),rgba(255,255,255,.98))}
    .dmInputBar .box{flex:1;display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#f4f6ff;border-radius:18px;padding:10px 14px}
    .dmInputBar input{border:none;background:transparent;padding:0;outline:none}
    .dmSend{min-width:56px;height:44px;border:none;border-radius:14px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:900;cursor:pointer}
    .replyChip{display:none;align-items:center;gap:8px;margin:-6px 0 6px}
    .replyChip .x{border:none;background:transparent;cursor:pointer;color:#888}

    /* ËÉåÊôØÁ∑®ËºØÂô® */
    #bgEditor{position:fixed;inset:0;z-index:80;display:none;background:rgba(0,0,0,.45)}
    #bgEditor .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    #bgPreview{height:42vh;border:1px dashed var(--line);border-radius:12px;background-size:var(--bgScale,cover);background-position:center;background-repeat:no-repeat;position:relative;overflow:hidden}
    #bgOverlay{position:absolute;inset:0;background:rgba(0,0,0,var(--bgDim,.25));backdrop-filter:blur(var(--bgBlur,0px))}
    .rangeRow{display:flex;align-items:center;gap:10px;margin:10px 0}
    .rangeRow label{min-width:72px;color:#556}
  </style>
</head>
<body>

  <!-- ===== HomeÔºàËóù‰∫∫Á´ØÔºâ ===== -->
  <section id="home" class="page active">
    <div id="homeHeader">
      <div class="me">
        <img id="meAvatar" src="https://picsum.photos/80?u=artist" onerror="imgFallback(this)">
        <div>
          <div id="meNickname" style="font-weight:900">Annie</div>
          <div class="id" id="meId">ARTIST-00001</div>
        </div>
      </div>
      <button class="chip" onclick="editArtistNickname()">‚úèÔ∏è Êõ¥ÊîπÊàëÁöÑÊö±Á®±</button>
    </div>

    <div id="storyWrap"><div id="storyBar"></div></div>
    <div id="feedWrap"></div>

    <button class="fab" id="fabNew">Ôºã</button>
  </section>

  <!-- ===== DM list ===== -->
  <section id="dm" class="page">
    <div class="row" style="justify-content:space-between;margin:2px 0 10px">
      <b style="font-weight:900">Ë®äÊÅØ</b>
    </div>
    <div id="dmList"></div>
  </section>

  <!-- ===== DM detailÔºàËóù‰∫∫Áæ§ËÅäÔºâ ===== -->
  <section id="dmDetail" class="page">
    <div class="chatHUD">
      <div class="left"><button class="hudBtn" onclick="goBack()">‚Üê</button></div>
      <div class="center" style="flex:1;min-width:0">
        <div class="row" style="gap:8px"><span class="artistTag">ARTIST</span><b id="dmTitle">Annie</b></div>
        <div class="subtitle">1:Â§ö Áæ§ËÅä ¬∑ <span class="ghost">ÔºàÈªûÂè≥‰∏ä ‚Ä¶ Ë®≠ÂÆöËÉåÊôØ/ÂêçÁ®±Ôºâ</span></div>
      </div>
      <div class="right">
        <button class="hudBtn" title="ÊêúÂ∞ã" onclick="alert('ÂÖàÊîæ‰ΩçÔºå‰πãÂæåÂÅöÊêúÂ∞ã')">üîç</button>
        <button class="hudBtn" title="Êõ¥Â§ö" onclick="toggleDmMenu()">‚ãØ</button>
      </div>
    </div>

    <div id="dmThread" class="thread"></div>

    <div id="replyChip" class="replyChip">
      <span class="replyTag">ÂõûË¶ÜÔºö</span><span id="replyChipText" class="ghost"></span>
      <button class="x" onclick="clearReply()">‚úï ÂèñÊ∂à</button>
    </div>

    <div class="dmInputBar">
      <div class="box"><input id="dmMessageInput" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ‚Ä¶" /></div>
      <button class="dmSend" id="dmSendBtn">‚û§</button>
    </div>

    <div id="dmMenu" class="card soft" style="position:fixed;right:12px;top:64px;display:none;z-index:70">
      <div class="row" style="flex-direction:column;gap:6px;align-items:stretch">
        <button class="chip" onclick="renameChat()">Êõ¥ÊîπËÅäÂ§©ÂÆ§ÂêçÁ®±</button>
        <button class="chip" onclick="openBgEditor()">Êõ¥ÊîπËÉåÊôØ</button>
      </div>
    </div>
  </section>

  <!-- ===== ComposerÔºàÔºã ÊâìÈñãÔºâ ===== -->
  <section id="composerArtist" class="page">
    <div class="row" style="gap:10px">
      <button class="hudBtn" onclick="goBack()">‚Üê</button>
      <b style="font-weight:900">NEXT ONE</b>
      <span class="ghost" id="composerWho" style="margin-left:auto"></span>
    </div>
    <div class="soft card" style="min-height:40vh;margin-top:10px">
      <textarea id="composeText" rows="4" placeholder="Âú®ÊÉ≥‰∫õ‰ªÄÈ∫ºÔºü" style="width:100%;border:none;outline:none"></textarea>
      <div id="composePreview" class="row" style="flex-wrap:wrap;gap:8px;margin-top:8px"></div>
    </div>
    <div class="row" style="gap:10px;margin-top:12px">
      <input id="composeMedia" type="file" multiple accept="image/*,video/*" onchange="previewComposeMedia(event)">
      <button class="chip" onclick="publishDraft()">Áôº‰ΩàÔºàÊö´Â≠òÊµÅÁ®ãÔºâ</button>
    </div>
  </section>

  <!-- ===== ËÉåÊôØÁ∑®ËºØÂô®ÔºàoverlayÔºâ ===== -->
  <div id="bgEditor">
    <div class="panel">
      <b style="font-weight:900">ËÉåÊôØË®≠ÂÆö</b>
      <div id="bgPreview"><div id="bgOverlay"></div></div>
      <div class="rangeRow"><label>Á∏ÆÊîæ</label><input id="bgScale" type="range" min="100" max="220" value="140"></div>
      <div class="rangeRow"><label>Ê®°Á≥ä</label><input id="bgBlur"  type="range" min="0" max="8" value="2"></div>
      <div class="rangeRow"><label>ÊöóÂ∫¶</label><input id="bgDim"   type="range" min="0" max="70" value="25"></div>
      <div class="row" style="justify-content:space-between;gap:8px;margin-top:8px">
        <input id="bgFile" type="file" accept="image/*">
        <div class="row" style="gap:8px">
          <button class="chip" onclick="closeBgEditor()">ÂèñÊ∂à</button>
          <button class="chip" onclick="applyBg()">Â•óÁî®</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="nav">
    <button id="tabHome" class="active" onclick="showPage('home')">È¶ñÈ†Å</button>
    <button id="tabDM" onclick="showPage('dm')">DM</button>
    <button id="tabLive" onclick="alert('Áõ¥Êí≠‰πãÂæåÂÜçÊé•')">Áõ¥Êí≠</button>
    <button id="tabStore" onclick="alert('ÂïÜÂ∫ó‰πãÂæåÂÜçÊé•')">ÂïÜÂ∫ó</button>
  </nav>

  <script>
  /* ==== Utils ==== */
  function imgFallback(img){
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#eaeef8'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa0b4' font-family='sans-serif' font-size='20'>NO IMG</text></svg>`);
    img.src = 'data:image/svg+xml;charset=UTF-8,' + svg; img.onerror = null;
  }
  const LS = {
    get(k,def=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
    getStr(k,def=''){ const v=localStorage.getItem(k); return v ?? def },
    setStr(k,v){ localStorage.setItem(k,v) }
  };
  const escapeHtml = s => String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmtTime = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  /* ==== ÂÖ®ÂüüÁãÄÊÖã ==== */
  const ARTIST_MODE = true;
  const HIDE_NAV_PAGES = ['dmDetail','composerArtist'];
  const pageStack = ['home'];
  function showPage(id){
    document.querySelectorAll('section.page').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    const nav = document.getElementById('nav');
    if(HIDE_NAV_PAGES.includes(id)) nav.classList.add('hidden'); else nav.classList.remove('hidden');
    document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
    const map = {home:'tabHome', dm:'tabDM'};
    if(map[id]) document.getElementById(map[id]).classList.add('active');
    if(pageStack[pageStack.length-1] !== id) pageStack.push(id);

    if(id==='home'){ renderStoryBar(); renderFeed(currentFilter); }
    if(id==='dm'){ renderDmList(); }
    if(id==='dmDetail'){ syncRoomTitleUI(); renderDmThread(); applyChatBg(); }
    if(id==='composerArtist'){ document.getElementById('composerWho').textContent = ME.name; }
  }
  function goBack(){
    if(pageStack.length>1) pageStack.pop();
    const id = pageStack[pageStack.length-1] || 'home';
    showPage(id);
  }

  /* ==== ÂÅáË≥áÊñô / ÁãÄÊÖã ==== */
  const ME = { id:'artist:annie', name:LS.getStr('artistName','Annie'), avatar:LS.getStr('artistAvatar','https://picsum.photos/80?u=artist') };
  const ARTISTS = [
    {id:'me', name:ME.name, avatar:ME.avatar},
    {id:'all', name:'ALL', avatar:'https://picsum.photos/80?u=all'},
    {id:'dohee', name:'Dohee', avatar:'https://picsum.photos/80?u=dh'},
    {id:'woo', name:'Woochan', avatar:'https://picsum.photos/80?u=wc'}
  ];
  const POSTS = LS.get('artistPosts', [
    { id:'p3', artistId:'dohee', artistName:'Dohee',   avatar:'https://picsum.photos/80?u=dh', text:'Á∑¥ËàûÁ∑¥Âà∞ÁàÜÊ±ó üíÉ', img:'https://picsum.photos/1200?u=dh1', ts: Date.now()-1000*60*40 },
    { id:'p2', artistId:'woo',   artistName:'Woochan', avatar:'https://picsum.photos/80?u=wc', text:'‰ªäÂ§©ÂêÉÊãâÈ∫µ üçú',   img:'httpsum.photos/1200?u=wc1'.replace('httpsum','https://picsum'), ts: Date.now()-1000*60*50 },
    { id:'p1', artistId:'me',    artistName:ME.name,   avatar:ME.avatar, text:'Â§ßÂÆ∂Â•ΩÔºåÊàëÊòØ Annie ‚ú®', img:'', ts: Date.now()-1000*60*60 }
  ]);
  const lastSeen = LS.get('lastSeen', {});
  const FANS = [
    {id:'f1', name:'Á≤âÁµ≤ A', avatar:'https://picsum.photos/40?u=f1'},
    {id:'f2', name:'Á≤âÁµ≤ B', avatar:'https://picsum.photos/40?u=f2'},
    {id:'f3', name:'Á≤âÁµ≤ C', avatar:'https://picsum.photos/40?u=f3'}
  ];
  let GROUP_MSGS = LS.get('groupMsgs', [
    {id:'m1', from:'fan', fanId:'f1', text:'ÂÅ∂ÂÉèÂ•ΩÔΩû', ts:Date.now()-1000*60*45},
    {id:'m2', from:'fan', fanId:'f2', text:'‰ªäÂ§©ÂêÉ‰ªÄÈ∫ºÔºü', ts:Date.now()-1000*60*43},
    {id:'m3', from:'artist', text:'ÊàëÂâõÂÇ≥‰∫Ü‰∏ÄÂºµËá™Êãç üì∏', ts:Date.now()-1000*60*40, replyTo:{text:'‰ªäÂ§©ÂêÉ‰ªÄÈ∫ºÔºü'}}
  ]);

  /* ==== HomeÔºöstories & feed ==== */
  let currentFilter = 'me';
  function hasNewDots(id){
    if(id==='me'||id==='all') return false;
    const seen = lastSeen[id]||0;
    const latest = Math.max(0,...POSTS.filter(p=>p.artistId===id).map(p=>p.ts));
    return latest>seen;
  }
  function renderStoryBar(){
    const bar=document.getElementById('storyBar');
    const order=[ARTISTS.find(a=>a.id==='me'),ARTISTS.find(a=>a.id==='all'),
      ...ARTISTS.filter(a=>a.id!=='me'&&a.id!=='all').sort((a,b)=>{
        const la=Math.max(0,...POSTS.filter(p=>p.artistId===a.id).map(p=>p.ts));
        const lb=Math.max(0,...POSTS.filter(p=>p.artistId===b.id).map(p=>p.ts));
        return lb-la;
      })];
    bar.innerHTML=order.map(a=>{
      const active=(currentFilter===a.id)?'active':'';
      const dot=hasNewDots(a.id)?'<span class="dot"></span>':'';
      return `<div class="story-item ${active}" data-id="${a.id}">
        <img src="${a.avatar}" onerror="imgFallback(this)">${dot}
        <div class="name">${escapeHtml(a.name)}</div></div>`;
    }).join('');
    bar.querySelectorAll('.story-item').forEach(el=>{
      el.onclick=()=>{ currentFilter=el.dataset.id; if(currentFilter!=='all') lastSeen[currentFilter]=Date.now(); LS.set('lastSeen',lastSeen); renderStoryBar(); renderFeed(currentFilter); window.scrollTo({top:0,behavior:'smooth'}); };
    });
  }
  function feedOf(filter){
    if(filter==='all') return POSTS.slice().sort((a,b)=>b.ts-a.ts);
    if(filter==='me')  return POSTS.filter(p=>p.artistId==='me').sort((a,b)=>b.ts-a.ts);
    return POSTS.filter(p=>p.artistId===filter).sort((a,b)=>b.ts-a.ts);
  }
  function renderFeed(filter='me'){
    const wrap=document.getElementById('feedWrap'); const list=feedOf(filter);
    if(!list.length){ wrap.innerHTML=`<div class="ghost" style="text-align:center;margin-top:20vh">Â∞öÁÑ°Ë≤ºÊñá</div>`; return; }
    wrap.innerHTML=list.map(p=>`
      <div class="card soft postCard">
        <div class="hdr">
          <img class="avatar" src="${p.avatar}" onerror="imgFallback(this)">
          <div class="meta">
            <b>${escapeHtml(p.artistName)} <span class="artistTag" style="vertical-align:middle">ARTIST</span></b>
            <small class="ghost">${new Date(p.ts).toLocaleString()}</small>
          </div>
        </div>
        <div class="body">
          <p>${escapeHtml(p.text)}</p>
          ${p.img? `<img class="hero" src="${p.img}" onerror="imgFallback(this)">` : ``}
          <div class="actions"><span class="chip ghost">üí¨ ÁïôË®ÄÔºàÈóúÈñâ‰∏≠Ôºâ</span><span class="chip ghost">‚ô° ÂèçÊáâÔºàÈóúÈñâ‰∏≠Ôºâ</span></div>
        </div>
      </div>
    `).join('');
  }

  /* ==== DM list ==== */
  function getRoomTitle(){ return LS.getStr('artistName','Annie'); }
  function renderDmList(){
    const box=document.getElementById('dmList');
    const last=GROUP_MSGS[GROUP_MSGS.length-1];
    box.innerHTML=`
      <div class="dmCard" onclick="showPage('dmDetail')">
        <div class="left">
          <img src="${ME.avatar}" onerror="imgFallback(this)">
          <div>
            <b>${escapeHtml(getRoomTitle())}</b>
            <small class="ghost">${escapeHtml(last?last.text:'ÔºàÁÑ°Ë®äÊÅØÔºâ')}</small>
          </div>
        </div>
      </div>`;
  }
  function syncRoomTitleUI(){
    document.getElementById('dmTitle').textContent = getRoomTitle();
  }

  /* ==== Êö±Á®±ÔºùËÅäÂ§©ÂÆ§ÂêçÁ®± ==== */
  function propagateArtistName(n){
    LS.setStr('artistName', n);
    ME.name=n; const meItem=ARTISTS.find(a=>a.id==='me'); if(meItem) meItem.name=n;
    POSTS.forEach(p=>{ if(p.artistId==='me') p.artistName=n; });
    LS.set('artistPosts', POSTS);
    document.getElementById('meNickname').textContent=n;
    syncRoomTitleUI(); renderDmList(); renderStoryBar(); if(pageStack[pageStack.length-1]==='home') renderFeed(currentFilter);
  }
  function editArtistNickname(){
    const cur=ME.name||'Annie';
    const v=prompt('Ëº∏ÂÖ•Êñ∞ÁöÑÊö±Á®±ÔºàÂ∞áÂêåÊ≠•ÊàêÁÇ∫ËÅäÂ§©ÂÆ§ÂêçÁ®±Ôºâ',cur);
    if(v&&v.trim()) propagateArtistName(v.trim());
  }
  function renameChat(){ editArtistNickname(); toggleDmMenu(); }

  /* ==== DMÔºöthread + reply ==== */
  let replyTarget=null; // {text}
  function toggleDmMenu(){
    const m=document.getElementById('dmMenu');
    m.style.display=(m.style.display==='block')?'none':'block';
  }
  function renderDmThread(){
    const box=document.getElementById('dmThread'); box.innerHTML='';
    GROUP_MSGS.forEach(m=>{
      const wrap=document.createElement('div'); wrap.className='dmMsg '+(m.from==='artist'?'right':'left');

      // ‰∏ªÊ≥°Ê≥°
      let bubble=`<div class="bubble">`;
      if(m.from==='fan'){
        bubble+=`<div class="label">FROM FAN</div><div class="orig">${escapeHtml(m.text)}</div>`;
      }else{
        bubble+=`<div class="orig">${escapeHtml(m.text)}</div>`;
      }
      bubble+=`</div>`;

      // ÂõûË¶ÜÈ†êË¶Ω
      if(m.from==='artist' && m.replyTo && m.replyTo.text){
        const prev=`<div class="replyPreview ${ARTIST_MODE?'bottom':'top'}"><span class="replyTag">FROM FAN</span>${escapeHtml(m.replyTo.text)}</div>`;
        bubble = bubble + prev; // Ëóù‰∫∫Ë¶ñËßíÔºöÊîæÂú®‰∏ãÊñπ
      }

      // ÂåÖË£ù
      const inner=document.createElement('div'); inner.style.position='relative'; inner.innerHTML=bubble;
      if(m.from==='fan'){
        const btn=document.createElement('button'); btn.className='replyBtn'; btn.title='ÂõûË¶Ü'; btn.textContent='‚Ü©Ô∏é';
        btn.onclick=()=>{ replyTarget={text:m.text}; showReplyChip(); document.getElementById('dmMessageInput').focus(); };
        inner.appendChild(btn);
      }
      wrap.appendChild(inner);
      const t=document.createElement('div'); t.className='time'; t.textContent=fmtTime(m.ts); wrap.appendChild(t);

      box.appendChild(wrap);
    });
    box.scrollTop=box.scrollHeight;
  }
  function showReplyChip(){
    const chip=document.getElementById('replyChip');
    if(replyTarget){ chip.style.display='flex'; document.getElementById('replyChipText').textContent = replyTarget.text.slice(0,42); }
    else chip.style.display='none';
  }
  function clearReply(){ replyTarget=null; showReplyChip(); }
  function sendArtistMsg(){
    const inp=document.getElementById('dmMessageInput');
    const t=(inp.value||'').trim(); if(!t) return;
    GROUP_MSGS.push({id:'u'+Date.now(), from:'artist', text:t, ts:Date.now(), replyTo: replyTarget? {text:replyTarget.text}: null});
    LS.set('groupMsgs', GROUP_MSGS);
    inp.value=''; clearReply(); renderDmThread(); renderDmList();
  }

  /* ==== DM ËÉåÊôØ ==== */
  function openBgEditor(){
    document.getElementById('bgEditor').style.display='block';
    const url=LS.getStr('artistChatBg',''); const s=LS.getStr('artistChatBgScale','140'); const b=LS.getStr('artistChatBgBlur','2'); const d=LS.getStr('artistChatBgDim','25');
    if(url) document.getElementById('bgPreview').style.backgroundImage=`url("${url}")`;
    document.getElementById('bgScale').value=s; document.getElementById('bgBlur').value=b; document.getElementById('bgDim').value=d; updateBgPreview();
  }
  function closeBgEditor(){ document.getElementById('bgEditor').style.display='none'; }
  function updateBgPreview(){
    const s=document.getElementById('bgScale').value, b=document.getElementById('bgBlur').value, d=document.getElementById('bgDim').value;
    document.getElementById('bgPreview').style.setProperty('--bgScale', `${s}%`);
    document.getElementById('bgOverlay').style.setProperty('--bgBlur', `${b}px`);
    document.getElementById('bgOverlay').style.setProperty('--bgDim',  `${d/100}`);
  }
  ['bgScale','bgBlur','bgDim'].forEach(id=>{
    document.addEventListener('input', e=>{ if(e.target && e.target.id===id) updateBgPreview(); }, {passive:true});
  });
  document.getElementById('bgFile').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=ev=>{ document.getElementById('bgPreview').style.backgroundImage=`url("${ev.target.result}")`; document.getElementById('bgPreview').dataset.url = ev.target.result; };
    reader.readAsDataURL(f);
  });
  function applyBg(){
    const url=document.getElementById('bgPreview').dataset.url || LS.getStr('artistChatBg','');
    const s=document.getElementById('bgScale').value, b=document.getElementById('bgBlur').value, d=document.getElementById('bgDim').value;
    if(url) LS.setStr('artistChatBg',url); LS.setStr('artistChatBgScale',s); LS.setStr('artistChatBgBlur',b); LS.setStr('artistChatBgDim',d);
    applyChatBg(); closeBgEditor();
  }
  function applyChatBg(){
    const url=LS.getStr('artistChatBg',''); const s=LS.getStr('artistChatBgScale','140'); const b=LS.getStr('artistChatBgBlur','2'); const d=LS.getStr('artistChatBgDim','25');
    const el=document.querySelector('#dmDetail');
    if(!url){ el.style.background='none'; }
    else{
      el.style.backgroundImage=`url("${url}")`;
      el.style.backgroundSize=`${s}%`;
      el.style.backgroundPosition='center';
      el.style.backgroundRepeat='no-repeat';
      el.style.setProperty('--bgDim', d/100);
      el.style.setProperty('--bgBlur', `${b}px`);
    }
  }

  /* ==== Composer ==== */
  function previewComposeMedia(e){
    const box=document.getElementById('composePreview'); box.innerHTML='';
    [...e.target.files].forEach(f=>{
      const url=URL.createObjectURL(f); const isVideo=f.type.startsWith('video/');
      const el=document.createElement(isVideo?'video':'img');
      el.src=url; el.style.width='110px'; el.style.height='110px'; el.style.objectFit='cover'; el.controls=isVideo;
      el.onloadeddata = el.onload = ()=>URL.revokeObjectURL(url);
      box.appendChild(el);
    });
  }
  function publishDraft(){ alert('ÂÖàÂ≠òËçâÁ®øÔºÜÈ†êË¶ΩÔºõ‰πãÂæåÊé•‰∏äÁúüÊ≠£Áôº‰ΩàÊµÅÁ®ã'); goBack(); }

  /* ==== ÂïüÂãï ==== */
  document.addEventListener('DOMContentLoaded', ()=>{
    // Home init
    document.getElementById('meNickname').textContent=ME.name;
    document.getElementById('meId').textContent='ARTIST-00001';
    document.getElementById('meAvatar').src=ME.avatar;

    renderStoryBar(); renderFeed(currentFilter);
    renderDmList();

    document.getElementById('fabNew').onclick=()=>{ showPage('composerArtist'); };

    document.getElementById('dmSendBtn').onclick=sendArtistMsg;
    document.getElementById('dmMessageInput').addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendArtistMsg(); }
    });
  });
  </script>
</body>
</html>
