<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NEXT’S YOU — Artist</title>
<style>
  /* 直接沿用粉絲端主題，視覺會一樣 */
  :root{--bg:#f5f7ff;--card:#fff;--text:#1a1a1a;--sub:#666;--line:#e6e8ef;--ghost:#9aa0b4;--accent:#6a5acd;--accent2:#836fff;--hover:#eef1ff;--radius:16px;--shadow:0 10px 35px rgba(26,26,26,.08)}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  .page{padding:12px 12px 88px} .row{display:flex;align-items:center;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)} .soft{padding:16px}
  nav{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);display:flex;gap:6px;justify-content:space-around;padding:10px 8px 14px}
  nav button{flex:1;border:none;background:transparent;padding:8px 0;border-radius:12px;color:var(--sub);font-weight:800}
  nav button.active{color:var(--accent);background:var(--hover);border:1px solid var(--line)}
  textarea,input[type="text"]{width:100%;border:1px solid var(--line);border-radius:12px;background:var(--hover);padding:12px}
  select{border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px}
  button.primary{border:none;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:900;padding:10px 16px}
  /* 貼文卡片（與粉絲端一致） */
  .postCard{margin:12px 6px}.hdr{display:flex;gap:10px;align-items:center;position:relative}
  .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  .meta b{font-weight:900}.meta small{display:block;color:var(--ghost)}
  .body{margin-top:8px}.hero{width:100%;height:400px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}
  /* 反應膠囊（同粉絲端縮小版） */
  .reaction-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .reaction{display:flex;align-items:center;justify-content:space-between;gap:8px;height:36px;padding:6px 10px;border:1px solid var(--line);background:#f7f8ff;border-radius:12px;font-weight:800}
  .reaction .count{margin-left:auto;min-width:2.2em;text-align:right;font-size:12px}
  /* 淡紫 Verified（除了 DM 以外都會顯示） */
  .v-badge{display:inline-block;margin-left:6px;width:18px;height:18px;border-radius:50%;background:#dcd3ff;color:#fff;position:relative}
  .v-badge:after{content:"✓";position:absolute;inset:0;display:grid;place-items:center;font-size:12px;font-weight:900}
</style>
</head>
<body>

<section id="publish" class="page">
  <div class="row" style="justify-content:space-between;margin:2px 0 10px">
    <b style="font-weight:900">發佈中心（藝人端）</b>
  </div>

  <div class="card soft" style="margin-bottom:12px">
    <h3 style="margin:0 0 8px;font-weight:900">發貼文</h3>
    <div class="row" style="gap:8px;margin:6px 0">
      <select id="artistPick"></select>
      <input id="postTs" type="text" placeholder="時間標籤（例如：剛剛 / 10小時前）">
    </div>
    <textarea id="postText" rows="4" placeholder="想說什麼？"></textarea>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <input type="file" id="postImg" accept="image/*">
      <button class="primary" onclick="publishPost()">發布</button>
    </div>
  </div>

  <div class="card soft">
    <h3 style="margin:0 0 8px;font-weight:900">DM 群發 / 個別</h3>
    <div class="row" style="gap:8px;margin:6px 0">
      <select id="dmTarget"></select>
    </div>
    <input id="dmText" type="text" placeholder="輸入訊息…">
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="primary" onclick="broadcastDM()">送出</button>
    </div>
  </div>
</section>

<section id="preview" class="page" style="display:none">
  <div class="row" style="justify-content:space-between;margin:2px 0 10px">
    <b style="font-weight:900">粉絲端預覽</b>
    <button class="primary" onclick="renderPreview()">重新整理</button>
  </div>
  <div id="feedWrap"></div>
</section>

<nav>
  <button id="tabPublish" class="active" onclick="switchTab('publish')">發佈</button>
  <button id="tabPreview" onclick="switchTab('preview')">預覽</button>
</nav>

<script>
/* 共享資料（與粉絲端一致） */
const ARTISTS = [
  {id:'annie',name:'Annie',avatar:'https://picsum.photos/80?u=an'},
  {id:'dohee',name:'Dohee',avatar:'https://picsum.photos/80?u=dh'},
  {id:'woo',name:'Woochan',avatar:'https://picsum.photos/80?u=wc'},
  {id:'group',name:'ALLDAY PROJECT',avatar:'https://picsum.photos/80?u=group'}
];

/* LocalStorage DB（與粉絲端透過這兩個 key 溝通） */
const DB = {
  getPosts(){ try{return JSON.parse(localStorage.getItem('postsOverride')||'[]')}catch(e){return []} },
  setPosts(list){ localStorage.setItem('postsOverride', JSON.stringify(list)); },
  getDM(){ try{return JSON.parse(localStorage.getItem('dmOverride')||'{}')}catch(e){return {}} },
  setDM(map){ localStorage.setItem('dmOverride', JSON.stringify(map)); }
};

/* 反應計數需要的型別（只做預覽視覺，不影響粉絲端互動） */
const REACTION_TYPES = [
  {key:'heart',icon:'💜'},{key:'clap',icon:'👏'},{key:'laugh',icon:'🤣'},
  {key:'panda',icon:'🐼'},{key:'tear',icon:'🥲'},{key:'cheer',icon:'🥳'}
];

/* 工具：壓縮圖片（輸出 blob URL） */
function compressImage(file, max=1400, cb){
  const img = new Image(), rd = new FileReader();
  rd.onload = e => { img.onload = ()=> {
      let w=img.width,h=img.height; if(w>h&&w>max){h*=max/w;w=max}else if(h>=w&&h>max){w*=max/h;h=max}
      const c=document.createElement('canvas'); c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
      c.toBlob(b=>cb(URL.createObjectURL(b)),'image/jpeg',0.9);
  }; img.src = e.target.result; }; rd.readAsDataURL(file);
}

/* UI 切頁 */
function switchTab(id){
  document.getElementById('publish').style.display = (id==='publish'?'block':'none');
  document.getElementById('preview').style.display = (id==='preview'?'block':'none');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id==='publish'?'tabPublish':'tabPreview').classList.add('active');
}

/* 初始化下拉 */
(function init(){
  const opts = ARTISTS.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  document.getElementById('artistPick').innerHTML = opts.replace('group',''); // 發貼文不選 group
  document.getElementById('dmTarget').innerHTML =
    `<option value="group">ALLDAY（團體）</option>` + opts;
  renderPreview();
})();

/* 發布貼文 → 寫入 postsOverride */
function publishPost(){
  const aId = document.getElementById('artistPick').value;
  const text = (document.getElementById('postText').value||'').trim();
  const ts   = (document.getElementById('postTs').value||'剛剛').trim();
  const file = document.getElementById('postImg').files[0];
  const artist = ARTISTS.find(a=>a.id===aId);
  if(!artist) return alert('請選擇藝人');
  if(!text && !file) return alert('請輸入文字或選擇圖片');

  const done = (imgUrl)=>{
    const list = DB.getPosts();
    list.unshift({ id:'p'+Date.now(), artistId:artist.id, artistName:artist.name,
      avatar:artist.avatar, text, img:imgUrl||'', ts:ts||'剛剛' });
    DB.setPosts(list);
    document.getElementById('postText').value='';
    document.getElementById('postImg').value='';
    renderPreview(); switchTab('preview'); alert('已發布');
  };
  if(file) compressImage(file, 1400, url=>done(url)); else done('');
}

/* DM 群發 / 個別 → 寫入 dmOverride */
function broadcastDM(){
  const target = document.getElementById('dmTarget').value;
  const text = (document.getElementById('dmText').value||'').trim();
  if(!text) return alert('請輸入訊息');
  const dm = DB.getDM();
  const push = id => {
    dm[id] = dm[id]||[];
    dm[id].push({id:'m'+Date.now(),from:'left',text,ts:Date.now(),translated:false,read:true});
  };
  if(target==='group') push('group'); else push(target);
  DB.setDM(dm);
  document.getElementById('dmText').value='';
  alert('已送出');
}

/* 粉絲端預覽（卡片樣式與 index.html 一致） */
function renderPreview(){
  const wrap = document.getElementById('feedWrap');
  const posts = DB.getPosts();
  if(posts.length===0){ wrap.innerHTML = `<div class="card soft" style="margin:12px">尚無貼文</div>`; return; }
  wrap.innerHTML = posts.map(p=>`
    <div class="card soft postCard">
      <div class="hdr">
        <img class="avatar" src="${p.avatar}">
        <div class="meta"><b>${p.artistName}</b><span class="v-badge"></span><small>${p.ts||''}</small></div>
      </div>
      <div class="body">
        <p>${escapeHtml(p.text||'')}</p>
        ${p.img?`<img class="hero" src="${p.img}">`:''}
        <div class="reaction-bar">
          ${REACTION_TYPES.map(r=>`<div class="reaction"><span>${r.icon}</span><span class="count"></span></div>`).join('')}
        </div>
      </div>
    </div>
  `).join('');
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>
</body>
</html>
